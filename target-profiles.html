<!DOCTYPE html>
<html lang="en">
<head>
<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-5CNT3VV9');</script>
<!-- End Google Tag Manager -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Target Profiles - Msgly AI</title>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-purple: #8039DF;
            --dark-purple: #3E0075;
            --glow-purple: #9F4EFF;
            --neon-purple: #7B2CBF;
            --electric-purple: #6A1B9A;
            --light-purple: #F5EDFF;
            --accent-pink: #FF2370;
            --success-green: #10B981;
            --warning-orange: #F59E0B;
            --error-red: #EF4444;
            --black: #111827;
            --charcoal: #1F2937;
            --dark-gray: #374151;
            --gray: #6B7280;
            --light-gray: #F9FAFB;
            --white: #FFFFFF;
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 8px 25px rgba(0, 0, 0, 0.12);
            --glow-shadow: 0 0 30px rgba(128, 57, 223, 0.25);
            --intense-glow: 0 0 45px rgba(128, 57, 223, 0.35);
            --neon-glow: 0 0 60px rgba(128, 57, 223, 0.25);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--light-gray);
            min-height: 100vh;
            display: flex;
        }

        /* Side Navigation */
        .sidebar {
            width: 280px;
            background: linear-gradient(180deg, var(--primary-purple) 0%, var(--dark-purple) 100%);
            color: var(--white);
            position: fixed;
            height: 100vh;
            left: 0;
            top: 0;
            z-index: 1000;
            overflow-y: auto;
            transition: transform 0.3s ease;
            box-shadow: var(--shadow-lg);
        }

        .sidebar-header {
            padding: 2rem 1.5rem 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-logo {
            display: flex;
            align-items: center;
            text-decoration: none;
            color: var(--white);
            margin-bottom: 1rem;
        }

        .sidebar-logo i {
            font-size: 2rem;
            margin-right: 12px;
            filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.3));
        }

        .sidebar-logo-text {
            display: flex;
            flex-direction: column;
        }

        .sidebar-logo-main {
            font-size: 1.5rem;
            font-weight: 700;
            line-height: 1.2;
        }

        .sidebar-logo-sub {
            font-size: 0.7rem;
            opacity: 0.8;
            font-weight: 400;
        }

        .sidebar-user {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }

        .sidebar-user-avatar {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .sidebar-user-info {
            flex: 1;
            min-width: 0;
        }

        .sidebar-user-name {
            font-weight: 600;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .sidebar-user-email {
            font-size: 0.75rem;
            opacity: 0.8;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .sidebar-user-plan {
            font-size: 0.7rem;
            opacity: 0.7;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .sidebar-user-credits {
            font-size: 0.85rem;
            font-weight: 700;
            margin-top: 0.5rem;
            padding: 0.4rem 0.8rem;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .sidebar-user-credits i {
            font-size: 0.9rem;
            filter: drop-shadow(0 0 4px rgba(255, 255, 255, 0.4));
        }

        .sidebar-user-credits.updating {
            animation: pulse 0.6s ease-in-out;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); background: rgba(255, 255, 255, 0.25); }
        }

        .sidebar-nav {
            padding: 1.5rem 0;
        }

        .nav-section {
            margin-bottom: 2rem;
        }

        .nav-section-title {
            padding: 0 1.5rem;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.6;
            font-weight: 600;
            margin-bottom: 0.8rem;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 0.9rem 1.5rem;
            color: rgba(255, 255, 255, 0.85);
            text-decoration: none;
            transition: all 0.3s ease;
            position: relative;
            font-weight: 500;
        }

        .nav-item i {
            width: 20px;
            margin-right: 12px;
            font-size: 1.1rem;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--white);
        }

        .nav-item.active {
            background: rgba(255, 255, 255, 0.15);
            color: var(--white);
            border-left: 3px solid var(--white);
            padding-left: calc(1.5rem - 3px);
        }

        .nav-badge {
            margin-left: auto;
            padding: 0.2rem 0.5rem;
            border-radius: 10px;
            font-size: 0.65rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .nav-badge.new {
            background: var(--accent-pink);
            color: var(--white);
        }

        .nav-badge.soon {
            background: rgba(255, 255, 255, 0.2);
            color: var(--white);
        }

        .sidebar-footer {
            padding: 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .logout-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 0.9rem;
            background: rgba(255, 255, 255, 0.1);
            color: var(--white);
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .logout-btn i {
            margin-right: 8px;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Main Content */
        .main-wrapper {
            flex: 1;
            margin-left: 280px;
            min-height: 100vh;
        }

        .main-content {
            padding: 2rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1.5rem;
        }

        .page-header-left {
            flex: 1;
        }

        .page-title {
            font-size: 2rem;
            font-weight: 700;
            color: var(--black);
            margin-bottom: 0.5rem;
        }

        .page-subtitle {
            color: var(--gray);
            font-size: 1rem;
        }

        .page-header-credits {
            background: linear-gradient(135deg, var(--primary-purple) 0%, var(--dark-purple) 100%);
            color: var(--white);
            padding: 0.8rem 1.5rem;
            border-radius: 25px;
            display: flex;
            align-items: center;
            gap: 0.6rem;
            font-size: 1.1rem;
            font-weight: 700;
            box-shadow: var(--glow-shadow);
            transition: all 0.3s ease;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .page-header-credits i {
            font-size: 1.3rem;
            filter: drop-shadow(0 0 6px rgba(255, 255, 255, 0.5));
        }

        .page-header-credits.updating {
            animation: creditPulse 0.6s ease-in-out;
        }

        @keyframes creditPulse {
            0%, 100% { transform: scale(1); }
            50% { 
                transform: scale(1.08); 
                box-shadow: 0 0 40px rgba(128, 57, 223, 0.5);
            }
        }

        /* FUNNEL STATS */
        .stats-section {
            margin-bottom: 2.5rem;
            padding: 3rem 2.5rem;
            background: linear-gradient(135deg, #FFFFFF 0%, #FAF5FF 100%);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(128, 57, 223, 0.15);
            border: 2px solid rgba(128, 57, 223, 0.1);
        }

        .funnel-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
        }

        .funnel-visual {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.8rem;
            flex-wrap: wrap;
        }

        .funnel-section {
            padding: 1.5rem 1rem;
            border-radius: 15px;
            text-align: center;
            color: white;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            cursor: pointer;
            animation: slideIn 0.6s ease-out backwards;
        }

        @keyframes slideIn {
            0% {
                opacity: 0;
                transform: translateX(-20px);
            }
            100% {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .funnel-section:hover {
            transform: translateY(-5px);
            filter: brightness(1.1);
        }

        .funnel-section-1 {
            width: 160px;
            background: linear-gradient(135deg, #8039DF 0%, #6A1B9A 100%);
            animation-delay: 0.1s;
            box-shadow: 0 8px 25px rgba(128, 57, 223, 0.35);
        }

        .funnel-section-2 {
            width: 140px;
            background: linear-gradient(135deg, #6A1B9A 0%, #7B2CBF 100%);
            animation-delay: 0.3s;
            box-shadow: 0 8px 25px rgba(106, 27, 154, 0.35);
        }

        .funnel-section-3 {
            width: 120px;
            background: linear-gradient(135deg, #FF2370 0%, #E91E63 100%);
            animation-delay: 0.5s;
            box-shadow: 0 8px 25px rgba(255, 35, 112, 0.35);
        }

        .funnel-number {
            font-size: 2.4rem;
            font-weight: 900;
            color: white;
            line-height: 1;
            margin-bottom: 0.3rem;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            animation: numberPop 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55) backwards;
        }

        .funnel-section-1 .funnel-number {
            animation-delay: 0.4s;
        }

        .funnel-section-2 .funnel-number {
            animation-delay: 0.6s;
        }

        .funnel-section-3 .funnel-number {
            animation-delay: 0.8s;
        }

        @keyframes numberPop {
            0% {
                opacity: 0;
                transform: scale(0) rotate(-180deg);
            }
            100% {
                opacity: 1;
                transform: scale(1) rotate(0deg);
            }
        }

        .funnel-label {
            font-size: 0.65rem;
            color: rgba(255, 255, 255, 0.95);
            text-transform: uppercase;
            letter-spacing: 0.8px;
            font-weight: 700;
            text-align: center;
            line-height: 1.3;
            margin-bottom: 0.25rem;
        }

        .funnel-percentage {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.95);
            font-weight: 700;
        }

        .response-rate-text {
            font-size: 0.8rem;
            color: var(--primary-purple);
            text-align: center;
            line-height: 1.5;
            animation: fadeInText 0.8s ease-out 1s backwards;
        }

        .response-rate-text strong {
            font-weight: 700;
        }

        .response-rate-text span {
            color: var(--gray);
            font-style: italic;
        }

        @keyframes fadeInText {
            0% {
                opacity: 0;
                transform: translateY(10px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .messages-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-box {
            flex: 1;
            min-width: 300px;
            position: relative;
        }

        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
            font-size: 1rem;
        }

        .search-input {
            width: 100%;
            padding: 0.8rem 1rem 0.8rem 2.8rem;
            border: 2px solid var(--light-gray);
            border-radius: 12px;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            background: var(--white);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary-purple);
            box-shadow: var(--glow-shadow);
        }

        .refresh-btn {
            background: none;
            border: none;
            color: var(--gray);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-size: 1.1rem;
        }

        .refresh-btn:hover {
            background: var(--light-purple);
            color: var(--primary-purple);
        }

        /* CARD-BASED LAYOUT */
        .messages-cards-container {
            background: var(--white);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            border: 1px solid rgba(128, 57, 223, 0.08);
            position: relative;
            overflow: hidden;
        }

        .messages-cards-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-purple) 0%, var(--electric-purple) 100%);
        }

        .pagination-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--light-gray);
        }

        .showing-info {
            font-size: 0.9rem;
            color: var(--dark-gray);
            font-weight: 500;
        }

        .load-more-btn {
            background: linear-gradient(135deg, var(--primary-purple) 0%, var(--dark-purple) 100%);
            color: var(--white);
            border: none;
            border-radius: 8px;
            padding: 0.8rem 1.5rem;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: var(--glow-shadow);
        }

        .load-more-btn:hover {
            background: linear-gradient(135deg, var(--electric-purple) 0%, var(--primary-purple) 100%);
            transform: translateY(-1px);
        }

        .load-more-btn:disabled {
            background: var(--gray);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .bottom-pagination {
            display: flex;
            justify-content: center;
            padding: 2rem 1rem 1rem;
            border-top: 1px solid var(--light-gray);
            margin-top: 2rem;
        }

        .bottom-pagination .load-more-btn {
            padding: 1rem 2rem;
            font-size: 1rem;
            min-width: 200px;
            justify-content: center;
        }

        .messages-cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 2rem;
            margin-top: 1rem;
        }

        .message-card {
            background: var(--white);
            border: 3px solid var(--light-gray);
            border-radius: 16px;
            padding: 1.5rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .message-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-purple);
        }

        .message-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-purple) 0%, var(--electric-purple) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .message-card:hover::before {
            opacity: 1;
        }

        /* Target Profile Header */
        .card-profile-header {
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--light-gray);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 1rem;
        }

        .profile-info {
            flex: 1;
            min-width: 0;
        }

        .profile-name {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--black);
            margin-bottom: 0.4rem;
        }

        .profile-role {
            font-size: 1rem;
            color: var(--dark-gray);
            font-weight: 500;
            margin-bottom: 0.3rem;
        }

        .profile-company {
            font-size: 0.9rem;
            color: var(--gray);
        }

        .email-finder-header-section {
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.8rem;
            padding: 0.5rem;
        }

        .email-finder-description {
            font-size: 0.7rem;
            color: var(--primary-purple);
            font-weight: 500;
            text-align: center;
            opacity: 0.8;
        }

        /* Enhanced Email Display */
        .email-found-container {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(16, 185, 129, 0.05) 100%);
            border: 2px solid var(--success-green);
            border-radius: 12px;
            padding: 1rem;
            width: 100%;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.15);
            animation: emailFoundPulse 0.6s ease-out;
        }

        @keyframes emailFoundPulse {
            0% { transform: scale(0.95); opacity: 0.8; }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); opacity: 1; }
        }

        .email-unknown-container {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(245, 158, 11, 0.05) 100%);
            border: 2px solid var(--warning-orange);
            border-radius: 12px;
            padding: 1rem;
            width: 100%;
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.15);
            animation: emailFoundPulse 0.6s ease-out;
        }

        .email-not-found-container {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.08) 0%, rgba(239, 68, 68, 0.03) 100%);
            border: 2px solid rgba(239, 68, 68, 0.3);
            border-radius: 12px;
            padding: 1rem;
            width: 100%;
        }

        .email-header-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.6rem;
        }

        .email-label {
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--success-green);
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .email-label.warning {
            color: var(--warning-orange);
        }

        .email-label.error {
            color: var(--error-red);
        }

        .email-address-display {
            font-size: 1rem;
            font-weight: 700;
            color: var(--dark-gray);
            word-break: break-all;
            margin-bottom: 0.6rem;
            padding: 0.6rem;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            border-left: 4px solid var(--success-green);
        }

        .email-address-display.warning {
            border-left-color: var(--warning-orange);
        }

        .email-actions-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.5rem;
        }

        .copy-email-btn {
            background: linear-gradient(135deg, var(--success-green) 0%, #059669 100%);
            color: var(--white);
            border: none;
            border-radius: 8px;
            padding: 0.6rem 1rem;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.4rem;
            flex: 1;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.25);
        }

        .copy-email-btn:hover {
            background: linear-gradient(135deg, #059669 0%, var(--success-green) 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.35);
        }

        .copy-email-btn.copied {
            background: var(--primary-purple);
            animation: copySuccess 0.4s ease-out;
        }

        .copy-email-btn.warning {
            background: linear-gradient(135deg, var(--warning-orange) 0%, #D97706 100%);
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.25);
        }

        .copy-email-btn.warning:hover {
            background: linear-gradient(135deg, #D97706 0%, var(--warning-orange) 100%);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.35);
        }

        @keyframes copySuccess {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .email-ask-btn {
            background: linear-gradient(135deg, var(--primary-purple) 0%, var(--dark-purple) 100%);
            color: var(--white);
            border: none;
            border-radius: 8px;
            padding: 0.7rem 1.2rem;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            box-shadow: var(--glow-shadow);
            white-space: nowrap;
        }

        .email-ask-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, var(--electric-purple) 0%, var(--primary-purple) 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(128, 57, 223, 0.4);
        }

        .email-ask-btn:disabled {
            background: var(--gray);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            opacity: 0.6;
        }

        .email-ask-btn.loading {
            background: var(--warning-orange);
            cursor: wait;
        }

        .email-ask-btn.search-again {
            background: linear-gradient(135deg, var(--warning-orange) 0%, #D97706 100%);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }

        .email-ask-btn.search-again:hover {
            background: linear-gradient(135deg, #D97706 0%, var(--warning-orange) 100%);
            box-shadow: 0 6px 16px rgba(245, 158, 11, 0.4);
        }

        .email-verification {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
            font-size: 0.8rem;
        }

        .email-address {
            color: var(--dark-gray);
            font-weight: 600;
            word-break: break-all;
        }

        .email-status {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .email-status.valid {
            color: var(--success-green);
        }

        .email-status.invalid,
        .email-status.not_valid {
            color: var(--error-red);
        }

        .email-status.catch_all {
            color: var(--warning-orange);
        }

        .email-status.unknown {
            color: var(--gray);
        }

        .email-status.error {
            color: var(--error-red);
        }

        .email-status.verified {
            color: var(--success-green);
        }

        .email-status.not-found,
        .email-status.not_found {
            color: var(--error-red);
        }

        .email-status.found {
            color: var(--warning-orange);
        }

        .email-verified-date {
            font-size: 0.7rem;
            color: var(--gray);
        }

        .email-not-available {
            color: var(--gray);
            font-style: italic;
            font-size: 0.8rem;
        }

        /* Message Types Section */
        .message-types-section {
            margin-bottom: 1.5rem;
        }

        .message-type-block {
            margin-bottom: 1rem;
            padding: 1rem;
            border: 1px solid var(--light-gray);
            border-radius: 12px;
            background: rgba(128, 57, 223, 0.01);
        }

        .message-type-block.linkedin {
            border-left: 4px solid #0077B5;
        }

        .message-type-block.connection {
            border-left: 4px solid var(--accent-pink);
        }

        .message-type-block.email {
            border-left: 4px solid var(--warning-orange);
        }

        .message-type-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.8rem;
        }

        .message-type-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--dark-gray);
        }

        .message-type-label i {
            font-size: 1rem;
        }

        .message-type-label.linkedin { color: #0077B5; }
        .message-type-label.connection { color: var(--accent-pink); }
        .message-type-label.email { color: var(--warning-orange); }

        .message-actions {
            display: flex;
            gap: 0.5rem;
        }

        .expand-btn, .edit-btn, .copy-btn {
            background: var(--light-gray);
            border: 1px solid var(--gray);
            border-radius: 6px;
            padding: 0.4rem 0.8rem;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            color: var(--dark-gray);
        }

        .expand-btn:hover {
            background: #0077B5;
            color: var(--white);
            border-color: #0077B5;
        }

        .edit-btn:hover {
            background: var(--warning-orange);
            color: var(--white);
            border-color: var(--warning-orange);
        }

        .copy-btn:hover {
            background: var(--primary-purple);
            color: var(--white);
            border-color: var(--primary-purple);
        }

        .copy-btn.copied {
            background: var(--success-green);
            color: var(--white);
            border-color: var(--success-green);
        }

        .message-text {
            font-size: 0.85rem;
            line-height: 1.5;
            color: var(--dark-gray);
            background: rgba(128, 57, 223, 0.03);
            padding: 0.8rem;
            border-radius: 8px;
            white-space: pre-wrap;
            display: none;
        }

        .message-text.expanded {
            display: block;
        }

        .message-text.empty {
            color: var(--gray);
            font-style: italic;
            text-align: center;
            padding: 1.5rem;
            display: block;
        }

        .message-preview {
            font-size: 0.85rem;
            color: var(--dark-gray);
            line-height: 1.4;
            display: block;
        }

        .message-preview.hidden {
            display: none;
        }

        .message-history-item {
            margin-bottom: 0.8rem;
            padding: 0.6rem;
            border: 1px solid var(--light-gray);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.5);
            transition: all 0.3s ease;
        }

        .message-history-item.latest {
            border-color: var(--primary-purple);
            background: rgba(128, 57, 223, 0.05);
        }

        .message-history-item.collapsed {
            background: var(--light-gray);
            cursor: pointer;
        }

        .message-history-item.collapsed:hover {
            background: rgba(128, 57, 223, 0.08);
        }

        .message-timestamp {
            font-size: 0.7rem;
            color: var(--gray);
            font-weight: 600;
            margin-bottom: 0.4rem;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .message-content-preview {
            font-size: 0.85rem;
            color: var(--dark-gray);
            line-height: 1.4;
        }

        .message-version-count {
            font-size: 0.75rem;
            color: var(--primary-purple);
            font-weight: 600;
            margin-left: 0.5rem;
            padding: 0.2rem 0.5rem;
            background: rgba(128, 57, 223, 0.1);
            border-radius: 10px;
        }

        /* Status and Comments Section */
        .card-status-section {
            padding: 1rem;
            background: rgba(128, 57, 223, 0.02);
            border-radius: 12px;
            border: 1px solid rgba(128, 57, 223, 0.08);
        }

        .status-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .status-item {
            text-align: center;
        }

        .status-label {
            font-size: 0.75rem;
            color: var(--gray);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }

        .toggle-switch {
            width: 60px;
            height: 28px;
            background: var(--light-gray);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            position: relative;
            margin: 0 auto 0.5rem;
        }

        .toggle-switch.pending {
            background: var(--light-gray);
        }

        .toggle-switch.yes {
            background: linear-gradient(135deg, var(--success-green) 0%, #059669 100%);
            border-color: var(--success-green);
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.25);
        }

        .toggle-switch.no {
            background: linear-gradient(135deg, var(--error-red) 0%, #DC2626 100%);
            border-color: var(--error-red);
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.25);
        }

        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: var(--white);
            border-radius: 50%;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 700;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .toggle-switch.pending .toggle-slider {
            background: var(--gray);
            color: var(--white);
        }

        .toggle-switch.yes .toggle-slider {
            transform: translateX(32px);
            background: var(--white);
            color: var(--success-green);
        }

        .toggle-switch.no .toggle-slider {
            background: var(--white);
            color: var(--error-red);
        }

        .toggle-label {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .toggle-label.pending {
            color: var(--gray);
        }

        .toggle-label.yes {
            color: var(--success-green);
        }

        .toggle-label.no {
            color: var(--error-red);
        }

        .comment-field {
            width: 100%;
            padding: 0.8rem;
            border: 2px solid var(--light-gray);
            border-radius: 8px;
            font-size: 0.85rem;
            font-family: inherit;
            resize: vertical;
            min-height: 80px;
            transition: all 0.3s ease;
            margin-bottom: 1rem;
        }

        .comment-field:focus {
            outline: none;
            border-color: var(--primary-purple);
            box-shadow: 0 0 0 3px rgba(128, 57, 223, 0.1);
        }

        .comment-field.modified {
            border-color: var(--warning-orange);
        }

        .save-btn {
            width: 100%;
            padding: 0.8rem;
            background: linear-gradient(135deg, var(--primary-purple) 0%, var(--dark-purple) 100%);
            color: var(--white);
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            box-shadow: var(--glow-shadow);
        }

        .save-btn:hover {
            background: linear-gradient(135deg, var(--electric-purple) 0%, var(--primary-purple) 100%);
            transform: translateY(-1px);
        }

        .save-btn.modified {
            background: linear-gradient(135deg, var(--warning-orange) 0%, #D97706 100%);
            animation: pulseModified 1.5s ease-in-out infinite;
        }

        @keyframes pulseModified {
            0%, 100% { box-shadow: 0 0 15px rgba(245, 158, 11, 0.3); }
            50% { box-shadow: 0 0 25px rgba(245, 158, 11, 0.5); }
        }

        .save-btn.saving {
            background: var(--gray);
            cursor: wait;
        }

        .save-btn.saved {
            background: linear-gradient(135deg, var(--success-green) 0%, #059669 100%);
        }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--primary-purple);
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--light-purple);
            border-top-color: var(--primary-purple);
            border-radius: 50%;
            margin: 0 auto 1rem;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--gray);
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1rem;
            color: var(--primary-purple);
            opacity: 0.3;
        }

        .empty-state h3 {
            font-size: 1.2rem;
            margin-bottom: 0.6rem;
            color: var(--dark-gray);
        }

        .empty-state p {
            font-size: 0.9rem;
            line-height: 1.4;
            max-width: 400px;
            margin: 0 auto;
        }

        /* Modals */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--white);
            border-radius: 16px;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            0% {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--light-gray);
        }

        .modal-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--black);
        }

        .modal-body {
            padding: 1.5rem;
            color: var(--dark-gray);
            line-height: 1.6;
        }

        .modal-actions {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--light-gray);
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        .modal-btn {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .modal-btn.secondary {
            background: var(--light-gray);
            color: var(--dark-gray);
        }

        .modal-btn.secondary:hover {
            background: var(--gray);
            color: var(--white);
        }

        .modal-btn.primary {
            background: linear-gradient(135deg, var(--primary-purple) 0%, var(--dark-purple) 100%);
            color: var(--white);
            box-shadow: var(--glow-shadow);
        }

        .modal-btn.primary:hover {
            background: linear-gradient(135deg, var(--electric-purple) 0%, var(--primary-purple) 100%);
            transform: translateY(-1px);
        }

        /* Sidebar Toggle for Mobile */
        .sidebar-toggle {
            display: none;
            position: fixed;
            top: 1rem;
            left: 1rem;
            z-index: 1001;
            background: var(--primary-purple);
            color: var(--white);
            border: none;
            border-radius: 8px;
            padding: 0.75rem;
            cursor: pointer;
            box-shadow: var(--shadow-lg);
            transition: all 0.3s ease;
        }

        .sidebar-toggle:hover {
            background: var(--electric-purple);
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .sidebar-toggle {
                display: block;
            }

            .main-wrapper {
                margin-left: 0;
            }

            .main-content {
                padding: 1rem;
                margin-top: 4rem;
            }

            .messages-controls {
                flex-direction: column;
            }

            .search-box {
                min-width: auto;
            }

            .messages-cards-grid {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }

            .status-row {
                grid-template-columns: 1fr;
                gap: 0.8rem;
            }

            .modal {
                max-width: 350px;
                padding: 1.5rem;
            }

            .page-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .page-header-credits {
                width: 100%;
                justify-content: center;
            }

            .funnel-visual {
                flex-direction: column;
                gap: 1rem;
            }

            .funnel-section {
                width: 100% !important;
                max-width: 200px;
            }
        }

        @media (min-width: 769px) and (max-width: 1200px) {
            .messages-cards-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (min-width: 1201px) {
            .messages-cards-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5CNT3VV9"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->

    <!-- Sidebar Toggle Button for Mobile -->
    <button class="sidebar-toggle" onclick="toggleSidebar()" aria-label="Toggle Sidebar">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Sidebar Navigation -->
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <a href="https://api.msgly.ai/dashboard" class="sidebar-logo">
                <i class="fas fa-comment-dots"></i>
                <div class="sidebar-logo-text">
                    <span class="sidebar-logo-main">Msgly</span>
                    <span class="sidebar-logo-sub">AI Outreach</span>
                </div>
            </a>

            <div class="sidebar-user">
                <div class="sidebar-user-avatar" id="sidebarUserAvatar">U</div>
                <div class="sidebar-user-info">
                    <div class="sidebar-user-name" id="sidebarUserName">User</div>
                    <div class="sidebar-user-email" id="sidebarUserEmail">user@example.com</div>
                    <div class="sidebar-user-plan" id="sidebarUserPlan">Free Plan</div>
                    <div class="sidebar-user-credits" id="sidebarUserCredits">
                        <i class="fas fa-coins"></i>
                        <span id="sidebarCreditsNumber">0</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="sidebar-nav">
            <div class="nav-section">
                <div class="nav-section-title">Main Menu</div>
                <a href="https://api.msgly.ai/dashboard" class="nav-item">
                    <i class="fas fa-tachometer-alt"></i>
                    <span class="nav-item-text">Dashboard</span>
                </a>
                <a href="https://api.msgly.ai/msgly-profile.html" class="nav-item">
                    <i class="fas fa-user-circle"></i>
                    <span class="nav-item-text">Msgly Profile</span>
                </a>
                <a href="https://api.msgly.ai/messages" class="nav-item">
                    <i class="fas fa-envelope"></i>
                    <span class="nav-item-text">Messages</span>
                </a>
                <a href="https://api.msgly.ai/target-profiles" class="nav-item active">
                    <i class="fas fa-users"></i>
                    <span class="nav-item-text">Target Profiles</span>
                </a>
                <a href="#" class="nav-item" onclick="alert('Analytics coming soon!')">
                    <i class="fas fa-chart-line"></i>
                    <span class="nav-item-text">Analytics</span>
                    <span class="nav-badge soon">Soon</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Account</div>
                <a href="https://chopa.chargebeeportal.com/portal/v2/login?forward=portal_main" class="nav-item" target="_blank">
                    <i class="fas fa-credit-card"></i>
                    <span class="nav-item-text">Billing</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Support</div>
                <a href="#" class="nav-item" onclick="alert('Help Center coming soon!')">
                    <i class="fas fa-question-circle"></i>
                    <span class="nav-item-text">Help Center</span>
                </a>
            </div>
        </div>

        <div class="sidebar-footer">
            <a href="#" class="logout-btn" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i>
                Logout
            </a>
        </div>
    </nav>

    <!-- Email Finder Modals -->
    <!-- 1. UPGRADE REQUIRED MODAL -->
    <div class="modal-overlay" id="upgradeModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">🚀 Upgrade Required</div>
            </div>
            <div class="modal-body">
                <strong>Email finder is available for Silver, Gold, and Platinum subscribers.</strong><br><br>
                Your current plan: <span id="currentPlanDisplay">Free</span><br><br>
                Upgrade your plan to unlock this feature and find verified email addresses for your LinkedIn contacts.
            </div>
            <div class="modal-actions">
                <button class="modal-btn secondary" onclick="closeUpgradeModal()">Cancel</button>
                <button class="modal-btn primary" onclick="window.open('https://chopa.chargebeeportal.com/portal/v2/login?forward=portal_main', '_blank')">Upgrade Plan</button>
            </div>
        </div>
    </div>

    <!-- 2. INSUFFICIENT CREDITS MODAL -->
    <div class="modal-overlay" id="insufficientCreditsModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">💳 Not Enough Credits</div>
            </div>
            <div class="modal-body">
                <strong>You need at least 2 credits to use the email finder.</strong><br><br>
                You currently have <strong><span id="currentCredits">0</span> credits</strong>.<br><br>
                Purchase more credits to continue finding email addresses.
            </div>
            <div class="modal-actions">
                <button class="modal-btn secondary" onclick="closeInsufficientCreditsModal()">Cancel</button>
                <button class="modal-btn primary" onclick="window.open('https://chopa.chargebeeportal.com/portal/v2/login?forward=portal_main', '_blank')">Buy Credits</button>
            </div>
        </div>
    </div>

    <!-- 3. EMAIL FINDER CONFIRMATION MODAL -->
    <div class="modal-overlay" id="emailFinderModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">🔍 Find & Verify Email</div>
            </div>
            <div class="modal-body">
                We'll search for this contact's email address using Snov.io. <strong>You'll only be charged 2 credits if we successfully find and verify an email.</strong><br><br>
                No charge if email is not found. Continue?
            </div>
            <div class="modal-actions">
                <button class="modal-btn secondary" onclick="closeEmailModal()">Cancel</button>
                <button class="modal-btn primary">Yes, Find Email</button>
            </div>
        </div>
    </div>

    <!-- Main Content Wrapper -->
    <div class="main-wrapper">
        <main class="main-content">
            <div class="container">
        <div class="page-header">
            <div class="page-header-left">
                <h1 class="page-title">Target Profiles</h1>
                <p class="page-subtitle">View and manage all your saved LinkedIn profiles with complete outreach history</p>
            </div>
            <div class="page-header-credits" id="headerCredits">
                <i class="fas fa-coins"></i>
                <span id="headerCreditsNumber">0</span>
                <span style="font-size: 0.9rem; font-weight: 500;">Credits</span>
            </div>
        </div>

        <!-- Statistics Section -->
        <div class="stats-section" id="statsSection">
            <div class="funnel-container">
                <!-- Horizontal Funnel Visual -->
                <div class="funnel-visual">
                    <!-- Section 1: Total Profiles -->
                    <div class="funnel-section funnel-section-1">
                        <div class="funnel-number" id="statTotal">0</div>
                        <div class="funnel-label">TOTAL<br>PROFILES</div>
                        <div class="funnel-percentage">100%</div>
                    </div>

                    <!-- Section 2: Contacted -->
                    <div class="funnel-section funnel-section-2">
                        <div class="funnel-number" id="statContacted">0</div>
                        <div class="funnel-label">CONTACTED</div>
                        <div class="funnel-percentage" id="contactedPercent">0%</div>
                    </div>

                    <!-- Section 3: Got Reply -->
                    <div class="funnel-section funnel-section-3">
                        <div class="funnel-number" id="statReplied">0</div>
                        <div class="funnel-label">GOT REPLY</div>
                        <div class="funnel-percentage" id="replyPercent">0%</div>
                    </div>
                </div>

                <!-- Small Response Rate Text -->
                <div class="response-rate-text">
                    <strong>Response Rate:</strong> <span>Got Reply ÷ Contacted × 100</span>
                </div>
            </div>
        </div>

        <div class="messages-controls">
            <div class="search-box">
                <i class="fas fa-search search-icon"></i>
                <input type="text" class="search-input" placeholder="Search profiles, names, companies..." 
                       id="searchInput" oninput="searchMessages(this.value)">
            </div>
            <button class="refresh-btn" onclick="refreshMessages()" title="Refresh Profiles">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>

        <div class="messages-cards-container">
            <!-- Loading State -->
            <div class="loading" id="loadingState">
                <div class="spinner"></div>
                <p>Loading target profiles...</p>
            </div>

            <!-- Pagination Info -->
            <div class="pagination-info" id="paginationInfo" style="display: none;">
                <div class="showing-info" id="showingInfo">Showing profiles</div>
                <button class="load-more-btn" id="loadMoreBtn" onclick="toggleShowAll()">
                    <i class="fas fa-eye"></i>
                    Show All Profiles
                </button>
            </div>

            <!-- Cards Grid -->
            <div class="messages-cards-grid" id="messagesCardsGrid" style="display: none;">
                <!-- Profile cards will be populated here -->
            </div>

            <!-- Empty State -->
            <div class="empty-state" id="emptyState" style="display: none;">
                <i class="fas fa-users"></i>
                <h3>No Profiles Found</h3>
                <p>Generate your first LinkedIn message using the Chrome extension, then return here to view your target profiles.</p>
            </div>

            <!-- Bottom Show All Button -->
            <div class="bottom-pagination" id="bottomPagination" style="display: none;">
                <button class="load-more-btn" id="bottomLoadMoreBtn" onclick="toggleShowAll()">
                    <i class="fas fa-eye"></i>
                    Show All Profiles
                </button>
            </div>
        </div>
            </div>
        </main>
    </div>

    <script>
        // Global variables
        let messagesData = [];
        let groupedMessages = {};
        let filteredMessages = [];
        let pendingChanges = new Map();
        let currentUserPlan = { planCode: 'free', totalCredits: 0, planName: 'Free' };
        let currentSearchTerm = '';
        let showingLimited = true;
        const INITIAL_DISPLAY_LIMIT = 21;

        // Auth token management
        function getAuthToken() {
            return localStorage.getItem('authToken');
        }

        function updateCreditDisplay(credits) {
            const creditValue = parseFloat(credits || 0).toFixed(2);
            document.getElementById('sidebarCreditsNumber').textContent = creditValue;
            document.getElementById('headerCreditsNumber').textContent = creditValue;
            
            const creditDisplays = document.querySelectorAll('.sidebar-user-credits, .page-header-credits');
            creditDisplays.forEach(display => {
                display.classList.add('updating');
                setTimeout(() => display.classList.remove('updating'), 600);
            });
        }

        // Load user profile
        async function loadUserProfile() {
            try {
                const token = getAuthToken();
                if (!token) {
                    window.location.href = '/login?returnUrl=/target-profiles';
                    return;
                }
                
                const response = await fetch('/profile/me', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.status === 401) {
                    localStorage.removeItem('authToken');
                    window.location.href = '/login?returnUrl=/target-profiles';
                    return;
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    const user = data.data.user;
                    
                    const renewableCredits = parseFloat(user.renewableCredits || 0);
                    const payasyougoCredits = parseFloat(user.payasyougoCredits || 0);
                    const totalCredits = renewableCredits + payasyougoCredits;
                    
                    currentUserPlan = {
                        planCode: user.planCode || user.plan_code || 'free',
                        totalCredits: totalCredits,
                        planName: user.planName || user.plan_name || 'Free'
                    };
                    
                    updateCreditDisplay(currentUserPlan.totalCredits);
                    
                    document.getElementById('sidebarUserName').textContent = user.displayName || user.email;
                    document.getElementById('sidebarUserEmail').textContent = user.email;
                    
                    const planCode = user.planCode || 'free';
                    const planNames = {
                        'free': 'Free Plan',
                        'silver-monthly': 'Silver Monthly',
                        'silver-payasyougo': 'Silver Pay-as-you-go',
                        'gold-monthly': 'Gold Monthly', 
                        'gold-payasyougo': 'Gold Pay-as-you-go',
                        'platinum-monthly': 'Platinum Monthly',
                        'platinum-payasyougo': 'Platinum Pay-as-you-go'
                    };
                    document.getElementById('sidebarUserPlan').textContent = planNames[planCode] || 'Unknown Plan';
                    
                    const displayName = user.displayName || user.email;
                    const initials = getInitials(displayName);
                    document.getElementById('sidebarUserAvatar').textContent = initials;
                } else {
                    throw new Error(data.error || 'Failed to load profile');
                }
                
            } catch (error) {
                console.error('[PROFILE] Error loading user profile:', error);
                document.getElementById('sidebarUserName').textContent = 'User';
                document.getElementById('sidebarUserEmail').textContent = 'user@example.com';
                document.getElementById('sidebarUserPlan').textContent = 'Free Plan';
                document.getElementById('sidebarUserAvatar').textContent = 'U';
                updateCreditDisplay(0);
            }
        }

        function getInitials(name) {
            if (!name) return '??';
            
            const parts = name.split(' ');
            if (parts.length >= 2) {
                return (parts[0][0] + parts[1][0]).toUpperCase();
            } else {
                return name.substring(0, 2).toUpperCase();
            }
        }

        // Load messages data from API
        async function loadMessagesData() {
            try {
                document.getElementById('loadingState').style.display = 'flex';
                
                const token = getAuthToken();
                if (!token) {
                    window.location.href = '/login?returnUrl=/target-profiles';
                    return;
                }
                
                const response = await fetch('/messages/history', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.status === 401) {
                    localStorage.removeItem('authToken');
                    window.location.href = '/login?returnUrl=/target-profiles';
                    return;
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    messagesData = data.data || [];
                    groupMessagesByTarget();
                } else {
                    throw new Error(data.error || 'Failed to load profiles');
                }
                
                applyFilters();
                
            } catch (error) {
                console.error('[PROFILES] Error loading profiles:', error);
                
                if (error.message && error.message.includes('401')) {
                    localStorage.removeItem('authToken');
                    window.location.href = '/login';
                    return;
                }
                
                showEmptyState();
            }
        }

        // Group messages by target profile
        function groupMessagesByTarget() {
            groupedMessages = {};
            
            messagesData.forEach(message => {
                const targetKey = message.targetProfile.firstName + '_' + message.targetProfile.company;
                
                if (!groupedMessages[targetKey]) {
                    const messageDate = new Date(message.created_at || message.createdAt || Date.now());
                    
                    groupedMessages[targetKey] = {
                        target: message.targetProfile,
                        messages: {
                            linkedin: [],
                            connection: [],
                            email: []
                        },
                        id: message.id,
                        sent: message.sent,
                        gotReply: message.gotReply,
                        comments: message.comments,
                        emailFound: message.emailFound,
                        emailStatus: message.emailStatus,
                        emailVerifiedAt: message.emailVerifiedAt,
                        latestMessageDate: messageDate
                    };
                } else {
                    const messageDate = new Date(message.created_at || message.createdAt || Date.now());
                    if (messageDate > groupedMessages[targetKey].latestMessageDate) {
                        groupedMessages[targetKey].latestMessageDate = messageDate;
                    }
                }
                
                const messageType = getMessageTypeFromDatabase(message.message_type || message.messageType);
                
                if (messageType === 'connection') {
                    groupedMessages[targetKey].messages.connection.push(message);
                } else if (messageType === 'email') {
                    groupedMessages[targetKey].messages.email.push(message);
                } else {
                    groupedMessages[targetKey].messages.linkedin.push(message);
                }
            });
            
            Object.values(groupedMessages).forEach(group => {
                group.messages.linkedin.sort((a, b) => new Date(b.created_at || b.createdAt || 0) - new Date(a.created_at || a.createdAt || 0));
                group.messages.connection.sort((a, b) => new Date(b.created_at || b.createdAt || 0) - new Date(a.created_at || a.createdAt || 0));
                group.messages.email.sort((a, b) => new Date(b.created_at || b.createdAt || 0) - new Date(a.created_at || a.createdAt || 0));
            });
        }

        function getMessageTypeFromDatabase(dbMessageType) {
            if (!dbMessageType) {
                return 'linkedin';
            }
            
            const dbType = dbMessageType.toLowerCase();
            
            if (dbType.includes('connection') || dbType === 'connection_request') {
                return 'connection';
            } else if (dbType.includes('email') || dbType === 'cold_email') {
                return 'email';
            } else {
                return 'linkedin';
            }
        }

        function applyFilters() {
            let filtered = Object.values(groupedMessages);
            
            if (currentSearchTerm) {
                filtered = filtered.filter(group => {
                    const target = group.target;
                    const messages = group.messages;
                    
                    const targetMatch = (
                        (target.firstName && target.firstName.toLowerCase().includes(currentSearchTerm.toLowerCase())) ||
                        (target.role && target.role.toLowerCase().includes(currentSearchTerm.toLowerCase())) ||
                        (target.company && target.company.toLowerCase().includes(currentSearchTerm.toLowerCase())) ||
                        (group.comments && group.comments.toLowerCase().includes(currentSearchTerm.toLowerCase()))
                    );
                    
                    const messageMatch = ['linkedin', 'connection', 'email'].some(type => {
                        const messageArray = messages[type];
                        if (Array.isArray(messageArray)) {
                            return messageArray.some(msg => 
                                msg.message && msg.message.toLowerCase().includes(currentSearchTerm.toLowerCase())
                            );
                        }
                        return false;
                    });
                    
                    return targetMatch || messageMatch;
                });
            }
            
            filtered.sort((a, b) => b.latestMessageDate - a.latestMessageDate);
            
            filteredMessages = filtered;
            renderMessages();
            updateStats();
        }

        function searchMessages(searchTerm) {
            currentSearchTerm = searchTerm.trim();
            applyFilters();
        }

        function toggleShowAll() {
            showingLimited = !showingLimited;
            renderMessages();
        }

        function updateStats() {
            const totalProfiles = filteredMessages.length;
            const contacted = filteredMessages.filter(g => g.sent === 'yes').length;
            const replied = filteredMessages.filter(g => g.gotReply === 'yes').length;
            
            document.getElementById('statTotal').textContent = totalProfiles;
            document.getElementById('statContacted').textContent = contacted;
            document.getElementById('statReplied').textContent = replied;
            
            const contactedPercent = totalProfiles > 0 ? Math.round((contacted / totalProfiles) * 100) : 0;
            const replyPercent = contacted > 0 ? Math.round((replied / contacted) * 100) : 0;
            
            document.getElementById('contactedPercent').textContent = contactedPercent + '%';
            document.getElementById('replyPercent').textContent = replyPercent + '%';
        }

        function renderMessages() {
            const grid = document.getElementById('messagesCardsGrid');
            
            if (!filteredMessages || filteredMessages.length === 0) {
                showEmptyState();
                return;
            }
            
            grid.innerHTML = '';
            
            const messagesToShow = showingLimited ? 
                filteredMessages.slice(0, INITIAL_DISPLAY_LIMIT) : 
                filteredMessages;
            
            messagesToShow.forEach(messageGroup => {
                const card = createMessageCard(messageGroup);
                grid.appendChild(card);
            });
            
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('messagesCardsGrid').style.display = 'grid';
            document.getElementById('emptyState').style.display = 'none';
            
            const showingInfo = document.getElementById('showingInfo');
            const loadMoreBtn = document.getElementById('loadMoreBtn');
            const bottomLoadMoreBtn = document.getElementById('bottomLoadMoreBtn');
            const paginationInfo = document.getElementById('paginationInfo');
            const bottomPagination = document.getElementById('bottomPagination');
            
            if (filteredMessages.length > INITIAL_DISPLAY_LIMIT) {
                showingInfo.textContent = showingLimited ? 
                    `Showing ${INITIAL_DISPLAY_LIMIT} of ${filteredMessages.length} profiles` : 
                    `Showing all ${filteredMessages.length} profiles`;
                
                loadMoreBtn.innerHTML = showingLimited ? 
                    '<i class="fas fa-eye"></i> Show All Profiles' : 
                    '<i class="fas fa-eye-slash"></i> Show Less';
                
                bottomLoadMoreBtn.innerHTML = showingLimited ? 
                    '<i class="fas fa-eye"></i> Show All Profiles' : 
                    '<i class="fas fa-eye-slash"></i> Show Less';
                
                paginationInfo.style.display = 'flex';
                bottomPagination.style.display = showingLimited ? 'flex' : 'none';
            } else {
                paginationInfo.style.display = 'none';
                bottomPagination.style.display = 'none';
            }
        }

        function createMessageCard(messageGroup) {
            const card = document.createElement('div');
            card.className = 'message-card';
            card.setAttribute('data-target-id', messageGroup.id);
            
            const target = messageGroup.target;
            const messages = messageGroup.messages;
            
            card.innerHTML = `
                <div class="card-profile-header">
                    <div class="profile-info">
                        <div class="profile-name">${target.firstName || 'Unknown'}</div>
                        <div class="profile-role">${target.role || 'Professional'}</div>
                        <div class="profile-company">${target.company || 'Company'}</div>
                    </div>
                    <div class="email-finder-header-section">
                        ${createEmailAskButton(messageGroup)}
                        <div class="email-finder-description">Email Finder (powered by Snov.io)</div>
                        ${createEmailVerificationDisplay(messageGroup)}
                    </div>
                </div>

                <div class="message-types-section">
                    ${messages.linkedin.length > 0 ? createMessageTypeBlock('linkedin', 'LinkedIn Message', messages.linkedin, 'fab fa-linkedin') : ''}
                    ${messages.connection.length > 0 ? createMessageTypeBlock('connection', 'Connection Request', messages.connection, 'fas fa-user-plus') : ''}
                    ${messages.email.length > 0 ? createMessageTypeBlock('email', 'Cold Email', messages.email, 'fas fa-envelope') : ''}
                </div>

                <div class="card-status-section">
                    <div class="status-row">
                        <div class="status-item">
                            <div class="status-label">Message Sent</div>
                            <div class="toggle-switch ${messageGroup.sent}" onclick="toggleStatus(${messageGroup.id}, 'sent')">
                                <div class="toggle-slider">${getStatusIcon(messageGroup.sent)}</div>
                            </div>
                            <div class="toggle-label ${messageGroup.sent}">${getStatusLabel(messageGroup.sent)}</div>
                        </div>
                        
                        <div class="status-item">
                            <div class="status-label">Got Reply</div>
                            <div class="toggle-switch ${messageGroup.gotReply}" onclick="toggleStatus(${messageGroup.id}, 'gotReply')">
                                <div class="toggle-slider">${getStatusIcon(messageGroup.gotReply)}</div>
                            </div>
                            <div class="toggle-label ${messageGroup.gotReply}">${getStatusLabel(messageGroup.gotReply)}</div>
                        </div>
                    </div>
                    
                    <textarea 
                        class="comment-field" 
                        placeholder="Add notes about this contact..."
                        onchange="updateComment(${messageGroup.id}, this.value)"
                        onkeyup="markFieldModified(${messageGroup.id})"
                    >${messageGroup.comments || ''}</textarea>
                    
                    <button class="save-btn" id="save-${messageGroup.id}" onclick="saveMessage(${messageGroup.id})">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                </div>
            `;
            
            return card;
        }

        function createEmailAskButton(messageGroup) {
            if (messageGroup.emailStatus === 'valid' || messageGroup.emailStatus === 'verified') {
                return `<button class="email-ask-btn search-again" onclick="askEmailClick(${messageGroup.id})" title="Search again (2 credits)">
                    <i class="fas fa-redo"></i> Search Again
                </button>`;
            }
            
            if (messageGroup.emailStatus === 'not_found' || messageGroup.emailStatus === 'error') {
                return `<button class="email-ask-btn search-again" onclick="askEmailClick(${messageGroup.id})" title="Try again (2 credits)">
                    <i class="fas fa-redo"></i> Try Again
                </button>`;
            }
            
            if (messageGroup.emailStatus === 'invalid' || messageGroup.emailStatus === 'not_valid' || 
                messageGroup.emailStatus === 'catch_all' || messageGroup.emailStatus === 'unknown') {
                return `<button class="email-ask-btn search-again" onclick="askEmailClick(${messageGroup.id})" title="Search again (2 credits)">
                    <i class="fas fa-redo"></i> Search Again
                </button>`;
            }
            
            return `<button class="email-ask-btn" onclick="askEmailClick(${messageGroup.id})" title="Find email (2 credits)">
                <i class="fas fa-search"></i> Find Email
            </button>`;
        }

        function createEmailVerificationDisplay(messageGroup) {
            if (!messageGroup.emailStatus) {
                return `<div class="email-not-available">Click "Find Email" to search</div>`;
            }
            
            const verifiedDate = messageGroup.emailVerifiedAt ? 
                new Date(messageGroup.emailVerifiedAt).toLocaleDateString('en-US', { 
                    year: 'numeric', month: 'short', day: 'numeric' 
                }) : '';
            
            const emailAddress = messageGroup.emailFound || 'N/A';
            
            switch(messageGroup.emailStatus) {
                case 'valid':
                case 'verified':
                    return `<div class="email-found-container">
                        <div class="email-header-row">
                            <div class="email-label">
                                <i class="fas fa-check-circle"></i> Email Found & Verified
                            </div>
                        </div>
                        <div class="email-address-display">${emailAddress}</div>
                        <div class="email-actions-row">
                            <button class="copy-email-btn" onclick="copyEmailAddress('${emailAddress}', this)">
                                <i class="fas fa-copy"></i> Copy Email
                            </button>
                            <div class="email-status valid">
                                <i class="fas fa-shield-alt"></i> Verified
                            </div>
                        </div>
                        ${verifiedDate ? `<div class="email-verified-date" style="margin-top: 0.5rem; text-align: center;">Found: ${verifiedDate}</div>` : ''}
                    </div>`;
                
                case 'unknown':
                    return `<div class="email-unknown-container">
                        <div class="email-header-row">
                            <div class="email-label warning">
                                <i class="fas fa-question-circle"></i> Email Found - Status Unknown
                            </div>
                        </div>
                        <div class="email-address-display warning">${emailAddress}</div>
                        <div class="email-actions-row">
                            <button class="copy-email-btn warning" onclick="copyEmailAddress('${emailAddress}', this)">
                                <i class="fas fa-copy"></i> Copy Email
                            </button>
                            <div class="email-status unknown">
                                <i class="fas fa-exclamation-triangle"></i> Unknown
                            </div>
                        </div>
                        <div style="font-size: 0.75rem; color: var(--gray); margin-top: 0.5rem; text-align: center;">
                            Verification status could not be determined
                        </div>
                        ${verifiedDate ? `<div class="email-verified-date" style="margin-top: 0.3rem; text-align: center;">Searched: ${verifiedDate}</div>` : ''}
                    </div>`;
                
                case 'catch_all':
                    return `<div class="email-unknown-container">
                        <div class="email-header-row">
                            <div class="email-label warning">
                                <i class="fas fa-exclamation-circle"></i> Catch-All Domain Detected
                            </div>
                        </div>
                        <div class="email-address-display warning">${emailAddress}</div>
                        <div class="email-actions-row">
                            <button class="copy-email-btn warning" onclick="copyEmailAddress('${emailAddress}', this)">
                                <i class="fas fa-copy"></i> Copy Email
                            </button>
                            <div class="email-status catch_all">
                                <i class="fas fa-info-circle"></i> Catch-All
                            </div>
                        </div>
                        <div style="font-size: 0.75rem; color: var(--gray); margin-top: 0.5rem; text-align: center;">
                            Domain accepts all emails - verification uncertain
                        </div>
                        ${verifiedDate ? `<div class="email-verified-date" style="margin-top: 0.3rem; text-align: center;">Searched: ${verifiedDate}</div>` : ''}
                    </div>`;
                    
                case 'invalid':
                case 'not_valid':
                    return `<div class="email-not-found-container">
                        <div class="email-header-row">
                            <div class="email-label error">
                                <i class="fas fa-times-circle"></i> Invalid Email Found
                            </div>
                        </div>
                        <div class="email-verification">
                            <div class="email-address">${emailAddress}</div>
                            <div class="email-status invalid">
                                <i class="fas fa-ban"></i> Email Invalid
                            </div>
                            <div style="font-size: 0.75rem; color: var(--gray); margin-top: 0.3rem;">
                                This email address appears to be invalid
                            </div>
                            ${verifiedDate ? `<div class="email-verified-date">Searched: ${verifiedDate}</div>` : ''}
                        </div>
                    </div>`;
                    
                case 'found':
                    return `<div class="email-unknown-container">
                        <div class="email-header-row">
                            <div class="email-label warning">
                                <i class="fas fa-hourglass-half"></i> Verifying Email...
                            </div>
                        </div>
                        <div class="email-address-display warning">${emailAddress}</div>
                        <div class="email-status found">
                            <i class="fas fa-spinner fa-pulse"></i> Verification in progress
                        </div>
                        ${verifiedDate ? `<div class="email-verified-date" style="margin-top: 0.5rem; text-align: center;">Found: ${verifiedDate}</div>` : ''}
                    </div>`;
                    
                case 'not_found':
                    return `<div class="email-not-found-container">
                        <div class="email-header-row">
                            <div class="email-label error">
                                <i class="fas fa-times-circle"></i> Email Not Found
                            </div>
                        </div>
                        <div class="email-verification">
                            <div style="font-size: 0.85rem; color: var(--gray); margin-top: 0.3rem; text-align: center;">
                                No public email found for this contact
                            </div>
                            ${verifiedDate ? `<div class="email-verified-date" style="margin-top: 0.5rem;">Searched: ${verifiedDate}</div>` : ''}
                        </div>
                    </div>`;
                    
                case 'error':
                    return `<div class="email-not-found-container">
                        <div class="email-header-row">
                            <div class="email-label error">
                                <i class="fas fa-exclamation-triangle"></i> Search Error
                            </div>
                        </div>
                        <div class="email-verification">
                            <div style="font-size: 0.85rem; color: var(--gray); margin-top: 0.3rem; text-align: center;">
                                An error occurred during the email search
                            </div>
                            ${verifiedDate ? `<div class="email-verified-date" style="margin-top: 0.5rem;">Attempted: ${verifiedDate}</div>` : ''}
                        </div>
                    </div>`;
                    
                default:
                    return `<div class="email-not-available">Status unknown</div>`;
            }
        }

        async function copyEmailAddress(email, button) {
            try {
                await navigator.clipboard.writeText(email);
                
                const originalHTML = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check"></i> Copied!';
                button.classList.add('copied');
                
                setTimeout(() => {
                    button.innerHTML = originalHTML;
                    button.classList.remove('copied');
                }, 2000);
                
            } catch (error) {
                console.error('[EMAIL] Error copying email:', error);
                alert('Failed to copy email address');
            }
        }

        function getStatusIcon(status) {
            switch(status) {
                case 'yes': return '✓';
                case 'no': return '✗';
                default: return '?';
            }
        }

        function getStatusLabel(status) {
            switch(status) {
                case 'yes': return 'YES';
                case 'no': return 'NO';
                default: return 'PENDING';
            }
        }

        function toggleStatus(messageId, field) {
            const messageGroup = Object.values(groupedMessages).find(group => group.id === messageId);
            if (!messageGroup) return;
            
            const currentStatus = messageGroup[field];
            let newStatus;
            
            if (currentStatus === 'pending' || !currentStatus) {
                newStatus = 'yes';
            } else if (currentStatus === 'yes') {
                newStatus = 'no';
            } else {
                newStatus = 'pending';
            }
            
            messageGroup[field] = newStatus;
            
            const card = document.querySelector(`[data-target-id="${messageId}"]`);
            if (card) {
                const toggles = card.querySelectorAll(`[onclick*="'${field}'"]`);
                toggles.forEach(toggle => {
                    toggle.className = `toggle-switch ${newStatus}`;
                    const slider = toggle.querySelector('.toggle-slider');
                    const label = toggle.parentElement.querySelector('.toggle-label');
                    
                    if (slider) slider.textContent = getStatusIcon(newStatus);
                    if (label) {
                        label.textContent = getStatusLabel(newStatus);
                        label.className = `toggle-label ${newStatus}`;
                    }
                });
            }
            
            markMessageModified(messageId);
        }

        function updateComment(messageId, value) {
            const messageGroup = Object.values(groupedMessages).find(group => group.id === messageId);
            if (messageGroup) {
                messageGroup.comments = value;
                markMessageModified(messageId);
            }
        }

        function markFieldModified(messageId) {
            markMessageModified(messageId);
            
            const commentFields = document.querySelectorAll(`textarea[onchange*="${messageId}"]`);
            commentFields.forEach(field => field.classList.add('modified'));
        }

        function markMessageModified(messageId) {
            if (!pendingChanges.has(messageId)) {
                pendingChanges.set(messageId, true);
            }
            
            const saveButtons = document.querySelectorAll(`#save-${messageId}`);
            saveButtons.forEach(btn => btn.classList.add('modified'));
        }

        async function saveMessage(messageId) {
            const messageGroup = Object.values(groupedMessages).find(group => group.id === messageId);
            if (!messageGroup || !pendingChanges.has(messageId)) return;
            
            const saveButtons = document.querySelectorAll(`#save-${messageId}`);
            
            try {
                saveButtons.forEach(btn => {
                    btn.classList.add('saving');
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                });
                
                const token = getAuthToken();
                if (!token) {
                    window.location.href = '/login';
                    return;
                }
                
                const response = await fetch(`/messages/${messageId}`, {
                    method: 'PUT',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sent_status: messageGroup.sent,
                        reply_status: messageGroup.gotReply,
                        comments: messageGroup.comments
                    })
                });
                
                if (response.status === 401) {
                    localStorage.removeItem('authToken');
                    window.location.href = '/login';
                    return;
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || 'Failed to save message');
                }
                
                saveButtons.forEach(btn => {
                    btn.classList.remove('saving', 'modified');
                    btn.classList.add('saved');
                    btn.innerHTML = '<i class="fas fa-check"></i> Saved!';
                });
                
                pendingChanges.delete(messageId);
                
                setTimeout(() => {
                    saveButtons.forEach(btn => {
                        btn.classList.remove('saved');
                        btn.innerHTML = '<i class="fas fa-save"></i> Save Changes';
                    });
                }, 2000);
                
            } catch (error) {
                console.error('[PROFILES] Error saving profile:', error);
                
                saveButtons.forEach(btn => {
                    btn.classList.remove('saving');
                    btn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Error';
                });
                
                setTimeout(() => {
                    saveButtons.forEach(btn => {
                        btn.classList.add('modified');
                        btn.innerHTML = '<i class="fas fa-save"></i> Save Changes';
                    });
                }, 3000);
            }
        }

        function cleanMessageText(messageText) {
            if (!messageText) return '';
            return messageText.replace(/<[^>]*>/g, '').trim();
        }

        function createMessageTypeBlock(type, label, messagesArray, iconClass) {
            if (!messagesArray || messagesArray.length === 0) {
                return '';
            }

            const latestMessage = messagesArray[0];
            const latestMessageText = cleanMessageText(latestMessage.message || '');
            const latestPreview = latestMessageText.length > 80 ? latestMessageText.substring(0, 80) + '...' : latestMessageText;
            const uniqueId = `${type}-${latestMessage.id}`;
            const hasMultiple = messagesArray.length > 1;
            
            let historyHTML = '';
            
            historyHTML += `
                <div class="message-history-item latest">
                    <div class="message-timestamp">
                        <i class="fas fa-clock"></i>
                        Latest: ${formatMessageDate(latestMessage.created_at || latestMessage.createdAt)}
                    </div>
                    <div class="message-content-preview" id="preview-${uniqueId}">${latestPreview}</div>
                    <div class="message-text" id="message-${uniqueId}" style="display: none;">
                        ${latestMessageText}
                    </div>
                </div>
            `;
            
            if (hasMultiple) {
                historyHTML += `<div class="message-history-previous" id="history-${uniqueId}" style="display: none;">`;
                
                messagesArray.slice(1).forEach((msg, index) => {
                    const msgText = cleanMessageText(msg.message || '');
                    const msgPreview = msgText.length > 60 ? msgText.substring(0, 60) + '...' : msgText;
                    const msgUniqueId = `${type}-${msg.id}`;
                    
                    historyHTML += `
                        <div class="message-history-item collapsed" onclick="toggleHistoryMessage('${msgUniqueId}', this)">
                            <div class="message-timestamp">
                                <i class="fas fa-history"></i>
                                Previous: ${formatMessageDate(msg.created_at || msg.createdAt)}
                            </div>
                            <div class="message-content-preview" id="preview-${msgUniqueId}">${msgPreview}</div>
                            <div class="message-text" id="message-${msgUniqueId}" style="display: none;">
                                ${msgText}
                            </div>
                        </div>
                    `;
                });
                
                historyHTML += `</div>`;
            }
            
            return `
                <div class="message-type-block ${type}">
                    <div class="message-type-header">
                        <div class="message-type-label ${type}">
                            <i class="${iconClass}"></i>
                            ${label}
                        </div>
                        <div class="message-actions">
                            <button class="edit-btn" onclick="editMessage('${type}', ${latestMessage.id})">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="copy-btn" onclick="copyMessage('${type}', ${latestMessage.id}, this)">
                                <i class="fas fa-copy"></i> Copy
                            </button>
                        </div>
                    </div>
                    ${historyHTML}
                    <div style="display: flex; align-items: center; justify-content: center; gap: 1rem; margin-top: 0.8rem;">
                        ${hasMultiple ? `
                        <button class="expand-btn" onclick="toggleMessageHistory('${uniqueId}', this)">
                            <i class="fas fa-history"></i> History
                        </button>` : ''}
                        <button class="expand-btn" onclick="toggleMessageExpand('${uniqueId}', this)">
                            <i class="fas fa-chevron-down"></i> Expand
                        </button>
                        ${hasMultiple ? `<span class="message-version-count">${messagesArray.length} versions</span>` : ''}
                    </div>
                </div>
            `;
        }

        function formatMessageDate(dateString) {
            try {
                let dateToFormat = dateString;
                
                if (!dateToFormat) {
                    return 'Just now';
                }
                
                const date = new Date(dateToFormat);
                
                if (isNaN(date.getTime())) {
                    return 'Date unavailable';
                }
                
                const now = new Date();
                const diffTime = now - date;
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                
                if (diffDays === 0) {
                    return date.toLocaleTimeString('en-US', { 
                        hour: '2-digit', 
                        minute: '2-digit',
                        hour12: true 
                    }) + ' (today)';
                } else if (diffDays === 1) {
                    return date.toLocaleTimeString('en-US', { 
                        hour: '2-digit', 
                        minute: '2-digit',
                        hour12: true 
                    }) + ' (yesterday)';
                } else if (diffDays < 7) {
                    return date.toLocaleDateString('en-US', { 
                        weekday: 'short',
                        hour: '2-digit', 
                        minute: '2-digit',
                        hour12: true 
                    });
                } else {
                    return date.toLocaleDateString('en-US', {
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: true
                    });
                }
            } catch (error) {
                return 'Date error';
            }
        }

        function toggleMessageHistory(messageId, button) {
            const historyElement = document.getElementById(`history-${messageId}`);
            const isVisible = historyElement.style.display !== 'none';
            
            if (isVisible) {
                historyElement.style.display = 'none';
                button.innerHTML = '<i class="fas fa-history"></i> History';
            } else {
                historyElement.style.display = 'block';
                button.innerHTML = '<i class="fas fa-history"></i> Hide History';
            }
        }

        function toggleHistoryMessage(messageId, element) {
            const messageElement = document.getElementById(`message-${messageId}`);
            const previewElement = document.getElementById(`preview-${messageId}`);
            const isExpanded = messageElement.style.display !== 'none';
            
            if (isExpanded) {
                messageElement.style.display = 'none';
                previewElement.style.display = 'block';
                element.classList.add('collapsed');
            } else {
                messageElement.style.display = 'block';
                previewElement.style.display = 'none';
                element.classList.remove('collapsed');
            }
        }

        function toggleMessageExpand(messageId, button) {
            const messageElement = document.getElementById(`message-${messageId}`);
            const previewElement = document.getElementById(`preview-${messageId}`);
            
            if (!messageElement || !previewElement) {
                return;
            }
            
            const isExpanded = messageElement.style.display === 'block';
            
            if (isExpanded) {
                messageElement.style.display = 'none';
                previewElement.style.display = 'block';
                button.innerHTML = '<i class="fas fa-chevron-down"></i> Expand';
            } else {
                messageElement.style.display = 'block';
                previewElement.style.display = 'none';
                button.innerHTML = '<i class="fas fa-chevron-up"></i> Collapse';
            }
        }

        function editMessage(type, messageId) {
            alert(`Edit functionality for ${type} message (ID: ${messageId}) will be implemented in a future update.`);
        }

        async function copyMessage(type, messageId, button) {
            try {
                let targetMessage = null;
                Object.values(groupedMessages).forEach(group => {
                    ['linkedin', 'connection', 'email'].forEach(messageType => {
                        const messages = group.messages[messageType];
                        if (Array.isArray(messages)) {
                            const found = messages.find(m => m.id === messageId);
                            if (found) targetMessage = found;
                        }
                    });
                });
                
                if (!targetMessage || !targetMessage.message) {
                    alert('Message not found or empty');
                    return;
                }
                
                const cleanText = cleanMessageText(targetMessage.message);
                await navigator.clipboard.writeText(cleanText);
                
                const originalHTML = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check"></i> Copied';
                button.classList.add('copied');
                
                setTimeout(() => {
                    button.innerHTML = originalHTML;
                    button.classList.remove('copied');
                }, 2000);
                
            } catch (error) {
                console.error('[COPY] Error copying message:', error);
                alert('Failed to copy message');
            }
        }

        // Email finder functionality
        async function askEmailClick(messageId) {
            console.log('[EMAIL_FINDER] Starting email search for message ID:', messageId);
            
            const messageGroup = Object.values(groupedMessages).find(group => group.id === messageId);
            if (!messageGroup) {
                console.error('[EMAIL_FINDER] Message group not found');
                return;
            }
            
            const planCode = currentUserPlan.planCode || 'free';
            if (planCode === 'free') {
                document.getElementById('currentPlanDisplay').textContent = currentUserPlan.planName || 'Free';
                showUpgradeModal();
                return;
            }
            
            if (currentUserPlan.totalCredits < 2) {
                document.getElementById('currentCredits').textContent = currentUserPlan.totalCredits.toFixed(2);
                showInsufficientCreditsModal();
                return;
            }
            
            showEmailModal(messageId);
        }

        function showUpgradeModal() {
            document.getElementById('upgradeModal').classList.add('active');
        }

        function closeUpgradeModal() {
            document.getElementById('upgradeModal').classList.remove('active');
        }

        function showInsufficientCreditsModal() {
            document.getElementById('insufficientCreditsModal').classList.add('active');
        }

        function closeInsufficientCreditsModal() {
            document.getElementById('insufficientCreditsModal').classList.remove('active');
        }

        function showEmailModal(messageId) {
            const modal = document.getElementById('emailFinderModal');
            modal.classList.add('active');
            
            const confirmButton = modal.querySelector('.modal-btn.primary');
            const newConfirmButton = confirmButton.cloneNode(true);
            confirmButton.parentNode.replaceChild(newConfirmButton, confirmButton);
            
            newConfirmButton.onclick = () => {
                closeEmailModal();
                findEmail(messageId);
            };
        }

        function closeEmailModal() {
            document.getElementById('emailFinderModal').classList.remove('active');
        }

        async function findEmail(messageId) {
            console.log('[EMAIL_FINDER] Finding email for message ID:', messageId);
            
            const messageGroup = Object.values(groupedMessages).find(group => group.id === messageId);
            if (!messageGroup) {
                console.error('[EMAIL_FINDER] Message group not found');
                return;
            }
            
            const emailButtons = document.querySelectorAll(`button[onclick*="askEmailClick(${messageId})"]`);
            emailButtons.forEach(btn => {
                btn.classList.add('loading');
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Searching...';
                btn.disabled = true;
            });
            
            try {
                const token = getAuthToken();
                if (!token) {
                    window.location.href = '/login';
                    return;
                }
                
                const response = await fetch('/email-finder/find', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        messageId: messageId,
                        firstName: messageGroup.target.firstName,
                        lastName: messageGroup.target.lastName,
                        company: messageGroup.target.company
                    })
                });
                
                if (response.status === 401) {
                    localStorage.removeItem('authToken');
                    window.location.href = '/login';
                    return;
                }
                
                const result = await response.json();
                console.log('[EMAIL_FINDER] Response:', result);
                
                if (result.success) {
                    messageGroup.emailFound = result.data.email;
                    messageGroup.emailStatus = result.data.status;
                    messageGroup.emailVerifiedAt = result.data.verifiedAt || new Date().toISOString();
                    
                    if (result.data.creditsRemaining !== undefined) {
                        currentUserPlan.totalCredits = result.data.creditsRemaining;
                        updateCreditDisplay(currentUserPlan.totalCredits);
                    }
                    
                    const card = document.querySelector(`[data-target-id="${messageId}"]`);
                    if (card) {
                        const emailSection = card.querySelector('.email-finder-header-section');
                        if (emailSection) {
                            emailSection.innerHTML = `
                                ${createEmailAskButton(messageGroup)}
                                <div class="email-finder-description">Email Finder (powered by Snov.io)</div>
                                ${createEmailVerificationDisplay(messageGroup)}
                            `;
                        }
                    }
                } else {
                    throw new Error(result.error || 'Failed to find email');
                }
                
            } catch (error) {
                console.error('[EMAIL_FINDER] Error:', error);
                alert(`Error finding email: ${error.message}`);
                
                emailButtons.forEach(btn => {
                    btn.classList.remove('loading');
                    btn.innerHTML = '<i class="fas fa-search"></i> Find Email';
                    btn.disabled = false;
                });
            }
        }

        function refreshMessages() {
            const refreshBtn = document.querySelector('.refresh-btn i');
            refreshBtn.classList.add('fa-spin');
            
            loadUserProfile();
            
            loadMessagesData().finally(() => {
                refreshBtn.classList.remove('fa-spin');
            });
        }

        function showEmptyState() {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('emptyState').style.display = 'block';
            document.getElementById('messagesCardsGrid').style.display = 'none';
            document.getElementById('paginationInfo').style.display = 'none';
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('active');
        }

        function logout() {
            localStorage.removeItem('authToken');
            window.location.href = '/login';
        }

        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal-overlay')) {
                closeEmailModal();
                closeInsufficientCreditsModal();
                closeUpgradeModal();
            }
        });

        document.addEventListener('click', function(event) {
            const sidebar = document.getElementById('sidebar');
            const toggle = document.querySelector('.sidebar-toggle');
            
            if (window.innerWidth <= 768 && 
                !sidebar.contains(event.target) && 
                !toggle.contains(event.target) && 
                sidebar.classList.contains('active')) {
                sidebar.classList.remove('active');
            }
        });

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadUserProfile();
            loadMessagesData();
        });
    </script>
</body>
</html>
