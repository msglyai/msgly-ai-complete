// Fixed Sign-up JavaScript - Async LinkedIn Processing
// Replace the <script> section in your sign-up.html with this code

let selectedPackage = 'free';
let userToken = localStorage.getItem('userToken');

// Pricing data
const pricing = {
    payAsYouGo: {
        silver: { price: '$12', period: '/one-time', credits: '75 Credits' },
        gold: { price: '$35', period: '/one-time', credits: '250 Credits' },
        platinum: { price: '$70', period: '/one-time', credits: '1,000 Credits' }
    },
    monthly: {
        silver: { price: '$8.60', period: '/month', credits: '75 Credits' },
        gold: { price: '$25.20', period: '/month', credits: '250 Credits' },
        platinum: { price: '$50.40', period: '/month', credits: '1,000 Credits' }
    }
};

// Check if user is already authenticated and registered
window.addEventListener('load', async () => {
    if (userToken) {
        try {
            const isRegistered = await checkRegistrationStatus();
            if (isRegistered) {
                window.location.href = 'https://api.msgly.ai/dashboard';
                return;
            }
            // User is authenticated but not registered - show step 2
            showStep2();
        } catch (error) {
            console.error('Error checking registration status:', error);
            localStorage.removeItem('userToken');
            userToken = null;
        }
    }

    // Check for OAuth callback
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');
    if (token) {
        userToken = token;
        localStorage.setItem('userToken', token);
        showStep2();
        window.history.replaceState({}, document.title, window.location.pathname);
    }
});

async function checkRegistrationStatus() {
    const response = await fetch('https://api.msgly.ai/api/user/registration-status', {
        headers: {
            'Authorization': `Bearer ${userToken}`
        }
    });
    
    if (response.ok) {
        const result = await response.json();
        return result.completed;
    }
    return false;
}

function showStep2() {
    document.getElementById('step1').classList.remove('active');
    document.getElementById('step1').classList.add('completed');
    document.getElementById('step2').classList.add('active');
    
    document.getElementById('step1Content').style.display = 'none';
    document.getElementById('step2Content').style.display = 'block';
}

// Toggle pricing
function togglePricing(type) {
    document.querySelectorAll('.toggle-option').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');

    const data = pricing[type];
    
    document.getElementById('silverPrice').innerHTML = `${data.silver.price}<span id="silverPeriod">${data.silver.period}</span>`;
    document.getElementById('silverCredits').textContent = data.silver.credits;
    
    document.getElementById('goldPrice').innerHTML = `${data.gold.price}<span id="goldPeriod">${data.gold.period}</span>`;
    document.getElementById('goldCredits').textContent = data.gold.credits;
    
    document.getElementById('platinumPrice').innerHTML = `${data.platinum.price}<span id="platinumPeriod">${data.platinum.period}</span>`;
    document.getElementById('platinumCredits').textContent = data.platinum.credits;
}

// Handle Google Sign In
function handleGoogleSignIn(e) {
    e.preventDefault();
    sessionStorage.setItem('selectedPackage', selectedPackage);
    window.location.href = `https://api.msgly.ai/auth/google?package=${selectedPackage}`;
}

// Handle package selection
function selectPackage(packageType) {
    if (packageType !== 'free') {
        alert('Premium packages coming soon! Start with our free plan.');
        return;
    }
    
    selectedPackage = packageType;
    
    document.querySelectorAll('.package-card').forEach(card => {
        card.classList.remove('selected');
    });
    event.currentTarget.classList.add('selected');
}

// Validate form
function validateForm() {
    const termsAgreed = document.getElementById('termsAgreement').checked;
    const linkedinUrl = document.getElementById('linkedinUrl').value.trim();
    const continueBtn = document.getElementById('continueBtn');
    
    if (termsAgreed && linkedinUrl && linkedinUrl.includes('linkedin.com/in/')) {
        continueBtn.disabled = false;
    } else {
        continueBtn.disabled = true;
    }
}

// Add event listener for LinkedIn URL input
document.addEventListener('DOMContentLoaded', function() {
    const linkedinInput = document.getElementById('linkedinUrl');
    if (linkedinInput) {
        linkedinInput.addEventListener('input', validateForm);
    }
});

// OPTIMIZED: Faster progress animation (no waiting for LinkedIn)
function animateExtractionProgress() {
    const progressBar = document.getElementById('progressBar');
    const steps = ['step-saving', 'step-analyzing', 'step-extracting', 'step-completing'];
    const messages = [
        'Saving your LinkedIn URL...',
        'Starting background analysis...',
        'Setting up your account...',
        'Account setup complete!'
    ];
    
    let currentStep = 0;
    
    const interval = setInterval(() => {
        if (currentStep > 0) {
            const prevStep = document.getElementById(steps[currentStep - 1]);
            prevStep.classList.remove('active');
            prevStep.classList.add('completed');
            prevStep.querySelector('.extraction-step-icon').textContent = 'âœ“';
        }
        
        if (currentStep < steps.length) {
            const currentStepEl = document.getElementById(steps[currentStep]);
            currentStepEl.classList.add('active');
            
            document.getElementById('loadingMessage').textContent = messages[currentStep];
            progressBar.style.width = `${((currentStep + 1) / steps.length) * 100}%`;
            
            currentStep++;
        } else {
            clearInterval(interval);
        }
    }, 800); // FASTER: 0.8 seconds per step (was 1.5 seconds)
}

// OPTIMIZED: Complete registration with async LinkedIn processing
async function completeRegistration() {
    const termsAgreed = document.getElementById('termsAgreement').checked;
    const linkedinUrl = document.getElementById('linkedinUrl').value.trim();
    
    // Validation
    if (!termsAgreed) {
        alert('Please agree to our Terms of Service and Privacy Policy to continue.');
        return;
    }
    
    if (!linkedinUrl) {
        alert('Please enter your LinkedIn profile URL to continue.');
        return;
    }
    
    if (!linkedinUrl.includes('linkedin.com/in/')) {
        alert('Please enter a valid LinkedIn profile URL (e.g., https://www.linkedin.com/in/your-profile)');
        return;
    }

    if (!userToken) {
        alert('Authentication required. Please sign in with Google first.');
        return;
    }
    
    // Show loading state
    document.getElementById('registrationForm').style.display = 'none';
    document.getElementById('loadingState').style.display = 'block';
    
    // Update steps
    document.getElementById('step2').classList.remove('active');
    document.getElementById('step2').classList.add('completed');
    
    // Start progress animation
    animateExtractionProgress();
    
    try {
        // Step 1: Update user profile with registration completion
        const profileResponse = await fetch('https://api.msgly.ai/update-profile', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${userToken}`
            },
            body: JSON.stringify({
                linkedinUrl: linkedinUrl,
                packageType: selectedPackage,
                registrationCompleted: true
            })
        });
        
        const profileResult = await profileResponse.json();
        
        if (!profileResult.success) {
            throw new Error(profileResult.error || 'Failed to update profile');
        }
        
        // Step 2: Start LinkedIn extraction (async - don't wait for completion)
        try {
            const extractionResponse = await fetch('https://api.msgly.ai/api/linkedin-profile', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${userToken}`
                },
                body: JSON.stringify({
                    profileUrl: linkedinUrl
                })
            });

            const extractionResult = await extractionResponse.json();
            
            if (extractionResult.success) {
                console.log('âœ… LinkedIn extraction started successfully:', extractionResult.jobId);
            } else {
                console.warn('âš ï¸ LinkedIn extraction failed to start:', extractionResult.error);
                // Don't fail the registration - LinkedIn analysis is optional
            }
        } catch (extractionError) {
            console.warn('âš ï¸ LinkedIn extraction error:', extractionError.message);
            // Don't fail the registration - continue to success
        }
        
        // FAST: Wait only for animation completion (3.2 seconds total)
        await new Promise(resolve => setTimeout(resolve, 3200));
        
        // Show success immediately (LinkedIn processing continues in background)
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('successState').style.display = 'block';
        
        // Clear any session state
        sessionStorage.removeItem('registrationInProgress');
        
    } catch (error) {
        console.error('Registration error:', error);
        
        // Show error and go back to form
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('registrationForm').style.display = 'block';
        
        // Reset steps
        document.getElementById('step2').classList.add('active');
        document.getElementById('step2').classList.remove('completed');
        
        alert('Registration failed: ' + error.message + '. Please try again.');
    }
}

// Add to Chrome Extension
function addToChromeExtension() {
    // Open Chrome Web Store (when extension is available)
    alert('ðŸš€ Chrome Extension will be available soon!\n\nFor now, you can:\nâœ… Access dashboard\nâœ… Get ready for LinkedIn integration\nâœ… Start your free plan');
    
    // When extension is ready, use this:
    // window.open('https://chrome.google.com/webstore/detail/your-extension-id', '_blank');
}

// Go to dashboard
function goToDashboard() {
    window.location.href = 'https://api.msgly.ai/dashboard';
}
