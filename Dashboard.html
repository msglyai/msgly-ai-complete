<!DOCTYPE html>
<html lang="en">
<head>
<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-5CNT3VV9');</script>
<!-- End Google Tag Manager -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Msgly AI</title>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-purple: #8039DF;
            --dark-purple: #3E0075;
            --glow-purple: #9F4EFF;
            --neon-purple: #7B2CBF;
            --electric-purple: #6A1B9A;
            --light-purple: #F5EDFF;
            --accent-pink: #FF2370;
            --success-green: #10B981;
            --warning-orange: #F59E0B;
            --error-red: #EF4444;
            --black: #111827;
            --charcoal: #1F2937;
            --dark-gray: #374151;
            --gray: #6B7280;
            --light-gray: #F9FAFB;
            --white: #FFFFFF;
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 8px 25px rgba(0, 0, 0, 0.12);
            --glow-shadow: 0 0 30px rgba(128, 57, 223, 0.25);
            --intense-glow: 0 0 45px rgba(128, 57, 223, 0.35);
            --neon-glow: 0 0 60px rgba(128, 57, 223, 0.25);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--light-gray);
            min-height: 100vh;
            display: flex;
        }

        /* Side Navigation */

        /* Main Content */
        .main-wrapper {
            flex: 1;
            margin-left: 280px;
            min-height: 100vh;
            transition: margin-left 0.3s ease;
        }

        .main-content {
            padding: 1.5rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        .page-header {
            margin-bottom: 1.5rem;
        }

        .page-title {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--black);
            margin-bottom: 0.4rem;
        }

        .page-subtitle {
            color: var(--gray);
            font-size: 1rem;
        }

        /* UPGRADE SUCCESS/ERROR NOTIFICATIONS */
        .notification-banner {
            border-radius: 14px;
            padding: 1.2rem;
            margin-bottom: 1.5rem;
            display: none;
            animation: slideInDown 0.5s ease-out;
            position: relative;
        }

        .notification-banner.success {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(16, 185, 129, 0.05) 100%);
            border: 2px solid var(--success-green);
        }

        .notification-banner.error {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(239, 68, 68, 0.05) 100%);
            border: 2px solid var(--error-red);
        }

        .notification-banner.warning {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(245, 158, 11, 0.05) 100%);
            border: 2px solid var(--warning-orange);
        }

        .notification-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .notification-icon {
            width: 22px;
            height: 22px;
            font-size: 1.1rem;
        }

        .notification-banner.success .notification-icon {
            color: var(--success-green);
        }

        .notification-banner.error .notification-icon {
            color: var(--error-red);
        }

        .notification-banner.warning .notification-icon {
            color: var(--warning-orange);
        }

        .notification-title {
            font-size: 1rem;
            font-weight: 600;
        }

        .notification-banner.success .notification-title {
            color: var(--success-green);
        }

        .notification-banner.error .notification-title {
            color: var(--error-red);
        }

        .notification-banner.warning .notification-title {
            color: var(--warning-orange);
        }

        .notification-message {
            color: var(--dark-gray);
            line-height: 1.5;
            font-size: 0.9rem;
        }

        .notification-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            color: var(--gray);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.2rem;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .notification-close:hover {
            background: rgba(0, 0, 0, 0.1);
            color: var(--black);
        }

        /* TRAFFIC LIGHT SYSTEM */
        .traffic-light-warning {
            border-radius: 14px;
            padding: 1.2rem;
            margin-bottom: 1.5rem;
            display: none;
            animation: slideInDown 0.5s ease-out;
        }

        .traffic-light-warning.red {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(239, 68, 68, 0.05) 100%);
            border: 2px solid var(--error-red);
        }

        .traffic-light-warning.orange {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(245, 158, 11, 0.05) 100%);
            border: 2px solid var(--warning-orange);
        }

        .traffic-light-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .traffic-light-icon {
            width: 22px;
            height: 22px;
            font-size: 1.1rem;
        }

        .traffic-light-warning.red .traffic-light-icon {
            color: var(--error-red);
        }

        .traffic-light-warning.orange .traffic-light-icon {
            color: var(--warning-orange);
        }

        .traffic-light-title {
            font-size: 1rem;
            font-weight: 600;
        }

        .traffic-light-warning.red .traffic-light-title {
            color: var(--error-red);
        }

        .traffic-light-warning.orange .traffic-light-title {
            color: var(--warning-orange);
        }

        .traffic-light-message {
            color: var(--dark-gray);
            line-height: 1.5;
            font-size: 0.9rem;
        }

        .traffic-light-highlight {
            font-weight: 600;
            color: var(--black);
        }

        .download-extension-btn {
            margin-top: 1.2rem;
            width: 100%;
            padding: 1rem 1.5rem;
            background: linear-gradient(135deg, var(--primary-purple) 0%, var(--dark-purple) 100%);
            color: var(--white);
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: var(--glow-shadow);
            position: relative;
            overflow: hidden;
        }

        .download-extension-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s ease;
        }

        .download-extension-btn:hover {
            background: linear-gradient(135deg, var(--electric-purple) 0%, var(--primary-purple) 100%);
            transform: translateY(-2px);
            box-shadow: var(--intense-glow);
        }

        .download-extension-btn:hover::before {
            left: 100%;
        }

        .download-extension-btn:active {
            transform: translateY(0);
        }

        .download-extension-btn i {
            font-size: 1.2rem;
            filter: drop-shadow(0 0 5px rgba(255,255,255,0.5));
        }

        .orange-progress {
            margin-top: 0.8rem;
            display: flex;
            align-items: center;
            gap: 0.8rem;
        }

        .progress-bar {
            flex: 1;
            height: 6px;
            background: rgba(245, 158, 11, 0.2);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--warning-orange) 0%, #D97706 100%);
            border-radius: 3px;
            transition: width 0.3s ease;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .progress-text {
            font-size: 0.8rem;
            color: var(--warning-orange);
            font-weight: 600;
            min-width: 100px;
        }

        /* Dashboard Grid - Optimized for smaller cards */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.2rem;
            margin-bottom: 1.5rem;
        }

        .dashboard-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.2rem;
            margin-bottom: 1.5rem;
        }

        /* NEW: Integrated Context Usage Styles */
        .context-usage-integrated {
            margin: 1.2rem 0;
            padding: 1rem;
            background: linear-gradient(135deg, var(--light-purple) 0%, rgba(128, 57, 223, 0.08) 100%);
            border-radius: 12px;
            border: 1px solid rgba(128, 57, 223, 0.15);
        }

        .context-usage-header {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            margin-bottom: 0.5rem;
        }

        .context-usage-number-integrated {
            font-size: 1.8rem;
            font-weight: 900;
            color: var(--primary-purple);
            text-shadow: 0 2px 4px rgba(128, 57, 223, 0.15);
        }

        .context-usage-label {
            color: var(--dark-gray);
            font-size: 1rem;
            font-weight: 600;
        }

        .context-usage-subtitle {
            color: var(--gray);
            font-size: 0.85rem;
            margin-bottom: 0.3rem;
            font-weight: 500;
        }

        .context-usage-note {
            color: var(--gray);
            font-size: 0.75rem;
            font-style: italic;
        }

        .addon-management-integrated {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--light-gray);
        }

        /* Recent Messages Section - Full Width */
        .recent-messages-section {
            margin-bottom: 1.5rem;
        }

        .recent-messages-card {
            background: var(--white);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            border: 1px solid rgba(128, 57, 223, 0.08);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .recent-messages-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-purple) 0%, var(--electric-purple) 100%);
        }

        .recent-messages-card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }

        .recent-messages-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--light-gray);
        }

        .recent-messages-title-section {
            display: flex;
            align-items: center;
            gap: 0.8rem;
        }

        .recent-messages-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary-purple) 0%, var(--dark-purple) 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-size: 1.1rem;
            box-shadow: var(--glow-shadow);
        }

        .recent-messages-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--black);
        }

        .view-all-btn {
            padding: 0.6rem 1.2rem;
            background: linear-gradient(135deg, var(--primary-purple) 0%, var(--dark-purple) 100%);
            color: var(--white);
            border: none;
            border-radius: 10px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: var(--glow-shadow);
        }

        .view-all-btn:hover {
            background: linear-gradient(135deg, var(--electric-purple) 0%, var(--primary-purple) 100%);
            transform: translateY(-1px);
            box-shadow: var(--intense-glow);
        }

        .recent-messages-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
        }

        .recent-message-item {
            background: var(--light-gray);
            border-radius: 12px;
            padding: 1rem;
            transition: all 0.3s ease;
            border-left: 4px solid var(--primary-purple);
            display: flex;
            gap: 0.8rem;
        }

        .recent-message-item:hover {
            background: var(--light-purple);
            transform: translateX(2px);
            box-shadow: var(--shadow);
        }

        .recent-msg-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary-purple) 0%, var(--dark-purple) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-size: 0.9rem;
            font-weight: 700;
            box-shadow: var(--glow-shadow);
            flex-shrink: 0;
        }

        .recent-msg-content {
            flex: 1;
            min-width: 0;
        }

        .recent-msg-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
            gap: 0.5rem;
        }

        .recent-msg-name {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--black);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .recent-msg-date {
            font-size: 0.75rem;
            color: var(--gray);
            white-space: nowrap;
        }

        .recent-msg-role {
            font-size: 0.8rem;
            color: var(--primary-purple);
            font-weight: 600;
            margin-bottom: 0.5rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .recent-msg-preview {
            font-size: 0.8rem;
            color: var(--dark-gray);
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .recent-msg-status {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .status-sent {
            background: linear-gradient(135deg, var(--success-green) 0%, #059669 100%);
            color: var(--white);
        }

        .status-replied {
            background: linear-gradient(135deg, var(--accent-pink) 0%, #E11D48 100%);
            color: var(--white);
        }

        .status-pending {
            background: linear-gradient(135deg, var(--warning-orange) 0%, #D97706 100%);
            color: var(--white);
        }

        .empty-messages {
            text-align: center;
            padding: 2rem;
            color: var(--gray);
        }

        .empty-messages i {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            color: var(--primary-purple);
            opacity: 0.5;
        }

        .empty-messages h3 {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            color: var(--dark-gray);
        }

        .empty-messages p {
            font-size: 0.9rem;
            line-height: 1.4;
        }

        /* Optimized Card Styles */
        .card {
            background: var(--white);
            border-radius: 16px;
            padding: 1.2rem;
            box-shadow: var(--shadow);
            border: 1px solid rgba(128, 57, 223, 0.08);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-purple) 0%, var(--electric-purple) 100%);
        }

        .card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            margin-bottom: 1.2rem;
            padding-bottom: 0.8rem;
            border-bottom: 1px solid var(--light-gray);
        }

        .card-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary-purple) 0%, var(--dark-purple) 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-size: 1.1rem;
            box-shadow: var(--glow-shadow);
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--black);
        }

        /* Optimized Account Info Card */
        .account-info-grid {
            display: grid;
            gap: 0.8rem;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.7rem 0.9rem;
            background: var(--light-gray);
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .info-item:hover {
            background: var(--light-purple);
            transform: translateX(2px);
        }

        .info-label {
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--dark-gray);
            font-size: 0.8rem;
            font-weight: 600;
        }

        .info-label i {
            color: var(--primary-purple);
            width: 14px;
            font-size: 0.9rem;
        }

        .info-value {
            color: var(--black);
            font-weight: 600;
            font-size: 0.8rem;
        }

        /* Optimized Subscription Card */
        .subscription-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.2rem;
        }

        .plan-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 0.5rem 1rem;
            background: linear-gradient(135deg, var(--success-green) 0%, #059669 100%);
            color: var(--white);
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            box-shadow: 0 3px 12px rgba(16, 185, 129, 0.25);
        }

        .status-badge-subscription {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 0.4rem 0.8rem;
            border-radius: 16px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-active {
            background: linear-gradient(135deg, var(--success-green) 0%, #059669 100%);
            color: var(--white);
        }

        .credits-display {
            display: flex;
            align-items: center;
            gap: 1.2rem;
            padding: 1rem;
            background: linear-gradient(135deg, var(--light-purple) 0%, rgba(128, 57, 223, 0.08) 100%);
            border-radius: 12px;
            margin: 1rem 0;
            border: 1px solid rgba(128, 57, 223, 0.15);
        }

        .credits-number {
            font-size: 2.2rem;
            font-weight: 900;
            color: var(--primary-purple);
            text-shadow: 0 2px 4px rgba(128, 57, 223, 0.15);
        }

        .credits-info {
            flex: 1;
        }

        .credits-text {
            color: var(--dark-gray);
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 0.3rem;
        }

        .credits-details {
            color: var(--gray);
            font-size: 0.75rem;
            line-height: 1.3;
        }

        .subscription-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.8rem;
            margin: 1rem 0;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
            padding: 0.7rem;
            background: var(--light-gray);
            border-radius: 10px;
        }

        .detail-label {
            font-size: 0.7rem;
            color: var(--gray);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .detail-value {
            font-size: 0.9rem;
            color: var(--black);
            font-weight: 700;
        }

        .upgrade-btn {
            width: 100%;
            padding: 0.8rem 1.2rem;
            background: linear-gradient(135deg, var(--primary-purple) 0%, var(--dark-purple) 100%);
            color: var(--white);
            border: none;
            border-radius: 10px;
            font-size: 0.85rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: var(--glow-shadow);
            text-decoration: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .upgrade-btn:hover {
            background: linear-gradient(135deg, var(--electric-purple) 0%, var(--primary-purple) 100%);
            transform: translateY(-1px);
            box-shadow: var(--intense-glow);
        }

        /* NEW: Context Storage Card Styles */
        .context-usage-display {
            display: flex;
            align-items: center;
            gap: 1.2rem;
            padding: 1rem;
            background: linear-gradient(135deg, var(--light-purple) 0%, rgba(128, 57, 223, 0.08) 100%);
            border-radius: 12px;
            margin: 1rem 0;
            border: 1px solid rgba(128, 57, 223, 0.15);
        }

        .context-usage-number {
            font-size: 2.2rem;
            font-weight: 900;
            color: var(--primary-purple);
            text-shadow: 0 2px 4px rgba(128, 57, 223, 0.15);
        }

        .context-usage-info {
            flex: 1;
        }

        .context-usage-text {
            color: var(--dark-gray);
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 0.3rem;
        }

        .context-usage-details {
            color: var(--gray);
            font-size: 0.75rem;
            line-height: 1.3;
        }

        .context-progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(128, 57, 223, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin: 1rem 0;
        }

        .context-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-purple) 0%, var(--electric-purple) 100%);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .context-progress-fill.warning {
            background: linear-gradient(90deg, var(--warning-orange) 0%, #D97706 100%);
        }

        .context-progress-fill.danger {
            background: linear-gradient(90deg, var(--error-red) 0%, #DC2626 100%);
        }

        .buy-addon-btn {
            width: 100%;
            padding: 0.8rem 1.2rem;
            background: linear-gradient(135deg, var(--accent-pink) 0%, #E11D48 100%);
            color: var(--white);
            border: none;
            border-radius: 10px;
            font-size: 0.85rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 1.2rem;
            margin-bottom: 0.8rem;
            box-shadow: 0 3px 12px rgba(255, 35, 112, 0.25);
        }

        .buy-addon-btn:hover {
            background: linear-gradient(135deg, #E11D48 0%, var(--accent-pink) 100%);
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(255, 35, 112, 0.35);
        }

        .addon-management {
            margin-top: 1rem;
        }

        .addon-section-title {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--dark-gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.8rem;
        }

        .addon-list {
            display: flex;
            flex-direction: column;
            gap: 0.6rem;
        }

        .addon-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.7rem 0.9rem;
            background: var(--light-gray);
            border-radius: 10px;
            border-left: 4px solid var(--accent-pink);
        }

        .addon-info {
            flex: 1;
        }

        .addon-name {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--black);
            margin-bottom: 0.2rem;
        }

        .addon-details {
            font-size: 0.7rem;
            color: var(--gray);
        }

        .addon-actions {
            display: flex;
            gap: 0.5rem;
        }

        .cancel-addon-btn {
            padding: 0.4rem 0.8rem;
            background: var(--error-red);
            color: var(--white);
            border: none;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .cancel-addon-btn:hover {
            background: #DC2626;
            transform: translateY(-1px);
        }

        .empty-addons {
            text-align: center;
            padding: 1.5rem;
            color: var(--gray);
            font-size: 0.85rem;
            background: var(--light-gray);
            border-radius: 10px;
        }

        /* Optimized LinkedIn Profile Card */
        .profile-summary {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.2rem;
        }

        .profile-avatar {
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, var(--primary-purple) 0%, var(--dark-purple) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-size: 1.8rem;
            font-weight: 700;
            box-shadow: var(--glow-shadow);
        }

        .profile-details {
            flex: 1;
        }

        .profile-name {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--black);
            margin-bottom: 0.3rem;
        }

        .profile-headline {
            color: var(--gray);
            font-size: 0.85rem;
            margin-bottom: 0.5rem;
            line-height: 1.3;
        }

        .profile-company {
            color: var(--dark-gray);
            font-size: 0.8rem;
            margin-bottom: 0.3rem;
            font-weight: 600;
        }

        .profile-location {
            color: var(--gray);
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .profile-url {
            background: var(--light-gray);
            padding: 0.7rem;
            border-radius: 10px;
            margin: 1rem 0;
        }

        .profile-url a {
            color: var(--primary-purple);
            text-decoration: none;
            font-size: 0.8rem;
            word-break: break-all;
            font-weight: 500;
        }

        .view-profile-btn {
            width: 100%;
            padding: 0.7rem;
            border: none;
            border-radius: 10px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            text-decoration: none;
        }

        .view-profile-btn.enabled {
            background: linear-gradient(135deg, var(--success-green) 0%, #059669 100%);
            color: var(--white);
            box-shadow: 0 3px 12px rgba(16, 185, 129, 0.25);
        }

        .view-profile-btn.enabled:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.35);
        }

        /* Optimized Analytics Card */
        .analytics-placeholder {
            text-align: center;
            padding: 2rem 1rem;
            color: var(--gray);
        }

        .analytics-placeholder i {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            color: var(--primary-purple);
            opacity: 0.6;
        }

        .analytics-placeholder h3 {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            color: var(--dark-gray);
        }

        .analytics-placeholder p {
            font-size: 0.85rem;
            line-height: 1.4;
        }

        /* MESSAGES SECTION STYLES */
        .messages-section {
            display: none;
        }

        .messages-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .messages-stats {
            display: flex;
            gap: 2rem;
        }

        .stat-item {
            text-align: center;
            padding: 1rem;
            background: var(--white);
            border-radius: 12px;
            box-shadow: var(--shadow);
            min-width: 120px;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 900;
            color: var(--primary-purple);
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .messages-filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 0.7rem 1.2rem;
            border: 2px solid var(--light-gray);
            background: var(--white);
            color: var(--gray);
            border-radius: 25px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .filter-btn:hover {
            border-color: var(--primary-purple);
            color: var(--primary-purple);
        }

        .filter-btn.active {
            background: linear-gradient(135deg, var(--primary-purple) 0%, var(--dark-purple) 100%);
            color: var(--white);
            border-color: var(--primary-purple);
        }

        .messages-grid {
            display: grid;
            gap: 1.5rem;
        }

        /* Loading State */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 400px;
            flex-direction: column;
            gap: 1.5rem;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid var(--light-gray);
            border-top: 3px solid var(--primary-purple);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes slideInDown {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Error State */
        .error {
            text-align: center;
            padding: 3rem;
            color: var(--error-red);
        }

        .error i {
            font-size: 4rem;
            margin-bottom: 1.5rem;
        }

        /* Mobile Responsive */
        @media (max-width: 1024px) {
            .dashboard-row {
                grid-template-columns: 1fr;
            }
            
            .dashboard-row-three {
                grid-template-columns: 1fr;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .messages-stats {
                justify-content: center;
            }

            .recent-messages-grid {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .sidebar-toggle {
                display: block;
            }

            .main-wrapper {
                margin-left: 0;
            }

            .main-content {
                padding: 1rem;
                margin-top: 4rem;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .card {
                padding: 1rem;
            }

            .recent-messages-grid {
                grid-template-columns: 1fr;
            }

            .recent-messages-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .profile-summary {
                flex-direction: column;
                align-items: center;
                text-align: center;
            }

            .profile-avatar {
                width: 60px;
                height: 60px;
                font-size: 1.5rem;
            }

            .subscription-details {
                grid-template-columns: 1fr;
            }

            .credits-display {
                flex-direction: column;
                text-align: center;
                gap: 0.8rem;
            }

            .context-usage-display {
                flex-direction: column;
                text-align: center;
                gap: 0.8rem;
            }

            .recent-message-item {
                flex-direction: column;
                text-align: center;
                gap: 0.5rem;
            }

            .recent-msg-avatar {
                align-self: center;
            }

            .recent-msg-header {
                flex-direction: column;
                gap: 0.2rem;
            }

            .recent-msg-status {
                justify-content: center;
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5CNT3VV9"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->

    <!-- Main Content Wrapper -->
    <div class="main-wrapper">
        <main class="main-content">
            <!-- Page Header -->
            <div class="page-header">
                <h1 class="page-title">Dashboard</h1>
                <p class="page-subtitle">Welcome to your AI-powered LinkedIn messaging center</p>
            </div>

            <!-- UPGRADE SUCCESS/ERROR NOTIFICATIONS -->
            <div class="notification-banner success" id="successNotification">
                <button class="notification-close" onclick="closeNotification('successNotification')">
                    <i class="fas fa-times"></i>
                </button>
                <div class="notification-header">
                    <i class="fas fa-check-circle notification-icon"></i>
                    <div class="notification-title">Upgrade Successful!</div>
                </div>
                <div class="notification-message" id="successMessage">
                    Welcome to your new plan! Your credits have been updated and are ready to use.
                </div>
            </div>

            <div class="notification-banner error" id="errorNotification">
                <button class="notification-close" onclick="closeNotification('errorNotification')">
                    <i class="fas fa-times"></i>
                </button>
                <div class="notification-header">
                    <i class="fas fa-exclamation-triangle notification-icon"></i>
                    <div class="notification-title">Upgrade Failed</div>
                </div>
                <div class="notification-message" id="errorMessage">
                    There was an issue processing your upgrade. Please try again or contact support.
                </div>
            </div>

            <div class="notification-banner warning" id="cancelNotification">
                <button class="notification-close" onclick="closeNotification('cancelNotification')">
                    <i class="fas fa-times"></i>
                </button>
                <div class="notification-header">
                    <i class="fas fa-info-circle notification-icon"></i>
                    <div class="notification-title">Upgrade Cancelled</div>
                </div>
                <div class="notification-message" id="cancelMessage">
                    No worries! Your upgrade was cancelled and no charges were made. You can upgrade anytime.
                </div>
            </div>

            <!-- TRAFFIC LIGHT WARNING SYSTEM -->
            <div class="traffic-light-warning red" id="redWarning">
                <div class="traffic-light-header">
                    <i class="fas fa-exclamation-triangle traffic-light-icon"></i>
                    <div class="traffic-light-title">Your profile is not fully synced yet.</div>
                </div>
                <div class="traffic-light-message">
                    To personalize your outreach messages at the highest level, we first need a complete view of your LinkedIn profile. Please visit <span class="traffic-light-highlight">your own LinkedIn profile</span> with the Msgly.AI Chrome extension installed and active â€" this will automatically sync your data. Once completed, you'll unlock the full power of our AI-generated messages.
                </div>
                <button class="download-extension-btn" onclick="downloadChromeExtension()">
                    <i class="fab fa-chrome"></i>
                    Download Chrome Extension
                </button>
            </div>

            <div class="traffic-light-warning orange" id="orangeWarning">
                <div class="traffic-light-header">
                    <i class="fas fa-cog fa-spin traffic-light-icon"></i>
                    <div class="traffic-light-title">Analyzing Profile</div>
                </div>
                <div class="traffic-light-message">
                    We're analyzing your profile data. This usually takes a few minutes. Once completed, you'll unlock the full power of our AI-generated messages.
                </div>
                <div class="orange-progress">
                    <div class="progress-bar">
                        <div class="progress-fill" id="analysisProgress" style="width: 0%"></div>
                    </div>
                    <div class="progress-text" id="progressText">Processing...</div>
                </div>
            </div>

            <!-- Loading State -->
            <div class="loading" id="loadingState">
                <div class="spinner"></div>
                <p>Loading your dashboard...</p>
            </div>

            <!-- Error State -->
            <div class="error" id="errorState" style="display: none;">
                <i class="fas fa-exclamation-triangle"></i>
                <h3>Unable to load dashboard</h3>
                <p id="errorMessage">Please try refreshing the page or logging in again.</p>
            </div>

            <!-- Dashboard Content -->
            <div id="dashboardContent" style="display: none;">
                <!-- Top Row: Account Info and Enhanced Subscription -->
                <div class="dashboard-row">
                    <!-- Enhanced Account Information -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-icon">
                                <i class="fas fa-user-circle"></i>
                            </div>
                            <h3 class="card-title">Account Information</h3>
                        </div>
                        
                        <div class="account-info-grid">
                            <div class="info-item">
                                <div class="info-label">
                                    <i class="fas fa-user"></i>
                                    Full Name
                                </div>
                                <div class="info-value" id="accountFullName">Loading...</div>
                            </div>
                            
                            <div class="info-item">
                                <div class="info-label">
                                    <i class="fas fa-envelope"></i>
                                    Email Address
                                </div>
                                <div class="info-value" id="accountEmail">Loading...</div>
                            </div>
                            
                            <div class="info-item">
                                <div class="info-label">
                                    <i class="fas fa-calendar-plus"></i>
                                    Member Since
                                </div>
                                <div class="info-value" id="accountSignupDate">Loading...</div>
                            </div>
                            
                            <div class="info-item">
                                <div class="info-label">
                                    <i class="fas fa-id-badge"></i>
                                    User ID
                                </div>
                                <div class="info-value" id="accountUserId">Loading...</div>
                            </div>
                            
                            <div class="info-item">
                                <div class="info-label">
                                    <i class="fas fa-shield-alt"></i>
                                    Account Status
                                </div>
                                <div class="info-value" id="accountStatus">Active</div>
                            </div>
                            
                            <div class="info-item">
                                <div class="info-label">
                                    <i class="fas fa-sync-alt"></i>
                                    Profile Status
                                </div>
                                <div class="info-value" id="profileSyncStatus">Checking...</div>
                            </div>
                        </div>
                    </div>

                    <!-- Enhanced Subscription & Credits with Context Usage -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-icon">
                                <i class="fas fa-crown"></i>
                            </div>
                            <h3 class="card-title">Subscription & Credits</h3>
                        </div>
                        
                        <div class="subscription-header">
                            <div class="plan-badge" id="planBadge">
                                <i class="fas fa-star"></i>
                                <span id="currentPlan">Loading...</span>
                            </div>
                            <div class="status-badge-subscription status-active" id="statusBadge">
                                <i class="fas fa-check-circle"></i>
                                <span id="subscriptionStatus">Active</span>
                            </div>
                        </div>
                        
                        <div class="credits-display">
                            <div class="credits-number" id="creditsRemaining">--</div>
                            <div class="credits-info">
                                <div class="credits-text">Credits Remaining</div>
                                <div class="credits-details" id="creditsDetails">
                                    <span id="creditBreakdown">Loading...</span><br>
                                    <span id="renewalInfo">Loading...</span>
                                </div>
                            </div>
                        </div>

                        <!-- NEW: Context Usage integrated into subscription card -->
                        <div class="context-usage-integrated">
                            <div class="context-usage-header">
                                <span class="context-usage-number-integrated" id="contextUsageNumberIntegrated">0/1</span>
                                <span class="context-usage-label">Contexts Used</span>
                            </div>
                            <div class="context-usage-subtitle" id="contextUsageSubtitle">1 base slots</div>
                            <div class="context-usage-note" id="contextUsageNote">Upgrade plan or buy addons for more</div>
                        </div>
                        
                        <div class="subscription-details">
                            <div class="detail-item">
                                <div class="detail-label">Billing Model</div>
                                <div class="detail-value" id="billingModel">Monthly</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Next Renewal</div>
                                <div class="detail-value" id="nextRenewal">Loading...</div>
                            </div>
                        </div>
                        
                        <a href="https://api.msgly.ai/upgrade" class="upgrade-btn">
                            <i class="fas fa-rocket"></i>
                            Upgrade Plan / Buy Credits
                        </a>

                        <!-- NEW: Buy Context Addon Button -->
                        <button class="buy-addon-btn" onclick="purchaseContextAddon()">
                            <i class="fas fa-plus"></i>
                            Buy +1 Extra Context Slot - $3.99/month
                        </button>
                        
                        <!-- NEW: Active Addons Management (hidden by default) -->
                        <div class="addon-management-integrated" id="addonManagementIntegrated" style="display: none;">
                            <div class="addon-section-title">Active Context Addons</div>
                            <div class="addon-list" id="addonListIntegrated">
                                <!-- Addons will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- NEW: Recent Messages Section -->
                <div class="recent-messages-section">
                    <div class="recent-messages-card">
                        <div class="recent-messages-header">
                            <div class="recent-messages-title-section">
                                <div class="recent-messages-icon">
                                    <i class="fas fa-envelope"></i>
                                </div>
                                <h3 class="recent-messages-title">Recent Messages</h3>
                            </div>
                            <a href="https://api.msgly.ai/messages" class="view-all-btn">
                                <i class="fas fa-arrow-right"></i>
                                View All Messages
                            </a>
                        </div>
                        
                        <div class="recent-messages-grid" id="recentMessagesGrid">
                            <!-- Recent messages will be populated by JavaScript -->
                        </div>

                        <div class="empty-messages" id="emptyRecentMessages" style="display: none;">
                            <i class="fas fa-envelope-open"></i>
                            <h3>No Messages Yet</h3>
                            <p>Your recent LinkedIn messages will appear here once you start using the extension.</p>
                        </div>
                    </div>
                </div>

                <!-- Bottom Row: LinkedIn Profile and Analytics -->
                <div class="dashboard-row">
                    <!-- Msgly Profile Summary -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-icon">
                                <i class="fab fa-linkedin"></i>
                            </div>
                            <h3 class="card-title">Msgly Profile Summary</h3>
                        </div>
                        
                        <div class="profile-summary">
                            <div class="profile-avatar" id="profileAvatar">
                                <span id="profileInitials">--</span>
                            </div>
                            <div class="profile-details">
                                <div class="profile-name" id="profileFullName">Loading...</div>
                                <div class="profile-headline" id="profileHeadline">Loading...</div>
                                <div class="profile-company" id="profileCompany">Loading...</div>
                                <div class="profile-location" id="profileLocation">
                                    <i class="fas fa-map-marker-alt"></i>
                                    Loading...
                                </div>
                            </div>
                        </div>
                        
                        <div class="profile-url">
                            <a href="#" id="profileUrl" target="_blank">Loading...</a>
                        </div>
                        
                        <a href="https://api.msgly.ai/msgly-profile.html" class="view-profile-btn enabled">
                            <i class="fas fa-eye"></i>
                            View Full Profile
                        </a>
                    </div>

                    <!-- Analytics Placeholder -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-icon">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <h3 class="card-title">Analytics & Performance</h3>
                        </div>
                        
                        <div class="analytics-placeholder">
                            <i class="fas fa-chart-bar"></i>
                            <h3>Analytics Dashboard â€" Coming Soon</h3>
                            <p>Track your reply rates, message performance, and comprehensive analytics data coming soon!</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Global variables
        let currentUserData = null;
        let trafficLightStatus = 'loading';
        let analysisProgressInterval = null;
        let currentContextUsage = null;

        // Initialization
        document.addEventListener('DOMContentLoaded', function() {
            console.log('[DASHBOARD] Page loaded - starting authentication...');
            checkAuthentication();
        });

        // Handle URL parameters for upgrade status only
        function checkUpgradeStatus() {
            const urlParams = new URLSearchParams(window.location.search);
            const upgradeStatus = urlParams.get('upgrade');
            
            if (upgradeStatus === 'success') {
                window.history.replaceState({}, document.title, window.location.pathname);
                showUpgradeSuccessNotification();
            } else if (upgradeStatus === 'cancelled') {
                window.history.replaceState({}, document.title, window.location.pathname);
                showUpgradeCancelledNotification();
            } else if (upgradeStatus === 'error') {
                window.history.replaceState({}, document.title, window.location.pathname);
                showUpgradeErrorNotification();
            }
        }

        // NEW: Function to send welcome email for newly registered users
        async function sendWelcomeEmailForNewUser(user) {
            // Check if user needs welcome email (registration completed but email not sent)
            const needsWelcomeEmail = user.registrationCompleted && !user.welcomeEmailSent;
            
            if (!needsWelcomeEmail) {
                console.log('[EMAIL] User does not need welcome email:', {
                    registrationCompleted: user.registrationCompleted,
                    welcomeEmailSent: user.welcomeEmailSent
                });
                return;
            }

            // Check if we already sent email in this session (prevent multiple sends)
            const sessionKey = `welcomeEmailSent_${user.id}`;
            if (sessionStorage.getItem(sessionKey)) {
                console.log('[EMAIL] Welcome email already sent in this session');
                return;
            }

            console.log('[EMAIL] Sending welcome email for newly registered user:', user.email);

            try {
                const token = getAuthToken();
                if (!token) return;

                const response = await fetch('https://api.msgly.ai/send-welcome-email', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: user.id,
                        email: user.email,
                        displayName: user.displayName || user.email
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        console.log('[EMAIL] Welcome email sent successfully');
                        
                        // Mark as sent in session to prevent re-sending
                        sessionStorage.setItem(sessionKey, 'true');
                        
                        // Show success notification
                        showUpgradeSuccessNotification('Welcome email sent! Check your inbox for important getting started information.');
                    } else {
                        console.error('[EMAIL] Welcome email failed:', result.error);
                    }
                } else {
                    console.error('[EMAIL] Welcome email request failed:', response.status);
                }

            } catch (error) {
                console.error('[EMAIL] Error sending welcome email:', error);
                // Don't show error to user - email is non-critical
            }
        }

        // NEW: Context Addon Functions
        async function loadContextUsage() {
            const token = getAuthToken();
            if (!token) return;

            try {
                const response = await fetch('https://api.msgly.ai/contexts/limits', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                
                if (data.success) {
                    currentContextUsage = data.data;
                    updateContextStorageDisplay(data.data);
                }
                
            } catch (error) {
                console.error('[CONTEXT] Error loading context usage:', error);
                // Show fallback data
                updateContextStorageDisplay({
                    used: 0,
                    baseLimit: 1,
                    totalLimit: 1,
                    addonSlots: 0,
                    addons: []
                });
            }
        }

        function updateContextStorageDisplay(usageData) {
            const {
                used = 0,
                baseLimit = 1,
                totalLimit = 1,
                addonSlots = 0,
                addons = []
            } = usageData;

            // Update integrated usage display
            document.getElementById('contextUsageNumberIntegrated').textContent = `${used}/${totalLimit}`;
            
            const contextUsageSubtitle = document.getElementById('contextUsageSubtitle');
            const contextUsageNote = document.getElementById('contextUsageNote');
            
            if (addonSlots > 0) {
                contextUsageSubtitle.textContent = `${baseLimit} base + ${addonSlots} addon = ${totalLimit} total slots`;
                contextUsageNote.textContent = 'Purchase more addon slots for extra storage';
            } else {
                contextUsageSubtitle.textContent = `${baseLimit} base slots`;
                contextUsageNote.textContent = 'Upgrade plan or buy addons for more';
            }

            // Update addon management section
            const addonManagementIntegrated = document.getElementById('addonManagementIntegrated');
            const addonListIntegrated = document.getElementById('addonListIntegrated');

            if (addons.length > 0) {
                addonManagementIntegrated.style.display = 'block';
                addonListIntegrated.innerHTML = addons.map(addon => createAddonListItem(addon)).join('');
            } else {
                addonManagementIntegrated.style.display = 'none';
            }
        }

        function createAddonListItem(addon) {
            const renewalDate = addon.renewalDate ? 
                new Date(addon.renewalDate).toLocaleDateString('en-US', { 
                    month: 'short', 
                    day: 'numeric' 
                }) : 
                'Unknown';

            return `
                <div class="addon-item">
                    <div class="addon-info">
                        <div class="addon-name">+1 Extra Context Slot</div>
                        <div class="addon-details">$3.99/month â€¢ Renews ${renewalDate}</div>
                    </div>
                    <div class="addon-actions">
                        <button class="cancel-addon-btn" onclick="cancelContextAddon('${addon.id}')">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
        }

        async function purchaseContextAddon() {
            const token = getAuthToken();
            if (!token) {
                alert('Please log in to purchase context addons');
                return;
            }

            try {
                console.log('[ADDON] Initiating context addon purchase...');
                
                const response = await fetch('https://api.msgly.ai/context-addons/purchase', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        addonType: 'context-slot',
                        quantity: 1
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const result = await response.json();
                
                if (result.success && result.data.checkoutUrl) {
                    console.log('[ADDON] Opening Chargebee checkout...');
                    window.open(result.data.checkoutUrl, '_blank');
                    
                    showUpgradeSuccessNotification('Checkout opened! Complete payment to add your extra context slot.');
                } else {
                    throw new Error(result.error || 'Purchase failed');
                }

            } catch (error) {
                console.error('[ADDON] Purchase error:', error);
                showUpgradeErrorNotification('Failed to initiate purchase. Please try again.');
            }
        }

        async function cancelContextAddon(addonId) {
            if (!confirm('Are you sure you want to cancel this context addon? You will lose access at the end of your current billing period.')) {
                return;
            }

            const token = getAuthToken();
            if (!token) return;

            try {
                const response = await fetch(`https://api.msgly.ai/context-addons/${addonId}/cancel`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const result = await response.json();
                
                if (result.success) {
                    showUpgradeSuccessNotification('Context addon cancelled successfully. Access will continue until the end of your billing period.');
                    
                    // Refresh context usage
                    setTimeout(() => loadContextUsage(), 1000);
                } else {
                    throw new Error(result.error || 'Cancellation failed');
                }

            } catch (error) {
                console.error('[ADDON] Cancel error:', error);
                showUpgradeErrorNotification('Failed to cancel addon. Please try again or contact support.');
            }
        }

        // UPGRADE HANDLING FUNCTIONS
        function showUpgradeSuccessNotification(customMessage = null) {
            const notification = document.getElementById('successNotification');
            const message = document.getElementById('successMessage');
            
            message.textContent = customMessage || 'Payment successful! Your plan has been upgraded and credits are ready to use.';
            notification.style.display = 'block';
            
            setTimeout(() => {
                closeNotification('successNotification');
            }, 10000);
        }

        function showUpgradeErrorNotification(customMessage = null) {
            const notification = document.getElementById('errorNotification');
            const message = document.getElementById('errorMessage');
            
            message.textContent = customMessage || 'There was an issue processing your upgrade. Please try again or contact support.';
            notification.style.display = 'block';
            
            setTimeout(() => {
                closeNotification('errorNotification');
            }, 8000);
        }

        function showUpgradeCancelledNotification() {
            const notification = document.getElementById('cancelNotification');
            notification.style.display = 'block';
            
            setTimeout(() => {
                closeNotification('cancelNotification');
            }, 6000);
        }

        function closeNotification(notificationId) {
            const notification = document.getElementById(notificationId);
            notification.style.display = 'none';
        }

        // Sidebar functions now handled by sidebar-loader.js

        function showSection(section) {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.nav-item').classList.add('active');

            switch(section) {
                case 'dashboard':
                    showDashboardSection();
                    break;
                default:
                    alert(`${section.charAt(0).toUpperCase() + section.slice(1)} section coming soon!`);
            }
        }

        function showDashboardSection() {
            document.getElementById('dashboardContent').style.display = 'block';
            
            document.querySelector('.page-title').textContent = 'Dashboard';
            document.querySelector('.page-subtitle').textContent = 'Welcome to your AI-powered LinkedIn messaging center';
        }

        // NEW: Helper function to clean message text
        function cleanMessageText(messageText) {
            if (!messageText) return '';
            const cleanedText = messageText.replace(/^MSG_\d+\s*/i, '');
            return cleanedText.replace(/^Subject:\s*/i, '').trim();
        }

        // UPDATED: Recent Messages Functions - Now uses real API data
        async function loadRecentMessages() {
            try {
                const token = getAuthToken();
                if (!token) return;

                console.log('[RECENT_MESSAGES] Loading real data from API...');
                
                const response = await fetch('/messages/history', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const data = await response.json();
                const recentMessages = data.success ? (data.data || []).slice(0, 4) : [];

                console.log('[RECENT_MESSAGES] Loaded', recentMessages.length, 'real messages');

                const recentMessagesGrid = document.getElementById('recentMessagesGrid');
                const emptyRecentMessages = document.getElementById('emptyRecentMessages');
                
                if (recentMessages.length === 0) {
                    recentMessagesGrid.style.display = 'none';
                    emptyRecentMessages.style.display = 'block';
                    return;
                }
                
                emptyRecentMessages.style.display = 'none';
                recentMessagesGrid.style.display = 'grid';
                
                recentMessagesGrid.innerHTML = recentMessages.map(message => createRecentMessageCard(message)).join('');
                
            } catch (error) {
                console.error('[RECENT_MESSAGES] Error loading messages:', error);
                // Show empty state on error
                document.getElementById('emptyRecentMessages').style.display = 'block';
                document.getElementById('recentMessagesGrid').style.display = 'none';
            }
        }

        function createRecentMessageCard(message) {
            // Use cleaned message text
            const messageText = cleanMessageText(message.message || '');
            
            // Display first name only
            const displayName = message.targetProfile?.firstName || 'Unknown';
            
            // Create initials from first name
            const initials = displayName.substring(0, 2).toUpperCase();
            
            // Convert database status values to display status
            const messageSent = message.sent === 'yes';
            const gotReply = message.gotReply === 'yes';
            
            // Determine status badges
            let statusBadges = [];
            if (messageSent) {
                statusBadges.push('<span class="status-badge status-sent"><i class="fas fa-check"></i> Sent</span>');
            }
            if (gotReply) {
                statusBadges.push('<span class="status-badge status-replied"><i class="fas fa-reply"></i> Replied</span>');
            }
            if (messageSent && !gotReply) {
                statusBadges.push('<span class="status-badge status-pending"><i class="fas fa-clock"></i> Pending</span>');
            }
            
            return `
                <div class="recent-message-item">
                    <div class="recent-msg-avatar">${initials}</div>
                    <div class="recent-msg-content">
                        <div class="recent-msg-header">
                            <div class="recent-msg-name">${displayName}</div>
                            <div class="recent-msg-date">${formatRecentMessageDate(message.createdAt)}</div>
                        </div>
                        <div class="recent-msg-role">${message.targetProfile?.role || 'Professional'}</div>
                        <div class="recent-msg-preview">${messageText}</div>
                        <div class="recent-msg-status">
                            ${statusBadges.join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function formatRecentMessageDate(dateString) {
            if (!dateString) return 'Unknown';
            
            try {
                const date = new Date(dateString);
                const now = new Date();
                const diffTime = now - date;
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                
                if (diffDays === 0) {
                    return 'Today';
                } else if (diffDays === 1) {
                    return 'Yesterday';
                } else if (diffDays < 7) {
                    return `${diffDays}d ago`;
                } else {
                    return date.toLocaleDateString('en-US', {
                        month: 'short',
                        day: 'numeric'
                    });
                }
            } catch (error) {
                return 'Unknown';
            }
        }

        // Authentication check - ENHANCED with upgrade status check
        async function checkAuthentication() {
            const token = getAuthToken();
            
            if (!token) {
                console.log('[AUTH] No authentication token found - redirecting to login');
                window.location.href = '/login';
                return;
            }

            checkUpgradeStatus();

            try {
                await loadDashboardData(token);
                await loadContextUsage(); // NEW: Load context usage
            } catch (error) {
                console.error('[AUTH] Dashboard load error:', error);
                if (error.message.includes('401') || error.message.includes('403')) {
                    window.location.href = '/login';
                } else {
                    showError('Failed to load dashboard data. Please try refreshing the page or logging in again.');
                }
            }
        }

        function getAuthToken() {
            const urlParams = new URLSearchParams(window.location.search);
            const urlToken = urlParams.get('token');
            
            if (urlToken) {
                localStorage.setItem('authToken', urlToken);
                window.history.replaceState({}, document.title, window.location.pathname);
                return urlToken;
            }
            
            return localStorage.getItem('authToken');
        }

        async function loadDashboardData(token) {
            try {
                // Load both profile data and plan data
                const [profileResponse, planResponse] = await Promise.all([
                    fetch('https://api.msgly.ai/profile', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    }),
                    fetch('https://api.msgly.ai/user/plan', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    })
                ]);

                if (!profileResponse.ok) {
                    throw new Error(`Profile API HTTP ${profileResponse.status}: ${profileResponse.statusText}`);
                }

                if (!planResponse.ok) {
                    throw new Error(`Plan API HTTP ${planResponse.status}: ${planResponse.statusText}`);
                }

                const profileData = await profileResponse.json();
                const planData = await planResponse.json();
                
                if (!profileData.success) {
                    throw new Error(profileData.error || 'Failed to load profile data');
                }

                if (!planData.success) {
                    throw new Error(planData.error || 'Failed to load plan data');
                }

                // Merge profile and plan data
                const mergedData = {
                    ...profileData.data,
                    planInfo: planData.data
                };

                currentUserData = mergedData;
                populateDashboard(mergedData);
                
            } catch (error) {
                console.error('[API] Error:', error);
                throw error;
            }
        }

        function populateDashboard(data) {
            const { user, profile, syncStatus, planInfo } = data;
            
            console.log('[DASHBOARD] Populating dashboard with merged data:', {
                userId: user.id,
                registrationCompleted: user.registrationCompleted,
                planCode: user.planCode,
                renewableCredits: user.renewableCredits,
                payasyougoCredits: user.payasyougoCredits,
                totalCredits: user.credits,
                packageType: user.packageType,
                // Plan info from /user/plan endpoint
                planInfo: planInfo
            });

            // NEW: Check if user needs welcome email (AFTER user data is loaded)
            sendWelcomeEmailForNewUser(user);

            // Sidebar is now updated by sidebar-loader.js automatically
            // Keeping this code commented for reference:
            // const displayName = extractFirstLastName(profile).firstName || user.displayName || user.email;
            // document.getElementById('sidebarUserName').textContent = displayName;
            // document.getElementById('sidebarUserEmail').textContent = user.email;
            // document.getElementById('sidebarUserPlan').textContent = planDisplayName;
            // document.getElementById('sidebarUserAvatar').textContent = sidebarInitials;

            // DETERMINE TRAFFIC LIGHT STATUS
            const displayName = extractFirstLastName(profile).firstName || user.displayName || user.email;
            const isRegistrationComplete = user.registrationCompleted;
            const isInitialScrapingDone = profile?.initialScrapingDone || false;
            const extractionStatus = profile?.extractionStatus || 'pending';
            const hasExperience = profile?.experience && Array.isArray(profile.experience) && profile.experience.length > 0;

            console.log('[TRAFFIC] Traffic Light Debug:', {
                registrationCompleted: isRegistrationComplete,
                initialScrapingDone: isInitialScrapingDone, 
                extractionStatus: extractionStatus,
                hasExperience: hasExperience
            });

            if (isRegistrationComplete && isInitialScrapingDone && extractionStatus === 'completed' && hasExperience) {
                trafficLightStatus = 'green';
                hideAllWarnings();
            } else if (isRegistrationComplete && isInitialScrapingDone) {
                trafficLightStatus = 'orange';
                showOrangeWarning();
            } else if (isRegistrationComplete) {
                trafficLightStatus = 'red';
                showRedWarning();
            } else {
                trafficLightStatus = 'red';
                showRedWarning();
            }

            // Enhanced Account Information with proper name extraction
            const nameData = extractFirstLastName(profile);
            const fullName = profile?.fullName || `${nameData.firstName} ${nameData.lastName}`.trim() || user.displayName || 'Not provided';
            document.getElementById('accountFullName').textContent = fullName;
            document.getElementById('accountEmail').textContent = user.email;
            document.getElementById('accountSignupDate').textContent = formatDate(user.createdAt);
            document.getElementById('accountUserId').textContent = `#${user.id}`;
            document.getElementById('accountStatus').textContent = 'Active';
            
            const profileSyncStatusEl = document.getElementById('profileSyncStatus');
            switch(trafficLightStatus) {
                case 'green':
                    profileSyncStatusEl.textContent = '✓ Fully Synced';
                    profileSyncStatusEl.style.color = 'var(--success-green)';
                    break;
                case 'orange':
                    profileSyncStatusEl.textContent = '🔄 Processing...';
                    profileSyncStatusEl.style.color = 'var(--warning-orange)';
                    break;
                case 'red':
                    profileSyncStatusEl.textContent = '🔴 Sync Required';
                    profileSyncStatusEl.style.color = 'var(--error-red)';
                    break;
            }

            // Use planInfo for subscription display
            updateSubscriptionDisplay(user, planInfo);

            // Msgly Profile Summary with enhanced name handling
            if (profile) {
                const profileName = profile.fullName || `${nameData.firstName} ${nameData.lastName}`.trim() || 'Profile name not synced yet';
                document.getElementById('profileFullName').textContent = profileName;
                document.getElementById('profileHeadline').textContent = profile.headline || 'Professional headline awaiting sync...';
                
                const companyName = extractCurrentJobTitle(profile) || profile.currentCompanyName || profile.currentCompany || 'Company info pending sync...';
                document.getElementById('profileCompany').textContent = companyName;
                
                const locationElement = document.getElementById('profileLocation');
                locationElement.innerHTML = `<i class="fas fa-map-marker-alt"></i> ${profile.location || 'Location awaiting sync...'}`;
                
                const profileUrlElement = document.getElementById('profileUrl');
                if (profile.linkedinUrl) {
                    profileUrlElement.href = profile.linkedinUrl;
                    profileUrlElement.textContent = profile.linkedinUrl;
                } else {
                    profileUrlElement.textContent = 'LinkedIn URL will appear after sync';
                    profileUrlElement.removeAttribute('href');
                }

                const initials = getInitials(profileName);
                document.getElementById('profileInitials').textContent = initials;
            } else {
                document.getElementById('profileFullName').textContent = 'LinkedIn profile not connected yet';
                document.getElementById('profileHeadline').textContent = 'Connect your profile to see your headline here';
                document.getElementById('profileCompany').textContent = 'Your company info will appear after sync';
                document.getElementById('profileLocation').innerHTML = '<i class="fas fa-map-marker-alt"></i> Location will sync automatically';
                document.getElementById('profileUrl').textContent = 'LinkedIn URL will appear after connection';
                
                const initials = getInitials(user.displayName || user.email);
                document.getElementById('profileInitials').textContent = initials;
            }

            // UPDATED: Load real recent messages
            loadRecentMessages();

            // Show dashboard content
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('dashboardContent').style.display = 'block';
        }

        // NEW: Enhanced name extraction functions
        function extractFirstLastName(profile) {
            if (!profile) return { firstName: '', lastName: '' };
            
            // Try explicit fields first
            if (profile.firstName && profile.lastName) {
                return {
                    firstName: profile.firstName,
                    lastName: profile.lastName
                };
            }
            
            // Extract from fullName if available
            if (profile.fullName) {
                const parts = profile.fullName.trim().split(' ');
                return {
                    firstName: parts[0] || '',
                    lastName: parts.slice(1).join(' ') || ''
                };
            }
            
            // Try to extract from JSONB fields if they exist
            try {
                if (profile.basicInfo && typeof profile.basicInfo === 'object') {
                    if (profile.basicInfo.firstName && profile.basicInfo.lastName) {
                        return {
                            firstName: profile.basicInfo.firstName,
                            lastName: profile.basicInfo.lastName
                        };
                    }
                }
            } catch (error) {
                console.log('[NAME_EXTRACTION] JSONB parsing failed, using fallback');
            }
            
            return { firstName: '', lastName: '' };
        }

        function extractCurrentJobTitle(profile) {
            if (!profile) return null;
            
            // Try currentRole first
            if (profile.currentRole) return profile.currentRole;
            
            // Try to extract from experience array
            if (profile.experience && Array.isArray(profile.experience) && profile.experience.length > 0) {
                const currentJob = profile.experience.find(exp => exp.current === true) || profile.experience[0];
                if (currentJob && currentJob.title) {
                    return currentJob.company ? `${currentJob.title} at ${currentJob.company}` : currentJob.title;
                }
            }
            
            return null;
        }

        function updateSubscriptionDisplay(user, planInfo) {
            const planDisplayNames = {
                'free': 'Free Plan',
                'silver-monthly': 'Silver Monthly',
                'silver-payasyougo': 'Silver Pay-as-you-go',
                'gold-monthly': 'Gold Monthly', 
                'gold-payasyougo': 'Gold Pay-as-you-go',
                'platinum-monthly': 'Platinum Monthly',
                'platinum-payasyougo': 'Platinum Pay-as-you-go'
            };

            const planCode = user.planCode || 'free';
            const planDisplayName = planDisplayNames[planCode] || 'Unknown Plan';
            
            console.log('[DISPLAY] Updating plan display with plan info:', {
                planCode: planCode,
                displayName: planDisplayName,
                renewableCredits: user.renewableCredits,
                payasyougoCredits: user.payasyougoCredits,
                totalCredits: user.credits,
                planInfo: planInfo
            });

            document.getElementById('currentPlan').textContent = planDisplayName;
            
            const planBadge = document.getElementById('planBadge');
            if (planCode === 'free') {
                planBadge.style.background = 'linear-gradient(135deg, var(--gray) 0%, var(--dark-gray) 100%)';
            } else if (planCode.startsWith('silver')) {
                planBadge.style.background = 'linear-gradient(135deg, #6B7280 0%, #4B5563 100%)';
            } else if (planCode.startsWith('gold')) {
                planBadge.style.background = 'linear-gradient(135deg, #F59E0B 0%, #D97706 100%)';
            } else if (planCode.startsWith('platinum')) {
                planBadge.style.background = 'linear-gradient(135deg, var(--primary-purple) 0%, var(--dark-purple) 100%)';
            }

            // CRITICAL FIX: Use proper dual credit calculation
            const renewableCredits = parseFloat(user.renewableCredits || 0);
            const payasyougoCredits = parseFloat(user.payasyougoCredits || 0);
            const totalCredits = renewableCredits + payasyougoCredits;
            
            // Always show exactly 2 decimal places
            document.getElementById('creditsRemaining').textContent = totalCredits.toFixed(2);
            
            // Debug logging to verify correct calculation
            console.log('[CREDIT_FIX] Renewable:', renewableCredits.toFixed(2));
            console.log('[CREDIT_FIX] PayAsYouGo:', payasyougoCredits.toFixed(2));
            console.log('[CREDIT_FIX] Total:', totalCredits.toFixed(2));
            
            const creditBreakdownEl = document.getElementById('creditBreakdown');
            const renewalInfoEl = document.getElementById('renewalInfo');
            
            if (payasyougoCredits > 0 && renewableCredits > 0) {
                creditBreakdownEl.textContent = `${payasyougoCredits.toFixed(2)} PAYG + ${renewableCredits.toFixed(2)} Monthly`;
                renewalInfoEl.textContent = `PAYG credits never expire â€¢ Monthly credits renew`;
            } else if (payasyougoCredits > 0) {
                creditBreakdownEl.textContent = `${payasyougoCredits.toFixed(2)} Pay-as-you-go credits`;
                renewalInfoEl.textContent = `Credits never expire`;
            } else if (renewableCredits > 0) {
                creditBreakdownEl.textContent = `${renewableCredits.toFixed(2)} Monthly credits`;
                renewalInfoEl.textContent = `Refreshes monthly`;
            } else {
                creditBreakdownEl.textContent = `${totalCredits.toFixed(2)} Credits`;
                renewalInfoEl.textContent = `Usage-based credits`;
            }

            document.getElementById('subscriptionStatus').textContent = (user.subscriptionStatus || 'active').charAt(0).toUpperCase() + (user.subscriptionStatus || 'active').slice(1);
            
            let billingDisplay;
            if (planCode.includes('payasyougo')) {
                billingDisplay = 'One-time Purchase';
            } else if (planCode.includes('monthly')) {
                billingDisplay = 'Monthly Subscription';
            } else {
                billingDisplay = (user.billingModel || 'monthly').charAt(0).toUpperCase() + (user.billingModel || 'monthly').slice(1);
            }
            document.getElementById('billingModel').textContent = billingDisplay;

            // FIXED: Use planInfo for renewal date (from /user/plan endpoint)
            const nextRenewalEl = document.getElementById('nextRenewal');
            
            console.log('[RENEWAL_FIX] Plan info data:', planInfo);
            
            // Try to get renewal date from planInfo (from /user/plan endpoint)
            let renewalDate = null;
            if (planInfo) {
                renewalDate = planInfo.nextBillingDate || planInfo.next_billing_date || planInfo.subscriptionRenewalDate || planInfo.renewalDate;
                console.log('[RENEWAL_FIX] Found renewal date in planInfo:', renewalDate);
            }
            
            if (renewalDate) {
                try {
                    const date = new Date(renewalDate);
                    // Verify it's a valid date
                    if (!isNaN(date.getTime())) {
                        const formattedDate = date.toLocaleDateString('en-US', {
                            month: 'short',
                            day: 'numeric',
                            year: 'numeric'
                        });
                        nextRenewalEl.textContent = formattedDate;
                        console.log('[RENEWAL_SUCCESS] Using actual renewal date:', formattedDate);
                    } else {
                        throw new Error('Invalid date');
                    }
                } catch (error) {
                    console.error('[RENEWAL_ERROR] Invalid renewal date:', renewalDate, error);
                    calculateFallbackRenewal();
                }
            } else {
                console.log('[RENEWAL_DEBUG] No renewal date found in planInfo, using fallback');
                calculateFallbackRenewal();
            }
            
            function calculateFallbackRenewal() {
                if (planCode.includes('monthly')) {
                    // Calculate next month's renewal for monthly plans
                    const nextMonth = new Date();
                    nextMonth.setMonth(nextMonth.getMonth() + 1);
                    const fallbackDate = nextMonth.toLocaleDateString('en-US', {
                        month: 'short',
                        day: 'numeric',
                        year: 'numeric'
                    });
                    nextRenewalEl.textContent = fallbackDate;
                    console.log('[RENEWAL_FALLBACK] Using calculated date:', fallbackDate);
                } else {
                    nextRenewalEl.textContent = 'N/A';
                    console.log('[RENEWAL_FALLBACK] No renewal for this plan type');
                }
            }
        }

        // TRAFFIC LIGHT FUNCTIONS
        function hideAllWarnings() {
            document.getElementById('redWarning').style.display = 'none';
            document.getElementById('orangeWarning').style.display = 'none';
        }

        function showRedWarning() {
            hideAllWarnings();
            document.getElementById('redWarning').style.display = 'block';
        }

        function showOrangeWarning() {
            hideAllWarnings();
            document.getElementById('orangeWarning').style.display = 'block';
            startAnalysisProgress();
        }

        function startAnalysisProgress() {
            let progress = 0;
            const progressFill = document.getElementById('analysisProgress');
            const progressText = document.getElementById('progressText');
            
            if (analysisProgressInterval) {
                clearInterval(analysisProgressInterval);
            }
            
            analysisProgressInterval = setInterval(() => {
                progress += Math.random() * 2;
                if (progress > 95) progress = 95;
                
                progressFill.style.width = `${progress}%`;
                
                if (progress < 30) {
                    progressText.textContent = 'Analyzing profile structure...';
                } else if (progress < 60) {
                    progressText.textContent = 'Processing experience data...';
                } else if (progress < 85) {
                    progressText.textContent = 'Extracting skills & certifications...';
                } else {
                    progressText.textContent = 'Finalizing analysis...';
                }
            }, 1000);
        }

        function showError(message) {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorState').style.display = 'block';
        }

        function formatDate(dateString) {
            if (!dateString) return 'Not available';
            
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            } catch (error) {
                return 'Invalid date';
            }
        }

        function getInitials(name) {
            if (!name) return '??';
            
            const parts = name.split(' ');
            if (parts.length >= 2) {
                return (parts[0][0] + parts[1][0]).toUpperCase();
            } else {
                return name.substring(0, 2).toUpperCase();
            }
        }

        function downloadChromeExtension() {
            const extensionUrl = 'https://chromewebstore.google.com/detail/msglyai-linkedin-message/gbnbbcbiimefgolddbfgplhedbijkgod';
            window.open(extensionUrl, '_blank');
        }

        // logout() now handled by sidebar-loader.js

        // Cleanup intervals on page unload
        window.addEventListener('beforeunload', function() {
            if (analysisProgressInterval) {
                clearInterval(analysisProgressInterval);
            }
        });
    </script>

    <!-- Load Shared Sidebar -->
    <script src="/sidebar-loader.js"></script>
</body>
</html>
