<!DOCTYPE html>
<html lang="en">
<head>
<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-5CNT3VV9');</script>
<!-- End Google Tag Manager -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messages - Msgly AI</title>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-purple: #8039DF;
            --dark-purple: #3E0075;
            --glow-purple: #9F4EFF;
            --neon-purple: #7B2CBF;
            --electric-purple: #6A1B9A;
            --light-purple: #F5EDFF;
            --accent-pink: #FF2370;
            --success-green: #10B981;
            --warning-orange: #F59E0B;
            --error-red: #EF4444;
            --black: #111827;
            --charcoal: #1F2937;
            --dark-gray: #374151;
            --gray: #6B7280;
            --light-gray: #F9FAFB;
            --white: #FFFFFF;
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 8px 25px rgba(0, 0, 0, 0.12);
            --glow-shadow: 0 0 30px rgba(128, 57, 223, 0.25);
            --intense-glow: 0 0 45px rgba(128, 57, 223, 0.35);
            --neon-glow: 0 0 60px rgba(128, 57, 223, 0.25);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--light-gray);
            min-height: 100vh;
            display: flex;
        }

        /* Side Navigation */
        .sidebar {
            width: 280px;
            background: linear-gradient(180deg, var(--primary-purple) 0%, var(--dark-purple) 100%);
            color: var(--white);
            position: fixed;
            height: 100vh;
            left: 0;
            top: 0;
            z-index: 1000;
            overflow-y: auto;
            transition: transform 0.3s ease;
            box-shadow: var(--shadow-lg);
        }

        .sidebar-header {
            padding: 2rem 1.5rem 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-logo {
            display: flex;
            align-items: center;
            text-decoration: none;
            color: var(--white);
            margin-bottom: 1rem;
        }

        .sidebar-logo i {
            font-size: 2rem;
            margin-right: 12px;
            filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.3));
        }

        .sidebar-logo-text {
            display: flex;
            flex-direction: column;
        }

        .sidebar-logo-main {
            font-size: 1.5rem;
            font-weight: 700;
            line-height: 1.2;
        }

        .sidebar-logo-sub {
            font-size: 0.7rem;
            opacity: 0.8;
            font-weight: 400;
        }

        .sidebar-user {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }

        .sidebar-user-avatar {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .sidebar-user-info {
            flex: 1;
            min-width: 0;
        }

        .sidebar-user-name {
            font-weight: 600;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .sidebar-user-email {
            font-size: 0.75rem;
            opacity: 0.8;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .sidebar-user-plan {
            font-size: 0.7rem;
            opacity: 0.7;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .sidebar-nav {
            padding: 1.5rem 0;
        }

        .nav-section {
            margin-bottom: 2rem;
        }

        .nav-section-title {
            padding: 0 1.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 0.5rem;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1.5rem;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .nav-item:hover, .nav-item.active {
            background: rgba(255, 255, 255, 0.15);
            color: var(--white);
            box-shadow: inset 4px 0 0 var(--white);
        }

        .nav-item i {
            width: 20px;
            margin-right: 12px;
            font-size: 1.1rem;
        }

        .nav-item-text {
            font-size: 0.9rem;
            font-weight: 500;
            flex: 1;
        }

        .nav-badge {
            background: rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.7rem;
            padding: 0.2rem 0.5rem;
            border-radius: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .nav-badge.new {
            background: var(--accent-pink);
            color: var(--white);
        }

        .nav-badge.soon {
            background: rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.8);
        }

        .sidebar-footer {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .logout-btn {
            width: 100%;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: var(--white);
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        /* Mobile Sidebar Toggle */
        .sidebar-toggle {
            display: none;
            position: fixed;
            top: 1rem;
            left: 1rem;
            z-index: 1001;
            background: var(--primary-purple);
            color: var(--white);
            border: none;
            border-radius: 8px;
            padding: 0.75rem;
            cursor: pointer;
            box-shadow: var(--shadow);
        }

        /* Main Content */
        .main-wrapper {
            flex: 1;
            margin-left: 280px;
            min-height: 100vh;
            transition: margin-left 0.3s ease;
        }

        .main-content {
            padding: 1.5rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .page-header {
            margin-bottom: 2rem;
        }

        .page-title {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--black);
        }

        .page-subtitle {
            color: var(--gray);
            font-size: 1rem;
            margin-top: 0.4rem;
        }

        .messages-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-box {
            flex: 1;
            min-width: 300px;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 0.8rem 1rem 0.8rem 3rem;
            border: 2px solid var(--light-gray);
            border-radius: 25px;
            font-size: 0.9rem;
            background: var(--white);
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary-purple);
            box-shadow: 0 0 15px rgba(128, 57, 223, 0.15);
        }

        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
            font-size: 1.1rem;
        }

        .messages-stats {
            display: flex;
            gap: 1rem;
        }

        .stat-item {
            text-align: center;
            padding: 0.8rem 1.2rem;
            background: var(--white);
            border-radius: 12px;
            box-shadow: var(--shadow);
            min-width: 100px;
            position: relative;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: 900;
            color: var(--primary-purple);
            margin-bottom: 0.2rem;
        }

        .stat-label {
            font-size: 0.7rem;
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .messages-filters {
            display: flex;
            gap: 0.8rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .filter-section {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .filter-label {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--dark-gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .filter-buttons {
            display: flex;
            gap: 0.8rem;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 0.6rem 1rem;
            border: 2px solid var(--light-gray);
            background: var(--white);
            color: var(--gray);
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .filter-btn:hover {
            border-color: var(--primary-purple);
            color: var(--primary-purple);
        }

        .filter-btn.active {
            background: linear-gradient(135deg, var(--primary-purple) 0%, var(--dark-purple) 100%);
            color: var(--white);
            border-color: var(--primary-purple);
        }

        /* CARD-BASED LAYOUT */
        .messages-cards-container {
            background: var(--white);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            border: 1px solid rgba(128, 57, 223, 0.08);
            position: relative;
            overflow: hidden;
        }

        .messages-cards-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-purple) 0%, var(--electric-purple) 100%);
        }

        .pagination-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--light-gray);
        }

        .showing-info {
            font-size: 0.9rem;
            color: var(--dark-gray);
            font-weight: 500;
        }

        .load-more-btn {
            background: linear-gradient(135deg, var(--primary-purple) 0%, var(--dark-purple) 100%);
            color: var(--white);
            border: none;
            border-radius: 8px;
            padding: 0.8rem 1.5rem;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: var(--glow-shadow);
        }

        .load-more-btn:hover {
            background: linear-gradient(135deg, var(--electric-purple) 0%, var(--primary-purple) 100%);
            transform: translateY(-1px);
        }

        .load-more-btn:disabled {
            background: var(--gray);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .messages-cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 2rem;
            margin-top: 1rem;
        }

        .message-card {
            background: var(--white);
            border: 3px solid var(--light-gray);
            border-radius: 16px;
            padding: 1.5rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .message-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-purple);
        }

        .message-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-purple) 0%, var(--electric-purple) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .message-card:hover::before {
            opacity: 1;
        }

        /* Target Profile Header */
        .card-profile-header {
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--light-gray);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 1rem;
        }

        .profile-info {
            flex: 1;
            min-width: 0;
        }

        .profile-name {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--black);
            margin-bottom: 0.4rem;
        }

        .profile-role {
            font-size: 1rem;
            color: var(--dark-gray);
            font-weight: 500;
            margin-bottom: 0.3rem;
        }

        .profile-company {
            font-size: 0.9rem;
            color: var(--gray);
        }

        .email-finder-header-section {
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }

        .email-finder-description {
            font-size: 0.7rem;
            color: var(--primary-purple);
            font-weight: 500;
            text-align: center;
            opacity: 0.8;
        }

        /* Email Finder Section */
        .email-finder-section {
            background: rgba(128, 57, 223, 0.03);
            border: 1px solid rgba(128, 57, 223, 0.1);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .email-finder-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.8rem;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--primary-purple);
        }

        .email-finder-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
        }

        .email-ask-btn {
            background: linear-gradient(135deg, var(--primary-purple) 0%, var(--dark-purple) 100%);
            color: var(--white);
            border: none;
            border-radius: 8px;
            padding: 0.6rem 1rem;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.4rem;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            box-shadow: var(--glow-shadow);
        }

        .email-ask-btn:hover {
            background: linear-gradient(135deg, var(--electric-purple) 0%, var(--primary-purple) 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(128, 57, 223, 0.3);
        }

        .email-ask-btn:disabled {
            background: var(--gray);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .email-ask-btn.loading {
            background: var(--warning-orange);
            cursor: not-allowed;
        }

        .email-verification {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
            font-size: 0.8rem;
        }

        .email-address {
            color: var(--dark-gray);
            font-weight: 600;
            word-break: break-all;
        }

        .email-status {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .email-status.verified {
            color: var(--success-green);
        }

        .email-status.not-found {
            color: var(--error-red);
        }

        .email-verified-date {
            font-size: 0.7rem;
            color: var(--gray);
        }

        .email-not-available {
            color: var(--gray);
            font-style: italic;
            font-size: 0.8rem;
        }

        /* Message Types Section */
        .message-types-section {
            margin-bottom: 1.5rem;
        }

        .message-type-block {
            margin-bottom: 1rem;
            padding: 1rem;
            border: 1px solid var(--light-gray);
            border-radius: 12px;
            background: rgba(128, 57, 223, 0.01);
        }

        .message-type-block.linkedin {
            border-left: 4px solid #0077B5;
        }

        .message-type-block.connection {
            border-left: 4px solid var(--accent-pink);
        }

        .message-type-block.email {
            border-left: 4px solid var(--warning-orange);
        }

        .message-type-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.8rem;
        }

        .message-type-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--dark-gray);
        }

        .message-type-label i {
            font-size: 1rem;
        }

        .message-type-label.linkedin { color: #0077B5; }
        .message-type-label.connection { color: var(--accent-pink); }
        .message-type-label.email { color: var(--warning-orange); }

        .message-actions {
            display: flex;
            gap: 0.5rem;
        }

        .expand-btn, .edit-btn, .copy-btn {
            background: var(--light-gray);
            border: 1px solid var(--gray);
            border-radius: 6px;
            padding: 0.4rem 0.8rem;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            color: var(--dark-gray);
        }

        .expand-btn:hover {
            background: #0077B5;
            color: var(--white);
            border-color: #0077B5;
        }

        .edit-btn:hover {
            background: var(--warning-orange);
            color: var(--white);
            border-color: var(--warning-orange);
        }

        .copy-btn:hover {
            background: var(--primary-purple);
            color: var(--white);
            border-color: var(--primary-purple);
        }

        .copy-btn.copied {
            background: var(--success-green);
            color: var(--white);
            border-color: var(--success-green);
        }

        .message-text {
            font-size: 0.85rem;
            line-height: 1.5;
            color: var(--dark-gray);
            background: rgba(128, 57, 223, 0.03);
            padding: 0.8rem;
            border-radius: 8px;
            white-space: pre-wrap;
            display: none;
        }

        .message-text.expanded {
            display: block;
        }

        .message-text.empty {
            color: var(--gray);
            font-style: italic;
            text-align: center;
            padding: 1.5rem;
            display: block;
        }

        .message-preview {
            font-size: 0.85rem;
            color: var(--dark-gray);
            line-height: 1.4;
            display: block;
        }

        .message-preview.hidden {
            display: none;
        }

        .message-history-item {
            margin-bottom: 0.8rem;
            padding: 0.6rem;
            border: 1px solid var(--light-gray);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.5);
            transition: all 0.3s ease;
        }

        .message-history-item.latest {
            border-color: var(--primary-purple);
            background: rgba(128, 57, 223, 0.05);
        }

        .message-history-item.collapsed {
            background: var(--light-gray);
            cursor: pointer;
        }

        .message-history-item.collapsed:hover {
            background: rgba(128, 57, 223, 0.08);
        }

        .message-timestamp {
            font-size: 0.7rem;
            color: var(--gray);
            font-weight: 600;
            margin-bottom: 0.4rem;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .message-content-preview {
            font-size: 0.85rem;
            color: var(--dark-gray);
            line-height: 1.4;
        }

        .message-version-count {
            font-size: 0.75rem;
            color: var(--primary-purple);
            font-weight: 600;
            margin-left: 0.5rem;
            padding: 0.2rem 0.5rem;
            background: rgba(128, 57, 223, 0.1);
            border-radius: 10px;
        }

        /* Status and Comments Section */
        .card-status-section {
            padding: 1rem;
            background: rgba(128, 57, 223, 0.02);
            border-radius: 12px;
            border: 1px solid rgba(128, 57, 223, 0.08);
        }

        .status-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .status-item {
            text-align: center;
        }

        .status-label {
            font-size: 0.75rem;
            color: var(--gray);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }

        .toggle-switch {
            width: 60px;
            height: 28px;
            background: var(--light-gray);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            position: relative;
            margin: 0 auto 0.5rem;
        }

        .toggle-switch.pending {
            background: var(--light-gray);
        }

        .toggle-switch.yes {
            background: linear-gradient(135deg, var(--success-green) 0%, #059669 100%);
            border-color: var(--success-green);
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.25);
        }

        .toggle-switch.no {
            background: linear-gradient(135deg, var(--error-red) 0%, #DC2626 100%);
            border-color: var(--error-red);
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.25);
        }

        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: var(--white);
            border-radius: 50%;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 700;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .toggle-switch.pending .toggle-slider {
            background: var(--gray);
            color: var(--white);
        }

        .toggle-switch.yes .toggle-slider {
            transform: translateX(32px);
            background: var(--white);
            color: var(--success-green);
        }

        .toggle-switch.no .toggle-slider {
            background: var(--white);
            color: var(--error-red);
        }

        .toggle-label {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .toggle-switch.pending + .toggle-label {
            color: var(--gray);
        }

        .toggle-switch.yes + .toggle-label {
            color: var(--success-green);
        }

        .toggle-switch.no + .toggle-label {
            color: var(--error-red);
        }

        .comment-field {
            width: 100%;
            min-height: 60px;
            max-height: 120px;
            padding: 0.8rem;
            border: 2px solid var(--light-gray);
            border-radius: 8px;
            font-size: 0.8rem;
            font-family: inherit;
            resize: vertical;
            transition: all 0.3s ease;
        }

        .comment-field:focus {
            outline: none;
            border-color: var(--primary-purple);
            box-shadow: 0 0 0 2px rgba(128, 57, 223, 0.1);
        }

        .save-btn {
            width: 100%;
            padding: 0.8rem;
            background: linear-gradient(135deg, var(--primary-purple) 0%, var(--dark-purple) 100%);
            color: var(--white);
            border: none;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            margin-top: 1rem;
            opacity: 0.6;
            transform: scale(0.98);
        }

        .save-btn.modified {
            opacity: 1;
            transform: scale(1);
            box-shadow: 0 4px 15px rgba(128, 57, 223, 0.3);
        }

        .save-btn:hover.modified {
            background: linear-gradient(135deg, var(--electric-purple) 0%, var(--primary-purple) 100%);
            transform: translateY(-1px) scale(1);
        }

        .save-btn.saving {
            background: var(--warning-orange);
            cursor: not-allowed;
        }

        .save-btn.saved {
            background: var(--success-green);
        }

        /* MODAL STYLES */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            backdrop-filter: blur(4px);
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--white);
            border-radius: 16px;
            padding: 2rem;
            max-width: 400px;
            width: 90%;
            box-shadow: var(--shadow-lg);
            transform: scale(0.9);
            transition: all 0.3s ease;
            border: 1px solid rgba(128, 57, 223, 0.1);
        }

        .modal-overlay.active .modal {
            transform: scale(1);
        }

        .modal-header {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--black);
            margin-bottom: 0.5rem;
        }

        .modal-body {
            text-align: center;
            margin-bottom: 2rem;
            color: var(--dark-gray);
            line-height: 1.5;
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        .modal-btn {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .modal-btn.primary {
            background: linear-gradient(135deg, var(--primary-purple) 0%, var(--dark-purple) 100%);
            color: var(--white);
            box-shadow: var(--glow-shadow);
        }

        .modal-btn.primary:hover {
            background: linear-gradient(135deg, var(--electric-purple) 0%, var(--primary-purple) 100%);
            transform: translateY(-1px);
        }

        .modal-btn.secondary {
            background: var(--light-gray);
            color: var(--dark-gray);
            border: 2px solid var(--light-gray);
        }

        .modal-btn.secondary:hover {
            border-color: var(--primary-purple);
            color: var(--primary-purple);
        }

        /* Loading & Empty States */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 300px;
            flex-direction: column;
            gap: 1rem;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--light-gray);
            border-top: 3px solid var(--primary-purple);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .empty-state {
            text-align: center;
            padding: 3rem 2rem;
            color: var(--gray);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: var(--primary-purple);
            opacity: 0.3;
        }

        .empty-state h3 {
            font-size: 1.2rem;
            margin-bottom: 0.6rem;
            color: var(--dark-gray);
        }

        .empty-state p {
            font-size: 0.9rem;
            line-height: 1.4;
            max-width: 400px;
            margin: 0 auto;
        }

        .refresh-btn {
            background: none;
            border: none;
            color: var(--gray);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-size: 1.1rem;
        }

        .refresh-btn:hover {
            background: var(--light-purple);
            color: var(--primary-purple);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .sidebar-toggle {
                display: block;
            }

            .main-wrapper {
                margin-left: 0;
            }

            .main-content {
                padding: 1rem;
                margin-top: 4rem;
            }

            .messages-controls {
                flex-direction: column;
            }

            .search-box {
                min-width: auto;
            }

            .messages-stats {
                justify-content: center;
                flex-wrap: wrap;
            }

            .messages-cards-grid {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }

            .status-row {
                grid-template-columns: 1fr;
                gap: 0.8rem;
            }

            .modal {
                max-width: 350px;
                padding: 1.5rem;
            }

            .filter-buttons {
                justify-content: center;
            }
        }

        @media (min-width: 769px) and (max-width: 1200px) {
            .messages-cards-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (min-width: 1201px) {
            .messages-cards-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
    </style>
</head>
<body>
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5CNT3VV9"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->
    <!-- Mobile Sidebar Toggle -->
    <button class="sidebar-toggle" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Side Navigation -->
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <a href="https://api.msgly.ai/dashboard" class="sidebar-logo">
                <i class="fas fa-comments"></i>
                <div class="sidebar-logo-text">
                    <div class="sidebar-logo-main">Msgly.AI</div>
                    <div class="sidebar-logo-sub">By Chopa AI LTD</div>
                </div>
            </a>
            
            <div class="sidebar-user">
                <div class="sidebar-user-avatar" id="sidebarUserAvatar">??</div>
                <div class="sidebar-user-info">
                    <div class="sidebar-user-name" id="sidebarUserName">Loading...</div>
                    <div class="sidebar-user-email" id="sidebarUserEmail">Loading...</div>
                    <div class="sidebar-user-plan" id="sidebarUserPlan">Loading...</div>
                </div>
            </div>
        </div>

        <div class="sidebar-nav">
            <div class="nav-section">
                <div class="nav-section-title">Main Menu</div>
                <a href="https://api.msgly.ai/dashboard" class="nav-item">
                    <i class="fas fa-tachometer-alt"></i>
                    <span class="nav-item-text">Dashboard</span>
                </a>
                <a href="https://api.msgly.ai/msgly-profile.html" class="nav-item">
                    <i class="fas fa-user-circle"></i>
                    <span class="nav-item-text">Msgly Profile</span>
                </a>
                <a href="https://api.msgly.ai/messages" class="nav-item active">
                    <i class="fas fa-envelope"></i>
                    <span class="nav-item-text">Messages</span>
                </a>
                <a href="#" class="nav-item" onclick="alert('Analytics coming soon!')">
                    <i class="fas fa-chart-line"></i>
                    <span class="nav-item-text">Analytics</span>
                    <span class="nav-badge soon">Soon</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Account</div>
                <a href="https://chopa.chargebeeportal.com/portal/v2/login?forward=portal_main" class="nav-item" target="_blank">
                    <i class="fas fa-credit-card"></i>
                    <span class="nav-item-text">Billing</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Support</div>
                <a href="#" class="nav-item" onclick="alert('Help Center coming soon!')">
                    <i class="fas fa-question-circle"></i>
                    <span class="nav-item-text">Help Center</span>
                </a>
            </div>
        </div>

        <div class="sidebar-footer">
            <a href="#" class="logout-btn" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i>
                Logout
            </a>
        </div>
    </nav>

    <!-- Email Finder Modals -->
    <div class="modal-overlay" id="emailFinderModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Find & Verify Email</div>
            </div>
            <div class="modal-body">
                We'll search for this contact's email address. You'll only be charged 2 credits if we successfully find and verify an email. Continue?
            </div>
            <div class="modal-actions">
                <button class="modal-btn secondary" onclick="closeEmailModal()">Cancel</button>
                <button class="modal-btn primary" onclick="confirmEmailFinder()">Yes, Find Email</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="insufficientCreditsModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Not Enough Credits</div>
            </div>
            <div class="modal-body">
                You don't have enough credits to perform this action.
            </div>
            <div class="modal-actions">
                <button class="modal-btn secondary" onclick="closeInsufficientCreditsModal()">Cancel</button>
                <button class="modal-btn primary" onclick="window.open('https://chopa.chargebeeportal.com/portal/v2/login?forward=portal_main', '_blank')">Buy Credits</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="upgradeModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Upgrade Required</div>
            </div>
            <div class="modal-body">
                Email finder is available for Silver, Gold, and Platinum subscribers. Upgrade your plan to unlock this feature and find verified email addresses for your LinkedIn contacts.
            </div>
            <div class="modal-actions">
                <button class="modal-btn secondary" onclick="closeUpgradeModal()">Cancel</button>
                <button class="modal-btn primary" onclick="window.open('https://chopa.chargebeeportal.com/portal/v2/login?forward=portal_main', '_blank')">Upgrade Plan</button>
            </div>
        </div>
    </div>

    <!-- Main Content Wrapper -->
    <div class="main-wrapper">
        <main class="main-content">
            <div class="container">
        <div class="page-header">
            <div>
                <h1 class="page-title">Messages</h1>
                <p class="page-subtitle">Manage your LinkedIn outreach campaigns and track responses</p>
            </div>
        </div>

        <div class="messages-controls">
            <div class="search-box">
                <i class="fas fa-search search-icon"></i>
                <input type="text" class="search-input" placeholder="Search messages, names, companies..." 
                       id="searchInput" oninput="searchMessages(this.value)">
            </div>
            <div class="messages-stats">
                <div class="stat-item">
                    <div class="stat-number" id="totalMessages">0</div>
                    <div class="stat-label">Total</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="sentMessages">0</div>
                    <div class="stat-label">Sent</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="repliedMessages">0</div>
                    <div class="stat-label">Replied</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="responseRate">0%</div>
                    <div class="stat-label">Response Rate</div>
                </div>
            </div>
            <button class="refresh-btn" onclick="refreshMessages()" title="Refresh Messages">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>

        <!-- ENHANCED FILTER SYSTEM -->
        <div class="messages-filters">
            <!-- Status Filter -->
            <div class="filter-section">
                <div class="filter-label">Status</div>
                <div class="filter-buttons">
                    <button class="filter-btn active" onclick="filterByStatus('all')">
                        <i class="fas fa-list"></i>
                        All
                    </button>
                    <button class="filter-btn" onclick="filterByStatus('sent')">
                        <i class="fas fa-paper-plane"></i>
                        Sent
                    </button>
                    <button class="filter-btn" onclick="filterByStatus('replied')">
                        <i class="fas fa-reply"></i>
                        Replied
                    </button>
                    <button class="filter-btn" onclick="filterByStatus('pending')">
                        <i class="fas fa-clock"></i>
                        Pending
                    </button>
                </div>
            </div>

            <!-- Message Type Filter -->
            <div class="filter-section">
                <div class="filter-label">Message Type</div>
                <div class="filter-buttons">
                    <button class="filter-btn active" onclick="filterByMessageType('all')" id="typeFilterAll">
                        <i class="fas fa-th-large"></i>
                        All Types
                    </button>
                    <button class="filter-btn" onclick="filterByMessageType('linkedin')" id="typeFilterLinkedin">
                        <i class="fab fa-linkedin"></i>
                        LinkedIn
                    </button>
                    <button class="filter-btn" onclick="filterByMessageType('connection')" id="typeFilterConnection">
                        <i class="fas fa-user-plus"></i>
                        Connection
                    </button>
                    <button class="filter-btn" onclick="filterByMessageType('email')" id="typeFilterEmail">
                        <i class="fas fa-envelope"></i>
                        Email
                    </button>
                </div>
            </div>

            <!-- Date Range Filter -->
            <div class="filter-section">
                <div class="filter-label">Date Range</div>
                <div class="filter-buttons">
                    <button class="filter-btn active" onclick="filterByDateRange('all')" id="dateFilterAll">
                        <i class="fas fa-calendar"></i>
                        All Time
                    </button>
                    <button class="filter-btn" onclick="filterByDateRange('7days')" id="dateFilter7days">
                        <i class="fas fa-calendar-week"></i>
                        Last 7 Days
                    </button>
                    <button class="filter-btn" onclick="filterByDateRange('30days')" id="dateFilter30days">
                        <i class="fas fa-calendar-alt"></i>
                        30 Days
                    </button>
                    <button class="filter-btn" onclick="filterByDateRange('3months')" id="dateFilter3months">
                        <i class="fas fa-calendar-day"></i>
                        3 Months
                    </button>
                    <button class="filter-btn" onclick="filterByDateRange('1year')" id="dateFilter1year">
                        <i class="fas fa-calendar-times"></i>
                        1 Year
                    </button>
                </div>
            </div>
        </div>

        <div class="messages-cards-container">
            <!-- Loading State -->
            <div class="loading" id="loadingState">
                <div class="spinner"></div>
                <p>Loading messages...</p>
            </div>

            <!-- Pagination Info -->
            <div class="pagination-info" id="paginationInfo" style="display: none;">
                <div class="showing-info" id="showingInfo">Showing 21 of X newest messages</div>
                <button class="load-more-btn" id="loadMoreBtn" onclick="toggleShowAll()">
                    <i class="fas fa-eye"></i>
                    Show All Messages
                </button>
            </div>

            <!-- Cards Grid -->
            <div class="messages-cards-grid" id="messagesCardsGrid" style="display: none;">
                <!-- Message cards will be populated here -->
            </div>

            <!-- Empty State -->
            <div class="empty-state" id="emptyState" style="display: none;">
                <i class="fas fa-envelope-open"></i>
                <h3>No Messages Found</h3>
                <p>Generate your first LinkedIn message using the Chrome extension, then return here to track your outreach campaign.</p>
            </div>
        </div>
            </div>
        </main>
    </div>

    <script>
        // Global variables
        let messagesData = [];
        let filteredMessages = [];
        let groupedMessages = {};
        let currentStatusFilter = 'all';
        let currentMessageTypeFilter = 'all';
        let currentDateRangeFilter = 'all';
        let currentSearchTerm = '';
        let pendingChanges = new Map();
        let currentTargetId = null; 
        let currentUserPlan = null;
        let showingLimited = true; // NEW: Track if we're showing limited results
        let CARDS_LIMIT = 21; // NEW: Number of cards to show initially

        // Authentication check and data loading
        document.addEventListener('DOMContentLoaded', function() {
            if (!checkAuthentication()) {
                return;
            }
            loadUserProfile();
            loadMessagesData();
        });

        function checkAuthentication() {
            const token = getAuthToken();
            if (!token) {
                window.location.href = '/login';
                return false;
            }
            return true;
        }

        function getAuthToken() {
            return localStorage.getItem('authToken');
        }

        // Load user profile for sidebar
        async function loadUserProfile() {
            try {
                const token = getAuthToken();
                if (!token) {
                    window.location.href = '/login';
                    return;
                }

                const response = await fetch('/profile', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.status === 401) {
                    localStorage.removeItem('authToken');
                    window.location.href = '/login';
                    return;
                }

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                
                if (data.success) {
                    const user = data.data.user;
                    
                    currentUserPlan = {
                        planCode: user.planCode || 'free',
                        totalCredits: user.totalCredits || 0,
                        planName: user.planName || 'Free'
                    };
                    
                    document.getElementById('sidebarUserName').textContent = user.displayName || user.email;
                    document.getElementById('sidebarUserEmail').textContent = user.email;
                    
                    const planCode = user.planCode || 'free';
                    const planNames = {
                        'free': 'Free Plan',
                        'silver-monthly': 'Silver Monthly',
                        'silver-payasyougo': 'Silver Pay-as-you-go',
                        'gold-monthly': 'Gold Monthly', 
                        'gold-payasyougo': 'Gold Pay-as-you-go',
                        'platinum-monthly': 'Platinum Monthly',
                        'platinum-payasyougo': 'Platinum Pay-as-you-go'
                    };
                    document.getElementById('sidebarUserPlan').textContent = planNames[planCode] || 'Unknown Plan';
                    
                    const displayName = user.displayName || user.email;
                    const initials = getInitials(displayName);
                    document.getElementById('sidebarUserAvatar').textContent = initials;
                    
                    console.log('[PROFILE] User profile loaded successfully');
                } else {
                    throw new Error(data.error || 'Failed to load profile');
                }
                
            } catch (error) {
                console.error('[PROFILE] Error loading user profile:', error);
                document.getElementById('sidebarUserName').textContent = 'User';
                document.getElementById('sidebarUserEmail').textContent = 'user@example.com';
                document.getElementById('sidebarUserPlan').textContent = 'Free Plan';
                document.getElementById('sidebarUserAvatar').textContent = 'U';
            }
        }

        function getInitials(name) {
            if (!name) return '??';
            
            const parts = name.split(' ');
            if (parts.length >= 2) {
                return (parts[0][0] + parts[1][0]).toUpperCase();
            } else {
                return name.substring(0, 2).toUpperCase();
            }
        }

        // Load messages data from API
        async function loadMessagesData() {
            try {
                document.getElementById('loadingState').style.display = 'flex';
                
                const token = getAuthToken();
                if (!token) {
                    window.location.href = '/login';
                    return;
                }
                
                console.log('[MESSAGES] Loading messages from API...');
                
                const response = await fetch('/messages/history', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.status === 401) {
                    localStorage.removeItem('authToken');
                    window.location.href = '/login';
                    return;
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    messagesData = data.data || [];
                    console.log(`[MESSAGES] Loaded ${messagesData.length} messages from database`);
                    groupMessagesByTarget();
                } else {
                    throw new Error(data.error || 'Failed to load messages');
                }
                
                applyFilters();
                
            } catch (error) {
                console.error('[MESSAGES] Error loading messages:', error);
                
                if (error.message && error.message.includes('401')) {
                    localStorage.removeItem('authToken');
                    window.location.href = '/login';
                    return;
                }
                
                showEmptyState();
            }
        }

        // Group messages by target profile with ENHANCED CONNECTION REQUEST DETECTION
        function groupMessagesByTarget() {
            groupedMessages = {};
            
            messagesData.forEach(message => {
                const targetKey = message.targetProfile.firstName + '_' + message.targetProfile.company;
                
                if (!groupedMessages[targetKey]) {
                    // FIXED: Handle different date field formats from database
                    const messageDate = new Date(message.created_at || message.createdAt || Date.now());
                    
                    groupedMessages[targetKey] = {
                        target: message.targetProfile,
                        messages: {
                            linkedin: [],
                            connection: [],
                            email: []
                        },
                        // Use the first message's metadata for status/comments
                        id: message.id,
                        sent: message.sent,
                        gotReply: message.gotReply,
                        comments: message.comments,
                        emailFound: message.emailFound,
                        emailStatus: message.emailStatus,
                        emailVerifiedAt: message.emailVerifiedAt,
                        latestMessageDate: messageDate // Track latest message date for sorting
                    };
                } else {
                    // Update latest message date if this message is newer
                    const messageDate = new Date(message.created_at || message.createdAt || Date.now());
                    if (messageDate > groupedMessages[targetKey].latestMessageDate) {
                        groupedMessages[targetKey].latestMessageDate = messageDate;
                    }
                }
                
                // ENHANCED content-based message type detection
                const messageContent = (message.message || '').toLowerCase();
                const messageType = detectMessageType(messageContent);
                
                console.log(`[DETECT] Message ID ${message.id}: "${messageType.toUpperCase()}" - Content: "${messageContent.substring(0, 50)}..."`);
                
                if (messageType === 'connection') {
                    groupedMessages[targetKey].messages.connection.push(message);
                } else if (messageType === 'email') {
                    groupedMessages[targetKey].messages.email.push(message);
                } else {
                    groupedMessages[targetKey].messages.linkedin.push(message);
                }
            });
            
            // Sort messages within each type by creation date (newest first)
            Object.values(groupedMessages).forEach(group => {
                group.messages.linkedin.sort((a, b) => new Date(b.created_at || b.createdAt || 0) - new Date(a.created_at || a.createdAt || 0));
                group.messages.connection.sort((a, b) => new Date(b.created_at || b.createdAt || 0) - new Date(a.created_at || a.createdAt || 0));
                group.messages.email.sort((a, b) => new Date(b.created_at || b.createdAt || 0) - new Date(a.created_at || a.createdAt || 0));
            });
            
            console.log('[MESSAGES] Grouped into', Object.keys(groupedMessages).length, 'target profiles with message history');
        }

        // FIXED: Enhanced message type detection with comprehensive patterns
        function detectMessageType(messageContent) {
            const content = messageContent.toLowerCase().trim();
            
            console.log(`[DETECT] Analyzing content: "${content.substring(0, 60)}..."`);
            
            // Cold Email indicators (check first as they're most specific)
            if (content.includes('subject:') || 
                content.match(/^subject\s*[:]\s*/m) ||
                content.includes('dear ') || 
                content.includes('hope this email finds you') ||
                content.includes('email') && content.includes('regarding') ||
                content.includes('from tech to table') ||
                content.includes('post helping laid-off folks')) {
                console.log('[DETECT]  COLD EMAIL (found email indicators)');
                return 'email';
            }
            
            // COMPREHENSIVE Connection Request indicators
            const connectionKeywords = [
                'connect', 'connection', 'network', 'networking',
                'would love to connect', "i'd love to connect", "love to connect",
                'add you to my network', 'build my network', 'expand my network',
                'send you a connection', 'accept my connection', 'linkedin connection',
                'professional network', 'connect with you', 'connect on linkedin',
                'co-founder at chopa ai', 'love your le cordon bleu', 'ex-linkedin/gong',
                'ex-linkedin, co-founder', 'ex-linkedin and co', 'ex-linkedin; co-founder'
            ];
            
            // Check for direct connection keywords
            const hasDirectConnectionWords = connectionKeywords.some(keyword => 
                content.includes(keyword)
            );
            
            // Check for short congratulatory messages (typical connection requests)
            const isShortCongrats = content.length < 300 && 
                (content.includes('congrats') || content.includes('congratulations')) &&
                (content.includes('role') || content.includes('position') || content.includes('job') || 
                 content.includes('ceo') || content.includes('co-founder') || content.includes('build'));
            
            // Check for LinkedIn context mentions
            const hasLinkedInContext = content.includes('ex-linkedin') || 
                                     content.includes('linkedin') ||
                                     content.includes('co-founder') ||
                                     content.includes('love your') ||
                                     content.includes('nice notion post');
            
            if (hasDirectConnectionWords || (isShortCongrats && hasLinkedInContext)) {
                console.log('[DETECT]  CONNECTION REQUEST (found connection indicators)');
                return 'connection';
            }
            
            // Default to LinkedIn message
            console.log('[DETECT]  LINKEDIN MESSAGE (default)');
            return 'linkedin';
        }

        // NEW: Filter functions with date range support
        function applyFilters() {
            let filtered = Object.values(groupedMessages);
            
            // Apply status filter
            filtered = filterMessagesByStatus(filtered);
            
            // Apply message type filter
            filtered = filterMessagesByType(filtered);
            
            // Apply date range filter
            filtered = filterMessagesByDateRange(filtered);
            
            // Apply search filter
            if (currentSearchTerm) {
                filtered = filtered.filter(group => {
                    const target = group.target;
                    const messages = group.messages;
                    
                    // Search in target profile
                    const targetMatch = (
                        (target.firstName && target.firstName.toLowerCase().includes(currentSearchTerm.toLowerCase())) ||
                        (target.role && target.role.toLowerCase().includes(currentSearchTerm.toLowerCase())) ||
                        (target.company && target.company.toLowerCase().includes(currentSearchTerm.toLowerCase())) ||
                        (group.comments && group.comments.toLowerCase().includes(currentSearchTerm.toLowerCase()))
                    );
                    
                    // Search in all message arrays
                    const messageMatch = ['linkedin', 'connection', 'email'].some(type => {
                        const messageArray = messages[type];
                        if (Array.isArray(messageArray)) {
                            return messageArray.some(msg => 
                                msg.message && msg.message.toLowerCase().includes(currentSearchTerm.toLowerCase())
                            );
                        }
                        return false;
                    });
                    
                    return targetMatch || messageMatch;
                });
            }
            
            // Sort by latest message date (newest first)
            filtered.sort((a, b) => b.latestMessageDate - a.latestMessageDate);
            
            filteredMessages = filtered;
            renderMessages();
            updateMessagesStats();
        }

        // NEW: Message type filtering
        function filterMessagesByType(messageGroups) {
            if (currentMessageTypeFilter === 'all') {
                return messageGroups;
            }
            
            return messageGroups.filter(group => {
                const messages = group.messages;
                switch (currentMessageTypeFilter) {
                    case 'linkedin':
                        return messages.linkedin && messages.linkedin.length > 0;
                    case 'connection':
                        return messages.connection && messages.connection.length > 0;
                    case 'email':
                        return messages.email && messages.email.length > 0;
                    default:
                        return true;
                }
            });
        }

        // NEW: Date range filtering
        function filterMessagesByDateRange(messageGroups) {
            if (currentDateRangeFilter === 'all') {
                return messageGroups;
            }
            
            const now = new Date();
            let cutoffDate;
            
            switch (currentDateRangeFilter) {
                case '7days':
                    cutoffDate = new Date(now.getTime() - (7 * 24 * 60 * 60 * 1000));
                    break;
                case '30days':
                    cutoffDate = new Date(now.getTime() - (30 * 24 * 60 * 60 * 1000));
                    break;
                case '3months':
                    cutoffDate = new Date(now.getTime() - (90 * 24 * 60 * 60 * 1000));
                    break;
                case '1year':
                    cutoffDate = new Date(now.getTime() - (365 * 24 * 60 * 60 * 1000));
                    break;
                default:
                    return messageGroups;
            }
            
            return messageGroups.filter(group => {
                return group.latestMessageDate >= cutoffDate;
            });
        }

        function searchMessages(searchTerm) {
            currentSearchTerm = searchTerm.trim();
            applyFilters();
        }

        // NEW: Individual filter functions for UI
        function filterByStatus(status) {
            currentStatusFilter = status;
            
            // Update UI
            document.querySelectorAll('.filter-section:first-child .filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            applyFilters();
        }

        function filterByMessageType(type) {
            currentMessageTypeFilter = type;
            
            // Update UI
            document.querySelectorAll('.filter-section:nth-child(2) .filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            applyFilters();
        }

        function filterByDateRange(range) {
            currentDateRangeFilter = range;
            
            // Update UI
            document.querySelectorAll('.filter-section:nth-child(3) .filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            applyFilters();
        }

        // NEW: Pagination control
        function toggleShowAll() {
            showingLimited = !showingLimited;
            renderMessages();
        }

        function renderMessages() {
            const cardsGrid = document.getElementById('messagesCardsGrid');
            const paginationInfo = document.getElementById('paginationInfo');
            const loadMoreBtn = document.getElementById('loadMoreBtn');
            const showingInfo = document.getElementById('showingInfo');
            
            if (filteredMessages.length === 0) {
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('messagesCardsGrid').style.display = 'none';
                document.getElementById('emptyState').style.display = 'block';
                paginationInfo.style.display = 'none';
                return;
            }
            
            // Determine how many messages to show
            let messagesToShow = filteredMessages;
            if (showingLimited && filteredMessages.length > CARDS_LIMIT) {
                messagesToShow = filteredMessages.slice(0, CARDS_LIMIT);
            }
            
            cardsGrid.innerHTML = '';
            
            messagesToShow.forEach(messageGroup => {
                const messageCard = createMessageCard(messageGroup);
                cardsGrid.appendChild(messageCard);
            });
            
            // Update pagination info
            if (filteredMessages.length > CARDS_LIMIT) {
                paginationInfo.style.display = 'flex';
                
                if (showingLimited) {
                    showingInfo.textContent = `Showing ${CARDS_LIMIT} of ${filteredMessages.length} newest messages`;
                    loadMoreBtn.innerHTML = '<i class="fas fa-eye"></i> Show All Messages';
                } else {
                    showingInfo.textContent = `Showing all ${filteredMessages.length} messages`;
                    loadMoreBtn.innerHTML = '<i class="fas fa-eye-slash"></i> Show Recent Only';
                }
            } else {
                paginationInfo.style.display = 'none';
            }
            
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('messagesCardsGrid').style.display = 'grid';
            document.getElementById('emptyState').style.display = 'none';
        }

        function createMessageCard(messageGroup) {
            const card = document.createElement('div');
            card.className = 'message-card';
            card.setAttribute('data-target-id', messageGroup.id);
            
            const target = messageGroup.target;
            const messages = messageGroup.messages;
            
            card.innerHTML = `
                <div class="card-profile-header">
                    <div class="profile-info">
                        <div class="profile-name">${target.firstName || 'Unknown'}</div>
                        <div class="profile-role">${target.role || 'Professional'}</div>
                        <div class="profile-company">${target.company || 'Company'}</div>
                    </div>
                    <div class="email-finder-header-section">
                        ${createEmailAskButton(messageGroup)}
                        <div class="email-finder-description">Email Finder (powered by Snov.io)</div>
                        ${createEmailVerificationDisplay(messageGroup)}
                    </div>
                </div>

                <div class="message-types-section">
                    ${messages.linkedin.length > 0 ? createMessageTypeBlock('linkedin', 'LinkedIn Message', messages.linkedin, 'fab fa-linkedin') : ''}
                    ${messages.connection.length > 0 ? createMessageTypeBlock('connection', 'Connection Request', messages.connection, 'fas fa-user-plus') : ''}
                    ${messages.email.length > 0 ? createMessageTypeBlock('email', 'Cold Email', messages.email, 'fas fa-envelope') : ''}
                </div>

                <div class="card-status-section">
                    <div class="status-row">
                        <div class="status-item">
                            <div class="status-label">Message Sent</div>
                            <div class="toggle-switch ${messageGroup.sent}" onclick="toggleStatus(${messageGroup.id}, 'sent')">
                                <div class="toggle-slider">${getStatusIcon(messageGroup.sent)}</div>
                            </div>
                            <div class="toggle-label">${getStatusLabel(messageGroup.sent)}</div>
                        </div>
                        
                        <div class="status-item">
                            <div class="status-label">Got Reply</div>
                            <div class="toggle-switch ${messageGroup.gotReply}" onclick="toggleStatus(${messageGroup.id}, 'gotReply')">
                                <div class="toggle-slider">${getStatusIcon(messageGroup.gotReply)}</div>
                            </div>
                            <div class="toggle-label">${getStatusLabel(messageGroup.gotReply)}</div>
                        </div>
                    </div>
                    
                    <textarea 
                        class="comment-field" 
                        placeholder="Add notes about this contact..."
                        onchange="updateComment(${messageGroup.id}, this.value)"
                        onkeyup="markFieldModified(${messageGroup.id})"
                    >${messageGroup.comments || ''}</textarea>
                    
                    <button class="save-btn" id="save-${messageGroup.id}" onclick="saveMessage(${messageGroup.id})">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                </div>
            `;
            
            return card;
        }

        function createMessageTypeBlock(type, label, messagesArray, iconClass) {
            if (!messagesArray || messagesArray.length === 0) {
                return '';
            }

            const latestMessage = messagesArray[0];
            const latestMessageText = cleanMessageText(latestMessage.message || '');
            const latestPreview = latestMessageText.length > 80 ? latestMessageText.substring(0, 80) + '...' : latestMessageText;
            const uniqueId = `${type}-${latestMessage.id}`;
            const hasMultiple = messagesArray.length > 1;
            
            let historyHTML = '';
            
            // Show latest message with FIXED date handling
            historyHTML += `
                <div class="message-history-item latest">
                    <div class="message-timestamp">
                        <i class="fas fa-clock"></i>
                        Latest: ${formatMessageDate(latestMessage.created_at || latestMessage.createdAt)}
                    </div>
                    <div class="message-content-preview" id="preview-${uniqueId}">${latestPreview}</div>
                    <div class="message-text" id="message-${uniqueId}" style="display: none;">
                        ${latestMessageText}
                    </div>
                </div>
            `;
            
            // Show previous messages (collapsed by default)
            if (hasMultiple) {
                historyHTML += `<div class="message-history-previous" id="history-${uniqueId}" style="display: none;">`;
                
                messagesArray.slice(1).forEach((msg, index) => {
                    const msgText = cleanMessageText(msg.message || '');
                    const msgPreview = msgText.length > 60 ? msgText.substring(0, 60) + '...' : msgText;
                    const msgUniqueId = `${type}-${msg.id}`;
                    
                    historyHTML += `
                        <div class="message-history-item collapsed" onclick="toggleHistoryMessage('${msgUniqueId}', this)">
                            <div class="message-timestamp">
                                <i class="fas fa-history"></i>
                                Previous: ${formatMessageDate(msg.created_at || msg.createdAt)}
                            </div>
                            <div class="message-content-preview" id="preview-${msgUniqueId}">${msgPreview}</div>
                            <div class="message-text" id="message-${msgUniqueId}" style="display: none;">
                                ${msgText}
                            </div>
                        </div>
                    `;
                });
                
                historyHTML += `</div>`;
            }
            
            return `
                <div class="message-type-block ${type}">
                    <div class="message-type-header">
                        <div class="message-type-label ${type}">
                            <i class="${iconClass}"></i>
                            ${label}
                        </div>
                        <div class="message-actions">
                            <button class="edit-btn" onclick="editMessage('${type}', ${latestMessage.id})">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="copy-btn" onclick="copyMessage('${type}', ${latestMessage.id}, this)">
                                <i class="fas fa-copy"></i> Copy
                            </button>
                        </div>
                    </div>
                    ${historyHTML}
                    <div style="display: flex; align-items: center; justify-content: center; gap: 1rem; margin-top: 0.8rem;">
                        ${hasMultiple ? `
                        <button class="expand-btn" onclick="toggleMessageHistory('${uniqueId}', this)">
                            <i class="fas fa-history"></i> History
                        </button>` : ''}
                        <button class="expand-btn" onclick="toggleMessageExpand('${uniqueId}', this)">
                            <i class="fas fa-chevron-down"></i> Expand
                        </button>
                        ${hasMultiple ? `<span class="message-version-count">${messagesArray.length} versions</span>` : ''}
                    </div>
                </div>
            `;
        }

        function createEmailAskButton(messageGroup) {
            if (messageGroup.emailStatus === 'verified' || messageGroup.emailStatus === 'not_found') {
                return `<button class="email-ask-btn" disabled title="Email already processed.">
                    <i class="fas fa-check"></i> Done
                </button>`;
            }
            
            return `<button class="email-ask-btn" onclick="showEmailFinderModal(${messageGroup.id})" title="Ask Email (2 credits)">
                <i class="fas fa-search"></i> Ask Email
            </button>`;
        }

        function createEmailVerificationDisplay(messageGroup) {
            if (!messageGroup.emailStatus) {
                return `<div class="email-not-available">Not searched</div>`;
            }
            
            if (messageGroup.emailStatus === 'verified') {
                const verifiedDate = messageGroup.emailVerifiedAt ? new Date(messageGroup.emailVerifiedAt).toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric' 
                }) : '';
                return `<div class="email-verification">
                    <div class="email-address">${messageGroup.emailFound || 'N/A'}</div>
                    <div class="email-status verified">
                        <i class="fas fa-check-circle"></i> Verified
                    </div>
                    ${verifiedDate ? `<div class="email-verified-date">Verified: ${verifiedDate}</div>` : ''}
                </div>`;
            } else if (messageGroup.emailStatus === 'not_found') {
                const verifiedDate = messageGroup.emailVerifiedAt ? new Date(messageGroup.emailVerifiedAt).toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric' 
                }) : '';
                return `<div class="email-verification">
                    <div class="email-status not-found">
                        <i class="fas fa-times-circle"></i> Not Found
                    </div>
                    ${verifiedDate ? `<div class="email-verified-date">Searched: ${verifiedDate}</div>` : ''}
                </div>`;
            }
            
            return `<div class="email-not-available">Not searched</div>`;
        }

        // FIXED: Format message date with comprehensive error handling and field compatibility
        function formatMessageDate(dateString) {
            try {
                // Handle multiple possible date field formats
                let dateToFormat = dateString;
                
                // If dateString is null/undefined, try to find a valid date
                if (!dateToFormat) {
                    console.warn('[DATE] No date provided, using current time');
                    return 'Just now';
                }
                
                const date = new Date(dateToFormat);
                
                // Check if date is valid
                if (isNaN(date.getTime())) {
                    console.warn('[DATE] Invalid date string:', dateString);
                    return 'Date unavailable';
                }
                
                const now = new Date();
                const diffTime = now - date;
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                
                if (diffDays === 0) {
                    return date.toLocaleTimeString('en-US', { 
                        hour: '2-digit', 
                        minute: '2-digit',
                        hour12: true 
                    }) + ' (today)';
                } else if (diffDays === 1) {
                    return date.toLocaleTimeString('en-US', { 
                        hour: '2-digit', 
                        minute: '2-digit',
                        hour12: true 
                    }) + ' (yesterday)';
                } else if (diffDays < 7) {
                    return date.toLocaleDateString('en-US', { 
                        weekday: 'short',
                        hour: '2-digit', 
                        minute: '2-digit',
                        hour12: true 
                    });
                } else {
                    return date.toLocaleDateString('en-US', {
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: true
                    });
                }
            } catch (error) {
                console.error('[DATE] Error formatting date:', error, 'Input:', dateString);
                return 'Date error';
            }
        }

        // Toggle message history visibility
        function toggleMessageHistory(messageId, button) {
            const historyElement = document.getElementById(`history-${messageId}`);
            const isVisible = historyElement.style.display !== 'none';
            
            if (isVisible) {
                historyElement.style.display = 'none';
                button.innerHTML = '<i class="fas fa-history"></i> History';
            } else {
                historyElement.style.display = 'block';
                button.innerHTML = '<i class="fas fa-history"></i> Hide History';
            }
        }

        // Toggle individual historical message
        function toggleHistoryMessage(messageId, element) {
            const messageElement = document.getElementById(`message-${messageId}`);
            const previewElement = document.getElementById(`preview-${messageId}`);
            const isExpanded = messageElement.style.display !== 'none';
            
            if (isExpanded) {
                messageElement.style.display = 'none';
                previewElement.style.display = 'block';
                element.classList.add('collapsed');
            } else {
                messageElement.style.display = 'block';
                previewElement.style.display = 'none';
                element.classList.remove('collapsed');
            }
        }

        // FIXED: Toggle message expand/collapse with preview hide/show
        function toggleMessageExpand(messageId, button) {
            const messageElement = document.getElementById(`message-${messageId}`);
            const previewElement = document.getElementById(`preview-${messageId}`);
            
            if (!messageElement || !previewElement) {
                console.error(`[EXPAND] Elements not found for message: ${messageId}`);
                return;
            }
            
            const isExpanded = messageElement.style.display === 'block';
            
            if (isExpanded) {
                // Collapse: hide full message, show preview
                messageElement.style.display = 'none';
                previewElement.style.display = 'block';
                button.innerHTML = '<i class="fas fa-chevron-down"></i> Expand';
            } else {
                // Expand: show full message, hide preview
                messageElement.style.display = 'block';
                previewElement.style.display = 'none';
                button.innerHTML = '<i class="fas fa-chevron-up"></i> Collapse';
            }
            
            console.log(`[EXPAND] Toggled message ${messageId}: ${isExpanded ? 'collapsed' : 'expanded'}`);
        }

        // Edit message functionality (placeholder for future implementation)
        function editMessage(type, messageId) {
            alert(`Edit functionality for ${type} message (ID: ${messageId}) will be implemented in a future update.`);
            console.log(`[EDIT] Edit requested for ${type} message ID: ${messageId}`);
        }

        // Copy message functionality
        async function copyMessage(type, messageId, button) {
            try {
                // Find the specific message by ID across all message groups
                let targetMessage = null;
                Object.values(groupedMessages).forEach(group => {
                    ['linkedin', 'connection', 'email'].forEach(messageType => {
                        const messages = group.messages[messageType];
                        if (Array.isArray(messages)) {
                            const found = messages.find(m => m.id === messageId);
                            if (found) targetMessage = found;
                        }
                    });
                });
                
                if (!targetMessage || !targetMessage.message) {
                    throw new Error('Message not found');
                }
                
                const cleanMessage = cleanMessageText(targetMessage.message);
                
                await navigator.clipboard.writeText(cleanMessage);
                
                const originalHTML = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check"></i> Copied!';
                button.classList.add('copied');
                
                setTimeout(() => {
                    button.innerHTML = originalHTML;
                    button.classList.remove('copied');
                }, 2000);
                
                console.log(`[COPY] ${type} message copied to clipboard`);
                
            } catch (error) {
                console.error('[COPY] Error copying message:', error);
                
                const originalHTML = button.innerHTML;
                button.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Error';
                
                setTimeout(() => {
                    button.innerHTML = originalHTML;
                }, 2000);
            }
        }

        function cleanMessageText(messageText) {
            if (!messageText) return '';
            
            const cleanedText = messageText.replace(/^MSG_\d+\s*/i, '');
            const finalText = cleanedText.replace(/^Subject:\s*/i, '');
            
            return finalText.trim();
        }

        // Email Finder modal functions
        function showEmailFinderModal(targetId) {
            currentTargetId = targetId;
            
            if (currentUserPlan && currentUserPlan.planCode === 'free') {
                console.log('[EMAIL_FINDER] Free user detected, showing upgrade modal');
                document.getElementById('upgradeModal').classList.add('active');
                return;
            }
            
            if (currentUserPlan && currentUserPlan.totalCredits < 2) {
                console.log('[EMAIL_FINDER] Insufficient credits, showing credits modal');
                document.getElementById('insufficientCreditsModal').classList.add('active');
                return;
            }
            
            console.log('[EMAIL_FINDER] Showing email finder modal for paid user');
            document.getElementById('emailFinderModal').classList.add('active');
        }

        function closeEmailModal() {
            document.getElementById('emailFinderModal').classList.remove('active');
            currentTargetId = null;
        }

        function closeInsufficientCreditsModal() {
            document.getElementById('insufficientCreditsModal').classList.remove('active');
        }

        function closeUpgradeModal() {
            document.getElementById('upgradeModal').classList.remove('active');
        }

        async function confirmEmailFinder() {
            if (!currentTargetId) return;
            
            closeEmailModal();
            
            console.log(`[EMAIL_FINDER] Starting email finder for target ${currentTargetId} (STUB MODE)`);
            
            const buttons = document.querySelectorAll(`[onclick*="showEmailFinderModal(${currentTargetId})"]`);
            buttons.forEach(btn => {
                btn.classList.add('loading');
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Finding...';
                btn.disabled = true;
            });
            
            setTimeout(() => {
                const fakeResult = {
                    success: true,
                    emailFound: 'dummy@example.com',
                    emailStatus: 'verified',
                    emailVerifiedAt: new Date().toISOString()
                };
                
                // Update the grouped message data
                Object.values(groupedMessages).forEach(group => {
                    if (group.id === currentTargetId) {
                        group.emailFound = fakeResult.emailFound;
                        group.emailStatus = fakeResult.emailStatus;
                        group.emailVerifiedAt = fakeResult.emailVerifiedAt;
                    }
                });
                
                renderMessages();
                
                console.log(`[EMAIL_FINDER] Email finder completed for target ${currentTargetId} (STUB MODE)`);
            }, 2000);
        }

        function getStatusIcon(status) {
            switch(status) {
                case 'yes': return '';
                case 'no': return '';
                default: return '?';
            }
        }

        function getStatusLabel(status) {
            switch(status) {
                case 'yes': return 'Yes';
                case 'no': return 'No';
                default: return 'Pending';
            }
        }

        function toggleStatus(messageId, field) {
            // Find the message group
            const messageGroup = Object.values(groupedMessages).find(group => group.id === messageId);
            if (!messageGroup) return;
            
            switch(messageGroup[field]) {
                case 'pending':
                    messageGroup[field] = 'yes';
                    break;
                case 'yes':
                    messageGroup[field] = 'no';
                    break;
                case 'no':
                    messageGroup[field] = 'pending';
                    break;
            }
            
            markMessageModified(messageId);
            updateToggleDisplay(messageId, field, messageGroup[field]);
            updateMessagesStats();
        }

        function updateToggleDisplay(messageId, field, status) {
            const selectors = [
                `[onclick="toggleStatus(${messageId}, '${field}')"]`,
            ];
            
            selectors.forEach(selector => {
                const toggles = document.querySelectorAll(selector);
                toggles.forEach(toggle => {
                    toggle.className = `toggle-switch ${status}`;
                    const slider = toggle.querySelector('.toggle-slider');
                    const label = toggle.nextElementSibling;
                    
                    if (slider) slider.textContent = getStatusIcon(status);
                    if (label) label.textContent = getStatusLabel(status);
                });
            });
        }

        function updateComment(messageId, value) {
            const messageGroup = Object.values(groupedMessages).find(group => group.id === messageId);
            if (messageGroup) {
                messageGroup.comments = value;
                markMessageModified(messageId);
            }
        }

        function markFieldModified(messageId) {
            markMessageModified(messageId);
            
            const commentFields = document.querySelectorAll(`textarea[onchange*="${messageId}"]`);
            commentFields.forEach(field => field.classList.add('modified'));
        }

        function markMessageModified(messageId) {
            if (!pendingChanges.has(messageId)) {
                pendingChanges.set(messageId, true);
            }
            
            const saveButtons = document.querySelectorAll(`#save-${messageId}`);
            saveButtons.forEach(btn => btn.classList.add('modified'));
        }

        async function saveMessage(messageId) {
            const messageGroup = Object.values(groupedMessages).find(group => group.id === messageId);
            if (!messageGroup || !pendingChanges.has(messageId)) return;
            
            const saveButtons = document.querySelectorAll(`#save-${messageId}`);
            
            try {
                saveButtons.forEach(btn => {
                    btn.classList.add('saving');
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                });
                
                const token = getAuthToken();
                if (!token) {
                    window.location.href = '/login';
                    return;
                }
                
                console.log(`[MESSAGES] Saving message ${messageId} to database...`);
                
                const response = await fetch(`/messages/${messageId}`, {
                    method: 'PUT',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sent_status: messageGroup.sent,
                        reply_status: messageGroup.gotReply,
                        comments: messageGroup.comments
                    })
                });
                
                if (response.status === 401) {
                    localStorage.removeItem('authToken');
                    window.location.href = '/login';
                    return;
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || 'Failed to save message');
                }
                
                saveButtons.forEach(btn => {
                    btn.classList.remove('saving', 'modified');
                    btn.classList.add('saved');
                    btn.innerHTML = '<i class="fas fa-check"></i> Saved!';
                });
                
                pendingChanges.delete(messageId);
                
                setTimeout(() => {
                    saveButtons.forEach(btn => {
                        btn.classList.remove('saved');
                        btn.innerHTML = '<i class="fas fa-save"></i> Save Changes';
                    });
                }, 2000);
                
                console.log(`[MESSAGES] Message ${messageId} saved successfully to database`);
                
            } catch (error) {
                console.error('[MESSAGES] Error saving message:', error);
                
                if (error.message && error.message.includes('401')) {
                    localStorage.removeItem('authToken');
                    window.location.href = '/login';
                    return;
                }
                
                saveButtons.forEach(btn => {
                    btn.classList.remove('saving');
                    btn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Error';
                });
                
                setTimeout(() => {
                    saveButtons.forEach(btn => {
                        btn.classList.add('modified');
                        btn.innerHTML = '<i class="fas fa-save"></i> Save Changes';
                    });
                }, 3000);
            }
        }

        function filterMessagesByStatus(messageGroups) {
            switch (currentStatusFilter) {
                case 'sent':
                    return messageGroups.filter(group => group.sent === 'yes');
                case 'replied':
                    return messageGroups.filter(group => group.gotReply === 'yes');
                case 'pending':
                    return messageGroups.filter(group => group.sent === 'yes' && group.gotReply !== 'yes');
                case 'all':
                default:
                    return messageGroups;
            }
        }

        function updateMessagesStats() {
            const totalMessages = filteredMessages.length;
            const sentMessages = filteredMessages.filter(group => group.sent === 'yes').length;
            const repliedMessages = filteredMessages.filter(group => group.gotReply === 'yes').length;
            const responseRate = sentMessages > 0 ? Math.round((repliedMessages / sentMessages) * 100) : 0;
            
            document.getElementById('totalMessages').textContent = totalMessages;
            document.getElementById('sentMessages').textContent = sentMessages;
            document.getElementById('repliedMessages').textContent = repliedMessages;
            document.getElementById('responseRate').textContent = `${responseRate}%`;
            
            console.log(`[MESSAGES] Updated stats: Total=${totalMessages}, Sent=${sentMessages}, Replied=${repliedMessages}, Rate=${responseRate}%`);
        }

        function refreshMessages() {
            console.log('[MESSAGES] Refreshing messages from database...');
            
            const refreshBtn = document.querySelector('.refresh-btn i');
            refreshBtn.classList.add('fa-spin');
            
            loadMessagesData().finally(() => {
                refreshBtn.classList.remove('fa-spin');
            });
        }

        function showEmptyState() {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('emptyState').style.display = 'block';
            document.getElementById('messagesCardsGrid').style.display = 'none';
            document.getElementById('paginationInfo').style.display = 'none';
        }

        // Navigation functions
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('active');
        }

        function logout() {
            localStorage.removeItem('authToken');
            window.location.href = '/login';
        }

        // Close modals when clicking outside
        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal-overlay')) {
                closeEmailModal();
                closeInsufficientCreditsModal();
                closeUpgradeModal();
            }
        });

        // Close sidebar when clicking outside on mobile
        document.addEventListener('click', function(event) {
            const sidebar = document.getElementById('sidebar');
            const toggle = document.querySelector('.sidebar-toggle');
            
            if (window.innerWidth <= 768 && 
                !sidebar.contains(event.target) && 
                !toggle.contains(event.target) && 
                sidebar.classList.contains('active')) {
                sidebar.classList.remove('active');
            }
        });
    </script>
</body>
</html>
