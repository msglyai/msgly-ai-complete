<!DOCTYPE html>
<html lang="en">
<head>
<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-5CNT3VV9');</script>
<!-- End Google Tag Manager -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messages - Msgly AI</title>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-purple: #8039DF;
            --dark-purple: #3E0075;
            --glow-purple: #9F4EFF;
            --neon-purple: #7B2CBF;
            --electric-purple: #6A1B9A;
            --light-purple: #F5EDFF;
            --accent-pink: #FF2370;
            --success-green: #10B981;
            --warning-orange: #F59E0B;
            --error-red: #EF4444;
            --black: #111827;
            --charcoal: #1F2937;
            --dark-gray: #374151;
            --gray: #6B7280;
            --light-gray: #F9FAFB;
            --white: #FFFFFF;
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 8px 25px rgba(0, 0, 0, 0.12);
            --glow-shadow: 0 0 30px rgba(128, 57, 223, 0.25);
            --intense-glow: 0 0 45px rgba(128, 57, 223, 0.35);
            --neon-glow: 0 0 60px rgba(128, 57, 223, 0.25);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--light-gray);
            min-height: 100vh;
            display: flex;
        }

        /* Side Navigation */
        .sidebar {
            width: 280px;
            background: linear-gradient(180deg, var(--primary-purple) 0%, var(--dark-purple) 100%);
            color: var(--white);
            position: fixed;
            height: 100vh;
            left: 0;
            top: 0;
            z-index: 1000;
            overflow-y: auto;
            transition: transform 0.3s ease;
            box-shadow: var(--shadow-lg);
        }

        .sidebar-header {
            padding: 2rem 1.5rem 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-logo {
            display: flex;
            align-items: center;
            text-decoration: none;
            color: var(--white);
            margin-bottom: 1rem;
        }

        .sidebar-logo i {
            font-size: 2rem;
            margin-right: 12px;
            filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.3));
        }

        .sidebar-logo-text {
            display: flex;
            flex-direction: column;
        }

        .sidebar-logo-main {
            font-size: 1.5rem;
            font-weight: 700;
            line-height: 1.2;
        }

        .sidebar-logo-sub {
            font-size: 0.7rem;
            opacity: 0.8;
            font-weight: 400;
        }

        .sidebar-user {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }

        .sidebar-user-avatar {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .sidebar-user-info {
            flex: 1;
            min-width: 0;
        }

        .sidebar-user-name {
            font-weight: 600;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .sidebar-user-email {
            font-size: 0.75rem;
            opacity: 0.8;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .sidebar-user-plan {
            font-size: 0.7rem;
            opacity: 0.7;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* NEW: Credits Display in Sidebar */
        .sidebar-user-credits {
            font-size: 0.85rem;
            font-weight: 700;
            margin-top: 0.5rem;
            padding: 0.4rem 0.8rem;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .sidebar-user-credits i {
            font-size: 0.9rem;
            filter: drop-shadow(0 0 4px rgba(255, 255, 255, 0.4));
        }

        .sidebar-user-credits.updating {
            animation: pulse 0.6s ease-in-out;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); background: rgba(255, 255, 255, 0.25); }
        }

        .sidebar-nav {
            padding: 1.5rem 0;
        }

        .nav-section {
            margin-bottom: 2rem;
        }

        .nav-section-title {
            padding: 0 1.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 0.5rem;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1.5rem;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .nav-item:hover, .nav-item.active {
            background: rgba(255, 255, 255, 0.15);
            color: var(--white);
            box-shadow: inset 4px 0 0 var(--white);
        }

        .nav-item i {
            width: 20px;
            margin-right: 12px;
            font-size: 1.1rem;
        }

        .nav-item-text {
            font-size: 0.9rem;
            font-weight: 500;
            flex: 1;
        }

        .nav-badge {
            background: var(--accent-pink);
            color: var(--white);
            font-size: 0.65rem;
            font-weight: 700;
            padding: 0.2rem 0.5rem;
            border-radius: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .nav-badge.soon {
            background: var(--warning-orange);
        }

        .sidebar-footer {
            padding: 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            margin-top: auto;
        }

        .logout-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            width: 100%;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.1);
            color: var(--white);
            text-decoration: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
            cursor: pointer;
            border: none;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        /* Main Content Wrapper */
        .main-wrapper {
            margin-left: 280px;
            width: calc(100% - 280px);
            min-height: 100vh;
        }

        .main-content {
            padding: 2rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Page Header */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            gap: 2rem;
        }

        .page-header-left {
            flex: 1;
        }

        .page-title {
            font-size: 2rem;
            font-weight: 700;
            color: var(--black);
            margin-bottom: 0.5rem;
        }

        .page-subtitle {
            font-size: 1rem;
            color: var(--gray);
        }

        /* NEW: Credits Badge in Header */
        .page-header-credits {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.25rem;
            background: linear-gradient(135deg, var(--primary-purple), var(--neon-purple));
            color: var(--white);
            border-radius: 30px;
            font-size: 1.1rem;
            font-weight: 700;
            box-shadow: 0 4px 15px rgba(128, 57, 223, 0.3);
            transition: all 0.3s ease;
        }

        .page-header-credits.updating {
            animation: pulse 0.6s ease-in-out;
        }

        .page-header-credits i {
            font-size: 1.2rem;
            filter: drop-shadow(0 0 4px rgba(255, 255, 255, 0.5));
        }

        /* Controls */
        .messages-controls {
            display: flex;
            gap: 1.5rem;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
            position: relative;
        }

        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
            font-size: 1rem;
        }

        .search-input {
            width: 100%;
            padding: 0.9rem 1rem 0.9rem 3rem;
            border: 2px solid #E5E7EB;
            border-radius: 12px;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            background: var(--white);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary-purple);
            box-shadow: 0 0 0 3px rgba(128, 57, 223, 0.1);
        }

        .messages-stats {
            display: flex;
            gap: 1.5rem;
        }

        .stat-item {
            text-align: center;
            min-width: 80px;
        }

        .stat-number {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-purple);
            line-height: 1;
            margin-bottom: 0.3rem;
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--gray);
            font-weight: 500;
        }

        .refresh-btn {
            padding: 0.9rem 1.2rem;
            background: var(--white);
            border: 2px solid #E5E7EB;
            border-radius: 12px;
            color: var(--primary-purple);
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .refresh-btn:hover {
            background: var(--light-purple);
            border-color: var(--primary-purple);
            transform: translateY(-1px);
        }

        .refresh-btn i.fa-spin {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Filters */
        .messages-filters {
            background: var(--white);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
        }

        .filter-section {
            margin-bottom: 1.5rem;
        }

        .filter-section:last-child {
            margin-bottom: 0;
        }

        .filter-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--dark-gray);
            margin-bottom: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .filter-buttons {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 0.6rem 1rem;
            background: var(--white);
            border: 2px solid #E5E7EB;
            border-radius: 8px;
            color: var(--dark-gray);
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .filter-btn:hover {
            border-color: var(--primary-purple);
            color: var(--primary-purple);
            background: var(--light-purple);
        }

        .filter-btn.active {
            background: var(--primary-purple);
            border-color: var(--primary-purple);
            color: var(--white);
        }

        .filter-btn i {
            font-size: 0.9rem;
        }

        /* Messages Cards Container */
        .messages-cards-container {
            position: relative;
        }

        .messages-cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        /* NEW REDESIGNED MESSAGE CARD */
        .message-card-redesigned {
            background: white;
            border-radius: 12px;
            padding: 0;
            margin-bottom: 0;
            box-shadow: 0 1px 3px rgba(128, 57, 223, 0.08), 0 1px 2px rgba(0, 0, 0, 0.06);
            overflow: visible;
            border: 1px solid #e5e7eb;
            transition: all 0.3s ease;
        }

        .message-card-redesigned:hover {
            box-shadow: 0 4px 12px rgba(128, 57, 223, 0.12), 0 2px 6px rgba(0, 0, 0, 0.08);
            transform: translateY(-2px);
        }

        /* SECTION 1: PROFILE */
        .profile-section-new {
            padding: 1.25rem 1.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            border-bottom: 2px solid #ede9fe;
            background: linear-gradient(135deg, #fdfcff 0%, #f9f7ff 100%);
        }

        .profile-details-wrapper {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .profile-fullname {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--black);
            margin: 0 0 0.35rem 0;
            line-height: 1.2;
            text-align: center;
        }

        .profile-meta-info {
            font-size: 0.9rem;
            color: var(--gray);
            margin-bottom: 0.5rem;
            text-align: center;
        }

        .meta-role {
            font-weight: 500;
            color: var(--dark-gray);
        }

        .meta-dot {
            margin: 0 0.5rem;
            color: var(--gray);
        }

        .meta-company {
            font-weight: 500;
            color: var(--dark-gray);
        }

        .linkedin-url-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--primary-purple);
            text-decoration: none;
            font-size: 0.95rem;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .linkedin-url-link:hover {
            color: var(--neon-purple);
            text-decoration: underline;
        }

        .linkedin-url-link i {
            font-size: 1.1rem;
        }

        /* SECTION 2: EMAIL FINDER */
        .email-section-new {
            padding: 1rem 1.5rem;
            border-bottom: 2px solid #ede9fe;
            background: linear-gradient(135deg, var(--light-purple) 0%, #FAF6FF 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .email-section-content {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 120px;
            justify-content: center;
        }

        .email-section-title {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            font-size: 0.7rem;
            font-weight: 700;
            color: #374151;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            white-space: nowrap;
            flex-wrap: nowrap;
        }

        .email-section-title i {
            color: var(--primary-purple);
            font-size: 0.85rem;
            flex-shrink: 0;
        }

        .email-section-title span:first-of-type {
            white-space: nowrap;
            flex-shrink: 1;
            min-width: 0;
        }

        .snov-powered {
            margin-left: auto;
            font-size: 0.65rem;
            color: #9333ea;
            font-weight: 600;
            text-transform: none;
            background: #f3e8ff;
            padding: 0.2rem 0.6rem;
            border-radius: 10px;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .find-email-big-btn {
            width: 100%;
            max-width: 400px;
            padding: 0.6rem 1rem;
            background: linear-gradient(135deg, var(--primary-purple), var(--neon-purple));
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(128, 57, 223, 0.2);
        }

        .find-email-big-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(128, 57, 223, 0.3);
        }

        .find-email-big-btn i {
            margin-right: 0.35rem;
        }

        .email-hint-text {
            text-align: center;
            color: var(--gray);
            font-size: 0.65rem;
            margin-top: 0.35rem;
        }

        .email-found-display {
            background: white;
            border: 1px solid #d1fae5;
            border-left: 3px solid var(--success-green);
            border-radius: 8px;
            padding: 0.75rem 0.85rem;
            width: 100%;
            max-width: 500px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .email-address-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 0.4rem;
            width: 100%;
        }

        .email-address-row i.fas.fa-envelope {
            color: var(--primary-purple);
            font-size: 0.85rem;
        }

        .email-text {
            flex: 1;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--black);
            font-family: 'Courier New', monospace;
        }

        .verified-check {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            background: var(--success-green);
            color: white;
            padding: 0.25rem 0.55rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .verified-check i {
            font-size: 0.75rem;
        }

        .email-buttons-row {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-top: 0.65rem;
            justify-content: center;
            width: 100%;
        }

        .email-btn-new {
            padding: 0.5rem 0.9rem;
            border: 1.5px solid var(--primary-purple);
            background: white;
            color: var(--primary-purple);
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.35rem;
            white-space: nowrap;
        }

        .email-btn-new i {
            font-size: 0.75rem;
        }

        .email-btn-new:hover {
            background: var(--primary-purple);
            color: white;
            transform: translateY(-1px);
        }

        .email-btn-new.copy {
            border-color: var(--primary-purple);
        }

        .email-btn-new.search-again {
            border-color: var(--gray);
            color: var(--gray);
        }

        .email-btn-new.search-again:hover {
            background: var(--gray);
            color: white;
        }

        /* EMAIL STATUS INFO (under email address) */
        .email-status-info {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 0.4rem;
            font-size: 0.65rem;
            width: 100%;
        }

        .email-searched-date {
            color: var(--gray);
            font-size: 0.65rem;
            margin-left: 0;
            text-align: center;
        }

        .email-searched-date i {
            margin-right: 0.25rem;
            color: var(--primary-purple);
            font-size: 0.6rem;
        }

        /* SECTION 3: OUTREACH HISTORY */
        .outreach-section-new {
            padding: 1rem 1.5rem;
            border-bottom: 2px solid #ede9fe;
            background: linear-gradient(135deg, var(--light-gray) 0%, #FCFCFD 100%);
        }

        .outreach-section-title {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            font-size: 0.7rem;
            font-weight: 700;
            color: #374151;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            white-space: nowrap;
            flex-wrap: nowrap;
        }

        .outreach-section-title i {
            color: var(--primary-purple);
            font-size: 0.95rem;
            flex-shrink: 0;
        }

        .outreach-timeline-wrapper {
            display: flex;
            flex-direction: column;
            gap: 0.6rem;
        }

        .no-outreach-yet {
            text-align: center;
            padding: 2rem;
            color: var(--gray);
            font-style: italic;
        }

        .history-timeline-item {
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            overflow: visible;
            transition: all 0.2s ease;
        }

        .history-timeline-item:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        /* Disabled state for message types with no data */
        .history-timeline-item.history-item-disabled {
            opacity: 0.5;
            background: #fafafa;
        }

        .history-timeline-item.history-item-disabled .history-item-header {
            cursor: not-allowed;
            background: #f5f5f5;
        }

        .history-timeline-item.history-item-disabled:hover {
            box-shadow: none;
        }

        .history-timeline-item.history-item-disabled .history-item-header:hover {
            background: #f5f5f5;
        }

        .history-item-header {
            padding: 0.75rem 1rem;
            background: var(--light-gray);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.6rem;
            font-size: 0.85rem;
            transition: background 0.2s ease;
        }

        /* Active (enabled) message types - highlighted with color */
        .history-timeline-item:not(.history-item-disabled) .history-item-header {
            background: linear-gradient(135deg, #f0f4ff 0%, #e8f0fe 100%);
            border-left: 3px solid var(--primary-purple);
        }

        .history-timeline-item:not(.history-item-disabled) .history-item-header:hover {
            background: linear-gradient(135deg, #e8f0fe 0%, #dbe7fc 100%);
        }

        .history-item-header:hover {
            background: #f0f0f0;
        }

        .chevron-toggle {
            color: var(--gray);
            font-size: 0.8rem;
            transition: transform 0.2s ease;
        }

        .history-type-icon {
            color: var(--primary-purple);
            font-size: 0.95rem;
        }

        .history-type-text {
            font-weight: 600;
            color: var(--black);
            font-size: 0.85rem;
        }

        .history-date-text {
            color: var(--gray);
            font-size: 0.8rem;
        }

        /* Header Status Badges */
        .header-status-badges {
            margin-left: auto;
            display: flex;
            gap: 1rem;
            align-items: center;
            font-size: 0.8rem;
            color: var(--dark-gray);
        }

        .header-status-item {
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .header-checkbox {
            width: 16px;
            height: 16px;
            border: 2px solid #6B7280;
            border-radius: 3px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: white;
            font-size: 0.7rem;
            color: #111827;
        }

        .header-checkbox.checked {
            background: white;
        }

        .header-status-text {
            font-weight: 500;
            color: #374151;
            white-space: nowrap;
        }

        .history-item-body {
            padding: 0.85rem 1rem;
            padding-bottom: 0.85rem;
            background: white;
            border-top: 1px solid #e0e0e0;
        }

        .message-preview-text {
            color: var(--dark-gray);
            font-size: 0.85rem;
            line-height: 1.5;
            margin-bottom: 0.65rem;
            font-style: italic;
        }

        .history-item-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 0.5rem;
        }

        .history-action-btn {
            padding: 0.5rem 0.75rem;
            background: white;
            border: 1px solid #d1d5db;
            color: var(--dark-gray);
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            min-width: auto;
            white-space: nowrap;
        }

        .history-action-btn:hover {
            background: var(--light-purple);
            border-color: var(--primary-purple);
            color: var(--primary-purple);
        }

        .history-action-btn i {
            font-size: 0.9rem;
        }

        /* COMPACT STATUS TOGGLES (inside message items) */
        .message-status-toggles {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
            margin: 0.5rem auto 0 auto;
            padding-top: 0.5rem;
            padding-bottom: 0rem;
            border-top: 1px solid #e5e7eb;
            max-width: 220px;
            width: fit-content;
        }

        .status-toggle-compact {
            display: flex;
            align-items: center;
            gap: 0.35rem;
            justify-content: flex-start;
        }

        .status-toggle-compact label {
            font-size: 0.65rem;
            color: var(--dark-gray);
            font-weight: 600;
            text-transform: uppercase;
            white-space: nowrap;
            min-width: 80px;
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
            display: inline-block;
            cursor: pointer;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #9ca3af;
            border-radius: 12px;
            transition: 0.3s;
        }

        .toggle-slider::before {
            content: "?";
            position: absolute;
            height: 18px;
            width: 18px;
            left: 3px;
            top: 3px;
            background: white;
            border-radius: 50%;
            transition: 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            font-weight: bold;
            color: #6b7280;
        }

        .toggle-switch input:checked + .toggle-slider {
            background: var(--success-green);
        }

        .toggle-switch input:checked + .toggle-slider::before {
            content: "‚úì";
            transform: translateX(20px);
            color: var(--success-green);
        }

        .toggle-switch.no-toggle input:checked + .toggle-slider {
            background: #ef4444;
        }

        .toggle-switch.no-toggle input:checked + .toggle-slider::before {
            content: "‚úï";
            color: #ef4444;
        }

        .toggle-status-label {
            font-size: 0.62rem;
            font-weight: 600;
            color: var(--dark-gray);
            margin-left: 0.3rem;
        }

        .toggle-status-label.pending {
            color: var(--gray);
        }

        .toggle-status-label.yes {
            color: var(--success-green);
        }

        .toggle-status-label.no {
            color: #ef4444;
        }

        /* SECTION 4: TAGS & NOTES */
        .tags-notes-section-new {
            padding: 1rem 1.5rem 1.5rem 1.5rem;
            background: linear-gradient(135deg, var(--white) 0%, #FEFCFF 100%);
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .tags-notes-content {
            flex: 1;
        }

        .tags-notes-title {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            font-size: 0.7rem;
            font-weight: 700;
            color: #374151;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            white-space: nowrap;
            flex-wrap: nowrap;
        }

        .tags-notes-title i {
            color: var(--primary-purple);
            font-size: 0.95rem;
            flex-shrink: 0;
        }

        .tags-display-area {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 0.85rem;
            justify-content: center;
        }

        .prospect-tag {
            padding: 0.35rem 0.75rem;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
        }

        .prospect-tag.hot-tag {
            background: #FFE5E5;
            color: #D32F2F;
        }

        .prospect-tag.decision-tag {
            background: #FFF4E5;
            color: #F57C00;
        }

        .prospect-tag.followup-tag {
            background: #E3F2FD;
            color: #1976D2;
        }

        .add-tag-button {
            padding: 0.35rem 0.75rem;
            background: white;
            border: 1.5px dashed var(--gray);
            color: var(--gray);
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
        }

        .add-tag-button:hover {
            border-color: var(--primary-purple);
            color: var(--primary-purple);
            background: var(--light-purple);
        }

        .notes-input-area {
            margin-bottom: 0.85rem;
        }

        .notes-input-label {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            font-size: 0.7rem;
            font-weight: 700;
            color: var(--dark-gray);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .notes-input-label i {
            color: var(--primary-purple);
            font-size: 0.85rem;
        }

        .notes-textarea {
            width: 100%;
            height: 80px;
            padding: 0.75rem;
            border: 1.5px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.85rem;
            font-family: inherit;
            color: var(--dark-gray);
            resize: none;
            transition: border-color 0.2s ease;
        }

        .notes-textarea:focus {
            outline: none;
            border-color: var(--primary-purple);
        }

        .notes-textarea::placeholder {
            color: var(--gray);
            font-style: italic;
        }

        .save-all-btn {
            width: 100%;
            padding: 0.7rem 1rem;
            background: linear-gradient(135deg, var(--primary-purple), var(--neon-purple));
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.4rem;
            box-shadow: 0 3px 12px rgba(128, 57, 223, 0.25);
            margin-top: auto;
        }

        .save-all-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 16px rgba(128, 57, 223, 0.35);
        }

        .save-all-btn.modified {
            background: linear-gradient(135deg, var(--warning-orange), #FF9800);
            animation: pulse-orange 0.6s ease-in-out;
        }

        .save-all-btn.saving {
            background: var(--gray);
            cursor: wait;
        }

        .save-all-btn.saved {
            background: linear-gradient(135deg, var(--success-green), #34D399);
        }

        @keyframes pulse-orange {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        /* Loading & Empty States */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 4rem 2rem;
            text-align: center;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--light-purple);
            border-top-color: var(--primary-purple);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        .loading p {
            color: var(--gray);
            font-size: 1rem;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 4rem 2rem;
            text-align: center;
            background: var(--white);
            border-radius: 12px;
            box-shadow: var(--shadow);
        }

        .empty-state i {
            font-size: 4rem;
            color: var(--gray);
            opacity: 0.3;
            margin-bottom: 1.5rem;
        }

        .empty-state h3 {
            font-size: 1.5rem;
            color: var(--black);
            margin-bottom: 0.75rem;
        }

        .empty-state p {
            color: var(--gray);
            font-size: 1rem;
            max-width: 500px;
        }

        /* Pagination */
        .pagination-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            margin-bottom: 1rem;
        }

        .showing-info {
            font-size: 0.9rem;
            color: var(--gray);
        }

        .load-more-btn {
            padding: 0.75rem 1.5rem;
            background: var(--primary-purple);
            color: var(--white);
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .load-more-btn:hover {
            background: var(--neon-purple);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(128, 57, 223, 0.3);
        }

        .bottom-pagination {
            display: flex;
            justify-content: center;
            padding: 1rem 0;
        }

        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(4px);
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--white);
            border-radius: 16px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--black);
        }

        .modal-body {
            margin-bottom: 1.5rem;
            color: var(--dark-gray);
            line-height: 1.6;
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        .modal-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .modal-btn.primary {
            background: var(--primary-purple);
            color: var(--white);
        }

        .modal-btn.primary:hover {
            background: var(--neon-purple);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(128, 57, 223, 0.3);
        }

        .modal-btn.secondary {
            background: var(--light-gray);
            color: var(--dark-gray);
        }

        .modal-btn.secondary:hover {
            background: #E5E7EB;
        }

        /* Mobile Styles */
        .sidebar-toggle {
            display: none;
            position: fixed;
            top: 1rem;
            left: 1rem;
            z-index: 1001;
            background: var(--primary-purple);
            color: var(--white);
            border: none;
            border-radius: 8px;
            width: 45px;
            height: 45px;
            font-size: 1.2rem;
            cursor: pointer;
            box-shadow: var(--shadow-lg);
            transition: all 0.3s ease;
        }

        .sidebar-toggle:hover {
            background: var(--neon-purple);
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .sidebar-toggle {
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .main-wrapper {
                margin-left: 0;
                width: 100%;
            }

            .main-content {
                padding: 5rem 1rem 1rem;
            }

            .messages-cards-grid {
                grid-template-columns: 1fr;
            }

            .page-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .page-header-credits {
                width: 100%;
                justify-content: center;
            }
        }

        @media (min-width: 769px) and (max-width: 1200px) {
            .messages-cards-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (min-width: 1201px) {
            .messages-cards-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
    </style>
</head>
<body>
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5CNT3VV9"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->
    <!-- Mobile Sidebar Toggle -->
    <button class="sidebar-toggle" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Side Navigation -->
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <a href="https://api.msgly.ai/dashboard" class="sidebar-logo">
                <i class="fas fa-comments"></i>
                <div class="sidebar-logo-text">
                    <div class="sidebar-logo-main">Msgly.AI</div>
                    <div class="sidebar-logo-sub">By Chopa AI LTD</div>
                </div>
            </a>
            
            <div class="sidebar-user">
                <div class="sidebar-user-avatar" id="sidebarUserAvatar">??</div>
                <div class="sidebar-user-info">
                    <div class="sidebar-user-name" id="sidebarUserName">Loading...</div>
                    <div class="sidebar-user-email" id="sidebarUserEmail">Loading...</div>
                    <div class="sidebar-user-plan" id="sidebarUserPlan">Loading...</div>
                    <!-- NEW: Credits Display in Sidebar -->
                    <div class="sidebar-user-credits" id="sidebarUserCredits">
                        <i class="fas fa-coins"></i>
                        <span id="sidebarCreditsNumber">0</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="sidebar-nav">
            <div class="nav-section">
                <div class="nav-section-title">Main Menu</div>
                <a href="https://api.msgly.ai/dashboard" class="nav-item">
                    <i class="fas fa-tachometer-alt"></i>
                    <span class="nav-item-text">Dashboard</span>
                </a>
                <a href="https://api.msgly.ai/msgly-profile.html" class="nav-item">
                    <i class="fas fa-user-circle"></i>
                    <span class="nav-item-text">Msgly Profile</span>
                </a>
                <a href="https://api.msgly.ai/messages" class="nav-item active">
                    <i class="fas fa-envelope"></i>
                    <span class="nav-item-text">Messages</span>
                </a>
                <a href="#" class="nav-item" onclick="alert('Analytics coming soon!')">
                    <i class="fas fa-chart-line"></i>
                    <span class="nav-item-text">Analytics</span>
                    <span class="nav-badge soon">Soon</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Account</div>
                <a href="https://chopa.chargebeeportal.com/portal/v2/login?forward=portal_main" class="nav-item" target="_blank">
                    <i class="fas fa-credit-card"></i>
                    <span class="nav-item-text">Billing</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Support</div>
                <a href="#" class="nav-item" onclick="alert('Help Center coming soon!')">
                    <i class="fas fa-question-circle"></i>
                    <span class="nav-item-text">Help Center</span>
                </a>
            </div>
        </div>

        <div class="sidebar-footer">
            <a href="#" class="logout-btn" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i>
                Logout
            </a>
        </div>
    </nav>

    <!-- Email Finder Modals -->
    <!-- 1. UPGRADE REQUIRED MODAL -->
    <div class="modal-overlay" id="upgradeModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">üöÄ Upgrade Required</div>
            </div>
            <div class="modal-body">
                <strong>Email finder is available for Silver, Gold, and Platinum subscribers.</strong><br><br>
                Your current plan: <span id="currentPlanDisplay">Free</span><br><br>
                Upgrade your plan to unlock this feature and find verified email addresses for your LinkedIn contacts.
            </div>
            <div class="modal-actions">
                <button class="modal-btn secondary" onclick="closeUpgradeModal()">Cancel</button>
                <button class="modal-btn primary" onclick="window.open('https://chopa.chargebeeportal.com/portal/v2/login?forward=portal_main', '_blank')">Upgrade Plan</button>
            </div>
        </div>
    </div>

    <!-- 2. INSUFFICIENT CREDITS MODAL -->
    <div class="modal-overlay" id="insufficientCreditsModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">üí≥ Not Enough Credits</div>
            </div>
            <div class="modal-body">
                <strong>You need at least 2 credits to use the email finder.</strong><br><br>
                You currently have <strong><span id="currentCredits">0</span> credits</strong>.<br><br>
                Purchase more credits to continue finding email addresses.
            </div>
            <div class="modal-actions">
                <button class="modal-btn secondary" onclick="closeInsufficientCreditsModal()">Cancel</button>
                <button class="modal-btn primary" onclick="window.open('https://chopa.chargebeeportal.com/portal/v2/login?forward=portal_main', '_blank')">Buy Credits</button>
            </div>
        </div>
    </div>

    <!-- 3. EMAIL FINDER CONFIRMATION MODAL -->
    <div class="modal-overlay" id="emailFinderModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">üîç Find & Verify Email</div>
            </div>
            <div class="modal-body">
                We'll search for this contact's email address using Snov.io. <strong>You'll only be charged 2 credits if we successfully find and verify an email.</strong><br><br>
                No charge if email is not found. Continue?
            </div>
            <div class="modal-actions">
                <button class="modal-btn secondary" onclick="closeEmailModal()">Cancel</button>
                <button class="modal-btn primary" id="confirmEmailSearchBtn">Yes, Find Email</button>
            </div>
        </div>
    </div>

    <!-- Main Content Wrapper -->
    <div class="main-wrapper">
        <main class="main-content">
            <div class="container">
        <div class="page-header">
            <div class="page-header-left">
                <h1 class="page-title">Messages</h1>
                <p class="page-subtitle">Manage your LinkedIn outreach campaigns and track responses</p>
            </div>
            <!-- NEW: Credits Badge in Header -->
            <div class="page-header-credits" id="headerCredits">
                <i class="fas fa-coins"></i>
                <span id="headerCreditsNumber">0</span>
                <span style="font-size: 0.9rem; font-weight: 500;">Credits</span>
            </div>
        </div>

        <div class="messages-controls">
            <div class="search-box">
                <i class="fas fa-search search-icon"></i>
                <input type="text" class="search-input" placeholder="Search messages, names, companies..." 
                       id="searchInput" oninput="searchMessages(this.value)">
            </div>
            <div class="messages-stats">
                <div class="stat-item">
                    <div class="stat-number" id="totalMessages">0</div>
                    <div class="stat-label">Total</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="sentMessages">0</div>
                    <div class="stat-label">Sent</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="repliedMessages">0</div>
                    <div class="stat-label">Replied</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="responseRate">0%</div>
                    <div class="stat-label">Response Rate</div>
                </div>
            </div>
            <button class="refresh-btn" onclick="refreshMessages()" title="Refresh Messages">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>

        <!-- ENHANCED FILTER SYSTEM -->
        <div class="messages-filters">
            <!-- Status Filter -->
            <div class="filter-section">
                <div class="filter-label">Status</div>
                <div class="filter-buttons">
                    <button class="filter-btn active" onclick="filterByStatus('all')">
                        <i class="fas fa-list"></i>
                        All
                    </button>
                    <button class="filter-btn" onclick="filterByStatus('replied')">
                        <i class="fas fa-reply"></i>
                        Replied
                    </button>
                    <button class="filter-btn" onclick="filterByStatus('pending')">
                        <i class="fas fa-clock"></i>
                        Pending
                    </button>
                </div>
            </div>

            <!-- Message Type Filter -->
            <div class="filter-section">
                <div class="filter-label">Message Type</div>
                <div class="filter-buttons">
                    <button class="filter-btn active" onclick="filterByMessageType('all')" id="typeFilterAll">
                        <i class="fas fa-th-large"></i>
                        All Types
                    </button>
                    <button class="filter-btn" onclick="filterByMessageType('linkedin')" id="typeFilterLinkedin">
                        <i class="fab fa-linkedin"></i>
                        LinkedIn
                    </button>
                    <button class="filter-btn" onclick="filterByMessageType('connection')" id="typeFilterConnection">
                        <i class="fas fa-user-plus"></i>
                        Connection
                    </button>
                    <button class="filter-btn" onclick="filterByMessageType('email')" id="typeFilterEmail">
                        <i class="fas fa-envelope"></i>
                        Email
                    </button>
                </div>
            </div>

            <!-- Date Range Filter -->
            <div class="filter-section">
                <div class="filter-label">Date Range</div>
                <div class="filter-buttons">
                    <button class="filter-btn active" onclick="filterByDateRange('all')" id="dateFilterAll">
                        <i class="fas fa-calendar"></i>
                        All Time
                    </button>
                    <button class="filter-btn" onclick="filterByDateRange('7days')" id="dateFilter7days">
                        <i class="fas fa-calendar-week"></i>
                        Last 7 Days
                    </button>
                    <button class="filter-btn" onclick="filterByDateRange('30days')" id="dateFilter30days">
                        <i class="fas fa-calendar-alt"></i>
                        30 Days
                    </button>
                    <button class="filter-btn" onclick="filterByDateRange('3months')" id="dateFilter3months">
                        <i class="fas fa-calendar-day"></i>
                        3 Months
                    </button>
                    <button class="filter-btn" onclick="filterByDateRange('1year')" id="dateFilter1year">
                        <i class="fas fa-calendar-times"></i>
                        1 Year
                    </button>
                </div>
            </div>
        </div>

        <div class="messages-cards-container">
            <!-- Loading State -->
            <div class="loading" id="loadingState">
                <div class="spinner"></div>
                <p>Loading messages...</p>
            </div>

            <!-- Pagination Info -->
            <div class="pagination-info" id="paginationInfo" style="display: none;">
                <div class="showing-info" id="showingInfo">Showing 21 of X newest messages</div>
                <button class="load-more-btn" id="loadMoreBtn" onclick="toggleShowAll()">
                    <i class="fas fa-eye"></i>
                    Show All Messages
                </button>
            </div>

            <!-- Cards Grid -->
            <div class="messages-cards-grid" id="messagesCardsGrid" style="display: none;">
                <!-- Message cards will be populated here -->
            </div>

            <!-- Empty State -->
            <div class="empty-state" id="emptyState" style="display: none;">
                <i class="fas fa-envelope-open"></i>
                <h3>No Messages Found</h3>
                <p>Generate your first LinkedIn message using the Chrome extension, then return here to track your outreach campaign.</p>
            </div>

            <!-- Bottom Show All Button -->
            <div class="bottom-pagination" id="bottomPagination" style="display: none;">
                <button class="load-more-btn" id="bottomLoadMoreBtn" onclick="toggleShowAll()">
                    <i class="fas fa-eye"></i>
                    Show All Messages
                </button>
            </div>
        </div>
            </div>
        </main>
    </div>

    <script>
        // API Configuration - Update this if your API is on a different domain
        const API_BASE_URL = window.location.origin; // Uses same domain as frontend
        // If your API is on a different domain/port, change to: const API_BASE_URL = 'https://api.msgly.ai';
        
        // Global variables
        let messagesData = [];
        let filteredMessages = [];
        let groupedMessages = {};
        let currentStatusFilter = 'all';
        let currentMessageTypeFilter = 'all';
        let currentDateRangeFilter = 'all';
        let currentSearchTerm = '';
        let pendingChanges = new Map();
        let currentUserPlan = null;
        let showingLimited = true;
        let CARDS_LIMIT = 21;
        let currentEmailSearchTargetId = null;

        // Authentication check and data loading
        document.addEventListener('DOMContentLoaded', function() {
            console.log('[CONFIG] API Base URL:', API_BASE_URL);
            console.log('[CONFIG] Full Messages Endpoint:', `${API_BASE_URL}/messages`);
            
            if (!checkAuthentication()) {
                return;
            }
            loadUserProfile();
            loadMessagesData();
        });

        function checkAuthentication() {
            const token = getAuthToken();
            if (!token) {
                window.location.href = '/login?returnUrl=/messages';
                return false;
            }
            return true;
        }

        function getAuthToken() {
            return localStorage.getItem('authToken');
        }

        // NEW: Update credit display in multiple locations
        function updateCreditDisplay(credits) {
            const creditsValue = Math.max(0, parseFloat(credits) || 0);
            const formattedCredits = creditsValue.toFixed(2);
            
            // Update sidebar credits
            const sidebarCredits = document.getElementById('sidebarCreditsNumber');
            const sidebarCreditsContainer = document.getElementById('sidebarUserCredits');
            if (sidebarCredits) {
                sidebarCredits.textContent = formattedCredits;
                if (sidebarCreditsContainer) {
                    sidebarCreditsContainer.classList.add('updating');
                    setTimeout(() => sidebarCreditsContainer.classList.remove('updating'), 600);
                }
            }
            
            // Update header credits
            const headerCredits = document.getElementById('headerCreditsNumber');
            const headerCreditsContainer = document.getElementById('headerCredits');
            if (headerCredits) {
                headerCredits.textContent = formattedCredits;
                if (headerCreditsContainer) {
                    headerCreditsContainer.classList.add('updating');
                    setTimeout(() => headerCreditsContainer.classList.remove('updating'), 600);
                }
            }
            
            // Update global variable
            if (currentUserPlan) {
                currentUserPlan.totalCredits = creditsValue;
            }
            
            console.log(`[CREDITS] Display updated: ${formattedCredits} credits`);
        }

        // Load user profile for sidebar
        async function loadUserProfile() {
            try {
                const token = getAuthToken();
                if (!token) {
                    window.location.href = '/login?returnUrl=/messages';
                    return;
                }

                const response = await fetch(`${API_BASE_URL}/profile`, {
                    method: 'GET',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.status === 401) {
                    localStorage.removeItem('authToken');
                    window.location.href = '/login?returnUrl=/messages';
                    return;
                }

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                // Check if response is JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    console.error('[PROFILE] Server returned non-JSON response:', contentType);
                    const text = await response.text();
                    console.error('[PROFILE] Response text:', text.substring(0, 200));
                    throw new Error('Server returned HTML instead of JSON - possible authentication issue');
                }

                const data = await response.json();
                
                if (data.success && data.profile) {
                    const profile = data.profile;
                    
                    // Update sidebar user info
                    const avatar = document.getElementById('sidebarUserAvatar');
                    const name = document.getElementById('sidebarUserName');
                    const email = document.getElementById('sidebarUserEmail');
                    const plan = document.getElementById('sidebarUserPlan');
                    
                    if (profile.name) {
                        const initials = profile.name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
                        avatar.textContent = initials;
                        name.textContent = profile.name;
                    }
                    
                    if (profile.email) {
                        email.textContent = profile.email;
                    }
                    
                    if (profile.subscription_plan) {
                        plan.textContent = profile.subscription_plan;
                        currentUserPlan = {
                            plan: profile.subscription_plan,
                            totalCredits: profile.total_credits || 0
                        };
                    }
                    
                    // Update credits display
                    updateCreditDisplay(profile.total_credits || 0);
                    
                    console.log('[PROFILE] User profile loaded successfully');
                }
            } catch (error) {
                console.error('[PROFILE] Error loading user profile:', error);
            }
        }

        // Load messages data
        async function loadMessagesData() {
            try {
                const token = getAuthToken();
                if (!token) {
                    window.location.href = '/login?returnUrl=/messages';
                    return;
                }

                const response = await fetch(`${API_BASE_URL}/messages`, {
                    method: 'GET',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.status === 401) {
                    localStorage.removeItem('authToken');
                    window.location.href = '/login?returnUrl=/messages';
                    return;
                }

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                // Check if response is JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    console.error('[MESSAGES] Server returned non-JSON response:', contentType);
                    const text = await response.text();
                    console.error('[MESSAGES] Response text:', text.substring(0, 200));
                    throw new Error('Server returned HTML instead of JSON - possible authentication issue');
                }

                const data = await response.json();
                
                if (data.success && data.messages) {
                    messagesData = data.messages;
                    console.log(`[MESSAGES] Loaded ${messagesData.length} messages from server`);
                    
                    groupMessagesByTarget();
                    applyFiltersAndSearch();
                    
                    if (filteredMessages.length === 0) {
                        showEmptyState();
                    }
                } else {
                    console.log('[MESSAGES] No messages found');
                    showEmptyState();
                }
            } catch (error) {
                console.error('[MESSAGES] Error loading messages:', error);
                
                // Show more helpful error message
                if (error.message && error.message.includes('JSON')) {
                    console.error('[MESSAGES] This usually means the server is returning an HTML page instead of JSON data.');
                    console.error('[MESSAGES] Check if: 1) User is logged in, 2) API endpoint is correct, 3) Server is running properly');
                }
                
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('emptyState').style.display = 'block';
            }
        }

        // Group messages by target profile
        function groupMessagesByTarget() {
            groupedMessages = {};
            
            messagesData.forEach(message => {
                const targetId = message.target_profile_id;
                
                if (!groupedMessages[targetId]) {
                    groupedMessages[targetId] = {
                        id: targetId,
                        target: {
                            firstName: message.target_first_name || 'Unknown',
                            lastName: message.target_last_name || '',
                            role: message.target_role || 'Professional',
                            company: message.target_company || 'Company',
                            linkedinUrl: message.target_linkedin_url || null
                        },
                        messages: {
                            linkedin: [],
                            connection: [],
                            email: []
                        },
                        sent: message.sent_status || 'pending',
                        gotReply: message.reply_status || 'pending',
                        comments: message.comments || '',
                        emailStatus: message.email_status || null,
                        emailFound: message.email_found || null,
                        emailVerifiedAt: message.email_verified_at || null,
                        latestDate: new Date(message.created_at)
                    };
                }
                
                const messageType = message.message_type || 'linkedin';
                const messageObj = {
                    id: message.id,
                    message: message.message_content,
                    created_at: message.created_at,
                    type: messageType
                };
                
                if (messageType === 'linkedin' || messageType === 'message') {
                    groupedMessages[targetId].messages.linkedin.push(messageObj);
                } else if (messageType === 'connection' || messageType === 'connection_request') {
                    groupedMessages[targetId].messages.connection.push(messageObj);
                } else if (messageType === 'email' || messageType === 'cold_email') {
                    groupedMessages[targetId].messages.email.push(messageObj);
                }
                
                const msgDate = new Date(message.created_at);
                if (msgDate > groupedMessages[targetId].latestDate) {
                    groupedMessages[targetId].latestDate = msgDate;
                }
            });
            
            console.log(`[MESSAGES] Grouped into ${Object.keys(groupedMessages).length} target profiles`);
        }

        // Apply filters and search
        function applyFiltersAndSearch() {
            filteredMessages = Object.values(groupedMessages);
            
            // Apply status filter
            if (currentStatusFilter === 'replied') {
                filteredMessages = filteredMessages.filter(group => group.gotReply === 'yes');
            } else if (currentStatusFilter === 'pending') {
                filteredMessages = filteredMessages.filter(group => group.gotReply !== 'yes');
            }
            
            // Apply message type filter
            if (currentMessageTypeFilter !== 'all') {
                filteredMessages = filteredMessages.filter(group => {
                    if (currentMessageTypeFilter === 'linkedin') {
                        return group.messages.linkedin.length > 0;
                    } else if (currentMessageTypeFilter === 'connection') {
                        return group.messages.connection.length > 0;
                    } else if (currentMessageTypeFilter === 'email') {
                        return group.messages.email.length > 0;
                    }
                    return true;
                });
            }
            
            // Apply date range filter
            if (currentDateRangeFilter !== 'all') {
                const now = new Date();
                let cutoffDate;
                
                if (currentDateRangeFilter === '7days') {
                    cutoffDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                } else if (currentDateRangeFilter === '30days') {
                    cutoffDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                } else if (currentDateRangeFilter === '3months') {
                    cutoffDate = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);
                } else if (currentDateRangeFilter === '1year') {
                    cutoffDate = new Date(now.getTime() - 365 * 24 * 60 * 60 * 1000);
                }
                
                if (cutoffDate) {
                    filteredMessages = filteredMessages.filter(group => group.latestDate >= cutoffDate);
                }
            }
            
            // Apply search
            if (currentSearchTerm) {
                const searchLower = currentSearchTerm.toLowerCase();
                filteredMessages = filteredMessages.filter(group => {
                    const target = group.target;
                    return (
                        (target.firstName && target.firstName.toLowerCase().includes(searchLower)) ||
                        (target.lastName && target.lastName.toLowerCase().includes(searchLower)) ||
                        (target.role && target.role.toLowerCase().includes(searchLower)) ||
                        (target.company && target.company.toLowerCase().includes(searchLower))
                    );
                });
            }
            
            // Sort by latest date
            filteredMessages.sort((a, b) => b.latestDate - a.latestDate);
            
            console.log(`[MESSAGES] Filtered to ${filteredMessages.length} target profiles`);
            
            renderMessages();
            updateMessagesStats();
        }

        // Filter functions
        function filterByStatus(status) {
            currentStatusFilter = status;
            
            document.querySelectorAll('.filter-section:first-child .filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.closest('.filter-btn').classList.add('active');
            
            applyFiltersAndSearch();
        }

        function filterByMessageType(type) {
            currentMessageTypeFilter = type;
            
            document.querySelectorAll('.filter-section:nth-child(2) .filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            const btnId = 'typeFilter' + type.charAt(0).toUpperCase() + type.slice(1);
            const activeBtn = document.getElementById(btnId);
            if (activeBtn) activeBtn.classList.add('active');
            
            applyFiltersAndSearch();
        }

        function filterByDateRange(range) {
            currentDateRangeFilter = range;
            
            document.querySelectorAll('.filter-section:last-child .filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            const btnId = 'dateFilter' + range.charAt(0).toUpperCase() + range.slice(1);
            const activeBtn = document.getElementById(btnId);
            if (activeBtn) activeBtn.classList.add('active');
            
            applyFiltersAndSearch();
        }

        function searchMessages(searchTerm) {
            currentSearchTerm = searchTerm;
            applyFiltersAndSearch();
        }

        function toggleShowAll() {
            showingLimited = !showingLimited;
            renderMessages();
        }

        // Render messages
        function renderMessages() {
            const container = document.getElementById('messagesCardsGrid');
            const paginationInfo = document.getElementById('paginationInfo');
            const bottomPagination = document.getElementById('bottomPagination');
            const showingInfo = document.getElementById('showingInfo');
            const loadMoreBtn = document.getElementById('loadMoreBtn');
            const bottomLoadMoreBtn = document.getElementById('bottomLoadMoreBtn');
            
            container.innerHTML = '';
            
            const messagesToShow = showingLimited ? 
                filteredMessages.slice(0, CARDS_LIMIT) : 
                filteredMessages;
            
            messagesToShow.forEach(messageGroup => {
                const messageCard = createMessageCard(messageGroup);
                container.appendChild(messageCard);
            });
            
            if (filteredMessages.length > CARDS_LIMIT) {
                paginationInfo.style.display = 'flex';
                bottomPagination.style.display = 'flex';
                
                if (showingLimited) {
                    showingInfo.textContent = `Showing ${CARDS_LIMIT} of ${filteredMessages.length} newest messages`;
                    loadMoreBtn.innerHTML = '<i class="fas fa-eye"></i> Show All Messages';
                    bottomLoadMoreBtn.innerHTML = '<i class="fas fa-eye"></i> Show All Messages';
                } else {
                    showingInfo.textContent = `Showing all ${filteredMessages.length} messages`;
                    loadMoreBtn.innerHTML = '<i class="fas fa-eye-slash"></i> Show Recent Only';
                    bottomLoadMoreBtn.innerHTML = '<i class="fas fa-eye-slash"></i> Show Recent Only';
                }
            } else {
                paginationInfo.style.display = 'none';
                bottomPagination.style.display = 'none';
            }
            
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('messagesCardsGrid').style.display = 'grid';
            document.getElementById('emptyState').style.display = 'none';
        }

        // Create message card with new redesigned layout
        function createMessageCard(messageGroup) {
            const card = document.createElement('div');
            card.className = 'message-card-redesigned';
            card.setAttribute('data-target-id', messageGroup.id);
            
            const target = messageGroup.target;
            const messages = messageGroup.messages;
            
            // Combine all messages for history
            const allMessages = [
                ...messages.linkedin.map(m => ({...m, type: 'linkedin', icon: 'fab fa-linkedin', label: 'LinkedIn Message'})),
                ...messages.connection.map(m => ({...m, type: 'connection', icon: 'fas fa-user-plus', label: 'Connection Request'})),
                ...messages.email.map(m => ({...m, type: 'email', icon: 'fas fa-envelope', label: 'Cold Email'}))
            ].sort((a, b) => new Date(b.created_at || 0) - new Date(a.created_at || 0));
            
            const emailAddress = messageGroup.emailFound || target.email || '';
            const hasEmail = (messageGroup.emailStatus === 'valid' || messageGroup.emailStatus === 'verified') && emailAddress;
            
            card.innerHTML = `
                <!-- SECTION 1: TARGET PROFILE INFO -->
                <div class="profile-section-new">
                    <div class="profile-details-wrapper">
                        <h3 class="profile-fullname">${target.firstName || ''} ${target.lastName || ''}</h3>
                        <div class="profile-meta-info">
                            <span class="meta-role">${target.role || 'Professional'}</span>
                            <span class="meta-dot">‚Ä¢</span>
                            <span class="meta-company">${target.company || 'Company'}</span>
                        </div>
                        ${target.linkedinUrl ? `
                            <a href="${target.linkedinUrl}" target="_blank" class="linkedin-url-link">
                                <i class="fab fa-linkedin"></i> View LinkedIn Profile
                            </a>
                        ` : ''}
                    </div>
                </div>

                <!-- SECTION 2: EMAIL FINDER & VERIFICATION -->
                <div class="email-section-new">
                    <div class="email-section-title">
                        <i class="fas fa-envelope-open-text"></i>
                        <span>EMAIL FINDER & VERIFICATION</span>
                        <span class="snov-powered">Powered by Snov.io</span>
                    </div>
                    <div class="email-section-content">
                        ${hasEmail ? createEmailFoundDisplay(messageGroup, emailAddress) : createEmailNotFoundDisplay(messageGroup)}
                    </div>
                </div>

                <!-- SECTION 3: OUTREACH HISTORY -->
                <div class="outreach-section-new">
                    <div class="outreach-section-title">
                        <i class="fas fa-history"></i>
                        <span>OUTREACH HISTORY</span>
                    </div>
                    <div class="outreach-timeline-wrapper">
                        ${createOutreachTimeline(allMessages, messageGroup)}
                    </div>
                </div>

                <!-- SECTION 4: TAGS & NOTES -->
                <div class="tags-notes-section-new">
                    <div class="tags-notes-content">
                        <div class="tags-notes-title">
                            <i class="fas fa-tags"></i>
                            <span>TAGS & NOTES</span>
                        </div>
                        <div class="tags-display-area">
                            <span class="prospect-tag hot-tag">#Hot-Lead</span>
                            <span class="prospect-tag decision-tag">#Decision-Maker</span>
                            <span class="prospect-tag followup-tag">#Follow-Up</span>
                            <button class="add-tag-button"><i class="fas fa-plus-circle"></i> Add Tag</button>
                        </div>
                        <div class="notes-input-area">
                            <label class="notes-input-label">
                                <i class="fas fa-sticky-note"></i> NOTES:
                            </label>
                            <textarea 
                                class="notes-textarea" 
                                placeholder="Very interested in pricing, follow up Nov 1..."
                                onchange="updateComment(${messageGroup.id}, this.value)"
                                onkeyup="markFieldModified(${messageGroup.id})"
                            >${messageGroup.comments || ''}</textarea>
                        </div>
                    </div>
                    <button class="save-all-btn" id="save-${messageGroup.id}" onclick="saveMessage(${messageGroup.id})">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                </div>
            `;
            
            return card;
        }

        function createEmailFoundDisplay(messageGroup, emailAddress) {
            const verifiedDate = messageGroup.emailVerifiedAt ? 
                new Date(messageGroup.emailVerifiedAt).toLocaleDateString('en-US', { 
                    year: 'numeric', month: 'short', day: 'numeric' 
                }) : '';
            
            return `
                <div class="email-found-display">
                    <div class="email-address-row">
                        <i class="fas fa-envelope"></i>
                        <span class="email-text">${emailAddress}</span>
                        <span class="verified-check"><i class="fas fa-check-circle"></i> Verified</span>
                    </div>
                    ${verifiedDate ? `
                        <div class="email-status-info">
                            <span class="email-searched-date">
                                <i class="fas fa-calendar-alt"></i> Searched: ${verifiedDate}
                            </span>
                        </div>
                    ` : ''}
                    <div class="email-buttons-row">
                        <button class="email-btn-new copy" onclick="copyEmailAddress('${emailAddress}', this)" title="Copy to clipboard">
                            <i class="fas fa-copy"></i> Copy Email
                        </button>
                        <button class="email-btn-new search-again" onclick="askEmailClick(${messageGroup.id})" title="Search again (2 credits)">
                            <i class="fas fa-redo"></i> Search Again
                        </button>
                    </div>
                </div>
            `;
        }

        function createEmailNotFoundDisplay(messageGroup) {
            const buttonText = (messageGroup.emailStatus === 'not_found' || messageGroup.emailStatus === 'error') ? 
                'Try Again' : 'Find Email';
            
            return `
                <button class="find-email-big-btn" onclick="askEmailClick(${messageGroup.id})">
                    <i class="fas fa-search"></i> ${buttonText} (2 Snov.io Credits)
                </button>
                <p class="email-hint-text">Click to reveal verified email address</p>
            `;
        }

        function createOutreachTimeline(messages, messageGroup) {
            // Define all 3 message types in order - always show all
            const allMessageTypes = [
                { type: 'linkedin', label: 'LinkedIn Message', icon: 'fab fa-linkedin' },
                { type: 'email', label: 'Cold Email', icon: 'fas fa-envelope' },
                { type: 'connection', label: 'Connection Request', icon: 'fas fa-user-plus' }
            ];
            
            // Determine toggle states (same for all message types)
            const sentChecked = messageGroup.sent === 'yes' ? 'checked' : '';
            const replyChecked = messageGroup.gotReply === 'yes' ? 'checked' : '';
            const sentLabel = messageGroup.sent === 'yes' ? 'YES' : (messageGroup.sent === 'no' ? 'NO' : 'PENDING');
            const replyLabel = messageGroup.gotReply === 'yes' ? 'YES' : (messageGroup.gotReply === 'no' ? 'NO' : 'PENDING');
            const sentLabelClass = messageGroup.sent === 'yes' ? 'yes' : (messageGroup.sent === 'no' ? 'no' : 'pending');
            const replyLabelClass = messageGroup.gotReply === 'yes' ? 'yes' : (messageGroup.gotReply === 'no' ? 'no' : 'pending');
            
            let html = '';
            
            // Loop through all 3 message types - always display all
            allMessageTypes.forEach((msgType, index) => {
                // Find if this message type exists in actual messages
                const actualMessage = messages && messages.find(m => m.type === msgType.type);
                const hasMessage = !!actualMessage;
                const isDisabled = !hasMessage;
                
                // Set date and message text
                let dateStr = 'N/A';
                let messageText = 'No message sent yet';
                
                if (hasMessage) {
                    const msgDate = actualMessage.created_at ? new Date(actualMessage.created_at) : new Date();
                    dateStr = msgDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    messageText = actualMessage.message || 'Message content...';
                }
                
                // All items start closed (minimized)
                const isOpen = false;
                const openClass = isOpen ? 'item-open' : 'item-closed';
                const chevronClass = isOpen ? 'fas fa-chevron-down' : 'fas fa-chevron-right';
                const bodyDisplay = isOpen ? 'block' : 'none';
                
                // Add disabled class if no message
                const disabledClass = isDisabled ? 'history-item-disabled' : '';
                const clickHandler = isDisabled ? '' : 'onclick="toggleHistoryExpand(this)"';
                
                html += '<div class="history-timeline-item ' + openClass + ' ' + disabledClass + '">';
                html += '<div class="history-item-header" ' + clickHandler + '>';
                
                // Show chevron only if message exists, otherwise show dash
                if (hasMessage) {
                    html += '<i class="' + chevronClass + ' chevron-toggle"></i>';
                } else {
                    html += '<i class="fas fa-minus chevron-toggle" style="opacity: 0.3;"></i>';
                }
                
                html += '<i class="' + msgType.icon + ' history-type-icon"></i>';
                html += '<span class="history-type-text">' + msgType.label + '</span>';
                html += '<span class="history-date-text">(' + dateStr + ')</span>';
                
                // Add status indicators in header
                html += '<div class="header-status-badges">';
                
                // Message Sent checkbox
                const sentCheckmark = messageGroup.sent === 'yes' ? '<i class="fas fa-check"></i>' : '';
                html += `
                    <div class="header-status-item">
                        <span class="header-status-text">Message Sent</span>
                        <div class="header-checkbox ${sentChecked}">${sentCheckmark}</div>
                    </div>
                `;
                
                // Got Reply checkbox
                const replyCheckmark = messageGroup.gotReply === 'yes' ? '<i class="fas fa-check"></i>' : '';
                html += `
                    <div class="header-status-item">
                        <span class="header-status-text">Got Reply</span>
                        <div class="header-checkbox ${replyChecked}">${replyCheckmark}</div>
                    </div>
                `;
                
                html += '</div>';
                html += '</div>';
                
                // Only add body content if message exists
                if (hasMessage) {
                    html += '<div class="history-item-body" style="display: ' + bodyDisplay + '">';
                    html += '<div class="message-preview-text">' + messageText + '</div>';
                    html += '<div class="history-item-actions">';
                    html += '<button class="history-action-btn"><i class="fas fa-edit"></i> Edit</button>';
                    html += '<button class="history-action-btn"><i class="fas fa-copy"></i> Copy</button>';
                    html += '</div>';
                    
                    // Add status toggles inside each message item
                    html += '<div class="message-status-toggles">';
                    html += '<div class="status-toggle-compact">';
                    html += '<label>Message Sent</label>';
                    html += '<label class="toggle-switch">';
                    html += '<input type="checkbox" ' + sentChecked + ' onchange="toggleMessageSent(' + messageGroup.id + ', this.checked)">';
                    html += '<span class="toggle-slider"></span>';
                    html += '</label>';
                    html += '<span class="toggle-status-label ' + sentLabelClass + '">' + sentLabel + '</span>';
                    html += '</div>';
                    
                    html += '<div class="status-toggle-compact">';
                    html += '<label>Got Reply</label>';
                    html += '<label class="toggle-switch no-toggle">';
                    html += '<input type="checkbox" ' + replyChecked + ' onchange="toggleGotReply(' + messageGroup.id + ', this.checked)">';
                    html += '<span class="toggle-slider"></span>';
                    html += '</label>';
                    html += '<span class="toggle-status-label ' + replyLabelClass + '">' + replyLabel + '</span>';
                    html += '</div>';
                    html += '</div>';
                    
                    html += '</div>';
                }
                
                html += '</div>';
            });
            
            return html;
        }

        function toggleHistoryExpand(headerEl) {
            const item = headerEl.parentElement;
            const body = item.querySelector('.history-item-body');
            const chevron = headerEl.querySelector('.chevron-toggle');
            
            if (item.classList.contains('item-open')) {
                item.classList.remove('item-open');
                item.classList.add('item-closed');
                body.style.display = 'none';
                chevron.className = 'fas fa-chevron-right chevron-toggle';
            } else {
                item.classList.add('item-open');
                item.classList.remove('item-closed');
                body.style.display = 'block';
                chevron.className = 'fas fa-chevron-down chevron-toggle';
            }
        }

        // Toggle functions for status switches
        function toggleMessageSent(messageId, isChecked) {
            const messageGroup = Object.values(groupedMessages).find(group => group.id === messageId);
            if (!messageGroup) return;
            
            messageGroup.sent = isChecked ? 'yes' : 'no';
            markMessageModified(messageId);
            
            // Update all labels and checkboxes for this target
            const card = document.querySelector(`[data-target-id="${messageId}"]`);
            if (card) {
                // Update toggle labels
                const labels = card.querySelectorAll('.status-toggle-compact:first-child .toggle-status-label');
                labels.forEach(label => {
                    label.textContent = isChecked ? 'YES' : 'NO';
                    label.className = 'toggle-status-label ' + (isChecked ? 'yes' : 'no');
                });
                
                // Update header checkboxes
                const checkboxes = card.querySelectorAll('.header-status-item:first-child .header-checkbox');
                checkboxes.forEach(checkbox => {
                    if (isChecked) {
                        checkbox.classList.add('checked');
                        checkbox.innerHTML = '<i class="fas fa-check"></i>';
                    } else {
                        checkbox.classList.remove('checked');
                        checkbox.innerHTML = '';
                    }
                });
            }
            
            updateMessagesStats();
        }

        function toggleGotReply(messageId, isChecked) {
            const messageGroup = Object.values(groupedMessages).find(group => group.id === messageId);
            if (!messageGroup) return;
            
            messageGroup.gotReply = isChecked ? 'yes' : 'no';
            markMessageModified(messageId);
            
            // Update all labels and checkboxes for this target
            const card = document.querySelector(`[data-target-id="${messageId}"]`);
            if (card) {
                // Update toggle labels
                const labels = card.querySelectorAll('.status-toggle-compact:last-child .toggle-status-label');
                labels.forEach(label => {
                    label.textContent = isChecked ? 'YES' : 'NO';
                    label.className = 'toggle-status-label ' + (isChecked ? 'yes' : 'no');
                });
                
                // Update header checkboxes
                const checkboxes = card.querySelectorAll('.header-status-item:last-child .header-checkbox');
                checkboxes.forEach(checkbox => {
                    if (isChecked) {
                        checkbox.classList.add('checked');
                        checkbox.innerHTML = '<i class="fas fa-check"></i>';
                    } else {
                        checkbox.classList.remove('checked');
                        checkbox.innerHTML = '';
                    }
                });
            }
            
            updateMessagesStats();
        }

        function updateComment(messageId, value) {
            const messageGroup = Object.values(groupedMessages).find(group => group.id === messageId);
            if (messageGroup) {
                messageGroup.comments = value;
                markMessageModified(messageId);
            }
        }

        function markFieldModified(messageId) {
            markMessageModified(messageId);
            
            const commentFields = document.querySelectorAll(`textarea[onchange*="${messageId}"]`);
            commentFields.forEach(field => field.classList.add('modified'));
        }

        function markMessageModified(messageId) {
            if (!pendingChanges.has(messageId)) {
                pendingChanges.set(messageId, true);
            }
            
            const saveButtons = document.querySelectorAll(`#save-${messageId}`);
            saveButtons.forEach(btn => btn.classList.add('modified'));
        }

        async function saveMessage(messageId) {
            const messageGroup = Object.values(groupedMessages).find(group => group.id === messageId);
            if (!messageGroup || !pendingChanges.has(messageId)) return;
            
            const saveButtons = document.querySelectorAll(`#save-${messageId}`);
            
            try {
                saveButtons.forEach(btn => {
                    btn.classList.add('saving');
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                });
                
                const token = getAuthToken();
                if (!token) {
                    window.location.href = '/login';
                    return;
                }
                
                const response = await fetch(`${API_BASE_URL}/messages/${messageId}`, {
                    method: 'PUT',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sent_status: messageGroup.sent,
                        reply_status: messageGroup.gotReply,
                        comments: messageGroup.comments
                    })
                });
                
                if (response.status === 401) {
                    localStorage.removeItem('authToken');
                    window.location.href = '/login';
                    return;
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || 'Failed to save message');
                }
                
                saveButtons.forEach(btn => {
                    btn.classList.remove('saving', 'modified');
                    btn.classList.add('saved');
                    btn.innerHTML = '<i class="fas fa-check"></i> Saved!';
                });
                
                pendingChanges.delete(messageId);
                
                setTimeout(() => {
                    saveButtons.forEach(btn => {
                        btn.classList.remove('saved');
                        btn.innerHTML = '<i class="fas fa-save"></i> Save Changes';
                    });
                }, 2000);
                
            } catch (error) {
                console.error('[MESSAGES] Error saving message:', error);
                
                saveButtons.forEach(btn => {
                    btn.classList.remove('saving');
                    btn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Error';
                });
                
                setTimeout(() => {
                    saveButtons.forEach(btn => {
                        btn.classList.add('modified');
                        btn.innerHTML = '<i class="fas fa-save"></i> Save Changes';
                    });
                }, 3000);
            }
        }

        // Email finder functionality
        function askEmailClick(targetId) {
            console.log('[EMAIL] Email search clicked for target:', targetId);
            
            if (!currentUserPlan) {
                console.log('[EMAIL] No user plan loaded, showing upgrade modal');
                document.getElementById('upgradeModal').classList.add('active');
                return;
            }
            
            const plan = currentUserPlan.plan.toLowerCase();
            if (plan === 'free') {
                console.log('[EMAIL] Free plan, showing upgrade modal');
                document.getElementById('currentPlanDisplay').textContent = 'Free';
                document.getElementById('upgradeModal').classList.add('active');
                return;
            }
            
            const credits = currentUserPlan.totalCredits || 0;
            if (credits < 2) {
                console.log('[EMAIL] Insufficient credits:', credits);
                document.getElementById('currentCredits').textContent = credits.toFixed(2);
                document.getElementById('insufficientCreditsModal').classList.add('active');
                return;
            }
            
            console.log('[EMAIL] Opening confirmation modal for target:', targetId);
            currentEmailSearchTargetId = targetId;
            
            const modal = document.getElementById('emailFinderModal');
            const confirmBtn = document.getElementById('confirmEmailSearchBtn');
            
            confirmBtn.onclick = function() {
                performEmailSearch(targetId);
            };
            
            modal.classList.add('active');
        }

        async function performEmailSearch(targetId) {
            console.log('[EMAIL] Starting email search for target:', targetId);
            
            closeEmailModal();
            
            try {
                const token = getAuthToken();
                if (!token) {
                    window.location.href = '/login';
                    return;
                }
                
                const response = await fetch(`${API_BASE_URL}/email-finder/${targetId}`, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.status === 401) {
                    localStorage.removeItem('authToken');
                    window.location.href = '/login';
                    return;
                }
                
                const result = await response.json();
                console.log('[EMAIL] Email search result:', result);
                
                if (result.success) {
                    // Update the message group with new email info
                    if (groupedMessages[targetId]) {
                        groupedMessages[targetId].emailStatus = result.emailStatus;
                        groupedMessages[targetId].emailFound = result.emailFound;
                        groupedMessages[targetId].emailVerifiedAt = result.emailVerifiedAt;
                    }
                    
                    // Update credits display
                    if (result.creditsRemaining !== undefined) {
                        updateCreditDisplay(result.creditsRemaining);
                    }
                    
                    // Re-render messages to show updated email info
                    renderMessages();
                    
                    console.log('[EMAIL] Email search completed successfully');
                } else {
                    console.error('[EMAIL] Email search failed:', result.error);
                    alert(result.error || 'Failed to search for email');
                }
            } catch (error) {
                console.error('[EMAIL] Error during email search:', error);
                alert('An error occurred while searching for email. Please try again.');
            }
        }

        function copyEmailAddress(email, buttonEl) {
            navigator.clipboard.writeText(email).then(() => {
                const originalHTML = buttonEl.innerHTML;
                buttonEl.innerHTML = '<i class="fas fa-check"></i> Copied!';
                buttonEl.style.background = 'var(--success-green)';
                
                setTimeout(() => {
                    buttonEl.innerHTML = originalHTML;
                    buttonEl.style.background = '';
                }, 2000);
            }).catch(err => {
                console.error('[EMAIL] Failed to copy:', err);
                alert('Failed to copy email address');
            });
        }

        function closeEmailModal() {
            document.getElementById('emailFinderModal').classList.remove('active');
            currentEmailSearchTargetId = null;
        }

        function closeInsufficientCreditsModal() {
            document.getElementById('insufficientCreditsModal').classList.remove('active');
        }

        function closeUpgradeModal() {
            document.getElementById('upgradeModal').classList.remove('active');
        }

        function updateMessagesStats() {
            const totalMessages = filteredMessages.length;
            const sentMessages = filteredMessages.filter(group => group.sent === 'yes').length;
            const repliedMessages = filteredMessages.filter(group => group.gotReply === 'yes').length;
            const responseRate = sentMessages > 0 ? Math.round((repliedMessages / sentMessages) * 100) : 0;
            
            document.getElementById('totalMessages').textContent = totalMessages;
            document.getElementById('sentMessages').textContent = sentMessages;
            document.getElementById('repliedMessages').textContent = repliedMessages;
            document.getElementById('responseRate').textContent = `${responseRate}%`;
        }

        function refreshMessages() {
            const refreshBtn = document.querySelector('.refresh-btn i');
            refreshBtn.classList.add('fa-spin');
            
            // Also refresh user profile to get latest credits
            loadUserProfile();
            
            loadMessagesData().finally(() => {
                refreshBtn.classList.remove('fa-spin');
            });
        }

        function showEmptyState() {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('emptyState').style.display = 'block';
            document.getElementById('messagesCardsGrid').style.display = 'none';
            document.getElementById('paginationInfo').style.display = 'none';
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('active');
        }

        function logout() {
            localStorage.removeItem('authToken');
            window.location.href = '/login';
        }

        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal-overlay')) {
                closeEmailModal();
                closeInsufficientCreditsModal();
                closeUpgradeModal();
            }
        });

        document.addEventListener('click', function(event) {
            const sidebar = document.getElementById('sidebar');
            const toggle = document.querySelector('.sidebar-toggle');
            
            if (window.innerWidth <= 768 && 
                !sidebar.contains(event.target) && 
                !toggle.contains(event.target) && 
                sidebar.classList.contains('active')) {
                sidebar.classList.remove('active');
            }
        });
    </script>
</body>
</html>
