<!DOCTYPE html>
<html lang="en">
<head>
<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-5CNT3VV9');</script>
<!-- End Google Tag Manager -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messages - Msgly AI</title>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-purple: #8039DF;
            --dark-purple: #3E0075;
            --glow-purple: #9F4EFF;
            --neon-purple: #7B2CBF;
            --electric-purple: #6A1B9A;
            --light-purple: #F5EDFF;
            --accent-pink: #FF2370;
            --success-green: #10B981;
            --warning-orange: #F59E0B;
            --error-red: #EF4444;
            --black: #111827;
            --charcoal: #1F2937;
            --dark-gray: #374151;
            --gray: #6B7280;
            --light-gray: #F9FAFB;
            --white: #FFFFFF;
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 8px 25px rgba(0, 0, 0, 0.12);
            --glow-shadow: 0 0 30px rgba(128, 57, 223, 0.25);
            --intense-glow: 0 0 45px rgba(128, 57, 223, 0.35);
            --neon-glow: 0 0 60px rgba(128, 57, 223, 0.25);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--light-gray);
            min-height: 100vh;
            display: flex;
        }

        /* Side Navigation */
        .sidebar {
            width: 280px;
            background: linear-gradient(180deg, var(--primary-purple) 0%, var(--dark-purple) 100%);
            color: var(--white);
            position: fixed;
            height: 100vh;
            left: 0;
            top: 0;
            z-index: 1000;
            overflow-y: auto;
            transition: transform 0.3s ease;
            box-shadow: var(--shadow-lg);
        }

        .sidebar-header {
            padding: 2rem 1.5rem 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-logo {
            display: flex;
            align-items: center;
            text-decoration: none;
            color: var(--white);
            margin-bottom: 1rem;
        }

        .sidebar-logo i {
            font-size: 2rem;
            margin-right: 12px;
            filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.3));
        }

        .sidebar-logo-text {
            display: flex;
            flex-direction: column;
        }

        .sidebar-logo-main {
            font-size: 1.5rem;
            font-weight: 700;
            line-height: 1.2;
        }

        .sidebar-logo-sub {
            font-size: 0.7rem;
            opacity: 0.8;
            font-weight: 400;
        }

        .sidebar-user {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }

        .sidebar-user-avatar {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .sidebar-user-info {
            flex: 1;
            min-width: 0;
        }

        .sidebar-user-name {
            font-weight: 600;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .sidebar-user-email {
            font-size: 0.75rem;
            opacity: 0.8;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .sidebar-user-plan {
            font-size: 0.7rem;
            opacity: 0.7;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* NEW: Credits Display in Sidebar */
        .sidebar-user-credits {
            font-size: 0.85rem;
            font-weight: 700;
            margin-top: 0.5rem;
            padding: 0.4rem 0.8rem;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .sidebar-user-credits i {
            font-size: 0.9rem;
            filter: drop-shadow(0 0 4px rgba(255, 255, 255, 0.4));
        }

        .sidebar-user-credits.updating {
            animation: pulse 0.6s ease-in-out;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); background: rgba(255, 255, 255, 0.25); }
        }

        .sidebar-nav {
            padding: 1.5rem 0;
        }

        .nav-section {
            margin-bottom: 2rem;
        }

        .nav-section-title {
            padding: 0 1.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 0.5rem;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1.5rem;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .nav-item:hover, .nav-item.active {
            background: rgba(255, 255, 255, 0.15);
            color: var(--white);
            box-shadow: inset 4px 0 0 var(--white);
        }

        .nav-item i {
            width: 20px;
            margin-right: 12px;
            font-size: 1.1rem;
        }

        .nav-item-text {
            font-size: 0.9rem;
            font-weight: 500;
            flex: 1;
        }

        .nav-badge {
            background: rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.7rem;
            padding: 0.2rem 0.5rem;
            border-radius: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .nav-badge.new {
            background: var(--accent-pink);
            color: var(--white);
        }

        .nav-badge.soon {
            background: rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.8);
        }

        .sidebar-footer {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .logout-btn {
            width: 100%;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: var(--white);
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        /* Mobile Sidebar Toggle */
        .sidebar-toggle {
            display: none;
            position: fixed;
            top: 1rem;
            left: 1rem;
            z-index: 1001;
            background: var(--primary-purple);
            color: var(--white);
            border: none;
            border-radius: 8px;
            padding: 0.75rem;
            cursor: pointer;
            box-shadow: var(--shadow);
        }

        /* Main Content */
        .main-wrapper {
            flex: 1;
            margin-left: 280px;
            min-height: 100vh;
            transition: margin-left 0.3s ease;
            overflow-x: hidden;
            width: calc(100% - 280px);
        }

        .main-content {
            padding: 1.5rem;
            max-width: 1400px;
            width: 100%;
            margin: 0 auto;
            box-sizing: border-box;
        }

        .container {
            width: 100%;
            margin: 0 auto;
        }

        .page-header {
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .page-header-left {
            flex: 1;
        }

        .page-title {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--black);
        }

        .page-subtitle {
            color: var(--gray);
            font-size: 1rem;
            margin-top: 0.4rem;
        }

        /* NEW: Credits Badge in Header */
        .page-header-credits {
            background: linear-gradient(135deg, var(--primary-purple) 0%, var(--dark-purple) 100%);
            color: var(--white);
            padding: 0.8rem 1.5rem;
            border-radius: 25px;
            display: flex;
            align-items: center;
            gap: 0.6rem;
            font-size: 1.1rem;
            font-weight: 700;
            box-shadow: var(--glow-shadow);
            transition: all 0.3s ease;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .page-header-credits i {
            font-size: 1.3rem;
            filter: drop-shadow(0 0 6px rgba(255, 255, 255, 0.5));
        }

        .page-header-credits.updating {
            animation: creditPulse 0.6s ease-in-out;
        }

        @keyframes creditPulse {
            0%, 100% { transform: scale(1); }
            50% { 
                transform: scale(1.08); 
                box-shadow: 0 0 40px rgba(128, 57, 223, 0.5);
            }
        }

        .messages-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-box {
            flex: 1;
            min-width: 300px;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 0.8rem 1rem 0.8rem 3rem;
            border: 2px solid var(--light-gray);
            border-radius: 25px;
            font-size: 0.9rem;
            background: var(--white);
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary-purple);
            box-shadow: 0 0 15px rgba(128, 57, 223, 0.15);
        }

        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
            font-size: 1.1rem;
        }

        .messages-stats {
            display: flex;
            gap: 1rem;
        }

        .stat-item {
            text-align: center;
            padding: 0.8rem 1.2rem;
            background: var(--white);
            border-radius: 12px;
            box-shadow: var(--shadow);
            min-width: 100px;
            position: relative;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: 900;
            color: var(--primary-purple);
            margin-bottom: 0.2rem;
        }

        .stat-label {
            font-size: 0.7rem;
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .messages-filters {
            display: flex;
            gap: 0.8rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .filter-section {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .filter-label {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--dark-gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .filter-buttons {
            display: flex;
            gap: 0.8rem;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 0.6rem 1rem;
            border: 2px solid var(--light-gray);
            background: var(--white);
            color: var(--gray);
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .filter-btn:hover {
            border-color: var(--primary-purple);
            color: var(--primary-purple);
        }

        .filter-btn.active {
            background: linear-gradient(135deg, var(--primary-purple) 0%, var(--dark-purple) 100%);
            color: var(--white);
            border-color: var(--primary-purple);
        }

        /* CARD-BASED LAYOUT */
        .messages-cards-container {
            background: var(--white);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            border: 1px solid rgba(128, 57, 223, 0.08);
            position: relative;
            overflow: hidden;
        }

        .messages-cards-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-purple) 0%, var(--electric-purple) 100%);
        }

        .pagination-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--light-gray);
        }

        .showing-info {
            font-size: 0.9rem;
            color: var(--dark-gray);
            font-weight: 500;
        }

        .load-more-btn {
            background: linear-gradient(135deg, var(--primary-purple) 0%, var(--dark-purple) 100%);
            color: var(--white);
            border: none;
            border-radius: 8px;
            padding: 0.8rem 1.5rem;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: var(--glow-shadow);
        }

        .load-more-btn:hover {
            background: linear-gradient(135deg, var(--electric-purple) 0%, var(--primary-purple) 100%);
            transform: translateY(-1px);
        }

        .load-more-btn:disabled {
            background: var(--gray);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Bottom pagination styling */
        .bottom-pagination {
            display: flex;
            justify-content: center;
            padding: 2rem 1rem 1rem;
            border-top: 1px solid var(--light-gray);
            margin-top: 2rem;
        }

        .bottom-pagination .load-more-btn {
            padding: 1rem 2rem;
            font-size: 1rem;
            min-width: 200px;
            justify-content: center;
        }

        .messages-cards-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.25rem;
            margin-top: 1rem;
            align-items: stretch;
            width: 100%;
            min-width: 0;
        }
        
        @media (max-width: 1600px) {
            .messages-cards-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 900px) {
            .messages-cards-grid {
                grid-template-columns: 1fr;
            }
        }

        .message-card {
            background: var(--white);
            border: 3px solid var(--light-gray);
            border-radius: 16px;
            padding: 0;
            transition: all 0.3s ease;
            position: relative;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: 100%;
            min-width: 0;
            overflow: hidden;
        }

        .message-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-purple);
        }

        .message-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-purple) 0%, var(--electric-purple) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .message-card:hover::before {
            opacity: 1;
        }

        /* Target Profile Header */
        .card-profile-header {
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--light-gray);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 1rem;
        }

        .profile-info {
            flex: 1;
            min-width: 0;
        }

        .profile-name {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--black);
            margin-bottom: 0.4rem;
        }

        .profile-role {
            font-size: 1rem;
            color: var(--dark-gray);
            font-weight: 500;
            margin-bottom: 0.3rem;
        }

        .profile-company {
            font-size: 0.9rem;
            color: var(--gray);
        }

        .email-finder-header-section {
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.8rem;
            padding: 0.5rem;
        }

        .email-finder-description {
            font-size: 0.7rem;
            color: var(--primary-purple);
            font-weight: 500;
            text-align: center;
            opacity: 0.8;
        }

        /* Enhanced Email Display */
        .email-found-container {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(16, 185, 129, 0.05) 100%);
            border: 2px solid var(--success-green);
            border-radius: 12px;
            padding: 1rem;
            width: 100%;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.15);
            animation: emailFoundPulse 0.6s ease-out;
        }

        @keyframes emailFoundPulse {
            0% { transform: scale(0.95); opacity: 0.8; }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Unknown/Catch-all - Yellow Warning State */
        .email-unknown-container {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(245, 158, 11, 0.05) 100%);
            border: 2px solid var(--warning-orange);
            border-radius: 12px;
            padding: 1rem;
            width: 100%;
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.15);
            animation: emailFoundPulse 0.6s ease-out;
        }

        .email-not-found-container {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.08) 0%, rgba(239, 68, 68, 0.03) 100%);
            border: 2px solid rgba(239, 68, 68, 0.3);
            border-radius: 12px;
            padding: 1rem;
            width: 100%;
        }

        .email-header-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.6rem;
        }

        .email-label {
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--success-green);
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .email-label.warning {
            color: var(--warning-orange);
        }

        .email-label.error {
            color: var(--error-red);
        }

        .email-address-display {
            font-size: 1rem;
            font-weight: 700;
            color: var(--dark-gray);
            word-break: break-all;
            margin-bottom: 0.6rem;
            padding: 0.6rem;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            border-left: 4px solid var(--success-green);
        }

        .email-address-display.warning {
            border-left-color: var(--warning-orange);
        }

        .email-actions-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.5rem;
        }

        .copy-email-btn {
            background: linear-gradient(135deg, var(--success-green) 0%, #059669 100%);
            color: var(--white);
            border: none;
            border-radius: 8px;
            padding: 0.6rem 1rem;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.4rem;
            flex: 1;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.25);
        }

        .copy-email-btn:hover {
            background: linear-gradient(135deg, #059669 0%, var(--success-green) 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.35);
        }

        .copy-email-btn.copied {
            background: var(--primary-purple);
            animation: copySuccess 0.4s ease-out;
        }

        .copy-email-btn.warning {
            background: linear-gradient(135deg, var(--warning-orange) 0%, #D97706 100%);
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.25);
        }

        .copy-email-btn.warning:hover {
            background: linear-gradient(135deg, #D97706 0%, var(--warning-orange) 100%);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.35);
        }

        @keyframes copySuccess {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* Email Finder Section */
        .email-finder-section {
            background: rgba(128, 57, 223, 0.03);
            border: 1px solid rgba(128, 57, 223, 0.1);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .email-finder-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.8rem;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--primary-purple);
        }

        .email-finder-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
        }

        .email-ask-btn {
            background: linear-gradient(135deg, var(--primary-purple) 0%, var(--dark-purple) 100%);
            color: var(--white);
            border: none;
            border-radius: 8px;
            padding: 0.7rem 1.2rem;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            box-shadow: var(--glow-shadow);
            white-space: nowrap;
        }

        .email-ask-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, var(--electric-purple) 0%, var(--primary-purple) 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(128, 57, 223, 0.4);
        }

        .email-ask-btn:disabled {
            background: var(--gray);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            opacity: 0.6;
        }

        .email-ask-btn.loading {
            background: var(--warning-orange);
            cursor: wait;
        }

        .email-ask-btn.search-again {
            background: linear-gradient(135deg, var(--warning-orange) 0%, #D97706 100%);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }

        .email-ask-btn.search-again:hover {
            background: linear-gradient(135deg, #D97706 0%, var(--warning-orange) 100%);
            box-shadow: 0 6px 16px rgba(245, 158, 11, 0.4);
        }

        .email-verification {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
            font-size: 0.8rem;
        }

        .email-address {
            color: var(--dark-gray);
            font-weight: 600;
            word-break: break-all;
        }

        .email-status {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .email-status.valid {
            color: var(--success-green);
        }

        .email-status.invalid,
        .email-status.not_valid {
            color: var(--error-red);
        }

        .email-status.catch_all {
            color: var(--warning-orange);
        }

        .email-status.unknown {
            color: var(--gray);
        }

        .email-status.error {
            color: var(--error-red);
        }

        .email-status.verified {
            color: var(--success-green);
        }

        .email-status.not-found,
        .email-status.not_found {
            color: var(--error-red);
        }

        .email-status.found {
            color: var(--warning-orange);
        }

        .email-verified-date {
            font-size: 0.7rem;
            color: var(--gray);
        }

        .email-not-available {
            color: var(--gray);
            font-style: italic;
            font-size: 0.8rem;
        }

        /* EXACT MOCK DESIGN - Email Display */
        .email-address-row {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 0.5rem;
            margin-bottom: 0.4rem;
            width: 100%;
        }

        .email-address-row i.fas.fa-envelope {
            color: var(--primary-purple);
            font-size: 0.85rem;
        }

        .email-text {
            flex: 1;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--black);
            font-family: 'Courier New', monospace;
        }

        .verified-check {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            background: var(--success-green);
            color: white;
            padding: 0.25rem 0.55rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .verified-check i {
            font-size: 0.75rem;
        }

        .verified-check.unknown {
            background: #F59E0B;
            color: white;
        }

        .verified-check.catch-all {
            background: #F59E0B;
            color: white;
        }

        .verified-check.invalid {
            background: #EF4444;
            color: white;
        }

        .verified-check.verifying {
            background: #3B82F6;
            color: white;
        }

        .email-status-info {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 0.4rem;
            font-size: 0.65rem;
            width: 100%;
        }

        .email-searched-date {
            color: var(--gray);
            font-size: 0.65rem;
            margin-left: 0;
            text-align: center;
        }

        .email-searched-date i {
            margin-right: 0.25rem;
            color: var(--primary-purple);
            font-size: 0.6rem;
        }

        .email-buttons-row {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-top: 0.65rem;
            justify-content: center;
            width: 100%;
        }

        .email-btn-new {
            padding: 0.5rem 0.9rem;
            border: 1.5px solid var(--primary-purple);
            background: white;
            color: var(--primary-purple);
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.35rem;
            white-space: nowrap;
        }

        .email-btn-new i {
            font-size: 0.75rem;
        }

        .email-btn-new:hover {
            background: var(--primary-purple);
            color: white;
            transform: translateY(-1px);
        }

        .email-btn-new.copy {
            border-color: var(--primary-purple);
        }

        .email-btn-new.search-again {
            border-color: var(--gray);
            color: var(--gray);
            background: #E5E7EB;
        }

        .email-btn-new.search-again:hover {
            background: var(--gray);
            color: white;
        }

        .email-explanation-text {
            font-size: 0.75rem;
            color: var(--gray);
            line-height: 1.4;
            margin-top: 0.65rem;
            text-align: center;
        }

        /* Email Not Found - Clean Design */
        .email-not-found-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem 0;
        }

        .email-try-again-btn {
            width: 100%;
            max-width: 500px;
            padding: 0.85rem 1.5rem;
            background: linear-gradient(135deg, var(--primary-purple) 0%, var(--dark-purple) 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            box-shadow: var(--glow-shadow);
        }

        .email-try-again-btn i {
            font-size: 0.9rem;
        }

        .email-try-again-btn:hover {
            background: linear-gradient(135deg, var(--electric-purple) 0%, var(--primary-purple) 100%);
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(128, 57, 223, 0.4);
        }

        .email-not-found-text {
            font-size: 0.85rem;
            color: var(--gray);
            text-align: center;
        }

        /* White box wrapper for email content with status-based colored border */
        .email-content-box {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            border-left: 4px solid #10B981;  /* Default green */
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            width: 100%;
            max-width: 600px;
        }

        /* Status-based left border colors for white box */
        .email-content-box[data-status="valid"],
        .email-content-box[data-status="verified"] {
            border-left-color: #10B981;  /* Green */
        }

        .email-content-box[data-status="unknown"],
        .email-content-box[data-status="catch_all"],
        .email-content-box[data-status="found"] {
            border-left-color: #F59E0B;  /* Orange */
        }

        .email-content-box[data-status="invalid"],
        .email-content-box[data-status="not_valid"],
        .email-content-box[data-status="not_found"],
        .email-content-box[data-status="error"] {
            border-left-color: #EF4444;  /* Red */
        }

        .email-content-box[data-status="none"] {
            border-left-color: #8B5CF6;  /* Purple - no status yet */
        }

        /* Message Types Section */
        .message-types-section {
            margin-bottom: 1.5rem;
        }

        .message-type-block {
            margin-bottom: 1rem;
            padding: 1rem;
            border: 1px solid var(--light-gray);
            border-radius: 12px;
            background: rgba(128, 57, 223, 0.01);
        }

        .message-type-block.linkedin {
            border-left: 4px solid #0077B5;
        }

        .message-type-block.connection {
            border-left: 4px solid var(--accent-pink);
        }

        .message-type-block.email {
            border-left: 4px solid var(--warning-orange);
        }

        .message-type-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.8rem;
        }

        .message-type-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--dark-gray);
        }

        .message-type-label i {
            font-size: 1rem;
        }

        .message-type-label.linkedin { color: #0077B5; }
        .message-type-label.connection { color: var(--accent-pink); }
        .message-type-label.email { color: var(--warning-orange); }

        .message-actions {
            display: flex;
            gap: 0.5rem;
        }

        .expand-btn, .edit-btn, .copy-btn {
            background: var(--light-gray);
            border: 1px solid var(--gray);
            border-radius: 6px;
            padding: 0.4rem 0.8rem;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            color: var(--dark-gray);
        }

        .expand-btn:hover {
            background: #0077B5;
            color: var(--white);
            border-color: #0077B5;
        }

        .edit-btn:hover {
            background: var(--warning-orange);
            color: var(--white);
            border-color: var(--warning-orange);
        }

        .copy-btn:hover {
            background: var(--primary-purple);
            color: var(--white);
            border-color: var(--primary-purple);
        }

        .copy-btn.copied {
            background: var(--success-green);
            color: var(--white);
            border-color: var(--success-green);
        }

        .message-text {
            font-size: 0.85rem;
            line-height: 1.5;
            color: var(--dark-gray);
            background: rgba(128, 57, 223, 0.03);
            padding: 0.8rem;
            border-radius: 8px;
            white-space: pre-wrap;
            display: none;
        }

        .message-text.expanded {
            display: block;
        }

        .message-text.empty {
            color: var(--gray);
            font-style: italic;
            text-align: center;
            padding: 1.5rem;
            display: block;
        }

        .message-preview {
            font-size: 0.85rem;
            color: var(--dark-gray);
            line-height: 1.4;
            display: block;
        }

        .message-preview.hidden {
            display: none;
        }

        .message-history-item {
            margin-bottom: 0.8rem;
            padding: 0.6rem;
            border: 1px solid var(--light-gray);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.5);
            transition: all 0.3s ease;
        }

        .message-history-item.latest {
            border-color: var(--primary-purple);
            background: rgba(128, 57, 223, 0.05);
        }

        .message-history-item.collapsed {
            background: var(--light-gray);
            cursor: pointer;
        }

        .message-history-item.collapsed:hover {
            background: rgba(128, 57, 223, 0.08);
        }

        .message-timestamp {
            font-size: 0.7rem;
            color: var(--gray);
            font-weight: 600;
            margin-bottom: 0.4rem;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .message-content-preview {
            font-size: 0.85rem;
            color: var(--dark-gray);
            line-height: 1.4;
        }

        .message-version-count {
            font-size: 0.75rem;
            color: var(--primary-purple);
            font-weight: 600;
            margin-left: 0.5rem;
            padding: 0.2rem 0.5rem;
            background: rgba(128, 57, 223, 0.1);
            border-radius: 10px;
        }

        /* Status and Comments Section */
        .card-status-section {
            padding: 1rem;
            background: rgba(128, 57, 223, 0.02);
            border-radius: 12px;
            border: 1px solid rgba(128, 57, 223, 0.08);
        }

        .status-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .status-item {
            text-align: center;
        }

        .status-label {
            font-size: 0.75rem;
            color: var(--gray);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }

        .toggle-switch {
            width: 60px;
            height: 28px;
            background: var(--light-gray);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            position: relative;
            margin: 0 auto 0.5rem;
        }

        .toggle-switch.pending {
            background: var(--light-gray);
        }

        .toggle-switch.yes {
            background: linear-gradient(135deg, var(--success-green) 0%, #059669 100%);
            border-color: var(--success-green);
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.25);
        }

        .toggle-switch.no {
            background: linear-gradient(135deg, var(--error-red) 0%, #DC2626 100%);
            border-color: var(--error-red);
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.25);
        }

        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: var(--white);
            border-radius: 50%;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 700;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .toggle-switch.pending .toggle-slider {
            background: var(--gray);
            color: var(--white);
        }

        .toggle-switch.yes .toggle-slider {
            transform: translateX(32px);
            background: var(--white);
            color: var(--success-green);
        }

        .toggle-switch.no .toggle-slider {
            background: var(--white);
            color: var(--error-red);
        }

        .toggle-label {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .toggle-switch.pending + .toggle-label {
            color: var(--gray);
        }

        .toggle-switch.yes + .toggle-label {
            color: var(--success-green);
        }

        .toggle-switch.no + .toggle-label {
            color: var(--error-red);
        }

        .comment-field {
            width: 100%;
            min-height: 60px;
            max-height: 120px;
            padding: 0.8rem;
            border: 2px solid var(--light-gray);
            border-radius: 8px;
            font-size: 0.8rem;
            font-family: inherit;
            resize: vertical;
            transition: all 0.3s ease;
        }

        .comment-field:focus {
            outline: none;
            border-color: var(--primary-purple);
            box-shadow: 0 0 0 2px rgba(128, 57, 223, 0.1);
        }

        .save-btn {
            width: 100%;
            padding: 0.8rem;
            background: linear-gradient(135deg, var(--primary-purple) 0%, var(--dark-purple) 100%);
            color: var(--white);
            border: none;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            margin-top: 1rem;
            opacity: 0.6;
            transform: scale(0.98);
        }

        .save-btn.modified {
            opacity: 1;
            transform: scale(1);
            box-shadow: 0 4px 15px rgba(128, 57, 223, 0.3);
        }

        .save-btn:hover.modified {
            background: linear-gradient(135deg, var(--electric-purple) 0%, var(--primary-purple) 100%);
            transform: translateY(-1px) scale(1);
        }

        .save-btn.saving {
            background: var(--warning-orange);
            cursor: not-allowed;
        }

        .save-btn.saved {
            background: var(--success-green);
        }

        /* ========== NEW 4-SECTION CARD DESIGN ========== */
        
        /* SECTION 1: PROFILE */
        .profile-section-new {
            padding: 1.25rem 1.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            border-bottom: 2px solid #ede9fe;
            background: linear-gradient(135deg, #fdfcff 0%, #f9f7ff 100%);
        }

        .profile-details-wrapper {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .profile-fullname {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--black);
            margin: 0 0 0.35rem 0;
            line-height: 1.2;
            text-align: center;
        }

        .profile-meta-info {
            font-size: 0.9rem;
            color: var(--gray);
            margin-bottom: 0.5rem;
            text-align: center;
        }

        .meta-role {
            font-weight: 500;
            color: var(--dark-gray);
        }

        .meta-dot {
            margin: 0 0.5rem;
            color: var(--gray);
        }

        .meta-company {
            font-weight: 500;
            color: var(--dark-gray);
        }

        .linkedin-url-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--primary-purple);
            text-decoration: none;
            font-size: 0.95rem;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .linkedin-url-link:hover {
            color: var(--neon-purple);
            text-decoration: underline;
        }

        .linkedin-url-link i {
            font-size: 1.1rem;
        }

        /* SECTION 2: EMAIL FINDER */
        .email-section-new {
            padding: 1rem 1.5rem;
            border-bottom: 2px solid #ede9fe;
            background: linear-gradient(135deg, var(--light-purple) 0%, #FAF6FF 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Email content gets white box with colored left border */
        .email-section-content {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 120px;
            justify-content: center;
        }

        .email-section-title {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            font-size: 0.7rem;
            font-weight: 700;
            color: #374151;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            white-space: nowrap;
            flex-wrap: nowrap;
        }

        .email-section-title i {
            color: var(--primary-purple);
            font-size: 0.85rem;
            flex-shrink: 0;
        }

        .email-section-title span:first-of-type {
            white-space: nowrap;
            flex-shrink: 1;
            min-width: 0;
        }

        .snov-powered {
            margin-left: auto;
            font-size: 0.65rem;
            color: #9333ea;
            font-weight: 600;
            text-transform: none;
            background: #f3e8ff;
            padding: 0.2rem 0.6rem;
            border-radius: 10px;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .find-email-big-btn {
            width: 100%;
            max-width: 400px;
            padding: 0.6rem 1rem;
            background: linear-gradient(135deg, var(--primary-purple), var(--neon-purple));
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(128, 57, 223, 0.2);
        }

        .find-email-big-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(128, 57, 223, 0.3);
        }

        .find-email-big-btn i {
            margin-right: 0.35rem;
        }

        .find-email-big-btn.search-again {
            background: linear-gradient(135deg, var(--warning-orange) 0%, #D97706 100%);
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.2);
        }

        .find-email-big-btn.search-again:hover {
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }

        .email-hint-text {
            text-align: center;
            color: var(--gray);
            font-size: 0.65rem;
            margin-top: 0.35rem;
        }

        .email-found-display {
            background: white;
            border: 1px solid #d1fae5;
            border-left: 3px solid var(--success-green);
            border-radius: 8px;
            padding: 0.75rem 0.85rem;
            width: 100%;
            max-width: 500px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .email-address-row {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 0.5rem;
            margin-bottom: 0.4rem;
            width: 100%;
        }

        .email-address-row i.fas.fa-envelope {
            color: var(--primary-purple);
            font-size: 0.85rem;
        }

        .email-text {
            flex: 1;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--black);
            font-family: 'Courier New', monospace;
            text-align: left;
        }

        .verified-check {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            background: var(--success-green);
            color: white;
            padding: 0.25rem 0.55rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .verified-check i {
            font-size: 0.75rem;
        }

        .verified-check.warning {
            background: var(--warning-orange);
        }

        .verified-check.error {
            background: var(--error-red);
        }

        .email-buttons-row {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-top: 0.65rem;
            justify-content: center;
            width: 100%;
        }

        .email-btn-new {
            padding: 0.5rem 0.9rem;
            border: 1.5px solid var(--primary-purple);
            background: white;
            color: var(--primary-purple);
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.35rem;
            white-space: nowrap;
        }

        .email-btn-new i {
            font-size: 0.75rem;
        }

        .email-btn-new:hover {
            background: var(--primary-purple);
            color: white;
            transform: translateY(-1px);
        }

        .email-btn-new.copy.copied {
            background: var(--success-green);
            color: white;
            border-color: var(--success-green);
        }

        .email-btn-new.search-again {
            border-color: var(--gray);
            color: var(--gray);
        }

        .email-btn-new.search-again:hover {
            background: var(--gray);
            color: white;
        }

        .email-status-info {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 0.4rem;
            font-size: 0.65rem;
            width: 100%;
        }

        .email-searched-date {
            color: var(--gray);
            font-size: 0.65rem;
            text-align: center;
        }

        .email-searched-date i {
            margin-right: 0.25rem;
            color: var(--primary-purple);
            font-size: 0.6rem;
        }

        .email-not-available {
            color: var(--gray);
            font-style: italic;
            font-size: 0.8rem;
            text-align: center;
        }

        /* SECTION 3: OUTREACH HISTORY */
        .outreach-section-new {
            padding: 0.5rem 0.5rem;
            border-bottom: 2px solid #ede9fe;
            background: linear-gradient(135deg, var(--light-gray) 0%, #FCFCFD 100%);
        }

        .outreach-section-title {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            font-size: 0.7rem;
            font-weight: 700;
            color: #374151;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            white-space: nowrap;
            flex-wrap: nowrap;
        }

        .outreach-section-title i {
            color: var(--primary-purple);
            font-size: 0.95rem;
            flex-shrink: 0;
        }

        .outreach-timeline-wrapper {
            display: flex;
            flex-direction: column;
            gap: 0.6rem;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }

        .no-outreach-yet {
            text-align: center;
            padding: 2rem;
            color: var(--gray);
            font-style: italic;
        }

        .history-timeline-item {
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            transition: all 0.2s ease;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }

        .history-timeline-item:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .history-timeline-item.history-item-disabled {
            opacity: 0.5;
            background: #fafafa;
        }

        .history-timeline-item.history-item-disabled .history-item-header {
            cursor: not-allowed;
            background: #f5f5f5;
        }

        .history-timeline-item.history-item-disabled:hover {
            box-shadow: none;
        }

        .history-timeline-item.history-item-disabled .history-item-header:hover {
            background: #f5f5f5;
        }

        .history-item-header {
            padding: 0.75rem 1rem;
            background: var(--light-gray);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.6rem;
            font-size: 0.85rem;
            transition: background 0.2s ease;
            width: 100%;
            box-sizing: border-box;
        }

        .history-timeline-item:not(.history-item-disabled) .history-item-header {
            background: linear-gradient(135deg, #f0f4ff 0%, #e8f0fe 100%);
            border-left: 3px solid var(--primary-purple);
        }

        .history-timeline-item:not(.history-item-disabled) .history-item-header:hover {
            background: linear-gradient(135deg, #e8f0fe 0%, #dbe7fc 100%);
        }

        .history-item-header:hover {
            background: #f0f0f0;
        }

        .chevron-toggle {
            color: var(--gray);
            font-size: 0.8rem;
            transition: transform 0.2s ease;
            flex-shrink: 0;
        }

        .chevron-toggle.rotated {
            transform: rotate(90deg);
        }

        .history-type-icon {
            color: var(--primary-purple);
            font-size: 0.95rem;
            flex-shrink: 0;
        }

        .history-type-text {
            font-weight: 600;
            color: var(--black);
            font-size: 0.85rem;
            flex: 1;
            min-width: 0;
        }

        .history-date-text {
            color: var(--gray);
            font-size: 0.8rem;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .history-item-body {
            padding: 0.5rem;
            background: white;
            border-top: 1px solid #e0e0e0;
            border-left: 4px solid var(--primary-purple);
            display: none;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }

        .history-item-body.expanded {
            display: block;
        }
        
        .message-text-content {
            font-style: normal;
            font-size: 0.9rem;
            line-height: 1.6;
            color: #374151;
            white-space: pre-wrap;
            margin-bottom: 1rem;
            text-align: left !important;
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-word;
            display: block;
            width: 100%;
            max-width: 100%;
        }
        
        .history-item-body * {
            box-sizing: border-box;
        }

        .message-preview-text {
            color: var(--dark-gray);
            font-size: 0.85rem;
            line-height: 1.5;
            margin-bottom: 0.65rem;
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-word;
            text-align: left !important;
        }

        .history-item-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 0.5rem;
        }

        .history-action-btn {
            padding: 0.5rem 0.75rem;
            background: white;
            border: 1px solid #d1d5db;
            color: var(--dark-gray);
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            min-width: auto;
            white-space: nowrap;
        }

        .history-action-btn:hover {
            background: var(--light-purple);
            border-color: var(--primary-purple);
            color: var(--primary-purple);
        }

        .history-action-btn.copied {
            background: var(--success-green);
            color: white;
            border-color: var(--success-green);
        }

        .history-action-btn i {
            font-size: 0.9rem;
        }

        /* Compact Status Toggles */
        .message-status-toggles {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
            margin: 0.5rem auto 0 auto;
            padding-top: 0.5rem;
            border-top: 1px solid #e5e7eb;
            max-width: 220px;
            width: fit-content;
        }

        .status-toggle-compact {
            display: flex;
            align-items: center;
            gap: 0.35rem;
            justify-content: flex-start;
        }

        .status-toggle-compact label {
            font-size: 0.65rem;
            color: var(--dark-gray);
            font-weight: 600;
            text-transform: uppercase;
            white-space: nowrap;
            min-width: 80px;
        }

        .toggle-switch-compact {
            position: relative;
            width: 44px;
            height: 24px;
            display: inline-block;
            cursor: pointer;
        }

        .toggle-switch-compact input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider-compact {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #9ca3af;
            border-radius: 12px;
            transition: 0.3s;
        }

        .toggle-slider-compact::before {
            content: "?";
            position: absolute;
            height: 18px;
            width: 18px;
            left: 3px;
            top: 3px;
            background: white;
            border-radius: 50%;
            transition: 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            font-weight: bold;
            color: #6b7280;
        }

        .toggle-switch-compact input:checked + .toggle-slider-compact {
            background: var(--success-green);
        }

        .toggle-switch-compact input:checked + .toggle-slider-compact::before {
            content: "✓";
            transform: translateX(20px);
            color: var(--success-green);
        }

        .toggle-status-label {
            font-size: 0.62rem;
            font-weight: 600;
            color: var(--dark-gray);
            margin-left: 0.3rem;
        }

        .toggle-status-label.yes {
            color: var(--success-green);
        }

        .toggle-status-label.no {
            color: #ef4444;
        }

        /* SECTION 4: TAGS & NOTES */
        .tags-notes-section-new {
            padding: 1rem 1.5rem 1.5rem 1.5rem;
            background: linear-gradient(135deg, var(--white) 0%, #FEFCFF 100%);
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .tags-notes-content {
            flex: 1;
        }

        .tags-notes-title {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            font-size: 0.7rem;
            font-weight: 700;
            color: #374151;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            white-space: nowrap;
            flex-wrap: nowrap;
        }

        .tags-notes-title i {
            color: var(--primary-purple);
            font-size: 0.95rem;
            flex-shrink: 0;
        }

        .tags-display-area {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 0.85rem;
            justify-content: center;
        }

        .prospect-tag {
            padding: 0.35rem 0.75rem;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
        }

        .prospect-tag.hot-tag {
            background: #FFE5E5;
            color: #D32F2F;
        }

        .prospect-tag.decision-tag {
            background: #FFF4E5;
            color: #F57C00;
        }

        .prospect-tag.followup-tag {
            background: #E3F2FD;
            color: #1976D2;
        }

        .add-tag-button {
            padding: 0.35rem 0.75rem;
            background: white;
            border: 1.5px dashed var(--gray);
            color: var(--gray);
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
        }

        .add-tag-button:hover {
            border-color: var(--primary-purple);
            color: var(--primary-purple);
            background: var(--light-purple);
        }

        .notes-input-area {
            margin-bottom: 0.85rem;
        }

        .notes-input-label {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            font-size: 0.7rem;
            font-weight: 700;
            color: var(--dark-gray);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .notes-input-label i {
            color: var(--primary-purple);
            font-size: 0.85rem;
        }

        .notes-textarea {
            width: 100%;
            height: 80px;
            padding: 0.75rem;
            border: 1.5px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.85rem;
            font-family: inherit;
            color: var(--dark-gray);
            resize: none;
            transition: border-color 0.2s ease;
        }

        .notes-textarea:focus {
            outline: none;
            border-color: var(--primary-purple);
        }

        .notes-textarea::placeholder {
            color: var(--gray);
            font-style: italic;
        }

        .save-all-btn {
            width: 100%;
            padding: 0.7rem 1rem;
            background: linear-gradient(135deg, var(--primary-purple), var(--neon-purple));
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.4rem;
            box-shadow: 0 3px 12px rgba(128, 57, 223, 0.25);
            margin-top: auto;
        }

        .save-all-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 16px rgba(128, 57, 223, 0.35);
        }

        .save-all-btn.modified {
            background: linear-gradient(135deg, var(--warning-orange), #FF9800);
            animation: pulse-orange 0.6s ease-in-out;
        }

        .save-all-btn.saving {
            background: var(--gray);
            cursor: wait;
        }

        .save-all-btn.saved {
            background: linear-gradient(135deg, var(--success-green), #34D399);
        }

        @keyframes pulse-orange {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        /* MODAL STYLES */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            backdrop-filter: blur(4px);
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--white);
            border-radius: 16px;
            padding: 2rem;
            max-width: 400px;
            width: 90%;
            box-shadow: var(--shadow-lg);
            transform: scale(0.9);
            transition: all 0.3s ease;
            border: 1px solid rgba(128, 57, 223, 0.1);
        }

        .modal-overlay.active .modal {
            transform: scale(1);
        }

        .modal-header {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--black);
            margin-bottom: 0.5rem;
        }

        .modal-body {
            text-align: center;
            margin-bottom: 2rem;
            color: var(--dark-gray);
            line-height: 1.5;
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        .modal-btn {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .modal-btn.primary {
            background: linear-gradient(135deg, var(--primary-purple) 0%, var(--dark-purple) 100%);
            color: var(--white);
            box-shadow: var(--glow-shadow);
        }

        .modal-btn.primary:hover {
            background: linear-gradient(135deg, var(--electric-purple) 0%, var(--primary-purple) 100%);
            transform: translateY(-1px);
        }

        .modal-btn.secondary {
            background: var(--light-gray);
            color: var(--dark-gray);
            border: 2px solid var(--light-gray);
        }

        .modal-btn.secondary:hover {
            border-color: var(--primary-purple);
            color: var(--primary-purple);
        }

        /* Loading & Empty States */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 300px;
            flex-direction: column;
            gap: 1rem;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--light-gray);
            border-top: 3px solid var(--primary-purple);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .empty-state {
            text-align: center;
            padding: 3rem 2rem;
            color: var(--gray);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: var(--primary-purple);
            opacity: 0.3;
        }

        .empty-state h3 {
            font-size: 1.2rem;
            margin-bottom: 0.6rem;
            color: var(--dark-gray);
        }

        .empty-state p {
            font-size: 0.9rem;
            line-height: 1.4;
            max-width: 400px;
            margin: 0 auto;
        }

        .refresh-btn {
            background: none;
            border: none;
            color: var(--gray);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-size: 1.1rem;
        }

        .refresh-btn:hover {
            background: var(--light-purple);
            color: var(--primary-purple);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .sidebar-toggle {
                display: block;
            }

            .main-wrapper {
                margin-left: 0;
            }

            .main-content {
                padding: 1rem;
                margin-top: 4rem;
            }

            .messages-controls {
                flex-direction: column;
            }

            .search-box {
                min-width: auto;
            }

            .messages-stats {
                justify-content: center;
                flex-wrap: wrap;
            }

            .messages-cards-grid {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }

            .status-row {
                grid-template-columns: 1fr;
                gap: 0.8rem;
            }

            .modal {
                max-width: 350px;
                padding: 1.5rem;
            }

            .filter-buttons {
                justify-content: center;
            }

            .page-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .page-header-credits {
                width: 100%;
                justify-content: center;
            }
        }

        @media (min-width: 769px) and (max-width: 1200px) {
            .messages-cards-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (min-width: 1201px) {
            .messages-cards-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
    </style>
</head>
<body>
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5CNT3VV9"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->
    <!-- Mobile Sidebar Toggle -->
    <button class="sidebar-toggle" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Side Navigation -->
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <a href="https://api.msgly.ai/dashboard" class="sidebar-logo">
                <i class="fas fa-comments"></i>
                <div class="sidebar-logo-text">
                    <div class="sidebar-logo-main">Msgly.AI</div>
                    <div class="sidebar-logo-sub">By Chopa AI LTD</div>
                </div>
            </a>
            
            <div class="sidebar-user">
                <div class="sidebar-user-avatar" id="sidebarUserAvatar">??</div>
                <div class="sidebar-user-info">
                    <div class="sidebar-user-name" id="sidebarUserName">Loading...</div>
                    <div class="sidebar-user-email" id="sidebarUserEmail">Loading...</div>
                    <div class="sidebar-user-plan" id="sidebarUserPlan">Loading...</div>
                    <!-- NEW: Credits Display in Sidebar -->
                    <div class="sidebar-user-credits" id="sidebarUserCredits">
                        <i class="fas fa-coins"></i>
                        <span id="sidebarCreditsNumber">0</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="sidebar-nav">
            <div class="nav-section">
                <div class="nav-section-title">Main Menu</div>
                <a href="https://api.msgly.ai/dashboard" class="nav-item">
                    <i class="fas fa-tachometer-alt"></i>
                    <span class="nav-item-text">Dashboard</span>
                </a>
                <a href="https://api.msgly.ai/msgly-profile.html" class="nav-item">
                    <i class="fas fa-user-circle"></i>
                    <span class="nav-item-text">Msgly Profile</span>
                </a>
                <a href="https://api.msgly.ai/messages" class="nav-item active">
                    <i class="fas fa-envelope"></i>
                    <span class="nav-item-text">Messages</span>
                </a>
                <a href="#" class="nav-item" onclick="alert('Analytics coming soon!')">
                    <i class="fas fa-chart-line"></i>
                    <span class="nav-item-text">Analytics</span>
                    <span class="nav-badge soon">Soon</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Account</div>
                <a href="https://chopa.chargebeeportal.com/portal/v2/login?forward=portal_main" class="nav-item" target="_blank">
                    <i class="fas fa-credit-card"></i>
                    <span class="nav-item-text">Billing</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Support</div>
                <a href="#" class="nav-item" onclick="alert('Help Center coming soon!')">
                    <i class="fas fa-question-circle"></i>
                    <span class="nav-item-text">Help Center</span>
                </a>
            </div>
        </div>

        <div class="sidebar-footer">
            <a href="#" class="logout-btn" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i>
                Logout
            </a>
        </div>
    </nav>

    <!-- Email Finder Modals -->
    <!-- 1. UPGRADE REQUIRED MODAL -->
    <div class="modal-overlay" id="upgradeModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">🚀 Upgrade Required</div>
            </div>
            <div class="modal-body">
                <strong>Email finder is available for Silver, Gold, and Platinum subscribers.</strong><br><br>
                Your current plan: <span id="currentPlanDisplay">Free</span><br><br>
                Upgrade your plan to unlock this feature and find verified email addresses for your LinkedIn contacts.
            </div>
            <div class="modal-actions">
                <button class="modal-btn secondary" onclick="closeUpgradeModal()">Cancel</button>
                <button class="modal-btn primary" onclick="window.open('https://chopa.chargebeeportal.com/portal/v2/login?forward=portal_main', '_blank')">Upgrade Plan</button>
            </div>
        </div>
    </div>

    <!-- 2. INSUFFICIENT CREDITS MODAL -->
    <div class="modal-overlay" id="insufficientCreditsModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">💳 Not Enough Credits</div>
            </div>
            <div class="modal-body">
                <strong>You need at least 2 credits to use the email finder.</strong><br><br>
                You currently have <strong><span id="currentCredits">0</span> credits</strong>.<br><br>
                Purchase more credits to continue finding email addresses.
            </div>
            <div class="modal-actions">
                <button class="modal-btn secondary" onclick="closeInsufficientCreditsModal()">Cancel</button>
                <button class="modal-btn primary" onclick="window.open('https://chopa.chargebeeportal.com/portal/v2/login?forward=portal_main', '_blank')">Buy Credits</button>
            </div>
        </div>
    </div>

    <!-- 3. EMAIL FINDER CONFIRMATION MODAL -->
    <div class="modal-overlay" id="emailFinderModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">🔍 Find & Verify Email</div>
            </div>
            <div class="modal-body">
                We'll search for this contact's email address using Snov.io. <strong>You'll only be charged 2 credits if we successfully find and verify an email.</strong><br><br>
                No charge if email is not found. Continue?
            </div>
            <div class="modal-actions">
                <button class="modal-btn secondary" onclick="closeEmailModal()">Cancel</button>
                <button class="modal-btn primary">Yes, Find Email</button>
            </div>
        </div>
    </div>

    <!-- Main Content Wrapper -->
    <div class="main-wrapper">
        <main class="main-content">
            <div class="container">
        <div class="page-header">
            <div class="page-header-left">
                <h1 class="page-title">Messages</h1>
                <p class="page-subtitle">Manage your LinkedIn outreach campaigns and track responses</p>
            </div>
            <!-- NEW: Credits Badge in Header -->
            <div class="page-header-credits" id="headerCredits">
                <i class="fas fa-coins"></i>
                <span id="headerCreditsNumber">0</span>
                <span style="font-size: 0.9rem; font-weight: 500;">Credits</span>
            </div>
        </div>

        <div class="messages-controls">
            <div class="search-box">
                <i class="fas fa-search search-icon"></i>
                <input type="text" class="search-input" placeholder="Search messages, names, companies..." 
                       id="searchInput" oninput="searchMessages(this.value)">
            </div>
            <div class="messages-stats">
                <div class="stat-item">
                    <div class="stat-number" id="totalMessages">0</div>
                    <div class="stat-label">Total</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="sentMessages">0</div>
                    <div class="stat-label">Sent</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="repliedMessages">0</div>
                    <div class="stat-label">Replied</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="responseRate">0%</div>
                    <div class="stat-label">Response Rate</div>
                </div>
            </div>
            <button class="refresh-btn" onclick="refreshMessages()" title="Refresh Messages">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>

        <!-- ENHANCED FILTER SYSTEM -->
        <div class="messages-filters">
            <!-- Status Filter -->
            <div class="filter-section">
                <div class="filter-label">Status</div>
                <div class="filter-buttons">
                    <button class="filter-btn active" onclick="filterByStatus('all')">
                        <i class="fas fa-list"></i>
                        All
                    </button>
                    <button class="filter-btn" onclick="filterByStatus('replied')">
                        <i class="fas fa-reply"></i>
                        Replied
                    </button>
                    <button class="filter-btn" onclick="filterByStatus('pending')">
                        <i class="fas fa-clock"></i>
                        Pending
                    </button>
                </div>
            </div>

            <!-- Message Type Filter -->
            <div class="filter-section">
                <div class="filter-label">Message Type</div>
                <div class="filter-buttons">
                    <button class="filter-btn active" onclick="filterByMessageType('all')" id="typeFilterAll">
                        <i class="fas fa-th-large"></i>
                        All Types
                    </button>
                    <button class="filter-btn" onclick="filterByMessageType('linkedin')" id="typeFilterLinkedin">
                        <i class="fab fa-linkedin"></i>
                        LinkedIn
                    </button>
                    <button class="filter-btn" onclick="filterByMessageType('connection')" id="typeFilterConnection">
                        <i class="fas fa-user-plus"></i>
                        Connection
                    </button>
                    <button class="filter-btn" onclick="filterByMessageType('email')" id="typeFilterEmail">
                        <i class="fas fa-envelope"></i>
                        Email
                    </button>
                </div>
            </div>

            <!-- Date Range Filter -->
            <div class="filter-section">
                <div class="filter-label">Date Range</div>
                <div class="filter-buttons">
                    <button class="filter-btn active" onclick="filterByDateRange('all')" id="dateFilterAll">
                        <i class="fas fa-calendar"></i>
                        All Time
                    </button>
                    <button class="filter-btn" onclick="filterByDateRange('7days')" id="dateFilter7days">
                        <i class="fas fa-calendar-week"></i>
                        Last 7 Days
                    </button>
                    <button class="filter-btn" onclick="filterByDateRange('30days')" id="dateFilter30days">
                        <i class="fas fa-calendar-alt"></i>
                        30 Days
                    </button>
                    <button class="filter-btn" onclick="filterByDateRange('3months')" id="dateFilter3months">
                        <i class="fas fa-calendar-day"></i>
                        3 Months
                    </button>
                    <button class="filter-btn" onclick="filterByDateRange('1year')" id="dateFilter1year">
                        <i class="fas fa-calendar-times"></i>
                        1 Year
                    </button>
                </div>
            </div>
        </div>

        <div class="messages-cards-container">
            <!-- Loading State -->
            <div class="loading" id="loadingState">
                <div class="spinner"></div>
                <p>Loading messages...</p>
            </div>

            <!-- Pagination Info -->
            <div class="pagination-info" id="paginationInfo" style="display: none;">
                <div class="showing-info" id="showingInfo">Showing 21 of X newest messages</div>
                <button class="load-more-btn" id="loadMoreBtn" onclick="toggleShowAll()">
                    <i class="fas fa-eye"></i>
                    Show All Messages
                </button>
            </div>

            <!-- Cards Grid -->
            <div class="messages-cards-grid" id="messagesCardsGrid" style="display: none;">
                <!-- Message cards will be populated here -->
            </div>

            <!-- Empty State -->
            <div class="empty-state" id="emptyState" style="display: none;">
                <i class="fas fa-envelope-open"></i>
                <h3>No Messages Found</h3>
                <p>Generate your first LinkedIn message using the Chrome extension, then return here to track your outreach campaign.</p>
            </div>

            <!-- Bottom Show All Button -->
            <div class="bottom-pagination" id="bottomPagination" style="display: none;">
                <button class="load-more-btn" id="bottomLoadMoreBtn" onclick="toggleShowAll()">
                    <i class="fas fa-eye"></i>
                    Show All Messages
                </button>
            </div>
        </div>
            </div>
        </main>
    </div>

    <script>
        // Global variables
        let messagesData = [];
        let filteredMessages = [];
        let groupedMessages = {};
        let currentStatusFilter = 'all';
        let currentMessageTypeFilter = 'all';
        let currentDateRangeFilter = 'all';
        let currentSearchTerm = '';
        let pendingChanges = new Map();
        let currentUserPlan = null;
        let showingLimited = true;
        let CARDS_LIMIT = 21;

        // Authentication check and data loading
        document.addEventListener('DOMContentLoaded', function() {
            if (!checkAuthentication()) {
                return;
            }
            loadUserProfile();
            loadMessagesData();
        });

        function checkAuthentication() {
            const token = getAuthToken();
            if (!token) {
                window.location.href = '/login?returnUrl=/messages';
                return false;
            }
            return true;
        }

        function getAuthToken() {
            return localStorage.getItem('authToken');
        }

        // NEW: Update credit display in multiple locations
        function updateCreditDisplay(credits) {
            const creditsValue = Math.max(0, parseFloat(credits) || 0);
            const formattedCredits = creditsValue.toFixed(2);
            
            // Update sidebar credits
            const sidebarCredits = document.getElementById('sidebarCreditsNumber');
            const sidebarCreditsContainer = document.getElementById('sidebarUserCredits');
            if (sidebarCredits) {
                sidebarCredits.textContent = formattedCredits;
                if (sidebarCreditsContainer) {
                    sidebarCreditsContainer.classList.add('updating');
                    setTimeout(() => sidebarCreditsContainer.classList.remove('updating'), 600);
                }
            }
            
            // Update header credits
            const headerCredits = document.getElementById('headerCreditsNumber');
            const headerCreditsContainer = document.getElementById('headerCredits');
            if (headerCredits) {
                headerCredits.textContent = formattedCredits;
                if (headerCreditsContainer) {
                    headerCreditsContainer.classList.add('updating');
                    setTimeout(() => headerCreditsContainer.classList.remove('updating'), 600);
                }
            }
            
            // Update global variable
            if (currentUserPlan) {
                currentUserPlan.totalCredits = creditsValue;
            }
            
            console.log(`[CREDITS] Display updated: ${formattedCredits} credits`);
        }

        // Load user profile for sidebar
        async function loadUserProfile() {
            try {
                const token = getAuthToken();
                if (!token) {
                    window.location.href = '/login?returnUrl=/messages';
                    return;
                }

                const response = await fetch('/profile', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.status === 401) {
                    localStorage.removeItem('authToken');
                    window.location.href = '/login?returnUrl=/messages';
                    return;
                }

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                
                if (data.success) {
                    const user = data.data.user;
                    
                    // FIXED: Use dual-credit calculation like Dashboard
                    const renewableCredits = parseFloat(user.renewableCredits || 0);
                    const payasyougoCredits = parseFloat(user.payasyougoCredits || 0);
                    const totalCredits = renewableCredits + payasyougoCredits;
                    
                    console.log('[CREDIT_FIX] Renewable:', renewableCredits.toFixed(2));
                    console.log('[CREDIT_FIX] PayAsYouGo:', payasyougoCredits.toFixed(2));
                    console.log('[CREDIT_FIX] Total:', totalCredits.toFixed(2));
                    
                    currentUserPlan = {
                        planCode: user.planCode || user.plan_code || 'free',
                        totalCredits: totalCredits,
                        planName: user.planName || user.plan_name || 'Free'
                    };
                    
                    console.log('[PROFILE] User credits loaded:', currentUserPlan.totalCredits);
                    
                    // Update credit displays immediately
                    updateCreditDisplay(currentUserPlan.totalCredits);
                    
                    document.getElementById('sidebarUserName').textContent = user.displayName || user.email;
                    document.getElementById('sidebarUserEmail').textContent = user.email;
                    
                    const planCode = user.planCode || 'free';
                    const planNames = {
                        'free': 'Free Plan',
                        'silver-monthly': 'Silver Monthly',
                        'silver-payasyougo': 'Silver Pay-as-you-go',
                        'gold-monthly': 'Gold Monthly', 
                        'gold-payasyougo': 'Gold Pay-as-you-go',
                        'platinum-monthly': 'Platinum Monthly',
                        'platinum-payasyougo': 'Platinum Pay-as-you-go'
                    };
                    document.getElementById('sidebarUserPlan').textContent = planNames[planCode] || 'Unknown Plan';
                    
                    const displayName = user.displayName || user.email;
                    const initials = getInitials(displayName);
                    document.getElementById('sidebarUserAvatar').textContent = initials;
                } else {
                    throw new Error(data.error || 'Failed to load profile');
                }
                
            } catch (error) {
                console.error('[PROFILE] Error loading user profile:', error);
                document.getElementById('sidebarUserName').textContent = 'User';
                document.getElementById('sidebarUserEmail').textContent = 'user@example.com';
                document.getElementById('sidebarUserPlan').textContent = 'Free Plan';
                document.getElementById('sidebarUserAvatar').textContent = 'U';
                updateCreditDisplay(0);
            }
        }

        function getInitials(name) {
            if (!name) return '??';
            
            const parts = name.split(' ');
            if (parts.length >= 2) {
                return (parts[0][0] + parts[1][0]).toUpperCase();
            } else {
                return name.substring(0, 2).toUpperCase();
            }
        }

        // Load messages data from API
        async function loadMessagesData() {
            try {
                document.getElementById('loadingState').style.display = 'flex';
                
                const token = getAuthToken();
                if (!token) {
                    window.location.href = '/login?returnUrl=/messages';
                    return;
                }
                
                const response = await fetch('/messages/history', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.status === 401) {
                    localStorage.removeItem('authToken');
                    window.location.href = '/login?returnUrl=/messages';
                    return;
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    messagesData = data.data || [];
                    groupMessagesByTarget();
                } else {
                    throw new Error(data.error || 'Failed to load messages');
                }
                
                applyFilters();
                
            } catch (error) {
                console.error('[MESSAGES] Error loading messages:', error);
                
                if (error.message && error.message.includes('401')) {
                    localStorage.removeItem('authToken');
                    window.location.href = '/login';
                    return;
                }
                
                showEmptyState();
            }
        }

        // Group messages by target profile
        function groupMessagesByTarget() {
            groupedMessages = {};
            
            messagesData.forEach(message => {
                const targetKey = message.targetProfile.firstName + '_' + message.targetProfile.company;
                
                if (!groupedMessages[targetKey]) {
                    const messageDate = new Date(message.created_at || message.createdAt || Date.now());
                    
                    groupedMessages[targetKey] = {
                        target: message.targetProfile,
                        messages: {
                            linkedin: [],
                            connection: [],
                            email: []
                        },
                        id: message.id,
                        sent: message.sent,
                        gotReply: message.gotReply,
                        comments: message.comments,
                        emailFound: message.emailFound,
                        emailStatus: message.emailStatus,
                        emailVerifiedAt: message.emailVerifiedAt,
                        latestMessageDate: messageDate
                    };
                } else {
                    const messageDate = new Date(message.created_at || message.createdAt || Date.now());
                    if (messageDate > groupedMessages[targetKey].latestMessageDate) {
                        groupedMessages[targetKey].latestMessageDate = messageDate;
                    }
                }
                
                const messageType = getMessageTypeFromDatabase(message.message_type || message.messageType);
                
                if (messageType === 'connection') {
                    groupedMessages[targetKey].messages.connection.push(message);
                } else if (messageType === 'email') {
                    groupedMessages[targetKey].messages.email.push(message);
                } else {
                    groupedMessages[targetKey].messages.linkedin.push(message);
                }
            });
            
            Object.values(groupedMessages).forEach(group => {
                group.messages.linkedin.sort((a, b) => new Date(b.created_at || b.createdAt || 0) - new Date(a.created_at || a.createdAt || 0));
                group.messages.connection.sort((a, b) => new Date(b.created_at || b.createdAt || 0) - new Date(a.created_at || a.createdAt || 0));
                group.messages.email.sort((a, b) => new Date(b.created_at || b.createdAt || 0) - new Date(a.created_at || a.createdAt || 0));
            });
        }

        function getMessageTypeFromDatabase(dbMessageType) {
            if (!dbMessageType) {
                return 'linkedin';
            }
            
            const dbType = dbMessageType.toLowerCase();
            
            if (dbType.includes('connection') || dbType === 'connection_request') {
                return 'connection';
            } else if (dbType.includes('email') || dbType === 'cold_email') {
                return 'email';
            } else {
                return 'linkedin';
            }
        }

        function applyFilters() {
            let filtered = Object.values(groupedMessages);
            
            filtered = filterMessagesByStatus(filtered);
            filtered = filterMessagesByType(filtered);
            filtered = filterMessagesByDateRange(filtered);
            
            if (currentSearchTerm) {
                filtered = filtered.filter(group => {
                    const target = group.target;
                    const messages = group.messages;
                    
                    const targetMatch = (
                        (target.firstName && target.firstName.toLowerCase().includes(currentSearchTerm.toLowerCase())) ||
                        (target.role && target.role.toLowerCase().includes(currentSearchTerm.toLowerCase())) ||
                        (target.company && target.company.toLowerCase().includes(currentSearchTerm.toLowerCase())) ||
                        (group.comments && group.comments.toLowerCase().includes(currentSearchTerm.toLowerCase()))
                    );
                    
                    const messageMatch = ['linkedin', 'connection', 'email'].some(type => {
                        const messageArray = messages[type];
                        if (Array.isArray(messageArray)) {
                            return messageArray.some(msg => 
                                msg.message && msg.message.toLowerCase().includes(currentSearchTerm.toLowerCase())
                            );
                        }
                        return false;
                    });
                    
                    return targetMatch || messageMatch;
                });
            }
            
            filtered.sort((a, b) => b.latestMessageDate - a.latestMessageDate);
            
            filteredMessages = filtered;
            renderMessages();
            updateMessagesStats();
        }

        function filterMessagesByStatus(messageGroups) {
            switch (currentStatusFilter) {
                case 'sent':
                    return messageGroups.filter(group => group.sent === 'yes');
                case 'replied':
                    return messageGroups.filter(group => group.gotReply === 'yes');
                case 'pending':
                    return messageGroups.filter(group => group.sent === 'yes' && group.gotReply !== 'yes');
                case 'all':
                default:
                    return messageGroups;
            }
        }

        function filterMessagesByType(messageGroups) {
            if (currentMessageTypeFilter === 'all') {
                return messageGroups;
            }
            
            return messageGroups.filter(group => {
                const messages = group.messages;
                switch (currentMessageTypeFilter) {
                    case 'linkedin':
                        return messages.linkedin && messages.linkedin.length > 0;
                    case 'connection':
                        return messages.connection && messages.connection.length > 0;
                    case 'email':
                        return messages.email && messages.email.length > 0;
                    default:
                        return true;
                }
            });
        }

        function filterMessagesByDateRange(messageGroups) {
            if (currentDateRangeFilter === 'all') {
                return messageGroups;
            }
            
            const now = new Date();
            let cutoffDate;
            
            switch (currentDateRangeFilter) {
                case '7days':
                    cutoffDate = new Date(now.getTime() - (7 * 24 * 60 * 60 * 1000));
                    break;
                case '30days':
                    cutoffDate = new Date(now.getTime() - (30 * 24 * 60 * 60 * 1000));
                    break;
                case '3months':
                    cutoffDate = new Date(now.getTime() - (90 * 24 * 60 * 60 * 1000));
                    break;
                case '1year':
                    cutoffDate = new Date(now.getTime() - (365 * 24 * 60 * 60 * 1000));
                    break;
                default:
                    return messageGroups;
            }
            
            return messageGroups.filter(group => {
                return group.latestMessageDate >= cutoffDate;
            });
        }

        function searchMessages(searchTerm) {
            currentSearchTerm = searchTerm.trim();
            applyFilters();
        }

        function filterByStatus(status) {
            currentStatusFilter = status;
            
            document.querySelectorAll('.filter-section:first-child .filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            applyFilters();
        }

        function filterByMessageType(type) {
            currentMessageTypeFilter = type;
            
            document.querySelectorAll('.filter-section:nth-child(2) .filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            applyFilters();
        }

        function filterByDateRange(range) {
            currentDateRangeFilter = range;
            
            document.querySelectorAll('.filter-section:nth-child(3) .filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            applyFilters();
        }

        function toggleShowAll() {
            showingLimited = !showingLimited;
            renderMessages();
        }

        function renderMessages() {
            const cardsGrid = document.getElementById('messagesCardsGrid');
            const paginationInfo = document.getElementById('paginationInfo');
            const bottomPagination = document.getElementById('bottomPagination');
            const loadMoreBtn = document.getElementById('loadMoreBtn');
            const bottomLoadMoreBtn = document.getElementById('bottomLoadMoreBtn');
            const showingInfo = document.getElementById('showingInfo');
            
            if (filteredMessages.length === 0) {
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('messagesCardsGrid').style.display = 'none';
                document.getElementById('emptyState').style.display = 'block';
                paginationInfo.style.display = 'none';
                bottomPagination.style.display = 'none';
                return;
            }
            
            let messagesToShow = filteredMessages;
            if (showingLimited && filteredMessages.length > CARDS_LIMIT) {
                messagesToShow = filteredMessages.slice(0, CARDS_LIMIT);
            }
            
            cardsGrid.innerHTML = '';
            
            messagesToShow.forEach(messageGroup => {
                const messageCard = createMessageCard(messageGroup);
                cardsGrid.appendChild(messageCard);
            });
            
            if (filteredMessages.length > CARDS_LIMIT) {
                paginationInfo.style.display = 'flex';
                bottomPagination.style.display = 'flex';
                
                if (showingLimited) {
                    showingInfo.textContent = `Showing ${CARDS_LIMIT} of ${filteredMessages.length} newest messages`;
                    loadMoreBtn.innerHTML = '<i class="fas fa-eye"></i> Show All Messages';
                    bottomLoadMoreBtn.innerHTML = '<i class="fas fa-eye"></i> Show All Messages';
                } else {
                    showingInfo.textContent = `Showing all ${filteredMessages.length} messages`;
                    loadMoreBtn.innerHTML = '<i class="fas fa-eye-slash"></i> Show Recent Only';
                    bottomLoadMoreBtn.innerHTML = '<i class="fas fa-eye-slash"></i> Show Recent Only';
                }
            } else {
                paginationInfo.style.display = 'none';
                bottomPagination.style.display = 'none';
            }
            
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('messagesCardsGrid').style.display = 'grid';
            document.getElementById('emptyState').style.display = 'none';
            
            // CRITICAL: Attach toggle click handlers after rendering
            attachToggleClickHandlers();
        }

        function createMessageCard(messageGroup) {
            const card = document.createElement('div');
            card.className = 'message-card';
            card.setAttribute('data-target-id', messageGroup.id);
            
            const target = messageGroup.target;
            const messages = messageGroup.messages;
            
            // Combine all messages for timeline
            const allMessages = [
                ...messages.linkedin.map(m => ({...m, type: 'linkedin', icon: 'fab fa-linkedin', label: 'LinkedIn Message'})),
                ...messages.connection.map(m => ({...m, type: 'connection', icon: 'fas fa-user-plus', label: 'Connection Request'})),
                ...messages.email.map(m => ({...m, type: 'email', icon: 'fas fa-envelope', label: 'Cold Email'}))
            ].sort((a, b) => new Date(b.created_at || 0) - new Date(a.created_at || 0));
            
            const emailAddress = messageGroup.emailFound || target.email || '';
            const hasEmailStatus = messageGroup.emailStatus && messageGroup.emailStatus !== 'none';
            
            card.innerHTML = `
                <!-- SECTION 1: TARGET PROFILE INFO -->
                <div class="profile-section-new">
                    <div class="profile-details-wrapper">
                        <h3 class="profile-fullname">${target.firstName || ''} ${target.lastName || ''}</h3>
                        <div class="profile-meta-info">
                            <span class="meta-role">${target.role || 'Professional'}</span>
                            <span class="meta-dot">•</span>
                            <span class="meta-company">${target.company || 'Company'}</span>
                        </div>
                        ${target.linkedinUrl ? `
                            <a href="${target.linkedinUrl}" target="_blank" class="linkedin-url-link">
                                <i class="fab fa-linkedin"></i> View LinkedIn Profile
                            </a>
                        ` : ''}
                    </div>
                </div>

                <!-- SECTION 2: EMAIL FINDER & VERIFICATION -->
                <div class="email-section-new" data-email-status="${messageGroup.emailStatus || 'none'}">
                    <div class="email-section-title">
                        <i class="fas fa-envelope-open-text"></i>
                        <span>EMAIL FINDER & VERIFICATION</span>
                        <span class="snov-powered">Powered by Snov.io</span>
                    </div>
                    <div class="email-section-content">
                        ${hasEmailStatus ? createEmailVerificationDisplay(messageGroup) : createEmailFinderButton(messageGroup)}
                    </div>
                </div>

                <!-- SECTION 3: OUTREACH HISTORY -->
                <div class="outreach-section-new">
                    <div class="outreach-section-title">
                        <i class="fas fa-history"></i>
                        <span>OUTREACH HISTORY</span>
                    </div>
                    <div class="outreach-timeline-wrapper">
                        ${createOutreachTimeline(allMessages, messageGroup)}
                    </div>
                </div>

                <!-- SECTION 4: TAGS & NOTES -->
                <div class="tags-notes-section-new">
                    <div class="tags-notes-content">
                        <div class="tags-notes-title">
                            <i class="fas fa-tags"></i>
                            <span>TAGS & NOTES</span>
                        </div>
                        <div class="tags-display-area">
                            <span class="prospect-tag hot-tag">#Hot-Lead</span>
                            <span class="prospect-tag decision-tag">#Decision-Maker</span>
                            <span class="prospect-tag followup-tag">#Follow-Up</span>
                            <button class="add-tag-button"><i class="fas fa-plus-circle"></i> Add Tag</button>
                        </div>
                        <div class="notes-input-area">
                            <label class="notes-input-label">
                                <i class="fas fa-sticky-note"></i> NOTES:
                            </label>
                            <textarea 
                                class="notes-textarea" 
                                placeholder="Add notes about this contact..."
                                onchange="updateComment(${messageGroup.id}, this.value)"
                                onkeyup="markFieldModified(${messageGroup.id})"
                            >${messageGroup.comments || ''}</textarea>
                        </div>
                    </div>
                    <button class="save-all-btn" id="save-${messageGroup.id}" onclick="saveMessage(${messageGroup.id})">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                </div>
            `;
            
            return card;
        }

        function createEmailFinderButton(messageGroup) {
            // Email not found - show "Try Again" option
            if (messageGroup.emailStatus === 'not_found' || messageGroup.emailStatus === 'error') {
                return `
                    <button class="find-email-big-btn search-again" onclick="askEmailClick(${messageGroup.id})">
                        <i class="fas fa-redo"></i> Try Again (2 Snov.io Credits)
                    </button>
                    <p class="email-hint-text">Email not found. Click to search again.</p>
                `;
            }
            
            // Invalid/catch-all - show "Search Again" option
            if (messageGroup.emailStatus === 'invalid' || messageGroup.emailStatus === 'not_valid' || 
                messageGroup.emailStatus === 'catch_all' || messageGroup.emailStatus === 'unknown') {
                return `
                    <button class="find-email-big-btn search-again" onclick="askEmailClick(${messageGroup.id})">
                        <i class="fas fa-redo"></i> Search Again (2 Snov.io Credits)
                    </button>
                    <p class="email-hint-text">Previous result was uncertain. Try again.</p>
                `;
            }
            
            // First time - show "Find Email"
            return `
                <button class="find-email-big-btn" onclick="askEmailClick(${messageGroup.id})">
                    <i class="fas fa-search"></i> Find Email (2 Snov.io Credits)
                </button>
                <p class="email-hint-text">Click to reveal verified email address</p>
            `;
        }

        function createEmailAskButton(messageGroup) {
            // Email found and verified - show "Search Again" option
            if (messageGroup.emailStatus === 'valid' || messageGroup.emailStatus === 'verified') {
                return `<button class="email-ask-btn search-again" onclick="askEmailClick(${messageGroup.id})" title="Search again (2 credits)">
                    <i class="fas fa-redo"></i> Search Again
                </button>`;
            }
            
            // Email not found - show "Try Again" option
            if (messageGroup.emailStatus === 'not_found' || messageGroup.emailStatus === 'error') {
                return `<button class="email-ask-btn search-again" onclick="askEmailClick(${messageGroup.id})" title="Try again (2 credits)">
                    <i class="fas fa-redo"></i> Try Again
                </button>`;
            }
            
            // Invalid/catch-all - show "Search Again" option
            if (messageGroup.emailStatus === 'invalid' || messageGroup.emailStatus === 'not_valid' || 
                messageGroup.emailStatus === 'catch_all' || messageGroup.emailStatus === 'unknown') {
                return `<button class="email-ask-btn search-again" onclick="askEmailClick(${messageGroup.id})" title="Search again (2 credits)">
                    <i class="fas fa-redo"></i> Search Again
                </button>`;
            }
            
            // First time - show "Ask Email"
            return `<button class="email-ask-btn" onclick="askEmailClick(${messageGroup.id})" title="Find email (2 credits)">
                <i class="fas fa-search"></i> Find Email
            </button>`;
        }

        function createEmailVerificationDisplay(messageGroup) {
            if (!messageGroup.emailStatus) {
                return `<div class="email-not-available">Click "Find Email" to search</div>`;
            }
            
            const verifiedDate = messageGroup.emailVerifiedAt ? 
                new Date(messageGroup.emailVerifiedAt).toLocaleDateString('en-US', { 
                    year: 'numeric', month: 'short', day: 'numeric' 
                }) : '';
            
            const emailAddress = messageGroup.emailFound || 'N/A';
            
            switch(messageGroup.emailStatus) {
                case 'valid':
                case 'verified':
                    return `<div class="email-content-box" data-status="verified">
                        <div class="email-address-row">
                            <i class="fas fa-envelope"></i>
                            <span class="email-text">${emailAddress}</span>
                            <span class="verified-check"><i class="fas fa-check-circle"></i> Verified</span>
                        </div>
                        <div class="email-status-info">
                            <span class="email-searched-date">
                                <i class="fas fa-calendar-alt"></i> Searched: ${verifiedDate || 'Recently'}
                            </span>
                        </div>
                        <div class="email-buttons-row">
                            <button class="email-btn-new copy" onclick="copyEmailAddress('${emailAddress}', this)" title="Copy to clipboard">
                                <i class="fas fa-copy"></i> Copy Email
                            </button>
                            <button class="email-btn-new search-again" onclick="askEmailClick(${messageGroup.id})" title="Search again (2 credits)">
                                <i class="fas fa-redo"></i> Search Again
                            </button>
                        </div>
                    </div>`;
                
                case 'unknown':
                    return `<div class="email-content-box" data-status="unknown">
                        <div class="email-address-row">
                            <span class="email-text">${emailAddress}</span>
                            <span class="verified-check unknown"><i class="fas fa-question-circle"></i> Unknown</span>
                        </div>
                        <div class="email-status-info">
                            <span class="email-searched-date">
                                <i class="fas fa-calendar-alt"></i> Searched: ${verifiedDate || 'Recently'}
                            </span>
                        </div>
                        <div class="email-buttons-row">
                            <button class="email-btn-new copy" onclick="copyEmailAddress('${emailAddress}', this)" title="Copy to clipboard">
                                <i class="fas fa-copy"></i> Copy Email
                            </button>
                            <button class="email-btn-new search-again" onclick="askEmailClick(${messageGroup.id})" title="Search again (2 credits)">
                                <i class="fas fa-redo"></i> Search Again
                            </button>
                        </div>
                        <div class="email-explanation-text">
                            Snov.io found this email but doesn't have verification data for it yet
                        </div>
                    </div>`;
                
                case 'catch_all':
                    return `<div class="email-content-box" data-status="catch_all">
                        <div class="email-address-row">
                            <span class="email-text">${emailAddress}</span>
                            <span class="verified-check catch-all"><i class="fas fa-exclamation-circle"></i> Catch-All</span>
                        </div>
                        <div class="email-status-info">
                            <span class="email-searched-date">
                                <i class="fas fa-calendar-alt"></i> Searched: ${verifiedDate || 'Recently'}
                            </span>
                        </div>
                        <div class="email-buttons-row">
                            <button class="email-btn-new copy" onclick="copyEmailAddress('${emailAddress}', this)" title="Copy to clipboard">
                                <i class="fas fa-copy"></i> Copy Email
                            </button>
                            <button class="email-btn-new search-again" onclick="askEmailClick(${messageGroup.id})" title="Search again (2 credits)">
                                <i class="fas fa-redo"></i> Search Again
                            </button>
                        </div>
                        <div class="email-explanation-text">
                            Snov.io found this email but the domain accepts all addresses - verification uncertain
                        </div>
                    </div>`;
                    
                case 'invalid':
                case 'not_valid':
                    return `<div class="email-content-box" data-status="invalid">
                        <div class="email-address-row">
                            <span class="email-text">${emailAddress}</span>
                            <span class="verified-check invalid"><i class="fas fa-times-circle"></i> Invalid</span>
                        </div>
                        <div class="email-status-info">
                            <span class="email-searched-date">
                                <i class="fas fa-calendar-alt"></i> Searched: ${verifiedDate || 'Recently'}
                            </span>
                        </div>
                        <div class="email-buttons-row">
                            <button class="email-btn-new search-again" onclick="askEmailClick(${messageGroup.id})" title="Search again (2 credits)">
                                <i class="fas fa-redo"></i> Search Again
                            </button>
                        </div>
                        <div class="email-explanation-text">
                            This email address appears to be invalid
                        </div>
                    </div>`;
                    
                case 'found':
                    return `<div class="email-content-box" data-status="found">
                        <div class="email-address-row">
                            <span class="email-text">${emailAddress}</span>
                            <span class="verified-check verifying"><i class="fas fa-spinner fa-pulse"></i> Verifying</span>
                        </div>
                        <div class="email-status-info">
                            <span class="email-searched-date">
                                <i class="fas fa-calendar-alt"></i> Searched: ${verifiedDate || 'Recently'}
                            </span>
                        </div>
                        <div class="email-explanation-text">
                            Verification in progress...
                        </div>
                    </div>`;
                    
                case 'not_found':
                    return `<div class="email-content-box" data-status="not_found">
                        <div class="email-address-row">
                            <i class="fas fa-search"></i>
                            <span class="email-text">Email not found</span>
                            <span class="verified-check invalid"><i class="fas fa-times-circle"></i> Not Found</span>
                        </div>
                        <div class="email-status-info">
                            <span class="email-searched-date">
                                <i class="fas fa-calendar-alt"></i> Searched: ${verifiedDate}
                            </span>
                        </div>
                        <div class="email-buttons-row">
                            <button class="email-btn-new" onclick="askEmailClick(${messageGroup.id})" title="Search again (2 credits)" style="background: linear-gradient(135deg, var(--primary-purple), var(--neon-purple)); color: white; border: none; width: 100%;">
                                <i class="fas fa-search"></i> Search Again
                            </button>
                        </div>
                    </div>`;
                    
                case 'error':
                    return `<div class="email-content-box" data-status="error">
                        <div class="email-address-row">
                            <span class="email-text">Search error occurred</span>
                            <span class="verified-check invalid"><i class="fas fa-exclamation-triangle"></i> Error</span>
                        </div>
                        <div class="email-status-info">
                            <span class="email-searched-date">
                                <i class="fas fa-calendar-alt"></i> Attempted: ${verifiedDate || 'Recently'}
                            </span>
                        </div>
                        <div class="email-buttons-row">
                            <button class="email-btn-new search-again" onclick="askEmailClick(${messageGroup.id})" title="Try again (2 credits)">
                                <i class="fas fa-redo"></i> Try Again
                            </button>
                        </div>
                    </div>`;
                    
                default:
                    return `<div class="email-not-available">Status unknown</div>`;
            }
        }

        async function copyEmailAddress(email, button) {
            try {
                await navigator.clipboard.writeText(email);
                
                const originalHTML = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check"></i> Copied!';
                button.classList.add('copied');
                
                setTimeout(() => {
                    button.innerHTML = originalHTML;
                    button.classList.remove('copied');
                }, 2000);
                
            } catch (error) {
                console.error('[EMAIL_COPY] Error:', error);
                const originalHTML = button.innerHTML;
                button.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Error';
                
                setTimeout(() => {
                    button.innerHTML = originalHTML;
                }, 2000);
            }
        }

        function askEmailClick(messageId) {
            console.log(`[EMAIL_FINDER] Ask Email clicked for message ID: ${messageId}`);
            
            if (!currentUserPlan) {
                console.log('[EMAIL_FINDER] No user plan data');
                document.getElementById('currentPlanDisplay').textContent = 'Unknown';
                document.getElementById('upgradeModal').classList.add('active');
                return;
            }
            
            const allowedPlans = ['silver-monthly', 'gold-monthly', 'platinum-monthly', 'silver-payasyougo', 'gold-payasyougo', 'platinum-payasyougo'];
            const userPlan = (currentUserPlan.planCode || 'free').toLowerCase();
            
            if (!allowedPlans.includes(userPlan)) {
                console.log(`[EMAIL_FINDER] Plan validation failed: ${userPlan} not in allowed plans`);
                document.getElementById('currentPlanDisplay').textContent = currentUserPlan.planName || 'Free';
                document.getElementById('upgradeModal').classList.add('active');
                return;
            }
            
            const userCredits = currentUserPlan.totalCredits || 0;
            
            if (userCredits < 2) {
                console.log(`[EMAIL_FINDER] Credit validation failed: ${userCredits} < 2`);
                const creditsElement = document.getElementById('currentCredits');
                if (creditsElement) {
                    creditsElement.textContent = userCredits.toFixed(2);
                }
                document.getElementById('insufficientCreditsModal').classList.add('active');
                return;
            }
            
            console.log(`[EMAIL_FINDER] All validations passed. Plan: ${userPlan}, Credits: ${userCredits}`);
            showEmailConfirmationModal(messageId);
        }

        function showEmailConfirmationModal(messageId) {
            const confirmButton = document.querySelector('#emailFinderModal .modal-btn.primary');
            confirmButton.onclick = () => confirmEmailFinder(messageId);
            document.getElementById('emailFinderModal').classList.add('active');
        }

        async function confirmEmailFinder(messageId) {
            closeEmailModal();
            
            console.log(`[EMAIL_FINDER] CONFIRMED: Sending messageId ${messageId} to backend`);
            
            const buttons = document.querySelectorAll(`[onclick*="askEmailClick(${messageId})"]`);
            buttons.forEach(btn => {
                btn.classList.add('loading');
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Finding & verifying email...';
                btn.disabled = true;
            });
            
            try {
                const token = getAuthToken();
                if (!token) {
                    window.location.href = '/login?returnUrl=/messages';
                    return;
                }
                
                const response = await fetch('/api/ask-email', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        messageId: messageId
                    })
                });
                
                if (response.status === 401) {
                    localStorage.removeItem('authToken');
                    window.location.href = '/login?returnUrl=/messages';
                    return;
                }
                
                const result = await response.json();
                
                if (result.success) {
                    console.log('[EMAIL_FINDER] Success! Email:', result.email, 'Status:', result.status, 'Credits charged:', result.creditsCharged);
                    
                    // FIXED: Update credits display with new balance
                    if (result.newBalance !== undefined) {
                        updateCreditDisplay(result.newBalance);
                    } else if (currentUserPlan && result.creditsCharged) {
                        const newBalance = currentUserPlan.totalCredits - result.creditsCharged;
                        updateCreditDisplay(newBalance);
                    }
                    
                    // FIXED: Update local data with complete email + status
                    Object.values(groupedMessages).forEach(group => {
                        if (group.id === messageId) {
                            group.emailFound = result.email;
                            group.emailStatus = result.status;
                            group.emailVerifiedAt = result.verifiedAt || new Date().toISOString();
                        }
                    });
                    
                    // FIXED: Force re-render to show updated data
                    renderMessages();
                    
                    // Show success message
                    console.log('[EMAIL_FINDER] UI updated with email and verification status');
                    
                } else {
                    if (result.error === 'email_not_found' || result.error === 'email_not_verified') {
                        Object.values(groupedMessages).forEach(group => {
                            if (group.id === messageId) {
                                group.emailStatus = 'not_found';
                                group.emailVerifiedAt = new Date().toISOString();
                            }
                        });
                        renderMessages();
                    } else {
                        alert(`Email finder failed: ${result.message || result.error}`);
                        buttons.forEach(btn => {
                            btn.classList.remove('loading');
                            btn.innerHTML = '<i class="fas fa-search"></i> Ask Email';
                            btn.disabled = false;
                        });
                    }
                }
                
            } catch (error) {
                console.error('[EMAIL_FINDER] Error:', error);
                alert('Email finder temporarily unavailable. Please try again later.');
                
                buttons.forEach(btn => {
                    btn.classList.remove('loading');
                    btn.innerHTML = '<i class="fas fa-search"></i> Ask Email';
                    btn.disabled = false;
                });
            }
        }

        function createMessageTypeBlock(type, label, messagesArray, iconClass) {
            if (!messagesArray || messagesArray.length === 0) {
                return '';
            }

            const latestMessage = messagesArray[0];
            const latestMessageText = cleanMessageText(latestMessage.message || '');
            const latestPreview = latestMessageText.length > 80 ? latestMessageText.substring(0, 80) + '...' : latestMessageText;
            const uniqueId = `${type}-${latestMessage.id}`;
            const hasMultiple = messagesArray.length > 1;
            
            let historyHTML = '';
            
            historyHTML += `
                <div class="message-history-item latest">
                    <div class="message-timestamp">
                        <i class="fas fa-clock"></i>
                        Latest: ${formatMessageDate(latestMessage.created_at || latestMessage.createdAt)}
                    </div>
                    <div class="message-content-preview" id="preview-${uniqueId}">${latestPreview}</div>
                    <div class="message-text" id="message-${uniqueId}" style="display: none;">
                        ${latestMessageText}
                    </div>
                </div>
            `;
            
            if (hasMultiple) {
                historyHTML += `<div class="message-history-previous" id="history-${uniqueId}" style="display: none;">`;
                
                messagesArray.slice(1).forEach((msg, index) => {
                    const msgText = cleanMessageText(msg.message || '');
                    const msgPreview = msgText.length > 60 ? msgText.substring(0, 60) + '...' : msgText;
                    const msgUniqueId = `${type}-${msg.id}`;
                    
                    historyHTML += `
                        <div class="message-history-item collapsed" onclick="toggleHistoryMessage('${msgUniqueId}', this)">
                            <div class="message-timestamp">
                                <i class="fas fa-history"></i>
                                Previous: ${formatMessageDate(msg.created_at || msg.createdAt)}
                            </div>
                            <div class="message-content-preview" id="preview-${msgUniqueId}">${msgPreview}</div>
                            <div class="message-text" id="message-${msgUniqueId}" style="display: none;">
                                ${msgText}
                            </div>
                        </div>
                    `;
                });
                
                historyHTML += `</div>`;
            }
            
            return `
                <div class="message-type-block ${type}">
                    <div class="message-type-header">
                        <div class="message-type-label ${type}">
                            <i class="${iconClass}"></i>
                            ${label}
                        </div>
                        <div class="message-actions">
                            <button class="edit-btn" onclick="editMessage('${type}', ${latestMessage.id})">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="copy-btn" onclick="copyMessage('${type}', ${latestMessage.id}, this)">
                                <i class="fas fa-copy"></i> Copy
                            </button>
                        </div>
                    </div>
                    ${historyHTML}
                    <div style="display: flex; align-items: center; justify-content: center; gap: 1rem; margin-top: 0.8rem;">
                        ${hasMultiple ? `
                        <button class="expand-btn" onclick="toggleMessageHistory('${uniqueId}', this)">
                            <i class="fas fa-history"></i> History
                        </button>` : ''}
                        <button class="expand-btn" onclick="toggleMessageExpand('${uniqueId}', this)">
                            <i class="fas fa-chevron-down"></i> Expand
                        </button>
                        ${hasMultiple ? `<span class="message-version-count">${messagesArray.length} versions</span>` : ''}
                    </div>
                </div>
            `;
        }

        function formatMessageDate(dateString) {
            try {
                let dateToFormat = dateString;
                
                if (!dateToFormat) {
                    return 'Just now';
                }
                
                const date = new Date(dateToFormat);
                
                if (isNaN(date.getTime())) {
                    return 'Date unavailable';
                }
                
                const now = new Date();
                const diffTime = now - date;
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                
                if (diffDays === 0) {
                    return date.toLocaleTimeString('en-US', { 
                        hour: '2-digit', 
                        minute: '2-digit',
                        hour12: true 
                    }) + ' (today)';
                } else if (diffDays === 1) {
                    return date.toLocaleTimeString('en-US', { 
                        hour: '2-digit', 
                        minute: '2-digit',
                        hour12: true 
                    }) + ' (yesterday)';
                } else if (diffDays < 7) {
                    return date.toLocaleDateString('en-US', { 
                        weekday: 'short',
                        hour: '2-digit', 
                        minute: '2-digit',
                        hour12: true 
                    });
                } else {
                    return date.toLocaleDateString('en-US', {
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: true
                    });
                }
            } catch (error) {
                return 'Date error';
            }
        }

        function toggleMessageHistory(messageId, button) {
            const historyElement = document.getElementById(`history-${messageId}`);
            const isVisible = historyElement.style.display !== 'none';
            
            if (isVisible) {
                historyElement.style.display = 'none';
                button.innerHTML = '<i class="fas fa-history"></i> History';
            } else {
                historyElement.style.display = 'block';
                button.innerHTML = '<i class="fas fa-history"></i> Hide History';
            }
        }

        function toggleHistoryMessage(messageId, element) {
            const messageElement = document.getElementById(`message-${messageId}`);
            const previewElement = document.getElementById(`preview-${messageId}`);
            const isExpanded = messageElement.style.display !== 'none';
            
            if (isExpanded) {
                messageElement.style.display = 'none';
                previewElement.style.display = 'block';
                element.classList.add('collapsed');
            } else {
                messageElement.style.display = 'block';
                previewElement.style.display = 'none';
                element.classList.remove('collapsed');
            }
        }

        function toggleMessageExpand(messageId, button) {
            const messageElement = document.getElementById(`message-${messageId}`);
            const previewElement = document.getElementById(`preview-${messageId}`);
            
            if (!messageElement || !previewElement) {
                return;
            }
            
            const isExpanded = messageElement.style.display === 'block';
            
            if (isExpanded) {
                messageElement.style.display = 'none';
                previewElement.style.display = 'block';
                button.innerHTML = '<i class="fas fa-chevron-down"></i> Expand';
            } else {
                messageElement.style.display = 'block';
                previewElement.style.display = 'none';
                button.innerHTML = '<i class="fas fa-chevron-up"></i> Collapse';
            }
        }

        function editMessage(type, messageId) {
            alert(`Edit functionality for ${type} message (ID: ${messageId}) will be implemented in a future update.`);
        }

        async function copyMessage(type, messageId, button) {
            try {
                let targetMessage = null;
                Object.values(groupedMessages).forEach(group => {
                    ['linkedin', 'connection', 'email'].forEach(messageType => {
                        const messages = group.messages[messageType];
                        if (Array.isArray(messages)) {
                            const found = messages.find(m => m.id === messageId);
                            if (found) targetMessage = found;
                        }
                    });
                });
                
                if (!targetMessage || !targetMessage.message) {
                    throw new Error('Message not found');
                }
                
                const cleanMessage = cleanMessageText(targetMessage.message);
                
                await navigator.clipboard.writeText(cleanMessage);
                
                const originalHTML = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check"></i> Copied!';
                button.classList.add('copied');
                
                setTimeout(() => {
                    button.innerHTML = originalHTML;
                    button.classList.remove('copied');
                }, 2000);
                
            } catch (error) {
                const originalHTML = button.innerHTML;
                button.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Error';
                
                setTimeout(() => {
                    button.innerHTML = originalHTML;
                }, 2000);
            }
        }

        function cleanMessageText(messageText) {
            if (!messageText) return '';
            
            const cleanedText = messageText.replace(/^MSG_\d+\s*/i, '');
            const finalText = cleanedText.replace(/^Subject:\s*/i, '');
            
            return finalText.trim();
        }

        function createOutreachTimeline(messages, messageGroup) {
            console.log('[TIMELINE] ====== Creating timeline for messageGroup:', messageGroup.id, '======');
            console.log('[TIMELINE] messageGroup.sent:', messageGroup.sent, 'type:', typeof messageGroup.sent);
            console.log('[TIMELINE] messageGroup.gotReply:', messageGroup.gotReply, 'type:', typeof messageGroup.gotReply);
            console.log('[TIMELINE] messages array:', messages);
            
            // Always show all 3 message types in order
            const allMessageTypes = [
                { type: 'linkedin', label: 'LinkedIn Message', icon: 'fab fa-linkedin' },
                { type: 'email', label: 'Cold Email', icon: 'fas fa-envelope' },
                { type: 'connection', label: 'Connection Request', icon: 'fas fa-user-plus' }
            ];
            
            let html = '';
            
            // Loop through all 3 message types - always display all
            allMessageTypes.forEach((msgType, index) => {
                // Find if this message type exists in actual messages
                const actualMessage = messages && messages.find(m => m.type === msgType.type);
                const hasMessage = !!actualMessage;
                const isDisabled = !hasMessage;
                
                console.log(`[TIMELINE] ${msgType.type}: hasMessage=${hasMessage}`, actualMessage);
                
                // Set date and message text
                let dateStr = 'N/A';
                let messageText = '';
                let messageId = null;
                
                if (hasMessage) {
                    messageId = actualMessage.id;
                    console.log(`[TIMELINE] Message ID: ${messageId}`);
                    
                    // Use formatMessageDate function that already exists and works
                    if (actualMessage.created_at || actualMessage.createdAt) {
                        const dateValue = actualMessage.created_at || actualMessage.createdAt;
                        console.log(`[TIMELINE] Date value: "${dateValue}"`);
                        const formattedDate = formatMessageDate(dateValue);
                        console.log(`[TIMELINE] Formatted date: "${formattedDate}"`);
                        dateStr = `(${formattedDate})`;
                    } else {
                        console.warn('[TIMELINE] No date available for message');
                    }
                    
                    // Get actual message text and clean it
                    messageText = cleanMessageText(actualMessage.message) || '';
                    console.log(`[TIMELINE] Message text length: ${messageText.length} chars`);
                }
                
                const uniqueId = `msg-${messageGroup.id}-${msgType.type}`;
                
                // CRITICAL FIX: Get status from INDIVIDUAL MESSAGE, not messageGroup!
                let sentStatus = 'pending';
                let replyStatus = 'pending';
                
                if (hasMessage && actualMessage) {
                    // Use the individual message's sent/gotReply status
                    sentStatus = actualMessage.sent === 'yes' ? 'yes' : (actualMessage.sent === 'no' ? 'no' : 'pending');
                    replyStatus = actualMessage.gotReply === 'yes' ? 'yes' : (actualMessage.gotReply === 'no' ? 'no' : 'pending');
                    
                    console.log(`[TIMELINE] Message ${messageId} statuses - sent: "${sentStatus}", reply: "${replyStatus}"`);
                } else {
                    console.log(`[TIMELINE] No message for ${msgType.type}, using pending status`);
                }
                
                const sentChecked = sentStatus === 'yes' ? 'checked' : '';
                const replyChecked = replyStatus === 'yes' ? 'checked' : '';
                
                // Status icons for header (always show)
                const sentIcon = sentStatus === 'yes' ? '<i class="fas fa-check-circle" style="color: #10B981;"></i>' : 
                                 (sentStatus === 'no' ? '<i class="fas fa-times-circle" style="color: #EF4444;"></i>' : 
                                 '<i class="fas fa-question-circle" style="color: #9CA3AF;"></i>');
                const replyIcon = replyStatus === 'yes' ? '<i class="fas fa-check-circle" style="color: #10B981;"></i>' : 
                                  (replyStatus === 'no' ? '<i class="fas fa-times-circle" style="color: #EF4444;"></i>' : 
                                  '<i class="fas fa-question-circle" style="color: #9CA3AF;"></i>');
                
                html += `
                    <div class="history-timeline-item ${isDisabled ? 'history-item-disabled' : ''}" style="margin-bottom: 0.5rem;">
                        <div class="history-item-header" onclick="${!isDisabled ? `toggleHistoryItem('${uniqueId}')` : ''}" style="cursor: ${isDisabled ? 'not-allowed' : 'pointer'}; opacity: ${isDisabled ? '0.6' : '1'}; padding: 0.75rem 1rem; background: ${isDisabled ? '#F9FAFB' : '#F3F4F6'}; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <i class="fas fa-chevron-right chevron-toggle" id="chevron-${uniqueId}" style="transition: transform 0.2s; color: #6B7280; font-size: 0.8rem;"></i>
                                <i class="${msgType.icon}" style="color: ${isDisabled ? '#9CA3AF' : 'var(--primary-purple)'};"></i>
                                <span style="font-weight: 600; color: ${isDisabled ? '#9CA3AF' : '#1F2937'};">${msgType.label}</span>
                                <span style="color: #9CA3AF; font-size: 0.9rem;">${dateStr}</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <span style="font-size: 0.85rem; color: #6B7280;">Message Sent</span>
                                ${sentIcon}
                                <span style="font-size: 0.85rem; color: #6B7280;">Got Reply</span>
                                ${replyIcon}
                            </div>
                        </div>
                        <div class="history-item-body" id="${uniqueId}">
                            ${hasMessage ? `
                                <div class="message-text-content">
                                    ${messageText}
                                </div>
                                <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; padding-top: 0.75rem; border-top: 1px solid #E5E7EB;">
                                    <button onclick="editMessage('${msgType.type}', ${messageId}); event.stopPropagation();" style="padding: 0.4rem 0.8rem; background: white; border: 1.5px solid #D1D5DB; border-radius: 6px; cursor: pointer; font-size: 0.85rem; color: #374151; font-weight: 500;">
                                        <i class="fas fa-edit"></i> Edit
                                    </button>
                                    <button onclick="copyMessageToClipboard(\`${messageText.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`, this); event.stopPropagation();" style="padding: 0.4rem 0.8rem; background: white; border: 1.5px solid #D1D5DB; border-radius: 6px; cursor: pointer; font-size: 0.85rem; color: #374151; font-weight: 500;">
                                        <i class="fas fa-copy"></i> Copy
                                    </button>
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 0.75rem; padding-top: 1rem; border-top: 1px solid #E5E7EB;">
                                    <div style="display: flex; align-items: center; gap: 1rem;">
                                        <span style="font-weight: 700; color: #1F2937; font-size: 0.8rem; letter-spacing: 0.5px; min-width: 100px;">MESSAGE SENT</span>
                                        <div class="toggle-switch ${sentStatus}" data-message-id="${messageId}" data-field="sent" style="position: relative; display: inline-block; width: 50px; height: 26px; cursor: pointer; background-color: ${sentStatus === 'yes' ? '#10B981' : (sentStatus === 'no' ? '#EF4444' : '#D1D5DB')}; transition: 0.3s; border-radius: 26px;">
                                            <div class="toggle-slider" style="position: absolute; content: ''; height: 20px; width: 20px; left: ${sentStatus === 'yes' ? '27px' : '3px'}; bottom: 3px; background-color: white; transition: 0.3s; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; color: ${sentStatus === 'yes' ? '#10B981' : (sentStatus === 'no' ? '#EF4444' : '#9CA3AF')}; font-weight: bold;">
                                                ${sentStatus === 'yes' ? '✓' : (sentStatus === 'no' ? '✕' : '?')}
                                            </div>
                                        </div>
                                        <span class="status-label-sent" data-message-id="${messageId}" style="font-weight: 600; color: ${sentStatus === 'yes' ? '#10B981' : (sentStatus === 'no' ? '#EF4444' : '#9CA3AF')}; font-size: 0.85rem; min-width: 65px;">
                                            ${sentStatus === 'yes' ? 'YES' : (sentStatus === 'no' ? 'NO' : 'PENDING')}
                                        </span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 1rem;">
                                        <span style="font-weight: 700; color: #1F2937; font-size: 0.8rem; letter-spacing: 0.5px; min-width: 100px;">GOT REPLY</span>
                                        <div class="toggle-switch ${replyStatus}" data-message-id="${messageId}" data-field="gotReply" style="position: relative; display: inline-block; width: 50px; height: 26px; cursor: pointer; background-color: ${replyStatus === 'yes' ? '#10B981' : (replyStatus === 'no' ? '#EF4444' : '#D1D5DB')}; transition: 0.3s; border-radius: 26px;">
                                            <div class="toggle-slider" style="position: absolute; content: ''; height: 20px; width: 20px; left: ${replyStatus === 'yes' ? '27px' : '3px'}; bottom: 3px; background-color: white; transition: 0.3s; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; color: ${replyStatus === 'yes' ? '#10B981' : (replyStatus === 'no' ? '#EF4444' : '#9CA3AF')}; font-weight: bold;">
                                                ${replyStatus === 'yes' ? '✓' : (replyStatus === 'no' ? '✕' : '?')}
                                            </div>
                                        </div>
                                        <span class="status-label-gotReply" data-message-id="${messageId}" style="font-weight: 600; color: ${replyStatus === 'yes' ? '#10B981' : (replyStatus === 'no' ? '#EF4444' : '#9CA3AF')}; font-size: 0.85rem; min-width: 65px;">
                                            ${replyStatus === 'yes' ? 'YES' : (replyStatus === 'no' ? 'NO' : 'PENDING')}
                                        </span>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            console.log('[TIMELINE] ====== Timeline creation complete ======');
            return html || '<div class="no-outreach-yet">No outreach messages yet</div>';
        }

        function attachToggleClickHandlers() {
            console.log('[TOGGLE] Attaching click handlers to all toggles');
            
            // Find all toggle switches
            const allToggles = document.querySelectorAll('.toggle-switch');
            console.log('[TOGGLE] Found', allToggles.length, 'toggle switches');
            
            allToggles.forEach(toggle => {
                // Check if already has handler (prevent duplicate listeners)
                if (toggle.dataset.handlerAttached === 'true') {
                    console.log('[TOGGLE] Handler already attached, skipping');
                    return;
                }
                
                // Mark as having handler
                toggle.dataset.handlerAttached = 'true';
                
                // Add click handler
                toggle.addEventListener('click', function(e) {
                    e.stopPropagation();
                    
                    const messageId = parseInt(this.getAttribute('data-message-id'));
                    const field = this.getAttribute('data-field');
                    
                    console.log('[TOGGLE] Toggle clicked - messageId:', messageId, 'field:', field);
                    
                    if (messageId && field) {
                        toggleStatus(messageId, field);
                    } else {
                        console.error('[TOGGLE] Missing data attributes:', { messageId, field });
                    }
                });
            });
            
            console.log('[TOGGLE] Click handlers attached');
        }

        function toggleHistoryItem(itemId) {
            const body = document.getElementById(itemId);
            const chevron = document.getElementById('chevron-' + itemId);
            
            if (body && chevron) {
                const isExpanded = body.style.display === 'block';
                
                if (isExpanded) {
                    body.style.display = 'none';
                    chevron.style.transform = 'rotate(0deg)';
                } else {
                    body.style.display = 'block';
                    chevron.style.transform = 'rotate(90deg)';
                }
            }
        }

        function copyMessageToClipboard(text, button) {
            navigator.clipboard.writeText(text).then(() => {
                const originalHTML = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check"></i> Copied!';
                button.style.background = '#10B981';
                button.style.color = 'white';
                button.style.borderColor = '#10B981';
                
                setTimeout(() => {
                    button.innerHTML = originalHTML;
                    button.style.background = 'white';
                    button.style.color = '#374151';
                    button.style.borderColor = '#D1D5DB';
                }, 2000);
            }).catch(err => {
                console.error('Copy failed:', err);
            });
        }

        function editMessage(type, messageId) {
            alert(`Edit functionality for ${type} message (ID: ${messageId}) will be implemented in a future update.`);
        }

        function copyEmailAddress(email, button) {
            navigator.clipboard.writeText(email).then(() => {
                const originalHTML = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check"></i> Copied!';
                button.classList.add('copied');
                
                setTimeout(() => {
                    button.innerHTML = originalHTML;
                    button.classList.remove('copied');
                }, 2000);
            });
        }

        function getStatusIcon(status) {
            switch(status) {
                case 'yes': return '✓';
                case 'no': return '✗';
                default: return '?';
            }
        }

        function getStatusLabel(status) {
            switch(status) {
                case 'yes': return 'YES';
                case 'no': return 'NO';
                default: return 'PENDING';
            }
        }

        function toggleStatus(messageId, field) {
            console.log('[TOGGLE] toggleStatus called - messageId:', messageId, 'field:', field);
            
            // Find the actual message in the groupedMessages structure
            let foundMessage = null;
            let foundGroup = null;
            let messageType = null;
            
            for (const group of Object.values(groupedMessages)) {
                // Check linkedin messages
                foundMessage = group.messages.linkedin.find(m => m.id === messageId);
                if (foundMessage) {
                    foundGroup = group;
                    messageType = 'linkedin';
                    break;
                }
                
                // Check email messages
                foundMessage = group.messages.email.find(m => m.id === messageId);
                if (foundMessage) {
                    foundGroup = group;
                    messageType = 'email';
                    break;
                }
                
                // Check connection messages
                foundMessage = group.messages.connection.find(m => m.id === messageId);
                if (foundMessage) {
                    foundGroup = group;
                    messageType = 'connection';
                    break;
                }
            }
            
            if (!foundMessage) {
                console.error('[TOGGLE] Message not found for ID:', messageId);
                return;
            }
            
            console.log('[TOGGLE] Found message:', messageType, 'Current status:', foundMessage[field]);
            
            // Cycle through: pending → yes → no → pending
            switch(foundMessage[field]) {
                case 'pending':
                case null:
                case undefined:
                    foundMessage[field] = 'yes';
                    break;
                case 'yes':
                    foundMessage[field] = 'no';
                    break;
                case 'no':
                    foundMessage[field] = 'pending';
                    break;
            }
            
            console.log('[TOGGLE] New status:', foundMessage[field]);
            
            // Mark this individual message as modified
            markIndividualMessageModified(messageId, foundGroup.id);
            updateToggleDisplay(messageId, field, foundMessage[field]);
            updateMessagesStats();
        }

        function updateToggleDisplay(messageId, field, status) {
            console.log('[TOGGLE] updateToggleDisplay - messageId:', messageId, 'field:', field, 'status:', status);
            
            // Find all toggle switches for this specific message and field
            const toggles = document.querySelectorAll(`.toggle-switch[data-message-id="${messageId}"][data-field="${field}"]`);
            console.log('[TOGGLE] Found', toggles.length, 'toggles to update');
            
            toggles.forEach(toggle => {
                console.log('[TOGGLE] Updating toggle');
                
                // Update the toggle switch background
                toggle.className = `toggle-switch ${status}`;
                toggle.style.backgroundColor = status === 'yes' ? '#10B981' : (status === 'no' ? '#EF4444' : '#D1D5DB');
                
                // Update the slider (knob)
                const slider = toggle.querySelector('.toggle-slider');
                if (slider) {
                    slider.style.left = status === 'yes' ? '27px' : '3px';
                    slider.style.color = status === 'yes' ? '#10B981' : (status === 'no' ? '#EF4444' : '#9CA3AF');
                    slider.innerHTML = getStatusIcon(status);
                }
            });
            
            // Update status labels for this message
            const labelClass = field === 'sent' ? '.status-label-sent' : '.status-label-gotReply';
            const labels = document.querySelectorAll(`${labelClass}[data-message-id="${messageId}"]`);
            labels.forEach(label => {
                label.textContent = getStatusLabel(status);
                label.style.color = status === 'yes' ? '#10B981' : (status === 'no' ? '#EF4444' : '#9CA3AF');
            });
            
            console.log('[TOGGLE] Display updated');
        }

        function toggleMessageSent(messageId, isChecked) {
            const messageGroup = Object.values(groupedMessages).find(group => group.id === messageId);
            if (!messageGroup) return;
            
            messageGroup.sent = isChecked ? 'yes' : 'no';
            markMessageModified(messageId);
            
            // Update label
            const card = document.querySelector(`[data-target-id="${messageId}"]`);
            if (card) {
                const labels = card.querySelectorAll('.status-toggle-compact:first-child .toggle-status-label');
                labels.forEach(label => {
                    label.textContent = isChecked ? 'YES' : 'NO';
                    label.className = 'toggle-status-label ' + (isChecked ? 'yes' : 'no');
                });
            }
        }

        function toggleGotReply(messageId, isChecked) {
            const messageGroup = Object.values(groupedMessages).find(group => group.id === messageId);
            if (!messageGroup) return;
            
            messageGroup.gotReply = isChecked ? 'yes' : 'no';
            markMessageModified(messageId);
            
            // Update label
            const card = document.querySelector(`[data-target-id="${messageId}"]`);
            if (card) {
                const labels = card.querySelectorAll('.status-toggle-compact:last-child .toggle-status-label');
                labels.forEach(label => {
                    label.textContent = isChecked ? 'YES' : 'NO';
                    label.className = 'toggle-status-label ' + (isChecked ? 'yes' : 'no');
                });
            }
        }

        function closeEmailModal() {
            document.getElementById('emailFinderModal').classList.remove('active');
        }

        function closeInsufficientCreditsModal() {
            document.getElementById('insufficientCreditsModal').classList.remove('active');
        }

        function closeUpgradeModal() {
            document.getElementById('upgradeModal').classList.remove('active');
        }

        function getStatusIcon(status) {
            switch(status) {
                case 'yes': return '✓';
                case 'no': return '✗';
                default: return '?';
            }
        }

        function getStatusLabel(status) {
            switch(status) {
                case 'yes': return 'Yes';
                case 'no': return 'No';
                default: return 'Pending';
            }
        }

        function updateComment(messageId, value) {
            const messageGroup = Object.values(groupedMessages).find(group => group.id === messageId);
            if (messageGroup) {
                messageGroup.comments = value;
                markMessageModified(messageId);
            }
        }

        function markFieldModified(messageId) {
            markMessageModified(messageId);
            
            const commentFields = document.querySelectorAll(`textarea[onchange*="${messageId}"]`);
            commentFields.forEach(field => field.classList.add('modified'));
        }

        // Track individual message changes separately
        const pendingMessageChanges = new Map(); // messageId -> groupId

        function markIndividualMessageModified(messageId, groupId) {
            console.log('[SAVE] Marking individual message modified:', messageId, 'in group:', groupId);
            pendingMessageChanges.set(messageId, groupId);
            
            // Also mark the group as modified for UI purposes
            markMessageModified(groupId);
        }

        function markMessageModified(messageId) {
            if (!pendingChanges.has(messageId)) {
                pendingChanges.set(messageId, true);
            }
            
            const saveButtons = document.querySelectorAll(`#save-${messageId}`);
            saveButtons.forEach(btn => btn.classList.add('modified'));
        }

        async function saveMessage(groupId) {
            const messageGroup = Object.values(groupedMessages).find(group => group.id === groupId);
            if (!messageGroup || !pendingChanges.has(groupId)) return;
            
            const saveButtons = document.querySelectorAll(`#save-${groupId}`);
            
            try {
                saveButtons.forEach(btn => {
                    btn.classList.add('saving');
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                });
                
                const token = getAuthToken();
                if (!token) {
                    window.location.href = '/login';
                    return;
                }
                
                // Collect all modified individual messages for this group
                const modifiedMessages = [];
                
                for (const [messageId, relatedGroupId] of pendingMessageChanges.entries()) {
                    if (relatedGroupId === groupId) {
                        // Find the message
                        const allMessages = [
                            ...messageGroup.messages.linkedin,
                            ...messageGroup.messages.email,
                            ...messageGroup.messages.connection
                        ];
                        
                        const message = allMessages.find(m => m.id === messageId);
                        if (message) {
                            modifiedMessages.push({
                                id: message.id,
                                sent: message.sent,
                                got_reply: message.gotReply
                            });
                        }
                    }
                }
                
                console.log('[SAVE] Saving', modifiedMessages.length, 'modified messages');
                
                // Save all modified messages
                const savePromises = modifiedMessages.map(async (msg) => {
                    const response = await fetch(`/messages/individual/${msg.id}`, {
                        method: 'PUT',
                        headers: { 
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            sent: msg.sent,
                            got_reply: msg.got_reply
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Failed to save message ${msg.id}`);
                    }
                    
                    return response.json();
                });
                
                // Also save group-level data (comments)
                const groupResponse = await fetch(`/messages/${groupId}`, {
                    method: 'PUT',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        comments: messageGroup.comments
                    })
                });
                
                if (groupResponse.status === 401) {
                    localStorage.removeItem('authToken');
                    window.location.href = '/login';
                    return;
                }
                
                // Wait for all saves to complete
                await Promise.all([...savePromises, groupResponse]);
                
                saveButtons.forEach(btn => {
                    btn.classList.remove('saving', 'modified');
                    btn.classList.add('saved');
                    btn.innerHTML = '<i class="fas fa-check"></i> Saved!';
                });
                
                // Clear pending changes
                pendingChanges.delete(groupId);
                for (const [messageId, relatedGroupId] of pendingMessageChanges.entries()) {
                    if (relatedGroupId === groupId) {
                        pendingMessageChanges.delete(messageId);
                    }
                }
                
                setTimeout(() => {
                    saveButtons.forEach(btn => {
                        btn.classList.remove('saved');
                        btn.innerHTML = '<i class="fas fa-save"></i> Save Changes';
                    });
                }, 2000);
                
            } catch (error) {
                console.error('[MESSAGES] Error saving message:', error);
                
                saveButtons.forEach(btn => {
                    btn.classList.remove('saving');
                    btn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Error';
                });
                
                setTimeout(() => {
                    saveButtons.forEach(btn => {
                        btn.classList.add('modified');
                        btn.innerHTML = '<i class="fas fa-save"></i> Save Changes';
                    });
                }, 3000);
            }
        }

        function updateMessagesStats() {
            const totalMessages = filteredMessages.length;
            const sentMessages = filteredMessages.filter(group => group.sent === 'yes').length;
            const repliedMessages = filteredMessages.filter(group => group.gotReply === 'yes').length;
            const responseRate = sentMessages > 0 ? Math.round((repliedMessages / sentMessages) * 100) : 0;
            
            document.getElementById('totalMessages').textContent = totalMessages;
            document.getElementById('sentMessages').textContent = sentMessages;
            document.getElementById('repliedMessages').textContent = repliedMessages;
            document.getElementById('responseRate').textContent = `${responseRate}%`;
        }

        function refreshMessages() {
            const refreshBtn = document.querySelector('.refresh-btn i');
            refreshBtn.classList.add('fa-spin');
            
            // Also refresh user profile to get latest credits
            loadUserProfile();
            
            loadMessagesData().finally(() => {
                refreshBtn.classList.remove('fa-spin');
            });
        }

        function showEmptyState() {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('emptyState').style.display = 'block';
            document.getElementById('messagesCardsGrid').style.display = 'none';
            document.getElementById('paginationInfo').style.display = 'none';
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('active');
        }

        function logout() {
            localStorage.removeItem('authToken');
            window.location.href = '/login';
        }

        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal-overlay')) {
                closeEmailModal();
                closeInsufficientCreditsModal();
                closeUpgradeModal();
            }
        });

        document.addEventListener('click', function(event) {
            const sidebar = document.getElementById('sidebar');
            const toggle = document.querySelector('.sidebar-toggle');
            
            if (window.innerWidth <= 768 && 
                !sidebar.contains(event.target) && 
                !toggle.contains(event.target) && 
                sidebar.classList.contains('active')) {
                sidebar.classList.remove('active');
            }
        });
    </script>
</body>
</html>
