<!DOCTYPE html>
<html lang="en">
<head>
<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-5CNT3VV9');</script>
<!-- End Google Tag Manager -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messages - Msgly AI</title>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-purple: #8039DF;
            --dark-purple: #3E0075;
            --glow-purple: #9F4EFF;
            --neon-purple: #7B2CBF;
            --electric-purple: #6A1B9A;
            --light-purple: #F5EDFF;
            --accent-pink: #FF2370;
            --success-green: #10B981;
            --warning-orange: #F59E0B;
            --error-red: #EF4444;
            --black: #111827;
            --charcoal: #1F2937;
            --dark-gray: #374151;
            --gray: #6B7280;
            --light-gray: #F9FAFB;
            --white: #FFFFFF;
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 8px 25px rgba(0, 0, 0, 0.12);
            --glow-shadow: 0 0 30px rgba(128, 57, 223, 0.25);
            --intense-glow: 0 0 45px rgba(128, 57, 223, 0.35);
            --neon-glow: 0 0 60px rgba(128, 57, 223, 0.25);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--light-gray);
            min-height: 100vh;
            display: flex;
        }

        /* Side Navigation */
        .sidebar {
            width: 280px;
            background: linear-gradient(180deg, var(--primary-purple) 0%, var(--dark-purple) 100%);
            color: var(--white);
            position: fixed;
            height: 100vh;
            left: 0;
            top: 0;
            z-index: 1000;
            overflow-y: auto;
            transition: transform 0.3s ease;
            box-shadow: var(--shadow-lg);
        }

        .sidebar-header {
            padding: 2rem 1.5rem 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-logo {
            display: flex;
            align-items: center;
            text-decoration: none;
            color: var(--white);
            margin-bottom: 1rem;
        }

        .sidebar-logo i {
            font-size: 2rem;
            margin-right: 12px;
            filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.3));
        }

        .sidebar-logo-text {
            display: flex;
            flex-direction: column;
        }

        .sidebar-logo-main {
            font-size: 1.5rem;
            font-weight: 700;
            line-height: 1.2;
        }

        .sidebar-logo-sub {
            font-size: 0.7rem;
            opacity: 0.8;
            font-weight: 400;
        }

        .sidebar-user {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }

        .sidebar-user-avatar {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .sidebar-user-info {
            flex: 1;
            min-width: 0;
        }

        .sidebar-user-name {
            font-weight: 600;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .sidebar-user-email {
            font-size: 0.75rem;
            opacity: 0.8;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .sidebar-user-plan {
            font-size: 0.7rem;
            opacity: 0.7;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .sidebar-nav {
            padding: 1.5rem 0;
        }

        .nav-section {
            margin-bottom: 2rem;
        }

        .nav-section-title {
            padding: 0 1.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 0.5rem;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1.5rem;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .nav-item:hover, .nav-item.active {
            background: rgba(255, 255, 255, 0.15);
            color: var(--white);
            box-shadow: inset 4px 0 0 var(--white);
        }

        .nav-item i {
            width: 20px;
            margin-right: 12px;
            font-size: 1.1rem;
        }

        .nav-item-text {
            font-size: 0.9rem;
            font-weight: 500;
            flex: 1;
        }

        .nav-badge {
            background: rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.7rem;
            padding: 0.2rem 0.5rem;
            border-radius: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .nav-badge.new {
            background: var(--accent-pink);
            color: var(--white);
        }

        .nav-badge.soon {
            background: rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.8);
        }

        .sidebar-footer {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .logout-btn {
            width: 100%;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: var(--white);
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        /* Mobile Sidebar Toggle */
        .sidebar-toggle {
            display: none;
            position: fixed;
            top: 1rem;
            left: 1rem;
            z-index: 1001;
            background: var(--primary-purple);
            color: var(--white);
            border: none;
            border-radius: 8px;
            padding: 0.75rem;
            cursor: pointer;
            box-shadow: var(--shadow);
        }

        /* Main Content */
        .main-wrapper {
            flex: 1;
            margin-left: 280px;
            min-height: 100vh;
            transition: margin-left 0.3s ease;
        }

        .main-content {
            padding: 1.5rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .page-header {
            margin-bottom: 2rem;
        }

        .page-title {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--black);
        }

        .page-subtitle {
            color: var(--gray);
            font-size: 1rem;
            margin-top: 0.4rem;
        }

        .messages-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-box {
            flex: 1;
            min-width: 300px;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 0.8rem 1rem 0.8rem 3rem;
            border: 2px solid var(--light-gray);
            border-radius: 25px;
            font-size: 0.9rem;
            background: var(--white);
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary-purple);
            box-shadow: 0 0 15px rgba(128, 57, 223, 0.15);
        }

        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
            font-size: 1.1rem;
        }

        .messages-stats {
            display: flex;
            gap: 1rem;
        }

        .stat-item {
            text-align: center;
            padding: 0.8rem 1.2rem;
            background: var(--white);
            border-radius: 12px;
            box-shadow: var(--shadow);
            min-width: 100px;
            position: relative;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: 900;
            color: var(--primary-purple);
            margin-bottom: 0.2rem;
        }

        .stat-label {
            font-size: 0.7rem;
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        /* Response Rate Tooltip */
        .stat-item.response-rate {
            cursor: help;
        }

        .stat-item.response-rate::after {
            content: "Percentage of sent messages that received replies";
            position: absolute;
            bottom: -40px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--black);
            color: var(--white);
            padding: 0.5rem;
            border-radius: 6px;
            font-size: 0.75rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .stat-item.response-rate:hover::after {
            opacity: 1;
            visibility: visible;
            bottom: -35px;
        }

        .messages-filters {
            display: flex;
            gap: 0.8rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 0.6rem 1rem;
            border: 2px solid var(--light-gray);
            background: var(--white);
            color: var(--gray);
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .filter-btn:hover {
            border-color: var(--primary-purple);
            color: var(--primary-purple);
        }

        .filter-btn.active {
            background: linear-gradient(135deg, var(--primary-purple) 0%, var(--dark-purple) 100%);
            color: var(--white);
            border-color: var(--primary-purple);
        }

        /* MESSAGES TABLE - Enhanced Design */
        .messages-card {
            background: var(--white);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            border: 1px solid rgba(128, 57, 223, 0.08);
            position: relative;
            overflow: hidden;
        }

        .messages-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-purple) 0%, var(--electric-purple) 100%);
        }

        .messages-table-wrapper {
            overflow-x: auto;
            border-radius: 12px;
            border: 1px solid var(--light-gray);
            background: var(--white);
        }

        .messages-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .messages-table th {
            background: linear-gradient(135deg, var(--light-purple) 0%, rgba(128, 57, 223, 0.08) 100%);
            color: var(--dark-gray);
            font-weight: 700;
            padding: 1rem 0.75rem;
            text-align: left;
            border-bottom: 2px solid var(--primary-purple);
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .messages-table td {
            padding: 1rem 0.75rem;
            border-bottom: 1px solid var(--light-gray);
            vertical-align: top;
        }

        .messages-table tbody tr {
            transition: all 0.3s ease;
        }

        .messages-table tbody tr:hover {
            background: rgba(128, 57, 223, 0.02);
        }

        /* Column Widths - UPDATED for new Context column */
        .col-message { width: 30%; }
        .col-context { width: 20%; }
        .col-target { width: 18%; }
        .col-sent { width: 10%; }
        .col-reply { width: 10%; }
        .col-comment { width: 12%; }
        .col-actions { width: 5%; }

        /* Message Content */
        .message-content {
            max-width: 400px;
        }

        .message-text {
            line-height: 1.4;
            color: var(--dark-gray);
        }

        .message-text.truncated {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .message-expand {
            color: var(--primary-purple);
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            margin-top: 0.5rem;
            display: inline-block;
            transition: all 0.3s ease;
        }

        .message-expand:hover {
            color: var(--dark-purple);
            text-decoration: underline;
        }

        .message-id {
            font-size: 0.7rem;
            color: var(--gray);
            font-weight: 600;
            background: var(--light-gray);
            padding: 0.2rem 0.5rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            display: inline-block;
        }

        /* NEW: Context Column Styles */
        .context-content {
            max-width: 300px;
            font-size: 0.8rem;
            line-height: 1.4;
            color: var(--dark-gray);
        }

        .context-content.truncated {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .context-expand {
            color: var(--primary-purple);
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: 0.3rem;
            display: inline-block;
            transition: all 0.3s ease;
        }

        .context-expand:hover {
            color: var(--dark-purple);
            text-decoration: underline;
        }

        /* Target Profile - Show first name only */
        .target-profile {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }

        .target-name {
            font-weight: 700;
            color: var(--black);
            font-size: 0.9rem;
        }

        .target-role {
            color: var(--dark-gray);
            font-size: 0.8rem;
            font-weight: 500;
        }

        .target-company {
            color: var(--gray);
            font-size: 0.75rem;
        }

        /* STATUS TOGGLES - Modern iOS-style Design */
        .status-toggle {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }

        .toggle-switch {
            position: relative;
            width: 60px;
            height: 28px;
            background: var(--light-gray);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .toggle-switch.pending {
            background: var(--light-gray);
        }

        .toggle-switch.yes {
            background: linear-gradient(135deg, var(--success-green) 0%, #059669 100%);
            border-color: var(--success-green);
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.25);
        }

        .toggle-switch.no {
            background: linear-gradient(135deg, var(--error-red) 0%, #DC2626 100%);
            border-color: var(--error-red);
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.25);
        }

        .toggle-switch.modified {
            border-color: var(--warning-orange);
            box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.2);
        }

        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: var(--white);
            border-radius: 50%;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 700;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .toggle-switch.pending .toggle-slider {
            background: var(--gray);
            color: var(--white);
        }

        .toggle-switch.yes .toggle-slider {
            transform: translateX(32px);
            background: var(--white);
            color: var(--success-green);
        }

        .toggle-switch.no .toggle-slider {
            background: var(--white);
            color: var(--error-red);
        }

        .toggle-label {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            min-width: 50px;
            text-align: center;
        }

        .toggle-switch.pending + .toggle-label {
            color: var(--gray);
        }

        .toggle-switch.yes + .toggle-label {
            color: var(--success-green);
        }

        .toggle-switch.no + .toggle-label {
            color: var(--error-red);
        }

        /* Comments Field */
        .comment-field {
            width: 100%;
            min-height: 60px;
            max-height: 120px;
            padding: 0.8rem;
            border: 2px solid var(--light-gray);
            border-radius: 8px;
            font-size: 0.8rem;
            font-family: inherit;
            resize: vertical;
            transition: all 0.3s ease;
        }

        .comment-field:focus {
            outline: none;
            border-color: var(--primary-purple);
            box-shadow: 0 0 0 2px rgba(128, 57, 223, 0.1);
        }

        .comment-field.modified {
            border-color: var(--warning-orange);
            box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.1);
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            min-width: 80px;
            align-items: center;
        }

        .save-btn {
            padding: 0.5rem 1rem;
            background: linear-gradient(135deg, var(--primary-purple) 0%, var(--dark-purple) 100%);
            color: var(--white);
            border: none;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            opacity: 0.6;
            transform: scale(0.9);
            box-shadow: var(--glow-shadow);
        }

        .save-btn.modified {
            opacity: 1;
            transform: scale(1);
            box-shadow: 0 4px 15px rgba(128, 57, 223, 0.3);
        }

        .save-btn:hover.modified {
            background: linear-gradient(135deg, var(--electric-purple) 0%, var(--primary-purple) 100%);
            transform: translateY(-1px) scale(1);
        }

        .save-btn.saving {
            background: var(--warning-orange);
            cursor: not-allowed;
        }

        .save-btn.saved {
            background: var(--success-green);
        }

        .refresh-btn {
            background: none;
            border: none;
            color: var(--gray);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-size: 1.1rem;
        }

        .refresh-btn:hover {
            background: var(--light-purple);
            color: var(--primary-purple);
        }

        /* Loading & Empty States */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 300px;
            flex-direction: column;
            gap: 1rem;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--light-gray);
            border-top: 3px solid var(--primary-purple);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .empty-state {
            text-align: center;
            padding: 3rem 2rem;
            color: var(--gray);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: var(--primary-purple);
            opacity: 0.3;
        }

        .empty-state h3 {
            font-size: 1.2rem;
            margin-bottom: 0.6rem;
            color: var(--dark-gray);
        }

        .empty-state p {
            font-size: 0.9rem;
            line-height: 1.4;
            max-width: 400px;
            margin: 0 auto;
        }

        /* MOBILE CARDS VIEW - FIXED: No duplication */
        .messages-cards {
            display: none;
        }

        .message-card {
            background: var(--white);
            border: 1px solid var(--light-gray);
            border-radius: 12px;
            padding: 1.2rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .message-card:hover {
            box-shadow: var(--shadow);
            transform: translateY(-1px);
        }

        .message-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
            gap: 1rem;
        }

        .card-target-profile {
            flex: 1;
        }

        .card-message-content {
            margin-bottom: 1rem;
        }

        .card-message-text {
            background: var(--light-gray);
            padding: 0.8rem;
            border-radius: 8px;
            font-size: 0.85rem;
            line-height: 1.4;
            color: var(--dark-gray);
            margin-bottom: 0.8rem;
        }

        /* NEW: Context section for mobile */
        .card-context-content {
            background: rgba(128, 57, 223, 0.05);
            padding: 0.8rem;
            border-radius: 8px;
            font-size: 0.8rem;
            line-height: 1.4;
            color: var(--dark-gray);
            border-left: 3px solid var(--primary-purple);
        }

        .card-context-label {
            font-size: 0.7rem;
            color: var(--primary-purple);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }

        .card-status-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.2rem;
        }

        .card-status-item {
            text-align: center;
        }

        .card-status-label {
            font-size: 0.7rem;
            color: var(--gray);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }

        .card-comment {
            margin-bottom: 1rem;
        }

        .card-comment label {
            display: block;
            font-size: 0.8rem;
            color: var(--dark-gray);
            font-weight: 600;
            margin-bottom: 0.4rem;
        }

        .card-actions {
            display: flex;
            justify-content: flex-end;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Mobile Responsive */
        @media (max-width: 1024px) {
            .messages-table-wrapper {
                overflow-x: auto;
            }

            .messages-table {
                min-width: 1100px; /* Increased for Context column */
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .sidebar-toggle {
                display: block;
            }

            .main-wrapper {
                margin-left: 0;
            }

            .main-content {
                padding: 1rem;
                margin-top: 4rem;
            }

            .messages-controls {
                flex-direction: column;
            }

            .search-box {
                min-width: auto;
            }

            .messages-stats {
                justify-content: center;
                flex-wrap: wrap;
            }

            .stat-item {
                min-width: 80px;
                padding: 0.6rem;
            }

            /* Switch to card view on mobile */
            .messages-table-wrapper {
                display: none;
            }

            .messages-cards {
                display: block;
            }

            .toggle-switch {
                width: 50px;
                height: 24px;
            }

            .toggle-slider {
                width: 18px;
                height: 18px;
                font-size: 0.6rem;
            }

            .toggle-switch.yes .toggle-slider {
                transform: translateX(26px);
            }
        }
    </style>
</head>
<body>
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5CNT3VV9"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->
    <!-- Mobile Sidebar Toggle -->
    <button class="sidebar-toggle" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Side Navigation -->
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <a href="https://api.msgly.ai/dashboard" class="sidebar-logo">
                <i class="fas fa-comments"></i>
                <div class="sidebar-logo-text">
                    <div class="sidebar-logo-main">Msgly.AI</div>
                    <div class="sidebar-logo-sub">By Chopa AI LTD</div>
                </div>
            </a>
            
            <div class="sidebar-user">
                <div class="sidebar-user-avatar" id="sidebarUserAvatar">??</div>
                <div class="sidebar-user-info">
                    <div class="sidebar-user-name" id="sidebarUserName">Loading...</div>
                    <div class="sidebar-user-email" id="sidebarUserEmail">Loading...</div>
                    <div class="sidebar-user-plan" id="sidebarUserPlan">Loading...</div>
                </div>
            </div>
        </div>

        <div class="sidebar-nav">
            <div class="nav-section">
                <div class="nav-section-title">Main Menu</div>
                <a href="https://api.msgly.ai/dashboard" class="nav-item">
                    <i class="fas fa-tachometer-alt"></i>
                    <span class="nav-item-text">Dashboard</span>
                </a>
                <a href="https://api.msgly.ai/msgly-profile.html" class="nav-item">
                    <i class="fas fa-user-circle"></i>
                    <span class="nav-item-text">Msgly Profile</span>
                </a>
                <a href="https://api.msgly.ai/messages" class="nav-item active">
                    <i class="fas fa-envelope"></i>
                    <span class="nav-item-text">Messages</span>
                </a>
                <a href="#" class="nav-item" onclick="alert('Analytics coming soon!')">
                    <i class="fas fa-chart-line"></i>
                    <span class="nav-item-text">Analytics</span>
                    <span class="nav-badge soon">Soon</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Account</div>
                <a href="https://chopa.chargebeeportal.com/portal/v2/login?forward=portal_main" class="nav-item" target="_blank">
                    <i class="fas fa-credit-card"></i>
                    <span class="nav-item-text">Billing</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Support</div>
                <a href="#" class="nav-item" onclick="alert('Help Center coming soon!')">
                    <i class="fas fa-question-circle"></i>
                    <span class="nav-item-text">Help Center</span>
                </a>
            </div>
        </div>

        <div class="sidebar-footer">
            <a href="#" class="logout-btn" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i>
                Logout
            </a>
        </div>
    </nav>

    <!-- Main Content Wrapper -->
    <div class="main-wrapper">
        <main class="main-content">
            <div class="container">
        <div class="page-header">
            <div>
                <h1 class="page-title">Messages</h1>
                <p class="page-subtitle">Manage your LinkedIn outreach campaigns and track responses</p>
            </div>
        </div>

        <div class="messages-controls">
            <div class="search-box">
                <i class="fas fa-search search-icon"></i>
                <input type="text" class="search-input" placeholder="Search messages, names, companies..." 
                       id="searchInput" oninput="searchMessages(this.value)">
            </div>
            <div class="messages-stats">
                <div class="stat-item">
                    <div class="stat-number" id="totalMessages">0</div>
                    <div class="stat-label">Total</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="sentMessages">0</div>
                    <div class="stat-label">Sent</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="repliedMessages">0</div>
                    <div class="stat-label">Replied</div>
                </div>
                <div class="stat-item response-rate">
                    <div class="stat-number" id="responseRate">0%</div>
                    <div class="stat-label">Response Rate</div>
                </div>
            </div>
            <button class="refresh-btn" onclick="refreshMessages()" title="Refresh Messages">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>

        <div class="messages-filters">
            <button class="filter-btn active" onclick="filterMessages('all')">
                <i class="fas fa-list"></i>
                All
            </button>
            <button class="filter-btn" onclick="filterMessages('sent')">
                <i class="fas fa-paper-plane"></i>
                Sent
            </button>
            <button class="filter-btn" onclick="filterMessages('replied')">
                <i class="fas fa-reply"></i>
                Replied
            </button>
            <button class="filter-btn" onclick="filterMessages('pending')">
                <i class="fas fa-clock"></i>
                Pending
            </button>
        </div>

        <div class="messages-card">
            <!-- Loading State -->
            <div class="loading" id="loadingState">
                <div class="spinner"></div>
                <p>Loading messages...</p>
            </div>

            <!-- Desktop Table View -->
            <div class="messages-table-wrapper" id="messagesTableWrapper" style="display: none;">
                <table class="messages-table">
                    <thead>
                        <tr>
                            <th class="col-message">Message</th>
                            <th class="col-context">Context</th>
                            <th class="col-target">Target Profile</th>
                            <th class="col-sent">Sent</th>
                            <th class="col-reply">Reply</th>
                            <th class="col-comment">Comments</th>
                            <th class="col-actions">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="messagesTableBody">
                        <!-- Messages will be populated here -->
                    </tbody>
                </table>
            </div>

            <!-- Mobile Cards View -->
            <div class="messages-cards" id="messagesCards">
                <!-- Message cards will be populated here -->
            </div>

            <!-- Empty State -->
            <div class="empty-state" id="emptyState" style="display: none;">
                <i class="fas fa-envelope-open"></i>
                <h3>No Messages Found</h3>
                <p>Generate your first LinkedIn message using the Chrome extension, then return here to track your outreach campaign.</p>
            </div>
        </div>
            </div>
        </main>
    </div>

    <script>
        // Global variables
        let messagesData = [];
        let filteredMessages = [];
        let currentFilter = 'all';
        let currentSearchTerm = '';
        let pendingChanges = new Map();

        // FIXED: Authentication check and data loading + user profile loading
        document.addEventListener('DOMContentLoaded', function() {
            if (!checkAuthentication()) {
                return; // Redirect will happen in checkAuthentication
            }
            loadUserProfile(); // NEW: Load user profile for sidebar
            loadMessagesData();
        });

        function checkAuthentication() {
            const token = getAuthToken();
            if (!token) {
                // FIXED: Redirect to login instead of dashboard
                window.location.href = '/login';
                return false;
            }
            return true;
        }

        function getAuthToken() {
            return localStorage.getItem('authToken');
        }

        // NEW: Load user profile for sidebar (FIXES LOADING ISSUE)
        async function loadUserProfile() {
            try {
                const token = getAuthToken();
                if (!token) {
                    window.location.href = '/login';
                    return;
                }

                const response = await fetch('/profile', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.status === 401) {
                    localStorage.removeItem('authToken');
                    window.location.href = '/login';
                    return;
                }

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                
                if (data.success) {
                    // Update sidebar user info
                    const user = data.data.user;
                    
                    document.getElementById('sidebarUserName').textContent = user.displayName || user.email;
                    document.getElementById('sidebarUserEmail').textContent = user.email;
                    document.getElementById('sidebarUserPlan').textContent = user.plan || 'Free Plan';
                    
                    // Update avatar with initials
                    const displayName = user.displayName || user.email;
                    const initials = getInitials(displayName);
                    document.getElementById('sidebarUserAvatar').textContent = initials;
                    
                    console.log('[PROFILE] User profile loaded successfully');
                } else {
                    throw new Error(data.error || 'Failed to load profile');
                }
                
            } catch (error) {
                console.error('[PROFILE] Error loading user profile:', error);
                // Fallback: show generic info
                document.getElementById('sidebarUserName').textContent = 'User';
                document.getElementById('sidebarUserEmail').textContent = 'user@example.com';
                document.getElementById('sidebarUserPlan').textContent = 'Free Plan';
                document.getElementById('sidebarUserAvatar').textContent = 'U';
            }
        }

        // NEW: Helper function to get initials
        function getInitials(name) {
            if (!name) return '??';
            
            const parts = name.split(' ');
            if (parts.length >= 2) {
                return (parts[0][0] + parts[1][0]).toUpperCase();
            } else {
                return name.substring(0, 2).toUpperCase();
            }
        }

        // REAL DATA: Authentication-aware data loading from API
        async function loadMessagesData() {
            try {
                // Show loading state
                document.getElementById('loadingState').style.display = 'flex';
                
                // Check auth token
                const token = getAuthToken();
                if (!token) {
                    // FIXED: Redirect to login instead of dashboard
                    window.location.href = '/login';
                    return;
                }
                
                console.log('[MESSAGES] Loading real messages from API...');
                
                // REAL API CALL: Get messages from database
                const response = await fetch('/messages/history', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.status === 401) {
                    // Token expired, redirect to login
                    localStorage.removeItem('authToken');
                    // FIXED: Redirect to login instead of dashboard
                    window.location.href = '/login';
                    return;
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    messagesData = data.data || [];
                    console.log(`[MESSAGES] Loaded ${messagesData.length} real messages from database`);
                } else {
                    throw new Error(data.error || 'Failed to load messages');
                }
                
                applyFilters();
                
            } catch (error) {
                console.error('[MESSAGES] Error loading messages:', error);
                
                // Check if it's an authentication error
                if (error.message && error.message.includes('401')) {
                    localStorage.removeItem('authToken');
                    // FIXED: Redirect to login instead of dashboard
                    window.location.href = '/login';
                    return;
                }
                
                showEmptyState();
            }
        }

        function applyFilters() {
            // Apply status filter
            let filtered = filterMessagesByStatus(messagesData);
            
            // Apply search filter
            if (currentSearchTerm) {
                filtered = filtered.filter(message => 
                    (message.message && message.message.toLowerCase().includes(currentSearchTerm.toLowerCase())) ||
                    (message.context && message.context.toLowerCase().includes(currentSearchTerm.toLowerCase())) ||
                    (message.target.firstName && message.target.firstName.toLowerCase().includes(currentSearchTerm.toLowerCase())) ||
                    (message.targetProfile.role && message.targetProfile.role.toLowerCase().includes(currentSearchTerm.toLowerCase())) ||
                    (message.targetProfile.company && message.targetProfile.company.toLowerCase().includes(currentSearchTerm.toLowerCase())) ||
                    (message.comments && message.comments.toLowerCase().includes(currentSearchTerm.toLowerCase()))
                );
            }
            
            filteredMessages = filtered;
            renderMessages();
            updateMessagesStats();
        }

        function searchMessages(searchTerm) {
            currentSearchTerm = searchTerm.trim();
            applyFilters();
        }

        function renderMessages() {
            const tableBody = document.getElementById('messagesTableBody');
            const cardsContainer = document.getElementById('messagesCards');
            
            if (filteredMessages.length === 0) {
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('messagesTableWrapper').style.display = 'none';
                document.getElementById('emptyState').style.display = 'block';
                return;
            }
            
            // Clear existing content
            tableBody.innerHTML = '';
            cardsContainer.innerHTML = '';
            
            filteredMessages.forEach(message => {
                // Render table row
                const tableRow = createTableRow(message);
                tableBody.appendChild(tableRow);
                
                // Render mobile card
                const messageCard = createMessageCard(message);
                cardsContainer.appendChild(messageCard);
            });
            
            // Show content
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('messagesTableWrapper').style.display = 'block';
            document.getElementById('emptyState').style.display = 'none';
        }

        // FIXED: Remove MSG_XXX IDs and add Context column
        function createTableRow(message) {
            const row = document.createElement('tr');
            
            // Clean message text by removing MSG_XXX prefix
            const cleanMessage = cleanMessageText(message.message || 'No message content');
            const context = message.context || 'No context available';
            
            row.innerHTML = `
                <td class="col-message">
                    <div class="message-content">
                        <div class="message-text ${cleanMessage.length > 150 ? 'truncated' : ''}" id="message-${message.id}">
                            ${cleanMessage}
                        </div>
                        ${cleanMessage.length > 150 ? 
                            `<div class="message-expand" onclick="toggleMessageExpand(${message.id})">Read more...</div>` : ''
                        }
                    </div>
                </td>
                <td class="col-context">
                    <div class="context-content ${context.length > 100 ? 'truncated' : ''}" id="context-${message.id}">
                        ${context}
                    </div>
                    ${context.length > 100 ? 
                        `<div class="context-expand" onclick="toggleContextExpand(${message.id})">Show more...</div>` : ''
                    }
                </td>
                <td class="col-target">
                    <div class="target-profile">
                        <div class="target-name">${message.targetProfile.firstName || 'Unknown'}</div>
                        <div class="target-role">${message.targetProfile.role || 'Professional'}</div>
                        <div class="target-company">${message.targetProfile.company || 'Company'}</div>
                    </div>
                </td>
                <td class="col-sent">
                    <div class="status-toggle">
                        <div class="toggle-switch ${message.sent}" onclick="toggleStatus(${message.id}, 'sent')">
                            <div class="toggle-slider">${getStatusIcon(message.sent)}</div>
                        </div>
                        <div class="toggle-label">${getStatusLabel(message.sent)}</div>
                    </div>
                </td>
                <td class="col-reply">
                    <div class="status-toggle">
                        <div class="toggle-switch ${message.gotReply}" onclick="toggleStatus(${message.id}, 'gotReply')">
                            <div class="toggle-slider">${getStatusIcon(message.gotReply)}</div>
                        </div>
                        <div class="toggle-label">${getStatusLabel(message.gotReply)}</div>
                    </div>
                </td>
                <td class="col-comment">
                    <textarea 
                        class="comment-field" 
                        placeholder="Add notes..."
                        onchange="updateComment(${message.id}, this.value)"
                        onkeyup="markFieldModified(${message.id})"
                    >${message.comments || ''}</textarea>
                </td>
                <td class="col-actions">
                    <div class="action-buttons">
                        <button class="save-btn" id="save-${message.id}" onclick="saveMessage(${message.id})">
                            <i class="fas fa-save"></i>
                        </button>
                    </div>
                </td>
            `;
            return row;
        }

        // FIXED: Mobile cards without duplication + Context section
        function createMessageCard(message) {
            const card = document.createElement('div');
            card.className = 'message-card';
            
            // Clean message text by removing MSG_XXX prefix
            const cleanMessage = cleanMessageText(message.message || 'No message content');
            const context = message.context || 'No context available';
            
            card.innerHTML = `
                <div class="message-card-header">
                    <div class="card-target-profile">
                        <div class="target-name">${message.targetProfile.firstName || 'Unknown'}</div>
                        <div class="target-role">${message.targetProfile.role || 'Professional'}</div>
                        <div class="target-company">${message.targetProfile.company || 'Company'}</div>
                    </div>
                </div>
                
                <div class="card-message-content">
                    <div class="card-message-text ${cleanMessage.length > 120 ? 'truncated' : ''}" id="card-message-${message.id}">
                        ${cleanMessage}
                    </div>
                    ${cleanMessage.length > 120 ? 
                        `<div class="message-expand" onclick="toggleCardMessageExpand(${message.id})">Read more...</div>` : ''
                    }
                    
                    <div class="card-context-label">Context Used:</div>
                    <div class="card-context-content ${context.length > 80 ? 'truncated' : ''}" id="card-context-${message.id}">
                        ${context}
                    </div>
                    ${context.length > 80 ? 
                        `<div class="context-expand" onclick="toggleCardContextExpand(${message.id})">Show more...</div>` : ''
                    }
                </div>
                
                <div class="card-status-row">
                    <div class="card-status-item">
                        <div class="card-status-label">Message Sent</div>
                        <div class="status-toggle">
                            <div class="toggle-switch ${message.sent}" onclick="toggleStatus(${message.id}, 'sent')">
                                <div class="toggle-slider">${getStatusIcon(message.sent)}</div>
                            </div>
                            <div class="toggle-label">${getStatusLabel(message.sent)}</div>
                        </div>
                    </div>
                    
                    <div class="card-status-item">
                        <div class="card-status-label">Got Reply</div>
                        <div class="status-toggle">
                            <div class="toggle-switch ${message.gotReply}" onclick="toggleStatus(${message.id}, 'gotReply')">
                                <div class="toggle-slider">${getStatusIcon(message.gotReply)}</div>
                            </div>
                            <div class="toggle-label">${getStatusLabel(message.gotReply)}</div>
                        </div>
                    </div>
                </div>
                
                <div class="card-comment">
                    <label>Comments:</label>
                    <textarea 
                        class="comment-field" 
                        placeholder="Add notes..."
                        onchange="updateComment(${message.id}, this.value)"
                        onkeyup="markFieldModified(${message.id})"
                    >${message.comments || ''}</textarea>
                </div>
                
                <div class="card-actions">
                    <button class="save-btn" id="card-save-${message.id}" onclick="saveMessage(${message.id})">
                        <i class="fas fa-save"></i> Save
                    </button>
                </div>
            `;
            return card;
        }

        // NEW: Function to clean message text by removing MSG_XXX prefix
        function cleanMessageText(messageText) {
            if (!messageText) return '';
            
            // Remove MSG_XXX pattern from the beginning of the message
            const cleanedText = messageText.replace(/^MSG_\d+\s*/i, '');
            
            // Also remove Subject: prefix if it exists
            const finalText = cleanedText.replace(/^Subject:\s*/i, '');
            
            return finalText.trim();
        }

        function getStatusIcon(status) {
            switch(status) {
                case 'yes': return '✓';
                case 'no': return '✗';
                default: return '?';
            }
        }

        function getStatusLabel(status) {
            switch(status) {
                case 'yes': return 'Yes';
                case 'no': return 'No';
                default: return 'Pending';
            }
        }

        function toggleStatus(messageId, field) {
            const message = messagesData.find(m => m.id === messageId);
            if (!message) return;
            
            // Cycle through: pending -> yes -> no -> pending
            switch(message[field]) {
                case 'pending':
                    message[field] = 'yes';
                    break;
                case 'yes':
                    message[field] = 'no';
                    break;
                case 'no':
                    message[field] = 'pending';
                    break;
            }
            
            markMessageModified(messageId);
            updateToggleDisplay(messageId, field, message[field]);
            updateMessagesStats();
        }

        function updateToggleDisplay(messageId, field, status) {
            const selectors = [
                `[onclick="toggleStatus(${messageId}, '${field}')"]`,
            ];
            
            selectors.forEach(selector => {
                const toggles = document.querySelectorAll(selector);
                toggles.forEach(toggle => {
                    toggle.className = `toggle-switch ${status} modified`;
                    const slider = toggle.querySelector('.toggle-slider');
                    const label = toggle.nextElementSibling;
                    
                    if (slider) slider.textContent = getStatusIcon(status);
                    if (label) label.textContent = getStatusLabel(status);
                });
            });
        }

        function updateComment(messageId, value) {
            const message = messagesData.find(m => m.id === messageId);
            if (message) {
                message.comments = value;
                markMessageModified(messageId);
            }
        }

        function markFieldModified(messageId) {
            markMessageModified(messageId);
            
            const commentFields = document.querySelectorAll(`textarea[onchange*="${messageId}"]`);
            commentFields.forEach(field => field.classList.add('modified'));
        }

        function markMessageModified(messageId) {
            if (!pendingChanges.has(messageId)) {
                pendingChanges.set(messageId, true);
            }
            
            const saveButtons = document.querySelectorAll(`#save-${messageId}, #card-save-${messageId}`);
            saveButtons.forEach(btn => btn.classList.add('modified'));
        }

        // REAL API: Authentication-aware save function
        async function saveMessage(messageId) {
            const message = messagesData.find(m => m.id === messageId);
            if (!message || !pendingChanges.has(messageId)) return;
            
            const saveButtons = document.querySelectorAll(`#save-${messageId}, #card-save-${messageId}`);
            
            try {
                saveButtons.forEach(btn => {
                    btn.classList.add('saving');
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                });
                
                // Check authentication before making API call
                const token = getAuthToken();
                if (!token) {
                    // FIXED: Redirect to login instead of dashboard
                    window.location.href = '/login';
                    return;
                }
                
                console.log(`[MESSAGES] Saving message ${messageId} to database...`);
                
                // REAL API CALL: Update message in database
                const response = await fetch(`/messages/${messageId}`, {
                    method: 'PUT',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sent_status: message.sent,
                        reply_status: message.gotReply,
                        comments: message.comments
                    })
                });
                
                if (response.status === 401) {
                    // Token expired, redirect to login
                    localStorage.removeItem('authToken');
                    // FIXED: Redirect to login instead of dashboard
                    window.location.href = '/login';
                    return;
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || 'Failed to save message');
                }
                
                saveButtons.forEach(btn => {
                    btn.classList.remove('saving', 'modified');
                    btn.classList.add('saved');
                    btn.innerHTML = '<i class="fas fa-check"></i>';
                });
                
                pendingChanges.delete(messageId);
                
                const toggles = document.querySelectorAll(`[onclick*="${messageId}"]`);
                toggles.forEach(toggle => toggle.classList.remove('modified'));
                
                const commentFields = document.querySelectorAll(`textarea[onchange*="${messageId}"]`);
                commentFields.forEach(field => field.classList.remove('modified'));
                
                setTimeout(() => {
                    saveButtons.forEach(btn => {
                        btn.classList.remove('saved');
                        btn.innerHTML = '<i class="fas fa-save"></i>';
                    });
                }, 2000);
                
                console.log(`[MESSAGES] Message ${messageId} saved successfully to database`);
                
            } catch (error) {
                console.error('[MESSAGES] Error saving message:', error);
                
                // Check if it's an authentication error
                if (error.message && error.message.includes('401')) {
                    localStorage.removeItem('authToken');
                    // FIXED: Redirect to login instead of dashboard
                    window.location.href = '/login';
                    return;
                }
                
                saveButtons.forEach(btn => {
                    btn.classList.remove('saving');
                    btn.innerHTML = '<i class="fas fa-exclamation-triangle"></i>';
                });
                
                setTimeout(() => {
                    saveButtons.forEach(btn => {
                        btn.classList.add('modified');
                        btn.innerHTML = '<i class="fas fa-save"></i>';
                    });
                }, 3000);
            }
        }

        function toggleMessageExpand(messageId) {
            const messageEl = document.getElementById(`message-${messageId}`);
            const expandBtn = messageEl.nextElementSibling;
            
            if (messageEl.classList.contains('truncated')) {
                messageEl.classList.remove('truncated');
                expandBtn.textContent = 'Show less';
            } else {
                messageEl.classList.add('truncated');
                expandBtn.textContent = 'Read more...';
            }
        }

        function toggleContextExpand(messageId) {
            const contextEl = document.getElementById(`context-${messageId}`);
            const expandBtn = contextEl.nextElementSibling;
            
            if (contextEl.classList.contains('truncated')) {
                contextEl.classList.remove('truncated');
                expandBtn.textContent = 'Show less';
            } else {
                contextEl.classList.add('truncated');
                expandBtn.textContent = 'Show more...';
            }
        }

        function toggleCardMessageExpand(messageId) {
            const messageEl = document.getElementById(`card-message-${messageId}`);
            const expandBtn = messageEl.nextElementSibling;
            
            if (messageEl.classList.contains('truncated')) {
                messageEl.classList.remove('truncated');
                expandBtn.textContent = 'Show less';
            } else {
                messageEl.classList.add('truncated');
                expandBtn.textContent = 'Read more...';
            }
        }

        function toggleCardContextExpand(messageId) {
            const contextEl = document.getElementById(`card-context-${messageId}`);
            const expandBtn = contextEl.nextElementSibling;
            
            if (contextEl.classList.contains('truncated')) {
                contextEl.classList.remove('truncated');
                expandBtn.textContent = 'Show less';
            } else {
                contextEl.classList.add('truncated');
                expandBtn.textContent = 'Show more...';
            }
        }

        function filterMessages(status) {
            currentFilter = status;
            
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            applyFilters();
        }

        function filterMessagesByStatus(messages) {
            switch (currentFilter) {
                case 'sent':
                    return messages.filter(msg => msg.sent === 'yes');
                case 'replied':
                    return messages.filter(msg => msg.gotReply === 'yes');
                case 'pending':
                    return messages.filter(msg => msg.sent === 'yes' && msg.gotReply !== 'yes');
                case 'all':
                default:
                    return messages;
            }
        }

        // REAL STATISTICS: Calculate from actual database data
        function updateMessagesStats() {
            const totalMessages = filteredMessages.length;
            const sentMessages = filteredMessages.filter(msg => msg.sent === 'yes').length;
            const repliedMessages = filteredMessages.filter(msg => msg.gotReply === 'yes').length;
            const responseRate = sentMessages > 0 ? Math.round((repliedMessages / sentMessages) * 100) : 0;
            
            document.getElementById('totalMessages').textContent = totalMessages;
            document.getElementById('sentMessages').textContent = sentMessages;
            document.getElementById('repliedMessages').textContent = repliedMessages;
            document.getElementById('responseRate').textContent = `${responseRate}%`;
            
            console.log(`[MESSAGES] Updated stats: Total=${totalMessages}, Sent=${sentMessages}, Replied=${repliedMessages}, Rate=${responseRate}%`);
        }

        function refreshMessages() {
            console.log('[MESSAGES] Refreshing messages from database...');
            
            const refreshBtn = document.querySelector('.refresh-btn i');
            refreshBtn.classList.add('fa-spin');
            
            loadMessagesData().finally(() => {
                refreshBtn.classList.remove('fa-spin');
            });
        }

        function showEmptyState() {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('emptyState').style.display = 'block';
            document.getElementById('messagesTableWrapper').style.display = 'none';
        }

        // Sidebar navigation functions
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('active');
        }

        function showSection(section) {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.nav-item').classList.add('active');

            switch(section) {
                case 'messages':
                    // Already on messages page
                    break;
                default:
                    alert(`${section.charAt(0).toUpperCase() + section.slice(1)} section coming soon!`);
            }
        }

        function logout() {
            localStorage.removeItem('authToken');
            window.location.href = '/login';
        }

        // Close sidebar when clicking outside on mobile
        document.addEventListener('click', function(event) {
            const sidebar = document.getElementById('sidebar');
            const toggle = document.querySelector('.sidebar-toggle');
            
            if (window.innerWidth <= 768 && 
                !sidebar.contains(event.target) && 
                !toggle.contains(event.target) && 
                sidebar.classList.contains('active')) {
                sidebar.classList.remove('active');
            }
        });
    </script>
</body>
</html>
