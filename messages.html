<!DOCTYPE html>
<html lang="en">
<head>
<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-5CNT3VV9');</script>
<!-- End Google Tag Manager -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messages - Msgly AI</title>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-purple: #8039DF;
            --dark-purple: #3E0075;
            --glow-purple: #9F4EFF;
            --neon-purple: #7B2CBF;
            --electric-purple: #6A1B9A;
            --light-purple: #F5EDFF;
            --accent-pink: #FF2370;
            --success-green: #10B981;
            --warning-orange: #F59E0B;
            --error-red: #EF4444;
            --black: #111827;
            --charcoal: #1F2937;
            --dark-gray: #374151;
            --gray: #6B7280;
            --light-gray: #F9FAFB;
            --white: #FFFFFF;
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 8px 25px rgba(0, 0, 0, 0.12);
            --glow-shadow: 0 0 30px rgba(128, 57, 223, 0.25);
            --intense-glow: 0 0 45px rgba(128, 57, 223, 0.35);
            --neon-glow: 0 0 60px rgba(128, 57, 223, 0.25);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--light-gray);
            min-height: 100vh;
            display: flex;
        }

        /* Main Content */
        .main-wrapper {
            flex: 1;
            margin-left: 280px;
            min-height: 100vh;
            transition: margin-left 0.3s ease;
            overflow-x: hidden;
            width: calc(100% - 280px);
        }

        .main-content {
            padding: 1.5rem;
            max-width: 2000px;
            width: 100%;
            margin: 0 auto;
            box-sizing: border-box;
        }

        .container {
            width: 100%;
            margin: 0 auto;
        }

        .page-header {
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .page-header-left {
            flex: 1;
        }

        .page-title {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--black);
        }

        .page-subtitle {
            color: var(--gray);
            font-size: 1rem;
            margin-top: 0.4rem;
        }

        /* Credits Badge in Header */
        .page-header-credits {
            background: linear-gradient(135deg, var(--primary-purple) 0%, var(--dark-purple) 100%);
            color: var(--white);
            padding: 0.8rem 1.5rem;
            border-radius: 25px;
            display: flex;
            align-items: center;
            gap: 0.6rem;
            font-size: 1.1rem;
            font-weight: 700;
            box-shadow: var(--glow-shadow);
            transition: all 0.3s ease;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .page-header-credits i {
            font-size: 1.3rem;
            filter: drop-shadow(0 0 6px rgba(255, 255, 255, 0.5));
        }

        .page-header-credits.updating {
            animation: creditPulse 0.6s ease-in-out;
        }

        @keyframes creditPulse {
            0%, 100% { transform: scale(1); }
            50% { 
                transform: scale(1.08); 
                box-shadow: 0 0 40px rgba(128, 57, 223, 0.5);
            }
        }

        /* Search and Stats Controls */
        .messages-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-box {
            flex: 1;
            min-width: 300px;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 0.8rem 1rem 0.8rem 3rem;
            border: 2px solid #E5E7EB;
            border-radius: 25px;
            font-size: 0.9rem;
            background: var(--white);
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary-purple);
            box-shadow: 0 0 15px rgba(128, 57, 223, 0.15);
        }

        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
            font-size: 1.1rem;
        }

        .messages-stats {
            display: flex;
            gap: 1rem;
        }

        .stat-item {
            text-align: center;
            padding: 0.8rem 1.2rem;
            background: var(--white);
            border-radius: 12px;
            box-shadow: var(--shadow);
            min-width: 100px;
            position: relative;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: 900;
            color: var(--primary-purple);
            margin-bottom: 0.2rem;
        }

        .stat-label {
            font-size: 0.7rem;
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .refresh-btn {
            background: var(--white);
            border: 2px solid var(--primary-purple);
            color: var(--primary-purple);
            padding: 0.8rem 1rem;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .refresh-btn:hover {
            background: var(--primary-purple);
            color: var(--white);
            transform: translateY(-2px);
            box-shadow: var(--glow-shadow);
        }

        /* Upper Filter Menu - NEW DESIGN */
        .upper-filter-menu {
            display: flex;
            gap: 0.8rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            background: var(--white);
            padding: 1rem;
            border-radius: 12px;
            box-shadow: var(--shadow);
        }

        .upper-filter-btn {
            padding: 0.7rem 1.5rem;
            border: 2px solid #E5E7EB;
            background: var(--white);
            color: var(--gray);
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            white-space: nowrap;
        }

        .upper-filter-btn i {
            font-size: 1rem;
        }

        .upper-filter-btn:hover {
            border-color: var(--primary-purple);
            color: var(--primary-purple);
            transform: translateY(-2px);
        }

        .upper-filter-btn.active {
            background: var(--primary-purple);
            border-color: var(--primary-purple);
            color: var(--white);
            box-shadow: var(--glow-shadow);
        }

        /* Table Container - NEW DESIGN */
        .messages-table-container {
            background: var(--white);
            border-radius: 12px;
            box-shadow: var(--shadow);
            overflow: hidden;
            margin-bottom: 2rem;
        }

        .messages-table {
            width: 100%;
            border-collapse: collapse;
        }

        .messages-table thead {
            background: #F9FAFB;
            border-bottom: 2px solid #E5E7EB;
        }

        .messages-table th {
            padding: 1rem;
            text-align: left;
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--dark-gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .messages-table tbody tr {
            border-bottom: 1px solid #F3F4F6;
            transition: background 0.2s ease;
        }

        .messages-table tbody tr:hover {
            background: #F9FAFB;
        }

        .messages-table td {
            padding: 1.2rem;
            vertical-align: top;
            font-size: 0.9rem;
        }

        /* Message Column */
        .message-cell {
            max-width: 350px;
        }

        .message-date {
            font-size: 0.8rem;
            color: var(--gray);
            margin-bottom: 0.4rem;
            font-weight: 600;
        }

        .message-preview {
            color: var(--dark-gray);
            line-height: 1.4;
            margin-bottom: 0.5rem;
        }

        .message-preview-text {
            display: block;
            margin-bottom: 0.3rem;
        }

        .send-more-link {
            color: var(--primary-purple);
            font-size: 0.85rem;
            cursor: pointer;
            text-decoration: none;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
        }

        .send-more-link:hover {
            text-decoration: underline;
        }

        /* Message Type Badge */
        .message-type-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            white-space: nowrap;
        }

        .message-type-badge.linkedin {
            background: #E0E7FF;
            color: #4338CA;
        }

        .message-type-badge.email {
            background: #DBEAFE;
            color: #1E40AF;
        }

        .message-type-badge.connection {
            background: #D1FAE5;
            color: #065F46;
        }

        /* Target Profile Column */
        .target-profile-cell {
            line-height: 1.5;
        }

        .target-name {
            font-weight: 700;
            color: var(--black);
            margin-bottom: 0.2rem;
            font-size: 0.95rem;
        }

        .target-title {
            color: var(--gray);
            font-size: 0.85rem;
            margin-bottom: 0.1rem;
        }

        .target-company {
            color: var(--gray);
            font-size: 0.85rem;
        }

        /* Email Finder Column */
        .email-finder-cell {
            max-width: 250px;
        }

        .find-email-btn {
            background: var(--primary-purple);
            color: var(--white);
            border: none;
            padding: 0.6rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
        }

        .find-email-btn:hover {
            background: var(--dark-purple);
            transform: translateY(-2px);
            box-shadow: var(--glow-shadow);
        }

        .email-display {
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
        }

        .email-address-text {
            color: var(--dark-gray);
            font-size: 0.85rem;
            font-weight: 600;
            word-break: break-all;
        }

        .email-verification-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.3rem 0.6rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            width: fit-content;
        }

        .email-verification-badge.valid {
            background: #D1FAE5;
            color: #065F46;
        }

        .email-verification-badge.risky {
            background: #FEF3C7;
            color: #92400E;
        }

        .email-verification-badge.unknown {
            background: #E5E7EB;
            color: #374151;
        }

        .email-verification-badge.invalid {
            background: #FEE2E2;
            color: #991B1B;
        }

        .email-not-found {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .email-not-found-text {
            color: var(--gray);
            font-size: 0.85rem;
        }

        .try-again-btn {
            background: var(--white);
            color: var(--primary-purple);
            border: 2px solid var(--primary-purple);
            padding: 0.5rem 0.8rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            transition: all 0.3s ease;
            width: fit-content;
        }

        .try-again-btn:hover {
            background: var(--primary-purple);
            color: var(--white);
        }

        /* Toggle Switches */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
            cursor: pointer;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #E5E7EB;
            border-radius: 30px;
            transition: 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .toggle-slider::before {
            content: "";
            position: absolute;
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            border-radius: 50%;
            transition: 0.3s;
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: var(--success-green);
        }

        .toggle-switch input:checked + .toggle-slider::before {
            transform: translateX(30px);
        }

        .toggle-switch input:not(:checked) + .toggle-slider {
            background-color: #EF4444;
        }

        .toggle-label {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.65rem;
            font-weight: 700;
            color: white;
            letter-spacing: 0.3px;
            pointer-events: none;
        }

        .toggle-label.yes {
            left: 8px;
        }

        .toggle-label.no {
            right: 8px;
        }

        .toggle-switch input:checked + .toggle-slider .toggle-label.no {
            opacity: 0;
        }

        .toggle-switch input:not(:checked) + .toggle-slider .toggle-label.yes {
            opacity: 0;
        }

        /* Comments Field */
        .comments-cell {
            position: relative;
        }

        .comments-input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #E5E7EB;
            border-radius: 6px;
            font-size: 0.85rem;
            font-family: inherit;
            resize: vertical;
            min-height: 35px;
            max-height: 100px;
            transition: all 0.3s ease;
        }

        .comments-input:focus {
            outline: none;
            border-color: var(--primary-purple);
            box-shadow: 0 0 0 3px rgba(128, 57, 223, 0.1);
        }

        .comments-input.modified {
            border-color: var(--warning-orange);
        }

        /* Actions Column */
        .actions-cell {
            text-align: center;
        }

        .delete-btn {
            background: var(--primary-purple);
            color: var(--white);
            border: none;
            padding: 0.6rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
        }

        .delete-btn:hover {
            background: var(--error-red);
            transform: scale(1.1);
        }

        .save-btn {
            background: var(--success-green);
            color: var(--white);
            border: none;
            padding: 0.6rem 0.8rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.4rem;
            white-space: nowrap;
        }

        .save-btn:hover {
            background: #059669;
            transform: translateY(-2px);
        }

        .save-btn.modified {
            background: var(--warning-orange);
        }

        .save-btn.saving {
            background: var(--gray);
            cursor: not-allowed;
        }

        .save-btn.saved {
            background: var(--success-green);
        }

        /* Edit and Copy Buttons */
        .edit-btn, .copy-btn {
            background: var(--light-gray);
            border: 1px solid var(--gray);
            border-radius: 6px;
            padding: 0.4rem 0.8rem;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            color: var(--dark-gray);
        }

        .edit-btn:hover {
            background: var(--warning-orange);
            color: var(--white);
            border-color: var(--warning-orange);
        }

        .copy-btn:hover {
            background: var(--primary-purple);
            color: var(--white);
            border-color: var(--primary-purple);
        }

        .copy-btn.copied {
            background: var(--success-green);
            color: var(--white);
            border-color: var(--success-green);
        }

        .message-actions-row {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
            flex-wrap: wrap;
        }

        /* Pagination */
        .pagination-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            margin-top: 2rem;
            padding: 1rem;
            background: var(--white);
            border-radius: 12px;
            box-shadow: var(--shadow);
        }

        .pagination-info {
            color: var(--gray);
            font-size: 0.9rem;
        }

        .load-more-btn {
            background: var(--primary-purple);
            color: var(--white);
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .load-more-btn:hover {
            background: var(--dark-purple);
            transform: translateY(-2px);
            box-shadow: var(--glow-shadow);
        }

        /* Empty and Loading States */
        .loading-state, .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            background: var(--white);
            border-radius: 12px;
            box-shadow: var(--shadow);
        }

        .loading-state i {
            font-size: 3rem;
            color: var(--primary-purple);
            margin-bottom: 1rem;
            display: block;
        }

        .empty-state i {
            font-size: 4rem;
            color: var(--gray);
            margin-bottom: 1rem;
            display: block;
        }

        .empty-state h3 {
            font-size: 1.5rem;
            color: var(--black);
            margin-bottom: 0.5rem;
        }

        .empty-state p {
            color: var(--gray);
            font-size: 1rem;
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            padding: 1rem;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: var(--white);
            border-radius: 16px;
            padding: 2rem;
            max-width: 500px;
            width: 100%;
            box-shadow: var(--shadow-lg);
            transform: scale(0.9);
            transition: all 0.3s ease;
        }

        .modal-overlay.active .modal-content {
            transform: scale(1);
        }

        .modal-header {
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--black);
            margin-bottom: 0.5rem;
        }

        .modal-description {
            color: var(--gray);
            font-size: 0.95rem;
        }

        .modal-body {
            margin-bottom: 1.5rem;
        }

        .modal-footer {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        .modal-btn {
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }

        .modal-btn.secondary {
            background: var(--light-gray);
            color: var(--dark-gray);
        }

        .modal-btn.secondary:hover {
            background: #E5E7EB;
        }

        .modal-btn.primary {
            background: var(--primary-purple);
            color: var(--white);
        }

        .modal-btn.primary:hover {
            background: var(--dark-purple);
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            /* Main Content - Fix width issues */
            .main-wrapper {
                margin-left: 0 !important;
                width: 100% !important;
            }

            .main-content {
                padding: 1rem;
                padding-top: 5rem; /* Space for mobile toggle button */
            }

            /* Hide desktop table, show mobile cards */
            .messages-table-container {
                display: none;
            }

            .mobile-cards-container {
                display: block !important;
            }

            /* Mobile Message Cards - Best Practices */
            .mobile-message-card {
                background: var(--white);
                border: 1px solid #E5E7EB;
                border-radius: 12px;
                padding: 1.25rem;
                margin-bottom: 1.5rem;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            }

            .mobile-card-header {
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
                margin-bottom: 1rem;
                padding-bottom: 1rem;
                border-bottom: 1px solid #F3F4F6;
            }

            .mobile-card-section {
                margin-bottom: 1rem;
            }

            .mobile-card-label {
                font-size: 0.75rem;
                font-weight: 700;
                color: var(--gray);
                text-transform: uppercase;
                letter-spacing: 0.5px;
                margin-bottom: 0.5rem;
            }

            /* Touch Target Sizes - WCAG AAA Compliant */
            .mobile-message-card button,
            .mobile-message-card .btn,
            .mobile-message-card .status-toggle {
                min-height: 48px;
                padding: 0.75rem 1rem;
                font-size: 0.9rem;
            }

            .mobile-message-card .action-btn {
                min-height: 48px;
                padding: 0.75rem 1.25rem;
            }

            /* Stats - Mobile Layout */
            .messages-stats {
                flex-wrap: wrap;
                gap: 0.75rem;
            }

            .stat-item {
                min-width: calc(50% - 0.5rem);
                padding: 1rem;
            }

            /* Page Header - Mobile */
            .page-header {
                flex-direction: column;
                gap: 1rem;
                margin-bottom: 1.5rem;
            }

            .page-header-credits {
                width: 100%;
                justify-content: center;
            }

            /* Search Box - Mobile */
            .search-box {
                min-width: 100%;
            }

            .search-input {
                font-size: 16px; /* Prevents iOS zoom */
            }

            /* Messages Controls */
            .messages-controls {
                flex-direction: column;
                gap: 1rem;
            }
        }

        /* Hide mobile layout on desktop */
        .mobile-cards-container {
            display: none;
        }
    </style>
</head>
<body>
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5CNT3VV9"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->

    <div class="main-wrapper">
        <div class="main-content">
            <div class="container">
                <!-- Page Header -->
                <div class="page-header">
                    <div class="page-header-left">
                        <h1 class="page-title">Messages</h1>
                        <p class="page-subtitle">Manage your LinkedIn outreach campaigns and track responses</p>
                    </div>
                    <div class="page-header-credits" id="creditsDisplay">
                        <i class="fas fa-coins"></i>
                        <span id="creditsAmount">0</span>
                    </div>
                </div>

                <!-- Search and Stats -->
                <div class="messages-controls">
                    <div class="search-box">
                        <i class="fas fa-search search-icon"></i>
                        <input 
                            type="text" 
                            class="search-input" 
                            placeholder="Search messages, names, companies..."
                            oninput="searchMessages(this.value)"
                        >
                    </div>
                    <div class="messages-stats">
                        <div class="stat-item">
                            <div class="stat-number" id="totalMessages">0</div>
                            <div class="stat-label">Total</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="sentMessages">0</div>
                            <div class="stat-label">Sent</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="repliedMessages">0</div>
                            <div class="stat-label">Replied</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="responseRate">0%</div>
                            <div class="stat-label">Replied Rate</div>
                        </div>
                    </div>
                    <button class="refresh-btn" onclick="refreshMessages()">
                        <i class="fas fa-sync-alt"></i>
                        Refresh
                    </button>
                </div>

                <!-- Upper Filter Menu -->
                <div class="upper-filter-menu">
                    <button class="upper-filter-btn active" onclick="filterByStatus('all')">
                        <i class="fas fa-list"></i>
                        All
                    </button>
                    <button class="upper-filter-btn" onclick="filterByStatus('sent')">
                        <i class="fas fa-paper-plane"></i>
                        Sent
                    </button>
                    <button class="upper-filter-btn" onclick="filterByStatus('replied')">
                        <i class="fas fa-reply"></i>
                        Replied
                    </button>
                    <button class="upper-filter-btn" onclick="filterByStatus('pending')">
                        <i class="fas fa-clock"></i>
                        Pending
                    </button>
                </div>

                <!-- Loading State -->
                <div id="loadingState" class="loading-state">
                    <i class="fas fa-spinner fa-spin"></i>
                    <h3>Loading messages...</h3>
                </div>

                <!-- Empty State -->
                <div id="emptyState" class="empty-state" style="display: none;">
                    <i class="fas fa-inbox"></i>
                    <h3>No messages found</h3>
                    <p>Start your outreach campaigns to see messages here</p>
                </div>

                <!-- Messages Table (Desktop) -->
                <div id="messagesTableContainer" class="messages-table-container" style="display: none;">
                    <table class="messages-table">
                        <thead>
                            <tr>
                                <th>MESSAGE</th>
                                <th>MESSAGE TYPE</th>
                                <th>TARGET PROFILE</th>
                                <th>EMAIL FINDER & VERIFICATION</th>
                                <th>SENT</th>
                                <th>REPLY</th>
                                <th>COMMENTS</th>
                                <th>ACTIONS</th>
                            </tr>
                        </thead>
                        <tbody id="messagesTableBody">
                            <!-- Table rows will be inserted here -->
                        </tbody>
                    </table>
                </div>

                <!-- Mobile Cards Container -->
                <div id="mobileCardsContainer" class="mobile-cards-container">
                    <!-- Mobile cards will be inserted here -->
                </div>

                <!-- Pagination -->
                <div id="paginationContainer" class="pagination-container" style="display: none;">
                    <div class="pagination-info" id="showingInfo">Showing messages</div>
                    <button class="load-more-btn" id="loadMoreBtn" onclick="toggleShowAll()">
                        <i class="fas fa-eye"></i>
                        Show All Messages
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Email Finder Modal -->
    <div id="emailFinderModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Find Email Address</h2>
                <p class="modal-description">This will use 2 credits to find and verify the email address for this contact.</p>
            </div>
            <div class="modal-body">
                <p style="color: var(--gray); font-size: 0.9rem;">
                    <strong>What's included:</strong><br>
                    â€¢ Email address discovery<br>
                    â€¢ Email verification status<br>
                    â€¢ Deliverability score
                </p>
            </div>
            <div class="modal-footer">
                <button class="modal-btn secondary" onclick="closeEmailModal()">Cancel</button>
                <button class="modal-btn primary" onclick="confirmEmailFinder()">
                    <i class="fas fa-search"></i>
                    Find Email (2 credits)
                </button>
            </div>
        </div>
    </div>

    <!-- Insufficient Credits Modal -->
    <div id="insufficientCreditsModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Insufficient Credits</h2>
                <p class="modal-description">You need at least 2 credits to use the email finder.</p>
            </div>
            <div class="modal-body">
                <p style="color: var(--gray); font-size: 0.9rem;">
                    Your current balance: <strong id="currentCredits">0</strong> credits
                </p>
            </div>
            <div class="modal-footer">
                <button class="modal-btn secondary" onclick="closeInsufficientCreditsModal()">Close</button>
                <button class="modal-btn primary" onclick="window.location.href='/billing'">
                    <i class="fas fa-plus"></i>
                    Buy Credits
                </button>
            </div>
        </div>
    </div>

    <!-- Upgrade Plan Modal -->
    <div id="upgradeModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Upgrade Required</h2>
                <p class="modal-description">Email finder is available for Silver, Gold, and Platinum plans.</p>
            </div>
            <div class="modal-body">
                <p style="color: var(--gray); font-size: 0.9rem;">
                    Your current plan: <strong id="currentPlanDisplay">Free</strong>
                </p>
            </div>
            <div class="modal-footer">
                <button class="modal-btn secondary" onclick="closeUpgradeModal()">Close</button>
                <button class="modal-btn primary" onclick="window.location.href='/billing'">
                    <i class="fas fa-arrow-up"></i>
                    Upgrade Plan
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global Variables
        let allMessages = [];
        let groupedMessages = {};
        let filteredMessages = [];
        let currentStatusFilter = 'all';
        let currentSearchTerm = '';
        let showingLimited = true;
        const MESSAGES_LIMIT = 12;
        let currentUserPlan = null;
        const pendingChanges = new Map();
        const pendingMessageChanges = new Map();
        let currentEmailFinderMessageId = null;

        // Authentication
        function getAuthToken() {
            return localStorage.getItem('authToken');
        }

        function checkAuth() {
            const token = getAuthToken();
            if (!token) {
                window.location.href = '/login';
                return false;
            }
            return true;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            if (!checkAuth()) return;
            loadUserProfile();
            loadMessagesData();
        });

        // Load User Profile
        async function loadUserProfile() {
            try {
                const token = getAuthToken();
                const response = await fetch('/profile', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.status === 401) {
                    localStorage.removeItem('authToken');
                    window.location.href = '/login?returnUrl=/messages';
                    return;
                }

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                
                if (data.success) {
                    const user = data.data.user;
                    
                    // Use dual-credit calculation
                    const renewableCredits = parseFloat(user.renewableCredits || 0);
                    const payasyougoCredits = parseFloat(user.payasyougoCredits || 0);
                    const totalCredits = renewableCredits + payasyougoCredits;
                    
                    console.log('[CREDITS] Renewable:', renewableCredits.toFixed(2));
                    console.log('[CREDITS] PayAsYouGo:', payasyougoCredits.toFixed(2));
                    console.log('[CREDITS] Total:', totalCredits.toFixed(2));
                    
                    currentUserPlan = {
                        planCode: user.planCode || user.plan_code || 'free',
                        planName: user.planName || user.plan_name || 'Free',
                        totalCredits: totalCredits,
                        renewableCredits: renewableCredits,
                        payasyougoCredits: payasyougoCredits
                    };
                    
                    updateCreditsDisplay(totalCredits);
                }
            } catch (error) {
                console.error('[USER_PROFILE] Error:', error);
            }
        }

        function updateCreditsDisplay(totalCredits) {
            const creditsElement = document.getElementById('creditsAmount');
            const creditsDisplay = document.getElementById('creditsDisplay');
            
            if (creditsElement && creditsDisplay) {
                creditsElement.textContent = totalCredits.toFixed(2);
                creditsDisplay.classList.add('updating');
                setTimeout(() => creditsDisplay.classList.remove('updating'), 600);
            }
        }

        // Load Messages Data
        async function loadMessagesData() {
            try {
                const token = getAuthToken();
                const response = await fetch('/messages/history', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.status === 401) {
                    localStorage.removeItem('authToken');
                    window.location.href = '/login?returnUrl=/messages';
                    return;
                }

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                
                if (data.success) {
                    allMessages = data.data || [];
                    processMessages();
                } else {
                    throw new Error(data.error || 'Failed to load messages');
                }
                
            } catch (error) {
                console.error('[MESSAGES] Error loading messages:', error);
                
                if (error.message && error.message.includes('401')) {
                    localStorage.removeItem('authToken');
                    window.location.href = '/login';
                    return;
                }
                
                showEmptyState();
            }
        }

        // Process Messages into Individual Rows
        function processMessages() {
            const messagesList = [];
            
            console.log('[PROCESS] Raw messages from DB:', allMessages.length);
            
            allMessages.forEach(msg => {
                const target = msg.targetProfile || {};
                const messageType = normalizeMessageType(msg.message_type || msg.messageType);
                
                // Convert database values to yes/no/pending format
                // Database might have: true/false (boolean), 'yes'/'no' (string), or null
                const convertStatus = (value) => {
                    if (value === true || value === 'yes') return 'yes';
                    if (value === false || value === 'no') return 'no';
                    return 'pending';
                };
                
                const sentStatus = convertStatus(msg.sent);
                const replyStatus = convertStatus(msg.gotReply);
                
                console.log(`[PROCESS] Message ${msg.id}: sent=${msg.sent} -> ${sentStatus}, gotReply=${msg.gotReply} -> ${replyStatus}`);
                
                messagesList.push({
                    id: msg.id,
                    groupId: msg.target_profile_id || msg.targetProfileId,
                    date: msg.created_at || msg.createdAt,
                    message: msg.message || '',
                    messageType: messageType,
                    target: {
                        firstName: target.firstName || 'Unknown',
                        lastName: target.lastName || '',
                        role: target.role || '',
                        company: target.company || '',
                        email: target.email || ''
                    },
                    emailFound: msg.emailFound || target.email || null,
                    emailVerificationStatus: msg.emailStatus || msg.emailVerificationStatus || null,
                    sent: sentStatus,
                    gotReply: replyStatus,
                    comments: msg.comments || ''
                });
            });

            filteredMessages = messagesList;
            applyFilters();
        }

        function normalizeMessageType(dbMessageType) {
            if (!dbMessageType) return 'linkedin';
            const dbType = dbMessageType.toLowerCase();
            
            if (dbType.includes('connection') || dbType === 'connection_request') {
                return 'connection';
            } else if (dbType.includes('email') || dbType === 'cold_email') {
                return 'email';
            } else {
                return 'linkedin';
            }
        }

        // Filters
        function applyFilters() {
            let filtered = [...filteredMessages];
            
            // Apply status filter
            switch (currentStatusFilter) {
                case 'sent':
                    filtered = filtered.filter(msg => msg.sent === 'yes');
                    break;
                case 'replied':
                    filtered = filtered.filter(msg => msg.gotReply === 'yes');
                    break;
                case 'pending':
                    filtered = filtered.filter(msg => msg.sent === 'yes' && msg.gotReply !== 'yes');
                    break;
            }
            
            // Apply search
            if (currentSearchTerm) {
                filtered = filtered.filter(msg => {
                    const searchLower = currentSearchTerm.toLowerCase();
                    return (
                        msg.target.firstName.toLowerCase().includes(searchLower) ||
                        msg.target.lastName.toLowerCase().includes(searchLower) ||
                        msg.target.role.toLowerCase().includes(searchLower) ||
                        msg.target.company.toLowerCase().includes(searchLower) ||
                        msg.message.toLowerCase().includes(searchLower) ||
                        msg.comments.toLowerCase().includes(searchLower)
                    );
                });
            }
            
            // Sort by date (newest first)
            filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            filteredMessages = filtered;
            renderMessages();
            updateMessagesStats();
        }

        function filterByStatus(status) {
            currentStatusFilter = status;
            
            // Update active button
            document.querySelectorAll('.upper-filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            applyFilters();
        }

        function searchMessages(searchTerm) {
            currentSearchTerm = searchTerm.trim();
            applyFilters();
        }

        // Render Messages
        function renderMessages() {
            document.getElementById('loadingState').style.display = 'none';
            
            if (filteredMessages.length === 0) {
                showEmptyState();
                return;
            }
            
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('messagesTableContainer').style.display = 'block';
            
            let messagesToShow = filteredMessages;
            if (showingLimited && filteredMessages.length > MESSAGES_LIMIT) {
                messagesToShow = filteredMessages.slice(0, MESSAGES_LIMIT);
            }
            
            renderDesktopTable(messagesToShow);
            renderMobileCards(messagesToShow);
            updatePagination();
        }

        function renderDesktopTable(messages) {
            const tbody = document.getElementById('messagesTableBody');
            tbody.innerHTML = '';
            
            console.log('[RENDER] Rendering', messages.length, 'messages');
            
            messages.forEach(msg => {
                console.log('[RENDER] Message:', msg.id, 'Sent:', msg.sent, 'Reply:', msg.gotReply);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="message-cell">
                        <div class="message-date">${formatMessageDate(msg.date)}</div>
                        <div class="message-preview">
                            <span class="message-preview-text">${msg.message}</span>
                        </div>
                        <div class="message-actions-row">
                            <button class="edit-btn" onclick="editMessage(${msg.id})" title="Edit message">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="copy-btn" onclick="copyMessageText(${msg.id}, this)" title="Copy to clipboard">
                                <i class="fas fa-copy"></i> Copy
                            </button>
                        </div>
                    </td>
                    <td>
                        ${renderMessageTypeBadge(msg.messageType)}
                    </td>
                    <td class="target-profile-cell">
                        <div class="target-name">${msg.target.firstName} ${msg.target.lastName}</div>
                        <div class="target-title">${msg.target.role}</div>
                        <div class="target-company">${msg.target.company}</div>
                    </td>
                    <td class="email-finder-cell">
                        ${renderEmailFinderColumn(msg)}
                    </td>
                    <td>
                        ${renderToggleSwitch(msg.id, 'sent', msg.sent)}
                    </td>
                    <td>
                        ${renderToggleSwitch(msg.id, 'reply', msg.gotReply)}
                    </td>
                    <td class="comments-cell">
                        <textarea 
                            class="comments-input" 
                            placeholder="Add notes..."
                            onchange="updateComment(${msg.id}, this.value)"
                        >${msg.comments}</textarea>
                    </td>
                    <td class="actions-cell">
                        <div style="display: flex; gap: 0.5rem; align-items: center; justify-content: center;">
                            <button class="save-btn" id="save-${msg.id}" onclick="saveMessage(${msg.id})" style="display: none;">
                                <i class="fas fa-save"></i> Save
                            </button>
                            <button class="delete-btn" onclick="deleteMessage(${msg.id})" title="Delete message">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function renderMobileCards(messages) {
            const container = document.getElementById('mobileCardsContainer');
            container.innerHTML = '';
            
            messages.forEach(msg => {
                const card = document.createElement('div');
                card.className = 'mobile-message-card';
                card.innerHTML = `
                    <div class="mobile-card-header">
                        <div>
                            <div class="target-name">${msg.target.firstName} ${msg.target.lastName}</div>
                            <div class="target-title">${msg.target.role}</div>
                            <div class="target-company">${msg.target.company}</div>
                        </div>
                        ${renderMessageTypeBadge(msg.messageType)}
                    </div>
                    
                    <div class="mobile-card-section">
                        <div class="mobile-card-label">Message</div>
                        <div class="message-date">${formatMessageDate(msg.date)}</div>
                        <div class="message-preview-text">${truncateText(msg.message, 120)}</div>
                    </div>
                    
                    <div class="mobile-card-section">
                        <div class="mobile-card-label">Email Finder</div>
                        ${renderEmailFinderColumn(msg)}
                    </div>
                    
                    <div class="mobile-card-section" style="display: flex; gap: 1rem;">
                        <div style="flex: 1;">
                            <div class="mobile-card-label">Sent</div>
                            ${renderToggleSwitch(msg.id, 'sent', msg.sent)}
                        </div>
                        <div style="flex: 1;">
                            <div class="mobile-card-label">Reply</div>
                            ${renderToggleSwitch(msg.id, 'reply', msg.gotReply)}
                        </div>
                    </div>
                    
                    <div class="mobile-card-section">
                        <div class="mobile-card-label">Comments</div>
                        <textarea 
                            class="comments-input" 
                            placeholder="Add notes..."
                            onchange="updateComment(${msg.id}, this.value)"
                        >${msg.comments}</textarea>
                        <button class="save-btn" id="save-mobile-${msg.id}" onclick="saveMessage(${msg.id})" style="display: none;">
                            <i class="fas fa-save"></i> Save
                        </button>
                    </div>
                    
                    <div class="mobile-card-section">
                        <button class="delete-btn" onclick="deleteMessage(${msg.id})" style="width: 100%;">
                            <i class="fas fa-trash"></i> Delete Message
                        </button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function renderMessageTypeBadge(type) {
            const labels = {
                linkedin: { text: 'LinkedIn', icon: 'fab fa-linkedin' },
                email: { text: 'Email', icon: 'fas fa-envelope' },
                connection: { text: 'Connection Request', icon: 'fas fa-user-plus' }
            };
            const label = labels[type] || labels.linkedin;
            return `<span class="message-type-badge ${type}"><i class="${label.icon}"></i> ${label.text}</span>`;
        }

        function renderEmailFinderColumn(msg) {
            // If email not requested yet
            if (!msg.emailFound && !msg.emailVerificationStatus) {
                return `<button class="find-email-btn" onclick="openEmailFinder(${msg.groupId})">
                    <i class="fas fa-search"></i> Find Email
                </button>`;
            }
            
            // If email found
            if (msg.emailFound && msg.emailVerificationStatus !== 'not_found') {
                const statusLabels = {
                    valid: { text: 'âœ“ Valid', class: 'valid' },
                    risky: { text: 'âš  Risky', class: 'risky' },
                    unknown: { text: '? Unknown', class: 'unknown' },
                    catch_all: { text: '? Catch-All', class: 'unknown' },
                    invalid: { text: 'âœ— Invalid', class: 'invalid' },
                    not_valid: { text: 'âœ— Invalid', class: 'invalid' },
                    found: { text: 'â³ Verifying', class: 'unknown' }
                };
                const status = statusLabels[msg.emailVerificationStatus] || statusLabels.unknown;
                
                return `<div class="email-display">
                    <div class="email-address-text">${msg.emailFound}</div>
                    <span class="email-verification-badge ${status.class}">${status.text}</span>
                </div>`;
            }
            
            // If email not found
            return `<div class="email-not-found">
                <div class="email-not-found-text">Not Found</div>
                <button class="try-again-btn" onclick="openEmailFinder(${msg.groupId})">
                    <i class="fas fa-redo"></i> Try Again
                </button>
            </div>`;
        }

        function renderToggleSwitch(messageId, type, value) {
            const status = value || 'pending'; // 'yes', 'no', or 'pending'
            const isYes = status === 'yes';
            const isNo = status === 'no';
            const isPending = status === 'pending' || (!isYes && !isNo);
            
            let bgColor, statusText;
            if (isYes) {
                bgColor = '#10B981'; // Green
                statusText = 'YES';
            } else if (isNo) {
                bgColor = '#EF4444'; // Red
                statusText = 'NO';
            } else {
                bgColor = '#9CA3AF'; // Gray
                statusText = 'PENDING';
            }
            
            return `
                <div class="toggle-switch ${status}" 
                     data-message-id="${messageId}" 
                     data-field="${type}" 
                     onclick="toggleStatusClick(this, ${messageId}, '${type}')"
                     style="position: relative; display: inline-flex; align-items: center; justify-content: center; width: ${isPending ? '95px' : '75px'}; height: 34px; cursor: pointer; background-color: ${bgColor}; transition: all 0.3s ease; border-radius: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                    <span style="font-size: 0.7rem; font-weight: 700; color: white; letter-spacing: 0.5px; z-index: 1; pointer-events: none;">
                        ${statusText}
                    </span>
                </div>
            `;
        }

        // Helper Functions
        function formatMessageDate(dateString) {
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return 'Date unavailable';
                
                const now = new Date();
                const diffTime = now - date;
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                
                if (diffDays === 0) {
                    return 'Today, ' + date.toLocaleTimeString('en-US', { 
                        hour: '2-digit', 
                        minute: '2-digit',
                        hour12: true 
                    });
                } else if (diffDays === 1) {
                    return 'Yesterday, ' + date.toLocaleTimeString('en-US', { 
                        hour: '2-digit', 
                        minute: '2-digit',
                        hour12: true 
                    });
                } else if (diffDays < 7) {
                    return date.toLocaleDateString('en-US', { 
                        weekday: 'short',
                        month: 'short',
                        day: 'numeric'
                    });
                } else {
                    return date.toLocaleDateString('en-US', {
                        month: 'short',
                        day: 'numeric',
                        year: 'numeric'
                    });
                }
            } catch (error) {
                return 'Date error';
            }
        }

        function truncateText(text, maxLength) {
            if (!text) return '';
            const cleaned = text.replace(/\s+/g, ' ').trim();
            return cleaned.length > maxLength ? cleaned.substring(0, maxLength) + '...' : cleaned;
        }

        // Toggle Status with Click
        function toggleStatusClick(element, messageId, type) {
            const currentStatus = element.classList.contains('yes') ? 'yes' : 
                                 element.classList.contains('no') ? 'no' : 'pending';
            
            // Cycle: yes -> no -> pending -> yes
            let newStatus;
            if (currentStatus === 'yes') {
                newStatus = 'no';
            } else if (currentStatus === 'no') {
                newStatus = 'pending';
            } else {
                newStatus = 'yes';
            }
            
            // Update the visual toggle
            element.classList.remove('yes', 'no', 'pending');
            element.classList.add(newStatus);
            
            const isYes = newStatus === 'yes';
            const isNo = newStatus === 'no';
            const isPending = newStatus === 'pending';
            
            let bgColor, statusText;
            if (isYes) {
                bgColor = '#10B981';
                statusText = 'YES';
            } else if (isNo) {
                bgColor = '#EF4444';
                statusText = 'NO';
            } else {
                bgColor = '#9CA3AF';
                statusText = 'PENDING';
            }
            
            element.style.backgroundColor = bgColor;
            element.style.width = isPending ? '95px' : '75px';
            
            const label = element.querySelector('span');
            if (label) {
                label.textContent = statusText;
            }
            
            // Update the data in the message object
            const message = filteredMessages.find(m => m.id === messageId);
            if (message) {
                if (type === 'sent') {
                    message.sent = newStatus;
                } else if (type === 'reply') {
                    message.gotReply = newStatus;
                }
            }
            
            // Mark as modified to show save button
            markMessageModified(messageId);
        }

        // Toggle Status
        function toggleStatus(messageId, type, isChecked) {
            const message = filteredMessages.find(m => m.id === messageId);
            if (!message) return;
            
            const value = isChecked ? 'yes' : 'no';
            
            if (type === 'sent') {
                message.sent = value;
            } else if (type === 'reply') {
                message.gotReply = value;
            }
            
            markMessageModified(messageId);
        }

        // Update Comment
        function updateComment(messageId, value) {
            const message = filteredMessages.find(m => m.id === messageId);
            if (message) {
                message.comments = value;
                markMessageModified(messageId);
            }
        }

        // Mark Modified
        function markMessageModified(messageId) {
            pendingChanges.set(messageId, true);
            
            const saveButtons = document.querySelectorAll(`#save-${messageId}, #save-mobile-${messageId}`);
            saveButtons.forEach(btn => {
                btn.style.display = 'inline-flex';
                btn.classList.add('modified');
            });
        }

        // Save Message
        async function saveMessage(messageId) {
            const message = filteredMessages.find(m => m.id === messageId);
            if (!message || !pendingChanges.has(messageId)) return;
            
            const saveButtons = document.querySelectorAll(`#save-${messageId}, #save-mobile-${messageId}`);
            
            try {
                saveButtons.forEach(btn => {
                    btn.classList.add('saving');
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                });
                
                const token = getAuthToken();
                if (!token) {
                    window.location.href = '/login';
                    return;
                }
                
                const response = await fetch(`/messages/individual/${messageId}`, {
                    method: 'PUT',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sent: message.sent,
                        got_reply: message.gotReply,
                        comments: message.comments
                    })
                });
                
                if (response.status === 401) {
                    localStorage.removeItem('authToken');
                    window.location.href = '/login';
                    return;
                }
                
                if (response.ok) {
                    saveButtons.forEach(btn => {
                        btn.classList.remove('saving', 'modified');
                        btn.classList.add('saved');
                        btn.innerHTML = '<i class="fas fa-check"></i> Saved';
                    });
                    
                    pendingChanges.delete(messageId);
                    
                    setTimeout(() => {
                        saveButtons.forEach(btn => {
                            btn.classList.remove('saved');
                            btn.style.display = 'none';
                        });
                    }, 2000);
                } else {
                    throw new Error('Save failed');
                }
                
            } catch (error) {
                console.error('[SAVE] Error:', error);
                
                saveButtons.forEach(btn => {
                    btn.classList.remove('saving');
                    btn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Error';
                });
                
                setTimeout(() => {
                    saveButtons.forEach(btn => {
                        btn.classList.add('modified');
                        btn.innerHTML = '<i class="fas fa-save"></i> Save';
                    });
                }, 3000);
            }
        }

        // Delete Message
        async function deleteMessage(messageId) {
            if (!confirm('Are you sure you want to delete this message?')) return;
            
            try {
                const token = getAuthToken();
                const response = await fetch(`/messages/${messageId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.status === 401) {
                    localStorage.removeItem('authToken');
                    window.location.href = '/login';
                    return;
                }
                
                if (response.ok) {
                    filteredMessages = filteredMessages.filter(m => m.id !== messageId);
                    renderMessages();
                    updateMessagesStats();
                }
            } catch (error) {
                console.error('[DELETE] Error:', error);
                alert('Failed to delete message');
            }
        }

        // Edit Message
        function editMessage(messageId) {
            alert('Edit functionality will be implemented in a future update.');
        }

        // Copy Message Text
        async function copyMessageText(messageId, button) {
            try {
                const message = filteredMessages.find(m => m.id === messageId);
                if (!message || !message.message) {
                    throw new Error('Message not found');
                }
                
                await navigator.clipboard.writeText(message.message);
                
                const originalHTML = button.innerHTML;
                button.classList.add('copied');
                button.innerHTML = '<i class="fas fa-check"></i> Copied';
                
                setTimeout(() => {
                    button.classList.remove('copied');
                    button.innerHTML = originalHTML;
                }, 2000);
                
            } catch (error) {
                console.error('[COPY] Error:', error);
                const originalHTML = button.innerHTML;
                button.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Error';
                
                setTimeout(() => {
                    button.innerHTML = originalHTML;
                }, 2000);
            }
        }

        // Email Finder
        function openEmailFinder(targetProfileId) {
            if (!currentUserPlan) {
                document.getElementById('upgradeModal').classList.add('active');
                return;
            }
            
            const allowedPlans = ['silver-monthly', 'gold-monthly', 'platinum-monthly', 'silver-payasyougo', 'gold-payasyougo', 'platinum-payasyougo'];
            const userPlan = (currentUserPlan.planCode || 'free').toLowerCase();
            
            if (!allowedPlans.includes(userPlan)) {
                document.getElementById('currentPlanDisplay').textContent = currentUserPlan.planName || 'Free';
                document.getElementById('upgradeModal').classList.add('active');
                return;
            }
            
            const userCredits = currentUserPlan.totalCredits || 0;
            
            if (userCredits < 2) {
                document.getElementById('currentCredits').textContent = userCredits.toFixed(2);
                document.getElementById('insufficientCreditsModal').classList.add('active');
                return;
            }
            
            currentEmailFinderMessageId = targetProfileId;
            document.getElementById('emailFinderModal').classList.add('active');
        }

        async function confirmEmailFinder() {
            if (!currentEmailFinderMessageId) return;
            
            closeEmailModal();
            
            try {
                const token = getAuthToken();
                const response = await fetch('/api/ask-email', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        targetProfileId: currentEmailFinderMessageId
                    })
                });
                
                if (response.status === 401) {
                    localStorage.removeItem('authToken');
                    window.location.href = '/login';
                    return;
                }
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Refresh user profile for updated credits
                    loadUserProfile();
                    
                    // Refresh messages to show email
                    loadMessagesData();
                    
                    alert('Email finder completed! Check the results in the table.');
                } else {
                    const error = await response.json();
                    alert(error.message || 'Failed to find email');
                }
                
            } catch (error) {
                console.error('[EMAIL_FINDER] Error:', error);
                alert('Failed to find email. Please try again.');
            }
            
            currentEmailFinderMessageId = null;
        }

        // Modal Controls
        function closeEmailModal() {
            document.getElementById('emailFinderModal').classList.remove('active');
            currentEmailFinderMessageId = null;
        }

        function closeInsufficientCreditsModal() {
            document.getElementById('insufficientCreditsModal').classList.remove('active');
        }

        function closeUpgradeModal() {
            document.getElementById('upgradeModal').classList.remove('active');
        }

        // Stats Update
        function updateMessagesStats() {
            const totalMessages = filteredMessages.length;
            const sentMessages = filteredMessages.filter(m => m.sent === 'yes').length;
            const repliedMessages = filteredMessages.filter(m => m.gotReply === 'yes').length;
            const responseRate = sentMessages > 0 ? Math.round((repliedMessages / sentMessages) * 100) : 0;
            
            document.getElementById('totalMessages').textContent = totalMessages;
            document.getElementById('sentMessages').textContent = sentMessages;
            document.getElementById('repliedMessages').textContent = repliedMessages;
            document.getElementById('responseRate').textContent = `${responseRate}%`;
        }

        // Pagination
        function updatePagination() {
            const container = document.getElementById('paginationContainer');
            const showingInfo = document.getElementById('showingInfo');
            const loadMoreBtn = document.getElementById('loadMoreBtn');
            
            if (filteredMessages.length > MESSAGES_LIMIT) {
                container.style.display = 'flex';
                
                if (showingLimited) {
                    showingInfo.textContent = `Showing ${MESSAGES_LIMIT} of ${filteredMessages.length} messages`;
                    loadMoreBtn.innerHTML = '<i class="fas fa-eye"></i> Show All Messages';
                } else {
                    showingInfo.textContent = `Showing all ${filteredMessages.length} messages`;
                    loadMoreBtn.innerHTML = '<i class="fas fa-eye-slash"></i> Show Recent Only';
                }
            } else {
                container.style.display = 'none';
            }
        }

        function toggleShowAll() {
            showingLimited = !showingLimited;
            renderMessages();
        }

        // Refresh
        function refreshMessages() {
            const refreshBtn = document.querySelector('.refresh-btn i');
            refreshBtn.classList.add('fa-spin');
            
            loadUserProfile();
            loadMessagesData().finally(() => {
                refreshBtn.classList.remove('fa-spin');
            });
        }

        // Empty State
        function showEmptyState() {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('emptyState').style.display = 'block';
            document.getElementById('messagesTableContainer').style.display = 'none';
            document.getElementById('mobileCardsContainer').style.display = 'none';
            document.getElementById('paginationContainer').style.display = 'none';
        }

        // Modal Click Outside
        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal-overlay')) {
                closeEmailModal();
                closeInsufficientCreditsModal();
                closeUpgradeModal();
            }
        });
    </script>

    <!-- Load Shared Sidebar -->
    <script src="/sidebar-loader.js"></script>
</body>
</html>
